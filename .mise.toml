[tools]
bun = "latest"
dbmate = "latest"
go = "1.25"

[env]
DBMATE_DATABASE_URL = "postgresql://wh:wh@localhost:5432/warehouse_dev?sslmode=disable"

# Go backend
GO_DATABASE_URL = "postgresql://wh:wh@localhost:5432/warehouse_dev?sslmode=disable"
GO_TEST_DATABASE_URL = "postgresql://wh:wh@localhost:5432/warehouse_test?sslmode=disable"

[tasks.setup]
description = "Setup hint"
run = "echo 'No setup needed. Run: mise trust && mise install'"

[tasks.update-ip]
description = "Update .env files with current machine IP"
run = """
IP=$(ip -4 addr show | grep -oP '192\\.168\\.\\d+\\.\\d+' | head -1)
if [ -z "$IP" ]; then
  echo "Could not detect IP, using localhost"
  IP="localhost"
fi
echo "Detected IP: $IP"

# Update frontend/.env.local
mkdir -p frontend
echo "NEXT_PUBLIC_API_URL=http://${IP}:8080" > frontend/.env.local
echo "Updated frontend/.env.local"

# Update backend/.env (preserve other settings if they exist)
if [ -f backend/.env ]; then
  grep -v '^CORS_ALLOWED_ORIGINS=' backend/.env > backend/.env.tmp || true
  echo "CORS_ALLOWED_ORIGINS=http://${IP}:3001" >> backend/.env.tmp
  mv backend/.env.tmp backend/.env
else
  echo "CORS_ALLOWED_ORIGINS=http://${IP}:3001" > backend/.env
fi
echo "Updated backend/.env"
"""

[tasks.start]
description = "Start all services (containers, backend, frontend)"
depends = ["dc-up", "migrate"]
run = "mise run dev & mise run fe-dev"

[tasks.dc-up]
description = "Start all containers (PostgreSQL + Redis)"
run = "docker compose up -d --wait"

[tasks.dc-down]
description = "Stop all containers"
run = "docker compose down"

[tasks.db-reset]
description = "Drop and recreate database with fresh migrations"
depends = ["dc-down"]
run = "rm -rf .data/postgres && mkdir -p .data/postgres && chmod 700 .data/postgres && docker compose up -d postgres --wait && DATABASE_URL=$DBMATE_DATABASE_URL dbmate -d backend/db/migrations up"

[tasks.env-reset]
description = "Reset entire environment: wipe all data (postgres, redis, etc), restart containers, run migrations"
run = "docker compose down && rm -rf .data && mkdir -p .data/postgres .data/redis .data/docspell .data/docspell-postgres && chmod 700 .data/postgres .data/docspell-postgres && chmod 755 .data/redis .data/docspell && docker compose up -d --wait && DATABASE_URL=$DBMATE_DATABASE_URL dbmate -d backend/db/migrations up"

[tasks.migrate]
description = "Run database migrations"
depends = ["dc-up"]
run = "DATABASE_URL=$DBMATE_DATABASE_URL dbmate -d backend/db/migrations up"

[tasks.migrate-new]
description = "Create new migration"
run = "DATABASE_URL=$DBMATE_DATABASE_URL dbmate -d backend/db/migrations new"

[tasks.migrate-down]
description = "Rollback last migration"
run = "DATABASE_URL=$DBMATE_DATABASE_URL dbmate -d backend/db/migrations down"

[tasks.migrate-status]
description = "Check migration status"
run = "DATABASE_URL=$DBMATE_DATABASE_URL dbmate -d backend/db/migrations status"

# Go Backend Tasks
[tasks.dev]
description = "Run Go backend dev server with hot reload"
depends = ["dc-up", "update-ip"]
run = "cd backend && air"

[tasks.run]
description = "Run Go backend server (no hot reload)"
depends = ["dc-up"]
run = "cd backend && go run cmd/server/main.go"

[tasks.build]
description = "Build Go backend binary"
run = "cd backend && CGO_ENABLED=0 go build -o bin/server cmd/server/main.go"

[tasks.worker]
description = "Run background import worker"
depends = ["dc-up"]
run = "cd backend && go run cmd/worker/main.go"

[tasks.build-worker]
description = "Build worker binary"
run = "cd backend && CGO_ENABLED=0 go build -o bin/worker cmd/worker/main.go"

[tasks.scheduler]
description = "Run job scheduler (loan reminders, cleanup tasks)"
depends = ["dc-up"]
run = "cd backend && go run cmd/scheduler/main.go"

[tasks.build-scheduler]
description = "Build scheduler binary"
run = "cd backend && CGO_ENABLED=0 go build -o bin/scheduler cmd/scheduler/main.go"

[tasks.test]
description = "Run Go backend tests"
run = "cd backend && go test -v ./..."

[tasks.test-unit]
description = "Run Go backend unit tests only"
run = "cd backend && go test -v ./internal/domain/..."

[tasks.test-integration]
description = "Run Go backend integration tests"
depends = ["dc-up"]
run = "cd backend && go test -v ./tests/integration/..."

[tasks.test-cover]
description = "Run Go backend tests with coverage"
run = "cd backend && go test -coverprofile=coverage.out ./... && go tool cover -html=coverage.out -o coverage.html"

[tasks.lint]
description = "Run Go backend linter"
run = "cd backend && golangci-lint run"

[tasks.fmt]
description = "Format Go backend code"
run = "cd backend && go fmt ./..."

[tasks.sqlc]
description = "Generate sqlc code from queries"
run = "cd backend && ~/go/bin/sqlc generate"

[tasks.sqlc-vet]
description = "Verify sqlc queries are valid"
run = "cd backend && ~/go/bin/sqlc vet"

[tasks.mod-tidy]
description = "Tidy Go backend dependencies"
run = "cd backend && go mod tidy"

[tasks.mod-download]
description = "Download Go backend dependencies"
run = "cd backend && go mod download"

# Frontend Tasks
[tasks.fe-dev]
description = "Run frontend dev server"
depends = ["update-ip"]
run = "cd frontend && bun run dev"

[tasks.fe-build]
description = "Build frontend"
run = "cd frontend && bun run build"

[tasks.fe-install]
description = "Install frontend dependencies"
run = "cd frontend && bun install"

[tasks.fe-lint]
description = "Run frontend linter"
run = "cd frontend && bun run lint"

# Database Seeder
[tasks.seed]
description = "Seed database with test data (expiring|warranty|low-stock|overdue-loans|locations|all)"
depends = ["dc-up"]
run = "cd backend && go run cmd/seed/main.go {{ arg(name='type', default='all') }}"

# Photo Admin Tools
[tasks.photo-admin]
description = "Run photo admin CLI (regenerate|cleanup|report)"
depends = ["dc-up"]
run = "cd backend && go run cmd/photo-admin/main.go {{ arg(name='command', default='help') }}"

[tasks.build-photo-admin]
description = "Build photo-admin binary"
run = "cd backend && CGO_ENABLED=0 go build -o bin/photo-admin cmd/photo-admin/main.go"

# Frontend Testing
[tasks.fe-test]
description = "Run frontend Playwright tests"
run = "cd frontend && bun run test"

[tasks.fe-test-ui]
description = "Run frontend Playwright tests with UI"
run = "cd frontend && bun run test:ui"