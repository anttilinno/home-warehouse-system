[tools]
python = "3.14"
uv = "latest"
bun = "latest"
dbmate = "latest"

[env]
DATABASE_URL = "postgresql+asyncpg://wh:wh@localhost:5432/warehouse_dev"
DBMATE_DATABASE_URL = "postgresql://wh:wh@localhost:5432/warehouse_dev?sslmode=disable"
APP_DEBUG = "true"

[tasks.dc-up]
description = "Start all containers (PostgreSQL + Redis)"
run = "docker compose up -d"

[tasks.dc-down]
description = "Stop all containers"
run = "docker compose down"

[tasks.db-reset]
description = "Drop and recreate database with fresh migrations"
depends = ["dc-down"]
run = "docker compose down -v && docker compose up -d postgres && sleep 3 && DATABASE_URL=$DBMATE_DATABASE_URL dbmate -d backend/db/migrations up"

[tasks.db-fresh]
description = "Complete database reset: drop data volume, recreate database, run migrations"
run = "docker compose down -v && docker compose up -d && sleep 3 && DATABASE_URL=$DBMATE_DATABASE_URL dbmate -d backend/db/migrations up"

[tasks.migrate]
description = "Run database migrations"
depends = ["dc-up"]
run = "DATABASE_URL=$DBMATE_DATABASE_URL dbmate -d backend/db/migrations up"

[tasks.migrate-new]
description = "Create new migration"
run = "DATABASE_URL=$DBMATE_DATABASE_URL dbmate -d backend/db/migrations new"

[tasks.dev]
description = "Run backend dev server"
depends = ["dc-up"]
run = "cd backend && uv run granian --interface asgi warehouse.app:app --reload"

[tasks.test]
description = "Run all tests"
run = "cd backend && uv run pytest"

[tasks.test-unit]
description = "Run unit tests only"
run = "cd backend && uv run pytest src/"

[tasks.test-e2e]
description = "Run e2e tests"
depends = ["dc-up"]
run = "cd backend && uv run pytest e2e/"

[tasks.lint]
description = "Run linter"
run = "cd backend && uv run ruff check ."

[tasks.format]
description = "Format code"
run = "cd backend && uv run ruff format ."

[tasks.fe-dev]
description = "Run frontend dev server"
run = "cd frontend && bun run dev"

[tasks.fe-build]
description = "Build frontend"
run = "cd frontend && bun run build"

[tasks.fe-install]
description = "Install frontend dependencies"
run = "cd frontend && bun install"

[tasks.rq-worker]
description = "Run RQ worker for loan jobs"
depends = ["dc-up"]
run = "cd backend && uv run rq worker loans"

[tasks.seed]
description = "Seed database with sample data"
depends = ["dc-up"]
run = "cd backend && uv run python scripts/seed.py"