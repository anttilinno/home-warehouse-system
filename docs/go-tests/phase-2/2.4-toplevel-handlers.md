# Phase 2.4: Top-Level Domain Handlers

**Objective**: Add comprehensive HTTP handler tests for 5 top-level domain handlers

## Overview

Test cross-cutting concern handlers including analytics, barcode generation, batch operations, import/export, and synchronization.

## Handlers to Test

| Domain | File | Coverage Target | Test Count |
|--------|------|----------------|------------|
| analytics | `analytics/handler_test.go` | 80% | 15-20 |
| barcode | `barcode/handler_test.go` | 75% | 8-10 |
| batch | `batch/handler_test.go` | 70% | 10-12 |
| importexport | `importexport/handler_test.go` | 85% | 20-25 |
| sync | `sync/handler_test.go` | 80% | 12-15 |

## Analytics Handler Tests

```go
package analytics_test

import (
    "fmt"
    "net/http"
    "testing"

    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/mock"

    "github.com/antti/home-warehouse/go-backend/internal/domain/analytics"
    "github.com/antti/home-warehouse/go-backend/internal/testutil"
)

func TestAnalyticsHandler_GetDashboardStats(t *testing.T) {
    setup := testutil.NewHandlerTestSetup()
    mockSvc := new(MockAnalyticsService)
    analytics.RegisterRoutes(setup.API, mockSvc)

    t.Run("gets dashboard statistics", func(t *testing.T) {
        stats := &analytics.DashboardStats{
            TotalItems:      150,
            TotalLocations:  25,
            TotalContainers: 40,
            LoanedItems:     12,
            LowStockItems:   5,
        }

        mockSvc.On("GetDashboardStats", mock.Anything, setup.WorkspaceID).
            Return(stats, nil)

        rec := setup.Get(fmt.Sprintf("/workspaces/%s/analytics/dashboard", setup.WorkspaceID))

        testutil.AssertStatus(t, rec, http.StatusOK)
        response := testutil.ParseJSONResponse[analytics.DashboardStats](t, rec)
        assert.Equal(t, 150, response.TotalItems)
        assert.Equal(t, 12, response.LoanedItems)
    })
}

func TestAnalyticsHandler_GetItemTrends(t *testing.T) {
    setup := testutil.NewHandlerTestSetup()
    mockSvc := new(MockAnalyticsService)
    analytics.RegisterRoutes(setup.API, mockSvc)

    t.Run("gets item trends with date range", func(t *testing.T) {
        trends := []analytics.TrendDataPoint{
            {Date: "2024-01-01", Value: 100},
            {Date: "2024-01-02", Value: 105},
        }

        mockSvc.On("GetItemTrends", mock.Anything, setup.WorkspaceID, mock.Anything, mock.Anything).
            Return(trends, nil)

        rec := setup.Get(fmt.Sprintf("/workspaces/%s/analytics/trends?start=2024-01-01&end=2024-01-31", setup.WorkspaceID))

        testutil.AssertStatus(t, rec, http.StatusOK)
        response := testutil.ParseJSONResponse[[]analytics.TrendDataPoint](t, rec)
        assert.Len(t, response, 2)
    })

    t.Run("returns 400 for invalid date format", func(t *testing.T) {
        rec := setup.Get(fmt.Sprintf("/workspaces/%s/analytics/trends?start=invalid", setup.WorkspaceID))

        testutil.AssertErrorResponse(t, rec, http.StatusBadRequest, "date")
    })
}

func TestAnalyticsHandler_GetCategoryDistribution(t *testing.T) {
    setup := testutil.NewHandlerTestSetup()
    mockSvc := new(MockAnalyticsService)
    analytics.RegisterRoutes(setup.API, mockSvc)

    t.Run("gets category distribution", func(t *testing.T) {
        distribution := []analytics.CategoryStats{
            {CategoryName: "Electronics", Count: 50, Percentage: 33.3},
            {CategoryName: "Tools", Count: 30, Percentage: 20.0},
        }

        mockSvc.On("GetCategoryDistribution", mock.Anything, setup.WorkspaceID).
            Return(distribution, nil)

        rec := setup.Get(fmt.Sprintf("/workspaces/%s/analytics/categories", setup.WorkspaceID))

        testutil.AssertStatus(t, rec, http.StatusOK)
        response := testutil.ParseJSONResponse[[]analytics.CategoryStats](t, rec)
        assert.Len(t, response, 2)
    })
}
```

## Barcode Handler Tests

```go
func TestBarcodeHandler_Generate(t *testing.T) {
    setup := testutil.NewHandlerTestSetup()
    mockSvc := new(MockBarcodeService)
    barcode.RegisterRoutes(setup.API, mockSvc)

    t.Run("generates QR code successfully", func(t *testing.T) {
        barcodeData := []byte("qr-code-image-data")

        mockSvc.On("GenerateQR", mock.Anything, "https://example.com/item/123").
            Return(barcodeData, nil)

        body := `{"type":"qr","data":"https://example.com/item/123"}`
        rec := setup.Post(fmt.Sprintf("/workspaces/%s/barcodes/generate", setup.WorkspaceID), body)

        testutil.AssertStatus(t, rec, http.StatusOK)
        assert.Equal(t, "image/png", rec.Header().Get("Content-Type"))
    })

    t.Run("generates barcode successfully", func(t *testing.T) {
        barcodeData := []byte("barcode-image-data")

        mockSvc.On("GenerateBarcode", mock.Anything, "123456789").
            Return(barcodeData, nil)

        body := `{"type":"code128","data":"123456789"}`
        rec := setup.Post(fmt.Sprintf("/workspaces/%s/barcodes/generate", setup.WorkspaceID), body)

        testutil.AssertStatus(t, rec, http.StatusOK)
    })

    t.Run("returns 400 for invalid barcode type", func(t *testing.T) {
        body := `{"type":"invalid","data":"test"}`
        rec := setup.Post(fmt.Sprintf("/workspaces/%s/barcodes/generate", setup.WorkspaceID), body)

        testutil.AssertErrorResponse(t, rec, http.StatusBadRequest, "type")
    })
}
```

## Batch Handler Tests

```go
func TestBatchHandler_ProcessBatch(t *testing.T) {
    setup := testutil.NewHandlerTestSetup()
    mockSvc := new(MockBatchService)
    batch.RegisterRoutes(setup.API, mockSvc)

    t.Run("processes batch operations successfully", func(t *testing.T) {
        result := &batch.BatchResult{
            Succeeded: 2,
            Failed:    0,
            Results: []batch.OperationResult{
                {Success: true, EntityID: uuid.New()},
                {Success: true, EntityID: uuid.New()},
            },
        }

        mockSvc.On("ProcessBatch", mock.Anything, setup.WorkspaceID, mock.Anything).
            Return(result, nil)

        body := `{
            "operations": [
                {"operation":"update","entity_type":"item","entity_id":"...","data":{}},
                {"operation":"delete","entity_type":"item","entity_id":"..."}
            ]
        }`
        rec := setup.Post(fmt.Sprintf("/workspaces/%s/batch", setup.WorkspaceID), body)

        testutil.AssertStatus(t, rec, http.StatusOK)
        response := testutil.ParseJSONResponse[batch.BatchResult](t, rec)
        assert.Equal(t, 2, response.Succeeded)
        assert.Equal(t, 0, response.Failed)
    })

    t.Run("handles partial batch failures", func(t *testing.T) {
        result := &batch.BatchResult{
            Succeeded: 1,
            Failed:    1,
            Results: []batch.OperationResult{
                {Success: true, EntityID: uuid.New()},
                {Success: false, Error: "Not found"},
            },
        }

        mockSvc.On("ProcessBatch", mock.Anything, setup.WorkspaceID, mock.Anything).
            Return(result, nil)

        body := `{"operations":[...]}`
        rec := setup.Post(fmt.Sprintf("/workspaces/%s/batch", setup.WorkspaceID), body)

        testutil.AssertStatus(t, rec, http.StatusOK)
        response := testutil.ParseJSONResponse[batch.BatchResult](t, rec)
        assert.Equal(t, 1, response.Failed)
    })
}
```

## Import/Export Handler Tests

```go
func TestImportExportHandler_Export(t *testing.T) {
    setup := testutil.NewHandlerTestSetup()
    mockSvc := new(MockImportExportService)
    importexport.RegisterRoutes(setup.API, mockSvc)

    t.Run("exports data as CSV", func(t *testing.T) {
        csvData := []byte("id,name,sku\n1,Item1,SKU-001")

        mockSvc.On("ExportItems", mock.Anything, setup.WorkspaceID, "csv").
            Return(csvData, nil)

        rec := setup.Get(fmt.Sprintf("/workspaces/%s/export/items?format=csv", setup.WorkspaceID))

        testutil.AssertStatus(t, rec, http.StatusOK)
        assert.Equal(t, "text/csv", rec.Header().Get("Content-Type"))
    })

    t.Run("exports data as JSON", func(t *testing.T) {
        jsonData := []byte(`[{"id":"...","name":"Item1"}]`)

        mockSvc.On("ExportItems", mock.Anything, setup.WorkspaceID, "json").
            Return(jsonData, nil)

        rec := setup.Get(fmt.Sprintf("/workspaces/%s/export/items?format=json", setup.WorkspaceID))

        testutil.AssertStatus(t, rec, http.StatusOK)
        assert.Equal(t, "application/json", rec.Header().Get("Content-Type"))
    })
}

func TestImportExportHandler_Import(t *testing.T) {
    setup := testutil.NewHandlerTestSetup()
    mockSvc := new(MockImportExportService)
    importexport.RegisterRoutes(setup.API, mockSvc)

    t.Run("imports CSV data", func(t *testing.T) {
        result := &importexport.ImportResult{
            Imported: 10,
            Failed:   0,
            Errors:   []string{},
        }

        mockSvc.On("ImportItems", mock.Anything, setup.WorkspaceID, mock.Anything, "csv").
            Return(result, nil)

        // Multipart form upload test
        // body := createMultipartBody(...)
        // rec := setup.Post(...)

        testutil.AssertStatus(t, rec, http.StatusOK)
    })
}
```

## Files to Create

- `internal/domain/analytics/handler_test.go`
- `internal/domain/barcode/handler_test.go`
- `internal/domain/batch/handler_test.go`
- `internal/domain/importexport/handler_test.go`
- `internal/domain/sync/handler_test.go`

## Estimated Effort

- **Time**: 20-25 hours
- **Tests to add**: 65-82

## Success Criteria

- [ ] Analytics endpoints (dashboard, trends, distributions) are tested
- [ ] Barcode/QR code generation is tested
- [ ] Batch operations are tested (success and partial failure)
- [ ] Import/export handlers are tested (CSV, JSON formats)
- [ ] Sync operations are tested
- [ ] File uploads/downloads are handled correctly
- [ ] Coverage for top-level handlers reaches 75%+

## Running Tests

```bash
# Test all top-level handlers
go test ./internal/domain/analytics -v -cover
go test ./internal/domain/barcode -v -cover
go test ./internal/domain/batch -v -cover
go test ./internal/domain/importexport -v -cover
go test ./internal/domain/sync -v -cover
```

## Phase 2 Summary

After completing all Phase 2 tasks:
- ✅ Handler test infrastructure created
- ✅ 13 warehouse domain handlers tested
- ✅ 4 auth domain handlers tested
- ✅ 5 top-level domain handlers tested

**Total Phase 2 Impact**: +25% overall coverage (53.9% → 78.9%)

Proceed to [Phase 3: Service Error Path Coverage](../phase-3/).
