# Phase 2.3: Auth Domain Handlers

**Objective**: Add comprehensive HTTP handler tests for all 4 auth domain handlers

## Overview

Test authentication and workspace management handlers. These are critical handlers as they control access to the system.

## Handlers to Test

| Domain | File | Coverage Target | Test Count |
|--------|------|----------------|------------|
| user | `auth/user/handler_test.go` | 90% | 25-30 |
| workspace | `auth/workspace/handler_test.go` | 85% | 20-25 |
| member | `auth/member/handler_test.go` | 80% | 15-20 |
| notification | `auth/notification/handler_test.go` | 75% | 12-15 |

## User Handler Test Template

```go
package user_test

import (
    "context"
    "fmt"
    "net/http"
    "testing"

    "github.com/google/uuid"
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/mock"

    "github.com/antti/home-warehouse/go-backend/internal/domain/auth/user"
    "github.com/antti/home-warehouse/go-backend/internal/pkg/jwt"
    "github.com/antti/home-warehouse/go-backend/internal/testutil"
)

type MockUserService struct {
    mock.Mock
}

func (m *MockUserService) Create(ctx context.Context, input user.CreateInput) (*user.User, error) {
    args := m.Called(ctx, input)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).(*user.User), args.Error(1)
}

func (m *MockUserService) Authenticate(ctx context.Context, email, password string) (*user.User, string, error) {
    args := m.Called(ctx, email, password)
    if args.Get(0) == nil {
        return nil, "", args.Error(2)
    }
    return args.Get(0).(*user.User), args.String(1), args.Error(2)
}

// ... other service methods

func TestUserHandler_Register(t *testing.T) {
    setup := testutil.NewHandlerTestSetup()
    mockSvc := new(MockUserService)
    user.RegisterRoutes(setup.API, mockSvc)

    t.Run("registers new user successfully", func(t *testing.T) {
        testUser := &user.User{
            ID:       uuid.New(),
            Email:    "test@example.com",
            FullName: "John Doe",
        }

        mockSvc.On("Create", mock.Anything, mock.MatchedBy(func(input user.CreateInput) bool {
            return input.Email == "test@example.com" && input.Password == "SecurePass123!"
        })).Return(testUser, nil)

        body := `{"email":"test@example.com","password":"SecurePass123!","full_name":"John Doe"}`
        rec := setup.Post("/auth/register", body)

        testutil.AssertStatus(t, rec, http.StatusCreated)
        response := testutil.ParseJSONResponse[user.User](t, rec)
        assert.Equal(t, "test@example.com", response.Email)
        mockSvc.AssertExpectations(t)
    })

    t.Run("returns 400 for invalid email", func(t *testing.T) {
        body := `{"email":"invalid-email","password":"SecurePass123!"}`
        rec := setup.Post("/auth/register", body)

        testutil.AssertErrorResponse(t, rec, http.StatusBadRequest, "email")
    })

    t.Run("returns 400 for weak password", func(t *testing.T) {
        body := `{"email":"test@example.com","password":"weak"}`
        rec := setup.Post("/auth/register", body)

        testutil.AssertErrorResponse(t, rec, http.StatusBadRequest, "password")
    })

    t.Run("returns 409 for duplicate email", func(t *testing.T) {
        mockSvc.On("Create", mock.Anything, mock.Anything).
            Return(nil, user.ErrDuplicateEmail)

        body := `{"email":"existing@example.com","password":"SecurePass123!"}`
        rec := setup.Post("/auth/register", body)

        testutil.AssertStatus(t, rec, http.StatusConflict)
    })
}

func TestUserHandler_Login(t *testing.T) {
    setup := testutil.NewHandlerTestSetup()
    mockSvc := new(MockUserService)
    user.RegisterRoutes(setup.API, mockSvc)

    t.Run("authenticates user successfully", func(t *testing.T) {
        testUser := &user.User{
            ID:    uuid.New(),
            Email: "test@example.com",
        }
        token := "jwt-token-here"

        mockSvc.On("Authenticate", mock.Anything, "test@example.com", "SecurePass123!").
            Return(testUser, token, nil)

        body := `{"email":"test@example.com","password":"SecurePass123!"}`
        rec := setup.Post("/auth/login", body)

        testutil.AssertStatus(t, rec, http.StatusOK)
        response := testutil.ParseJSONResponse[struct {
            User  user.User `json:"user"`
            Token string    `json:"token"`
        }](t, rec)
        assert.Equal(t, token, response.Token)
        mockSvc.AssertExpectations(t)
    })

    t.Run("returns 401 for invalid credentials", func(t *testing.T) {
        mockSvc.On("Authenticate", mock.Anything, "test@example.com", "WrongPass").
            Return(nil, "", user.ErrInvalidCredentials)

        body := `{"email":"test@example.com","password":"WrongPass"}`
        rec := setup.Post("/auth/login", body)

        testutil.AssertStatus(t, rec, http.StatusUnauthorized)
    })

    t.Run("returns 400 for missing email", func(t *testing.T) {
        body := `{"password":"SecurePass123!"}`
        rec := setup.Post("/auth/login", body)

        testutil.AssertErrorResponse(t, rec, http.StatusBadRequest, "email")
    })
}

func TestUserHandler_GetMe(t *testing.T) {
    setup := testutil.NewHandlerTestSetup()
    mockSvc := new(MockUserService)
    user.RegisterRoutes(setup.API, mockSvc)

    t.Run("gets current user profile", func(t *testing.T) {
        testUser := &user.User{
            ID:       setup.UserID,
            Email:    "test@example.com",
            FullName: "John Doe",
        }

        mockSvc.On("GetByID", mock.Anything, setup.UserID).
            Return(testUser, nil)

        rec := setup.Get("/auth/me")

        testutil.AssertStatus(t, rec, http.StatusOK)
        response := testutil.ParseJSONResponse[user.User](t, rec)
        assert.Equal(t, setup.UserID, response.ID)
    })
}

func TestUserHandler_UpdateProfile(t *testing.T) {
    setup := testutil.NewHandlerTestSetup()
    mockSvc := new(MockUserService)
    user.RegisterRoutes(setup.API, mockSvc)

    t.Run("updates user profile", func(t *testing.T) {
        updatedUser := &user.User{
            ID:       setup.UserID,
            FullName: "Jane Doe",
        }

        mockSvc.On("Update", mock.Anything, setup.UserID, mock.Anything).
            Return(updatedUser, nil)

        body := `{"full_name":"Jane Doe"}`
        rec := setup.Patch("/auth/me", body)

        testutil.AssertStatus(t, rec, http.StatusOK)
        response := testutil.ParseJSONResponse[user.User](t, rec)
        assert.Equal(t, "Jane Doe", response.FullName)
    })
}

func TestUserHandler_ChangePassword(t *testing.T) {
    setup := testutil.NewHandlerTestSetup()
    mockSvc := new(MockUserService)
    user.RegisterRoutes(setup.API, mockSvc)

    t.Run("changes password successfully", func(t *testing.T) {
        mockSvc.On("ChangePassword", mock.Anything, setup.UserID, "OldPass123!", "NewPass456!").
            Return(nil)

        body := `{"old_password":"OldPass123!","new_password":"NewPass456!"}`
        rec := setup.Post("/auth/me/change-password", body)

        testutil.AssertStatus(t, rec, http.StatusOK)
    })

    t.Run("returns 401 for incorrect old password", func(t *testing.T) {
        mockSvc.On("ChangePassword", mock.Anything, setup.UserID, "WrongOld", "NewPass456!").
            Return(user.ErrInvalidCredentials)

        body := `{"old_password":"WrongOld","new_password":"NewPass456!"}`
        rec := setup.Post("/auth/me/change-password", body)

        testutil.AssertStatus(t, rec, http.StatusUnauthorized)
    })
}
```

## Workspace Handler Test Scenarios

Test cases for workspace handler:
- Create workspace (owner is automatically added)
- List user's workspaces
- Get workspace by ID
- Update workspace details
- Delete workspace (owner only)
- Workspace slug uniqueness validation
- Permission checks (only members can access)

## Member Handler Test Scenarios

Test cases for member handler:
- Add member to workspace (admin/owner only)
- List workspace members
- Update member role (owner only)
- Remove member (admin/owner only)
- Role validation (owner, admin, member, viewer)
- Permission checks for role changes
- Cannot remove last owner

## Notification Handler Test Scenarios

Test cases for notification handler:
- List user notifications
- Mark notification as read
- Delete notification
- Mark all as read
- Filter by type/status

## Files to Create

- `internal/domain/auth/user/handler_test.go`
- `internal/domain/auth/workspace/handler_test.go`
- `internal/domain/auth/member/handler_test.go`
- `internal/domain/auth/notification/handler_test.go`

## Estimated Effort

- **Time**: 20-25 hours
- **Tests to add**: 70-90

## Success Criteria

- [ ] User registration and authentication are tested
- [ ] Password change and profile updates are tested
- [ ] Workspace CRUD operations are tested
- [ ] Member management and role updates are tested
- [ ] Permission/authorization checks are tested
- [ ] Validation errors return correct status codes
- [ ] Coverage for auth handlers reaches 85%+

## Running Tests

```bash
# Test all auth handlers
go test ./internal/domain/auth/.../handler_test.go -v -cover

# Test user handler specifically
go test ./internal/domain/auth/user -run TestUserHandler -v -cover

# Expected output
coverage: 90%+ of statements for user handler
coverage: 80%+ of statements for other handlers
```

## Next Steps

After completing auth handlers, proceed to [2.4 Top-Level Domain Handlers](2.4-toplevel-handlers.md).
