# Phase 5.1: Test Router and API Setup

**Objective**: Add tests for router initialization and API configuration

**Package**: `internal/api`

## Overview

Test the main router setup, middleware registration, and API initialization to ensure all routes are properly registered and middleware is applied correctly.

## Router Tests

```go
package api_test

import (
    "context"
    "net/http"
    "net/http/httptest"
    "testing"

    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/require"

    "github.com/antti/home-warehouse/go-backend/internal/api"
    "github.com/antti/home-warehouse/go-backend/internal/config"
    "github.com/antti/home-warehouse/go-backend/internal/testutil"
)

func TestNewRouter(t *testing.T) {
    pool := testutil.SetupTestDB(t)
    cfg := &config.Config{
        JWTSecret:          "test-secret",
        JWTExpirationHours: 24,
        Debug:              true,
    }

    router := api.NewRouter(pool, cfg)

    assert.NotNil(t, router)

    t.Run("health endpoint is registered", func(t *testing.T) {
        req := httptest.NewRequest("GET", "/health", nil)
        rec := httptest.NewRecorder()

        router.ServeHTTP(rec, req)

        assert.Equal(t, http.StatusOK, rec.Code)

        var response map[string]string
        err := json.Unmarshal(rec.Body.Bytes(), &response)
        assert.NoError(t, err)
        assert.Equal(t, "ok", response["status"])
    })

    t.Run("API documentation endpoint is registered", func(t *testing.T) {
        req := httptest.NewRequest("GET", "/docs", nil)
        rec := httptest.NewRecorder()

        router.ServeHTTP(rec, req)

        // Should redirect or return docs
        assert.Contains(t, []int{http.StatusOK, http.StatusMovedPermanently}, rec.Code)
    })

    t.Run("CORS middleware is applied", func(t *testing.T) {
        req := httptest.NewRequest("OPTIONS", "/health", nil)
        req.Header.Set("Origin", "http://localhost:3000")
        req.Header.Set("Access-Control-Request-Method", "GET")
        rec := httptest.NewRecorder()

        router.ServeHTTP(rec, req)

        assert.Equal(t, http.StatusOK, rec.Code)
        assert.NotEmpty(t, rec.Header().Get("Access-Control-Allow-Origin"))
    })

    t.Run("request logging middleware is applied", func(t *testing.T) {
        req := httptest.NewRequest("GET", "/health", nil)
        rec := httptest.NewRecorder()

        router.ServeHTTP(rec, req)

        // Verify request was logged (check logs or internal state)
        assert.Equal(t, http.StatusOK, rec.Code)
    })
}

func TestRouteRegistration(t *testing.T) {
    pool := testutil.SetupTestDB(t)
    cfg := &config.Config{
        JWTSecret:          "test-secret",
        JWTExpirationHours: 24,
    }

    router := api.NewRouter(pool, cfg)

    tests := []struct {
        name   string
        method string
        path   string
    }{
        // Auth routes
        {"register", "POST", "/auth/register"},
        {"login", "POST", "/auth/login"},
        {"me", "GET", "/auth/me"},

        // Workspace routes (with placeholder IDs)
        {"list workspaces", "GET", "/workspaces"},
        {"items", "GET", "/workspaces/00000000-0000-0000-0000-000000000001/items"},
        {"locations", "GET", "/workspaces/00000000-0000-0000-0000-000000000001/locations"},
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            req := httptest.NewRequest(tt.method, tt.path, nil)
            rec := httptest.NewRecorder()

            router.ServeHTTP(rec, req)

            // Should not return 404 (route exists)
            // May return 401 (unauthorized) which is fine - route is registered
            assert.NotEqual(t, http.StatusNotFound, rec.Code,
                "Route %s %s should be registered", tt.method, tt.path)
        })
    }
}

func TestMiddlewareOrder(t *testing.T) {
    pool := testutil.SetupTestDB(t)
    cfg := &config.Config{
        JWTSecret:          "test-secret",
        JWTExpirationHours: 24,
    }

    router := api.NewRouter(pool, cfg)

    t.Run("authentication runs before authorization", func(t *testing.T) {
        // Request without auth token
        req := httptest.NewRequest("GET", "/workspaces", nil)
        rec := httptest.NewRecorder()

        router.ServeHTTP(rec, req)

        // Should return 401 (auth failed), not 403 (authorization failed)
        assert.Equal(t, http.StatusUnauthorized, rec.Code)
    })

    t.Run("error transformer handles domain errors", func(t *testing.T) {
        // This would require triggering a specific domain error
        // and verifying it's transformed to the correct HTTP status
    })
}
```

## API Configuration Tests

```go
func TestAPIConfiguration(t *testing.T) {
    pool := testutil.SetupTestDB(t)

    t.Run("creates API with default config", func(t *testing.T) {
        cfg := &config.Config{
            JWTSecret:          "test-secret",
            JWTExpirationHours: 24,
        }

        router := api.NewRouter(pool, cfg)
        assert.NotNil(t, router)
    })

    t.Run("uses debug mode when configured", func(t *testing.T) {
        cfg := &config.Config{
            JWTSecret:          "test-secret",
            JWTExpirationHours: 24,
            Debug:              true,
        }

        router := api.NewRouter(pool, cfg)
        assert.NotNil(t, router)

        // In debug mode, errors should include stack traces
        req := httptest.NewRequest("GET", "/non-existent", nil)
        rec := httptest.NewRecorder()
        router.ServeHTTP(rec, req)

        // Verify debug info in response (if applicable)
    })
}
```

## Files to Create

- `internal/api/router_test.go` (new)

## Estimated Effort

- **Time**: 3-4 hours
- **Tests to add**: 10-15

## Success Criteria

- [ ] Router initialization is tested
- [ ] Health endpoint works correctly
- [ ] All major routes are registered
- [ ] Middleware is applied in correct order
- [ ] CORS configuration works
- [ ] Debug mode is respected
- [ ] Coverage for `internal/api/router.go` reaches 80%+

## Running Tests

```bash
go test ./internal/api -v -cover -run TestNewRouter
go test ./internal/api -v -cover
```

## Next Steps

After completing router tests, proceed to [5.2 Test Documentation Routes](5.2-documentation-routes.md).
