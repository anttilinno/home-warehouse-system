# Phase 5.2: Test Documentation Routes

**Objective**: Add tests for API documentation endpoints (OpenAPI, ReDoc, Scalar)

**Package**: `internal/api`

## Overview

Test that API documentation is properly served and accessible. This includes OpenAPI spec generation, ReDoc UI, and any other documentation endpoints.

## Documentation Tests

```go
package api_test

import (
    "encoding/json"
    "net/http"
    "net/http/httptest"
    "testing"

    "github.com/stretchr/testify/assert"

    "github.com/antti/home-warehouse/go-backend/internal/api"
    "github.com/antti/home-warehouse/go-backend/internal/testutil"
)

func TestRegisterDocsRoutes(t *testing.T) {
    pool := testutil.SetupTestDB(t)
    cfg := testutil.DefaultTestConfig()
    router := api.NewRouter(pool, cfg)

    t.Run("serves OpenAPI spec", func(t *testing.T) {
        req := httptest.NewRequest("GET", "/openapi.json", nil)
        rec := httptest.NewRecorder()

        router.ServeHTTP(rec, req)

        assert.Equal(t, http.StatusOK, rec.Code)
        assert.Equal(t, "application/json", rec.Header().Get("Content-Type"))

        // Parse and validate OpenAPI spec
        var spec map[string]interface{}
        err := json.Unmarshal(rec.Body.Bytes(), &spec)
        assert.NoError(t, err)

        // Check required OpenAPI fields
        assert.Equal(t, "3.0.0", spec["openapi"])
        assert.NotNil(t, spec["info"])
        assert.NotNil(t, spec["paths"])
    })

    t.Run("serves ReDoc UI", func(t *testing.T) {
        req := httptest.NewRequest("GET", "/docs", nil)
        rec := httptest.NewRecorder()

        router.ServeHTTP(rec, req)

        assert.Equal(t, http.StatusOK, rec.Code)
        assert.Contains(t, rec.Header().Get("Content-Type"), "text/html")

        // Verify it contains ReDoc
        body := rec.Body.String()
        assert.Contains(t, body, "redoc")
    })

    t.Run("OpenAPI spec includes auth endpoints", func(t *testing.T) {
        req := httptest.NewRequest("GET", "/openapi.json", nil)
        rec := httptest.NewRecorder()

        router.ServeHTTP(rec, req)

        var spec map[string]interface{}
        json.Unmarshal(rec.Body.Bytes(), &spec)

        paths := spec["paths"].(map[string]interface{})
        assert.Contains(t, paths, "/auth/register")
        assert.Contains(t, paths, "/auth/login")
    })

    t.Run("OpenAPI spec includes workspace endpoints", func(t *testing.T) {
        req := httptest.NewRequest("GET", "/openapi.json", nil)
        rec := httptest.NewRecorder()

        router.ServeHTTP(rec, req)

        var spec map[string]interface{}
        json.Unmarshal(rec.Body.Bytes(), &spec)

        paths := spec["paths"].(map[string]interface{})

        // Check for workspace routes
        found := false
        for path := range paths {
            if strings.Contains(path, "/workspaces") {
                found = true
                break
            }
        }
        assert.True(t, found, "Workspace endpoints should be in OpenAPI spec")
    })

    t.Run("OpenAPI spec includes security schemes", func(t *testing.T) {
        req := httptest.NewRequest("GET", "/openapi.json", nil)
        rec := httptest.NewRecorder()

        router.ServeHTTP(rec, req)

        var spec map[string]interface{}
        json.Unmarshal(rec.Body.Bytes(), &spec)

        components := spec["components"].(map[string]interface{})
        securitySchemes := components["securitySchemes"].(map[string]interface{})

        assert.NotEmpty(t, securitySchemes, "Should have security schemes defined")
    })

    t.Run("OpenAPI spec includes request/response schemas", func(t *testing.T) {
        req := httptest.NewRequest("GET", "/openapi.json", nil)
        rec := httptest.NewRecorder()

        router.ServeHTTP(rec, req)

        var spec map[string]interface{}
        json.Unmarshal(rec.Body.Bytes(), &spec)

        components := spec["components"].(map[string]interface{})
        schemas := components["schemas"].(map[string]interface{})

        // Should have domain schemas
        assert.NotEmpty(t, schemas, "Should have schema definitions")

        // Check for some expected schemas
        schemaNames := make([]string, 0, len(schemas))
        for name := range schemas {
            schemaNames = append(schemaNames, name)
        }

        // At least some domain objects should be present
        assert.Greater(t, len(schemaNames), 10, "Should have multiple schema definitions")
    })
}

func TestAPIVersioning(t *testing.T) {
    pool := testutil.SetupTestDB(t)
    cfg := testutil.DefaultTestConfig()
    router := api.NewRouter(pool, cfg)

    t.Run("API version is present in OpenAPI spec", func(t *testing.T) {
        req := httptest.NewRequest("GET", "/openapi.json", nil)
        rec := httptest.NewRecorder()

        router.ServeHTTP(rec, req)

        var spec map[string]interface{}
        json.Unmarshal(rec.Body.Bytes(), &spec)

        info := spec["info"].(map[string]interface{})
        version := info["version"].(string)

        assert.NotEmpty(t, version)
        assert.Regexp(t, `^\d+\.\d+\.\d+$`, version, "Version should be semver")
    })
}
```

## Files to Create/Extend

- `internal/api/docs_test.go` (new or extend existing)

## Estimated Effort

- **Time**: 2 hours
- **Tests to add**: 5-8

## Success Criteria

- [ ] OpenAPI spec is served correctly
- [ ] ReDoc UI is accessible
- [ ] OpenAPI spec includes all endpoints
- [ ] Security schemes are documented
- [ ] Request/response schemas are present
- [ ] API version is correct
- [ ] Coverage for `internal/api/docs.go` reaches 90%+

## Running Tests

```bash
go test ./internal/api -v -cover -run TestRegisterDocsRoutes
```

## Next Steps

After completing documentation tests, proceed to [5.3 Add Batch Operation Tests](5.3-batch-operations.md).
