# Phase 1.1: Complete Middleware Testing

**Current Coverage**: 49.3% | **Target Coverage**: 95%

**Package**: `internal/api/middleware`

## Objective

Test all middleware components including JWTAuth, Workspace, and ErrorTransformer middleware.

## Files to Test

### 1. `auth.go` - JWTAuth middleware (currently 0% covered)
**Location**: `internal/api/middleware/auth.go:29-64`

Test scenarios:
- Valid JWT token extracts user correctly
- Missing Authorization header returns 401
- Invalid token format returns 401
- Expired token returns 401
- Token with invalid signature returns 401
- Token missing required claims returns 401

### 2. `workspace.go` - Workspace middleware (currently 0% covered)
**Location**: `internal/api/middleware/workspace.go:15-38`

Test scenarios:
- Valid workspace ID is extracted from URL
- Missing workspace ID returns 400
- Invalid workspace ID format returns 400
- Workspace ID is added to request context
- User has access to workspace
- User does not have access to workspace (403)

### 3. `errors.go` - ErrorTransformer (currently 0% covered)
**Location**: `internal/api/middleware/errors.go:12-26`

Test scenarios:
- Domain errors are transformed to correct HTTP status codes
- ErrNotFound → 404
- ErrUnauthorized → 401
- ErrForbidden → 403
- ErrValidation → 400
- ErrConflict → 409
- Unknown errors → 500

## Test Approach

### Example: Testing JWTAuth Middleware

```go
package middleware_test

import (
    "context"
    "net/http"
    "net/http/httptest"
    "testing"

    "github.com/google/uuid"
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/mock"

    "github.com/antti/home-warehouse/go-backend/internal/api/middleware"
    "github.com/antti/home-warehouse/go-backend/internal/pkg/jwt"
)

type MockJWTService struct {
    mock.Mock
}

func (m *MockJWTService) ValidateToken(token string) (*jwt.Claims, error) {
    args := m.Called(token)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).(*jwt.Claims), args.Error(1)
}

func TestJWTAuth_ValidToken(t *testing.T) {
    mockJWT := new(MockJWTService)
    userID := uuid.New()

    mockJWT.On("ValidateToken", "valid-token").Return(&jwt.Claims{
        UserID: userID,
        Email:  "test@example.com",
    }, nil)

    handler := middleware.JWTAuth(mockJWT)(testHandler())
    req := httptest.NewRequest("GET", "/", nil)
    req.Header.Set("Authorization", "Bearer valid-token")
    rec := httptest.NewRecorder()

    handler.ServeHTTP(rec, req)

    assert.Equal(t, http.StatusOK, rec.Code)
    mockJWT.AssertExpectations(t)
}

func TestJWTAuth_MissingToken(t *testing.T) {
    mockJWT := new(MockJWTService)

    handler := middleware.JWTAuth(mockJWT)(testHandler())
    req := httptest.NewRequest("GET", "/", nil)
    // No Authorization header
    rec := httptest.NewRecorder()

    handler.ServeHTTP(rec, req)

    assert.Equal(t, http.StatusUnauthorized, rec.Code)
}

func TestJWTAuth_InvalidTokenFormat(t *testing.T) {
    mockJWT := new(MockJWTService)

    handler := middleware.JWTAuth(mockJWT)(testHandler())
    req := httptest.NewRequest("GET", "/", nil)
    req.Header.Set("Authorization", "InvalidFormat token")
    rec := httptest.NewRecorder()

    handler.ServeHTTP(rec, req)

    assert.Equal(t, http.StatusUnauthorized, rec.Code)
}

func TestJWTAuth_ExpiredToken(t *testing.T) {
    mockJWT := new(MockJWTService)

    mockJWT.On("ValidateToken", "expired-token").Return(nil, jwt.ErrExpiredToken)

    handler := middleware.JWTAuth(mockJWT)(testHandler())
    req := httptest.NewRequest("GET", "/", nil)
    req.Header.Set("Authorization", "Bearer expired-token")
    rec := httptest.NewRecorder()

    handler.ServeHTTP(rec, req)

    assert.Equal(t, http.StatusUnauthorized, rec.Code)
    mockJWT.AssertExpectations(t)
}

// Helper function for test handler
func testHandler() http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        w.WriteHeader(http.StatusOK)
        w.Write([]byte("OK"))
    })
}
```

### Example: Testing Workspace Middleware

```go
func TestWorkspaceMiddleware_ValidWorkspaceID(t *testing.T) {
    workspaceID := uuid.New()

    handler := middleware.WorkspaceMiddleware()(testHandler())
    req := httptest.NewRequest("GET", fmt.Sprintf("/workspaces/%s/items", workspaceID), nil)
    req = req.WithContext(context.WithValue(req.Context(), chi.RouteCtxKey, &chi.Context{
        URLParams: chi.RouteParams{
            Keys:   []string{"workspaceID"},
            Values: []string{workspaceID.String()},
        },
    }))
    rec := httptest.NewRecorder()

    handler.ServeHTTP(rec, req)

    assert.Equal(t, http.StatusOK, rec.Code)

    // Verify workspace ID was added to context
    wsID := req.Context().Value(middleware.WorkspaceContextKey)
    assert.Equal(t, workspaceID, wsID)
}

func TestWorkspaceMiddleware_InvalidWorkspaceID(t *testing.T) {
    handler := middleware.WorkspaceMiddleware()(testHandler())
    req := httptest.NewRequest("GET", "/workspaces/invalid-uuid/items", nil)
    req = req.WithContext(context.WithValue(req.Context(), chi.RouteCtxKey, &chi.Context{
        URLParams: chi.RouteParams{
            Keys:   []string{"workspaceID"},
            Values: []string{"invalid-uuid"},
        },
    }))
    rec := httptest.NewRecorder()

    handler.ServeHTTP(rec, req)

    assert.Equal(t, http.StatusBadRequest, rec.Code)
}
```

### Example: Testing ErrorTransformer Middleware

```go
func TestErrorTransformer_NotFoundError(t *testing.T) {
    handler := middleware.ErrorTransformer()(errorHandler(domain.ErrNotFound))
    req := httptest.NewRequest("GET", "/", nil)
    rec := httptest.NewRecorder()

    handler.ServeHTTP(rec, req)

    assert.Equal(t, http.StatusNotFound, rec.Code)
}

func TestErrorTransformer_ValidationError(t *testing.T) {
    handler := middleware.ErrorTransformer()(errorHandler(domain.ErrValidation))
    req := httptest.NewRequest("GET", "/", nil)
    rec := httptest.NewRecorder()

    handler.ServeHTTP(rec, req)

    assert.Equal(t, http.StatusBadRequest, rec.Code)
}

func TestErrorTransformer_UnknownError(t *testing.T) {
    handler := middleware.ErrorTransformer()(errorHandler(errors.New("unknown error")))
    req := httptest.NewRequest("GET", "/", nil)
    rec := httptest.NewRecorder()

    handler.ServeHTTP(rec, req)

    assert.Equal(t, http.StatusInternalServerError, rec.Code)
}

// Helper for error handler
func errorHandler(err error) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        // Simulate handler returning an error
        http.Error(w, err.Error(), http.StatusInternalServerError)
    })
}
```

## Files to Create

- `internal/api/middleware/auth_test.go` (new)
- `internal/api/middleware/workspace_test.go` (new)
- `internal/api/middleware/errors_test.go` (new)

## Estimated Effort

- **Time**: 3-4 hours
- **Tests to add**: 15-20

## Success Criteria

- [ ] All middleware functions have test coverage
- [ ] Both success and error paths are tested
- [ ] Edge cases (malformed input, missing headers) are covered
- [ ] Mock JWT service is used for auth tests
- [ ] All tests pass consistently
- [ ] Coverage for `internal/api/middleware` reaches 95%+

## Running Tests

```bash
# Test middleware package only
go test ./internal/api/middleware -v -cover

# Expected output
ok      github.com/antti/home-warehouse/go-backend/internal/api/middleware    0.015s  coverage: 95.2% of statements
```

## Next Steps

After completing middleware tests, proceed to [1.2 Entity Validation Tests](1.2-entity-validation.md).
