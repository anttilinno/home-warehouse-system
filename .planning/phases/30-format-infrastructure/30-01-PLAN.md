---
phase: 30-format-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/db/migrations/010_format_preferences.sql
  - backend/internal/domain/auth/user/entity.go
  - backend/internal/domain/auth/user/service.go
  - backend/internal/domain/auth/user/handler.go
  - backend/internal/infra/postgres/user_repository.go
autonomous: true

must_haves:
  truths:
    - "Time format preference (12h/24h) is stored in auth.users table with default '24h'"
    - "Number format preferences (thousand_separator, decimal_separator) are stored in auth.users table with defaults ','/'.'"
    - "PATCH /users/me/preferences accepts time_format, thousand_separator, decimal_separator fields"
    - "GET /users/me returns time_format, thousand_separator, decimal_separator in JSON response"
    - "Backend rejects conflicting separator values (thousand_separator == decimal_separator) with 400"
  artifacts:
    - path: "backend/db/migrations/010_format_preferences.sql"
      provides: "Three new columns on auth.users"
      contains: "time_format"
    - path: "backend/internal/domain/auth/user/entity.go"
      provides: "Entity fields, getters, Reconstruct, UpdatePreferences for new prefs"
      contains: "timeFormat"
    - path: "backend/internal/domain/auth/user/handler.go"
      provides: "Updated DTOs and handler wiring for new preference fields"
      contains: "ThousandSeparator"
    - path: "backend/internal/infra/postgres/user_repository.go"
      provides: "Updated SQL queries, scan functions, and Save for new columns"
      contains: "thousand_separator"
  key_links:
    - from: "handler.go updatePreferences"
      to: "service.go UpdatePreferences"
      via: "UpdatePreferencesInput struct"
      pattern: "TimeFormat.*ThousandSeparator.*DecimalSeparator"
    - from: "service.go UpdatePreferences"
      to: "entity.go UpdatePreferences"
      via: "method call with new fields"
      pattern: "user\\.UpdatePreferences"
    - from: "user_repository.go Save"
      to: "entity.go getters"
      via: "u.TimeFormat(), u.ThousandSeparator(), u.DecimalSeparator()"
      pattern: "TimeFormat|ThousandSeparator|DecimalSeparator"
---

<objective>
Add time_format, thousand_separator, and decimal_separator columns to the auth.users table and thread the new fields through every backend layer: entity, service, handler DTOs, and repository.

Purpose: Persist user format preferences so the frontend can read them from the user profile API and format displays accordingly.
Output: Database migration, updated Go entity/service/handler/repository with full round-trip support for three new preference fields.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-format-infrastructure/30-RESEARCH.md

Key source files to read before implementing:
@backend/internal/domain/auth/user/entity.go
@backend/internal/domain/auth/user/handler.go
@backend/internal/domain/auth/user/service.go
@backend/internal/infra/postgres/user_repository.go
@backend/db/migrations/001_initial_schema.sql (for existing column patterns on auth.users)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration and entity layer</name>
  <files>
    backend/db/migrations/010_format_preferences.sql
    backend/internal/domain/auth/user/entity.go
  </files>
  <action>
    1. Create migration `backend/db/migrations/010_format_preferences.sql`:
       - migrate:up: ALTER TABLE auth.users ADD COLUMN time_format VARCHAR(10) NOT NULL DEFAULT '24h', ADD COLUMN thousand_separator VARCHAR(5) NOT NULL DEFAULT ',', ADD COLUMN decimal_separator VARCHAR(5) NOT NULL DEFAULT '.';
       - Add COMMENT ON COLUMN for each (time format: '12h or 24h'; thousand separator: 'comma, period, or space'; decimal separator: 'period or comma')
       - migrate:down: DROP COLUMN time_format, DROP COLUMN thousand_separator, DROP COLUMN decimal_separator

    2. Run the migration: `mise run migrate`

    3. Update entity.go:
       - Add three private fields to User struct: `timeFormat string`, `thousandSeparator string`, `decimalSeparator string`
       - Add defaults in NewUser: timeFormat: "24h", thousandSeparator: ",", decimalSeparator: "."
       - Add to Reconstruct function signature (3 new string params after theme, before avatarPath) and assignment
       - Add three getter methods: TimeFormat(), ThousandSeparator(), DecimalSeparator()
       - Extend UpdatePreferences method signature from (dateFormat, language, theme string) to (dateFormat, language, theme, timeFormat, thousandSeparator, decimalSeparator string). Add the same `if value != "" { u.field = value }` guards for each new field.
       - Add separator conflict validation in UpdatePreferences: if both thousandSeparator and decimalSeparator are non-empty AND equal, return an error (change return type from void to error). Update all callers accordingly in service.go.
  </action>
  <verify>
    - `mise run migrate` succeeds
    - `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go build ./...` compiles (will have errors until Task 2 updates repository/handler)
  </verify>
  <done>
    Migration creates 3 new columns on auth.users with correct defaults. Entity has fields, getters, Reconstruct params, and UpdatePreferences accepts all 6 preference fields with separator conflict validation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Service, handler DTOs, and repository</name>
  <files>
    backend/internal/domain/auth/user/service.go
    backend/internal/domain/auth/user/handler.go
    backend/internal/infra/postgres/user_repository.go
  </files>
  <action>
    1. Update service.go:
       - Add TimeFormat, ThousandSeparator, DecimalSeparator fields to UpdatePreferencesInput struct
       - Update the UpdatePreferences method to pass all 6 fields to user.UpdatePreferences() and handle the new error return value

    2. Update handler.go:
       - Add TimeFormat, ThousandSeparator, DecimalSeparator to UserResponse struct with json tags "time_format", "thousand_separator", "decimal_separator"
       - Add TimeFormat, ThousandSeparator, DecimalSeparator to UserAdminResponse struct with same json tags
       - Add TimeFormat, ThousandSeparator, DecimalSeparator to UpdatePrefsRequestBody with json tags and omitempty
       - Update ALL places that construct UserResponse to include: TimeFormat: user.TimeFormat(), ThousandSeparator: user.ThousandSeparator(), DecimalSeparator: user.DecimalSeparator(). These locations are:
         - getMe handler
         - updateMe handler
         - updatePreferences handler
         - The legacy RegisterProtectedRoutes functions (getMe, updateMe, updatePreferences)
       - Update ALL places that construct UserAdminResponse to include the three new fields:
         - listUsers handler
         - getUserByID handler
       - Update updatePreferences handler to pass new fields from request body to UpdatePreferencesInput
       - Update the uploadAvatar handler's JSON response (the manual Fprintf) to include the three new fields

    3. Update user_repository.go:
       - In Save(): Add time_format, thousand_separator, decimal_separator to INSERT column list, VALUES placeholders, ON CONFLICT UPDATE list, and Exec args (using u.TimeFormat(), u.ThousandSeparator(), u.DecimalSeparator())
       - In ALL SELECT queries (FindByID, FindByEmail, List, UpdateAvatar RETURNING, UpdateEmail RETURNING): Add time_format, thousand_separator, decimal_separator columns after theme
       - In scanUser() and scanUserFromRows(): Add three new scan variables (timeFormat, thousandSeparator, decimalSeparator string), add to Scan() args, and pass to Reconstruct()
       - The scan order must match the SELECT column order exactly

    4. Verify the full backend compiles: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go build ./...`
    5. Run tests: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./... -short -count=1 2>&1 | tail -30`
  </action>
  <verify>
    - `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go build ./...` succeeds with zero errors
    - `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/auth/user/... -short -count=1` passes
    - Grep all UserResponse constructions to confirm none are missing the new fields
  </verify>
  <done>
    All backend layers thread time_format, thousand_separator, decimal_separator end-to-end. GET /users/me returns the new fields. PATCH /users/me/preferences accepts them. Save and scan functions include them. Backend compiles and tests pass.
  </done>
</task>

</tasks>

<verification>
1. Backend compiles: `cd backend && go build ./...`
2. Migration applied: Check table columns exist via `psql` or migration status
3. Full round-trip: Start backend, PATCH /users/me/preferences with {"time_format": "12h"}, GET /users/me returns time_format: "12h"
4. Separator conflict: PATCH with {"thousand_separator": ".", "decimal_separator": "."} returns 400
5. Default values: New user has time_format=24h, thousand_separator=",", decimal_separator="."
</verification>

<success_criteria>
- Database has three new columns on auth.users with correct types and defaults
- Backend compiles with zero errors
- All existing tests pass
- UserResponse JSON includes time_format, thousand_separator, decimal_separator
- UpdatePreferences accepts and persists the three new fields
- Conflicting separators are rejected with 400
</success_criteria>

<output>
After completion, create `.planning/phases/30-format-infrastructure/30-01-SUMMARY.md`
</output>
