---
phase: 21-mobile-form-improvements
plan: 03
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - frontend/components/forms/multi-step-form.tsx
  - frontend/components/forms/form-step.tsx
  - frontend/components/forms/step-indicator.tsx
  - frontend/components/forms/index.ts
autonomous: true

must_haves:
  truths:
    - "Multi-step form preserves values when navigating between steps"
    - "Step indicator shows current position and progress"
    - "Form validation runs per-step before allowing navigation"
    - "Draft changes are persisted on every step change"
  artifacts:
    - path: "frontend/components/forms/multi-step-form.tsx"
      provides: "Wizard container with FormProvider"
      exports: ["MultiStepForm"]
    - path: "frontend/components/forms/form-step.tsx"
      provides: "Step wrapper with navigation"
      exports: ["FormStep"]
    - path: "frontend/components/forms/step-indicator.tsx"
      provides: "Progress indicator"
      exports: ["StepIndicator"]
  key_links:
    - from: "frontend/components/forms/multi-step-form.tsx"
      to: "react-hook-form"
      via: "FormProvider"
      pattern: "FormProvider"
    - from: "frontend/components/forms/multi-step-form.tsx"
      to: "frontend/lib/hooks/use-form-draft.ts"
      via: "draft persistence"
      pattern: "useFormDraft"
---

<objective>
Create multi-step form wizard infrastructure with FormProvider context sharing, step navigation, and progress indicator.

Purpose: Enable complex forms like Create Item to be split into digestible steps (Basic -> Details -> Photos) while preserving values across steps. Integrates with useFormDraft for persistence.

Output: MultiStepForm container, FormStep wrapper, and StepIndicator components.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-mobile-form-improvements/21-RESEARCH.md
@.planning/phases/21-mobile-form-improvements/21-01-SUMMARY.md

@frontend/lib/hooks/use-form-draft.ts
@frontend/components/ui/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StepIndicator component</name>
  <files>frontend/components/forms/step-indicator.tsx</files>
  <action>
Create step-indicator.tsx for showing progress:

```typescript
"use client";

import { Check } from "lucide-react";
import { cn } from "@/lib/utils";

export interface Step {
  id: string;
  title: string;
}

interface StepIndicatorProps {
  steps: Step[];
  currentStep: number;
  onStepClick?: (index: number) => void;
  /** Allow clicking to navigate to completed steps */
  allowNavigation?: boolean;
  className?: string;
}

export function StepIndicator({
  steps,
  currentStep,
  onStepClick,
  allowNavigation = false,
  className,
}: StepIndicatorProps) {
  return (
    <nav aria-label="Progress" className={className}>
      <ol className="flex items-center gap-2" role="list">
        {steps.map((step, index) => {
          const isCompleted = index < currentStep;
          const isCurrent = index === currentStep;
          const isClickable = allowNavigation && isCompleted && onStepClick;

          return (
            <li key={step.id} className="flex items-center">
              {index > 0 && (
                <div
                  className={cn(
                    "h-0.5 w-6 sm:w-10 mx-1",
                    isCompleted ? "bg-primary" : "bg-muted"
                  )}
                  aria-hidden="true"
                />
              )}

              <button
                type="button"
                className={cn(
                  "flex items-center gap-2 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 rounded-md",
                  "min-h-[44px] min-w-[44px] touch-manipulation",
                  isClickable ? "cursor-pointer" : "cursor-default"
                )}
                onClick={() => isClickable && onStepClick(index)}
                disabled={!isClickable}
                aria-current={isCurrent ? "step" : undefined}
              >
                {/* Step number/check circle */}
                <span
                  className={cn(
                    "flex h-8 w-8 items-center justify-center rounded-full text-sm font-medium shrink-0",
                    isCurrent && "bg-primary text-primary-foreground",
                    isCompleted && "bg-primary/20 text-primary",
                    !isCurrent && !isCompleted && "bg-muted text-muted-foreground"
                  )}
                >
                  {isCompleted ? (
                    <Check className="h-4 w-4" aria-hidden="true" />
                  ) : (
                    index + 1
                  )}
                </span>

                {/* Step title - hidden on very small screens */}
                <span
                  className={cn(
                    "text-sm hidden sm:inline",
                    isCurrent && "font-medium text-foreground",
                    isCompleted && "text-primary",
                    !isCurrent && !isCompleted && "text-muted-foreground"
                  )}
                >
                  {step.title}
                </span>
              </button>
            </li>
          );
        })}
      </ol>
    </nav>
  );
}
```

Key features:
- Check mark for completed steps
- Current step highlighted with primary color
- 44px touch targets on each step button
- Optional click navigation to completed steps
- Responsive (hides titles on mobile, shows numbers)
- aria-current="step" for accessibility
  </action>
  <verify>TypeScript compilation passes</verify>
  <done>StepIndicator shows progress with check marks and allows optional navigation</done>
</task>

<task type="auto">
  <name>Task 2: Create MultiStepForm container</name>
  <files>frontend/components/forms/multi-step-form.tsx</files>
  <action>
Create multi-step-form.tsx following research patterns:

```typescript
"use client";

import { useState, useEffect, useCallback, useRef } from "react";
import {
  useForm,
  FormProvider,
  type UseFormProps,
  type FieldValues,
  type DefaultValues,
} from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import type { z } from "zod";
import { v7 as uuidv7 } from "uuid";

import { useFormDraft } from "@/lib/hooks/use-form-draft";
import { StepIndicator, type Step } from "./step-indicator";
import { Skeleton } from "@/components/ui/skeleton";

interface MultiStepFormProps<TSchema extends z.ZodType> {
  /** Zod schema for the entire form */
  schema: TSchema;
  /** Default values for the form */
  defaultValues: DefaultValues<z.infer<TSchema>>;
  /** Array of step definitions */
  steps: Step[];
  /** Render function for step content */
  children: (props: {
    currentStep: number;
    goNext: () => Promise<boolean>;
    goBack: () => void;
    isFirstStep: boolean;
    isLastStep: boolean;
    isSubmitting: boolean;
  }) => React.ReactNode;
  /** Called when form is submitted on last step */
  onSubmit: (data: z.infer<TSchema>) => Promise<void>;
  /** Called when user cancels */
  onCancel?: () => void;
  /** Form type identifier for draft persistence */
  formType: string;
  /** Optional draft ID (auto-generated if not provided) */
  draftId?: string;
  /** Fields to validate on each step (array of arrays) */
  stepFields?: (keyof z.infer<TSchema>)[][];
  /** Additional classes */
  className?: string;
}

export function MultiStepForm<TSchema extends z.ZodType>({
  schema,
  defaultValues,
  steps,
  children,
  onSubmit,
  onCancel,
  formType,
  draftId: externalDraftId,
  stepFields,
  className,
}: MultiStepFormProps<TSchema>) {
  type FormData = z.infer<TSchema>;

  const [currentStep, setCurrentStep] = useState(0);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [draftLoaded, setDraftLoaded] = useState(false);

  // Generate or use provided draft ID
  const draftIdRef = useRef(externalDraftId || uuidv7());
  const { loadDraft, saveDraft, clearDraft } = useFormDraft<FormData>(
    formType,
    draftIdRef.current
  );

  // Initialize form with shouldUnregister: false to preserve values across steps
  const methods = useForm<FormData>({
    resolver: zodResolver(schema),
    defaultValues,
    mode: "onChange",
    shouldUnregister: false, // CRITICAL: Preserve values when steps unmount
  } as UseFormProps<FormData>);

  const { reset, watch, handleSubmit, trigger } = methods;

  // Load draft on mount
  useEffect(() => {
    let mounted = true;

    async function load() {
      const draft = await loadDraft();
      if (mounted && draft) {
        reset({ ...defaultValues, ...draft } as DefaultValues<FormData>);
      }
      if (mounted) {
        setDraftLoaded(true);
      }
    }

    load();

    return () => {
      mounted = false;
    };
  }, [loadDraft, reset, defaultValues]);

  // Auto-save draft on value changes (after initial load)
  useEffect(() => {
    if (!draftLoaded) return;

    const subscription = watch((data) => {
      saveDraft(data as Partial<FormData>);
    });

    return () => subscription.unsubscribe();
  }, [watch, saveDraft, draftLoaded]);

  // Navigate to next step (validates current step first)
  const goNext = useCallback(async (): Promise<boolean> => {
    // Validate current step's fields if specified
    if (stepFields && stepFields[currentStep]) {
      const fields = stepFields[currentStep] as string[];
      const isValid = await trigger(fields as any);
      if (!isValid) {
        return false;
      }
    }

    if (currentStep < steps.length - 1) {
      setCurrentStep((prev) => prev + 1);
      return true;
    }

    return false;
  }, [currentStep, steps.length, stepFields, trigger]);

  // Navigate to previous step
  const goBack = useCallback(() => {
    if (currentStep > 0) {
      setCurrentStep((prev) => prev - 1);
    } else {
      onCancel?.();
    }
  }, [currentStep, onCancel]);

  // Handle final form submission
  const onFormSubmit = async (data: FormData) => {
    setIsSubmitting(true);
    try {
      await onSubmit(data);
      await clearDraft();
    } finally {
      setIsSubmitting(false);
    }
  };

  // Handle step click in indicator
  const handleStepClick = useCallback((index: number) => {
    // Only allow going to previous steps
    if (index < currentStep) {
      setCurrentStep(index);
    }
  }, [currentStep]);

  // Show skeleton while loading draft
  if (!draftLoaded) {
    return (
      <div className={className}>
        <div className="space-y-4">
          <Skeleton className="h-10 w-full" />
          <Skeleton className="h-32 w-full" />
          <Skeleton className="h-10 w-full" />
        </div>
      </div>
    );
  }

  const isFirstStep = currentStep === 0;
  const isLastStep = currentStep === steps.length - 1;

  return (
    <FormProvider {...methods}>
      <form
        onSubmit={handleSubmit(onFormSubmit)}
        className={className}
      >
        {/* Step indicator */}
        <StepIndicator
          steps={steps}
          currentStep={currentStep}
          onStepClick={handleStepClick}
          allowNavigation
          className="mb-6"
        />

        {/* Step content */}
        {children({
          currentStep,
          goNext,
          goBack,
          isFirstStep,
          isLastStep,
          isSubmitting,
        })}
      </form>
    </FormProvider>
  );
}
```

Key features:
- FormProvider shares state across all steps
- shouldUnregister: false preserves values when components unmount
- Draft auto-saves on every change (debounced in hook)
- Per-step validation via stepFields array
- goNext returns boolean for validation feedback
- Shows skeleton while loading draft
  </action>
  <verify>TypeScript compilation passes with generics</verify>
  <done>MultiStepForm preserves values across steps and auto-saves drafts</done>
</task>

<task type="auto">
  <name>Task 3: Update barrel export</name>
  <files>frontend/components/forms/index.ts</files>
  <action>
Update index.ts to export new components:

```typescript
export { CollapsibleSection } from "./collapsible-section";
export { MobileFormField } from "./mobile-form-field";
export { MobileFormTextarea } from "./mobile-form-textarea";
export { MultiStepForm } from "./multi-step-form";
export { StepIndicator, type Step } from "./step-indicator";
```

Verify all imports resolve correctly.
  </action>
  <verify>
    - `cd frontend && bun run build` succeeds
    - All exports are accessible
  </verify>
  <done>Barrel export includes MultiStepForm and StepIndicator</done>
</task>

</tasks>

<verification>
1. `cd frontend && bun run build` completes without errors
2. `cd frontend && bun run lint` passes
3. All files exist:
   - frontend/components/forms/multi-step-form.tsx
   - frontend/components/forms/step-indicator.tsx
4. MultiStepForm uses:
   - FormProvider from react-hook-form
   - shouldUnregister: false
   - useFormDraft for persistence
5. StepIndicator has 44px touch targets
</verification>

<success_criteria>
- MultiStepForm wraps children with FormProvider context
- Values are preserved when navigating between steps
- Per-step validation prevents proceeding with invalid data
- Draft changes auto-save on every step
- StepIndicator shows completed steps with checkmarks
- Navigation to completed steps is allowed
</success_criteria>

<output>
After completion, create `.planning/phases/21-mobile-form-improvements/21-03-SUMMARY.md`
</output>
