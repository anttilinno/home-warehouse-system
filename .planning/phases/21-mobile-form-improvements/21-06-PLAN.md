---
phase: 21-mobile-form-improvements
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/components/items/create-item-wizard/basic-step.tsx
  - frontend/components/items/create-item-wizard/details-step.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Category field pre-fills with most recent selection on mount"
    - "User selects category and choice is recorded for future defaults"
    - "Brand/manufacturer fields pre-fill with recent values"
  artifacts:
    - path: "frontend/components/items/create-item-wizard/basic-step.tsx"
      provides: "Category select with smart defaults integration"
      contains: "useSmartDefaults"
    - path: "frontend/components/items/create-item-wizard/details-step.tsx"
      provides: "Brand/manufacturer with smart defaults"
      contains: "useSmartDefaults"
  key_links:
    - from: "basic-step.tsx"
      to: "use-smart-defaults.ts"
      via: "import and hook call"
      pattern: "useSmartDefaults\\('item-category'\\)"
    - from: "details-step.tsx"
      to: "use-smart-defaults.ts"
      via: "import and hook calls"
      pattern: "useSmartDefaults\\('item-brand'\\)"
---

<objective>
Integrate the orphaned useSmartDefaults hook into the Create Item wizard

Purpose: Close the verification gap - the hook was created but never wired into the wizard, so users cannot benefit from auto-filled fields based on recent activity.

Output: Category, brand, and manufacturer fields pre-fill with user's recent selections
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/21-mobile-form-improvements/21-VERIFICATION.md
@frontend/lib/hooks/use-smart-defaults.ts
@frontend/components/items/create-item-wizard/basic-step.tsx
@frontend/components/items/create-item-wizard/details-step.tsx
@frontend/components/items/create-item-wizard/schema.ts
@frontend/lib/api/categories.ts
@frontend/components/ui/select.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add category select with smart defaults to basic-step.tsx</name>
  <files>frontend/components/items/create-item-wizard/basic-step.tsx</files>
  <action>
1. Import useSmartDefaults from "@/lib/hooks/use-smart-defaults"
2. Import useWorkspace from "@/lib/hooks/use-workspace" for workspace ID
3. Import categoriesApi from "@/lib/api/categories"
4. Import Select, SelectContent, SelectItem, SelectTrigger, SelectValue from "@/components/ui/select"
5. Import useFormContext from "react-hook-form"
6. Import useState, useEffect from "react"

7. Inside BasicStep, call:
   - const { workspace } = useWorkspace()
   - const { getDefault, recordSelection } = useSmartDefaults("item-category")
   - const { setValue, watch } = useFormContext<CreateItemFormData>()
   - const [categories, setCategories] = useState<Category[]>([])
   - const categoryId = watch("category_id")

8. Add useEffect to fetch categories on mount:
   ```
   useEffect(() => {
     if (workspace?.id) {
       categoriesApi.list(workspace.id).then(setCategories).catch(console.error)
     }
   }, [workspace?.id])
   ```

9. Add useEffect to pre-fill from smart defaults on mount:
   ```
   useEffect(() => {
     const defaultCat = getDefault()
     if (defaultCat && !categoryId) {
       setValue("category_id", defaultCat)
     }
   }, [getDefault, setValue, categoryId])
   ```

10. Replace the TODO comment with a category Select field:
    - Use Label + Select pattern with min-h-[44px] on SelectTrigger
    - On value change: setValue("category_id", value) and recordSelection(value, categoryLabel)
    - Show placeholder "Select category..." when no selection
    - Map categories to SelectItem components

11. Add translations for category field if missing (check messages files)
  </action>
  <verify>
    - `grep -n "useSmartDefaults" frontend/components/items/create-item-wizard/basic-step.tsx` shows import and usage
    - `grep -n "category_id" frontend/components/items/create-item-wizard/basic-step.tsx` shows Select field
    - No TODO comment remains in the file
  </verify>
  <done>
    - Category select field visible in Step 1 of wizard
    - Field pre-fills with last selected category on mount
    - Selection is recorded when user chooses a category
  </done>
</task>

<task type="auto">
  <name>Task 2: Add smart defaults to brand/manufacturer in details-step.tsx</name>
  <files>frontend/components/items/create-item-wizard/details-step.tsx</files>
  <action>
1. Import useSmartDefaults from "@/lib/hooks/use-smart-defaults"
2. Import useEffect from "react"

3. Inside DetailsStep, add three smart defaults hooks:
   - const brandDefaults = useSmartDefaults("item-brand")
   - const manufacturerDefaults = useSmartDefaults("item-manufacturer")
   - const purchasedFromDefaults = useSmartDefaults("item-purchased-from")

4. Add watch for these fields:
   - const brand = watch("brand")
   - const manufacturer = watch("manufacturer")
   - const purchasedFrom = watch("purchased_from")

5. Add useEffect to pre-fill from smart defaults on mount (only if field is empty):
   ```
   useEffect(() => {
     const defaultBrand = brandDefaults.getDefault()
     if (defaultBrand && !brand) {
       setValue("brand", defaultBrand)
     }
     const defaultManufacturer = manufacturerDefaults.getDefault()
     if (defaultManufacturer && !manufacturer) {
       setValue("manufacturer", defaultManufacturer)
     }
     const defaultPurchasedFrom = purchasedFromDefaults.getDefault()
     if (defaultPurchasedFrom && !purchasedFrom) {
       setValue("purchased_from", defaultPurchasedFrom)
     }
   }, [])  // Only on mount
   ```

6. Add onBlur handlers to the MobileFormField components to record selections:
   - For brand field: onBlur={(e) => e.target.value && brandDefaults.recordSelection(e.target.value)}
   - For manufacturer field: onBlur={(e) => e.target.value && manufacturerDefaults.recordSelection(e.target.value)}
   - For purchased_from field: onBlur={(e) => e.target.value && purchasedFromDefaults.recordSelection(e.target.value)}

Note: MobileFormField accepts standard input props including onBlur. Verify this by checking the component signature - it spreads props to the Input element.
  </action>
  <verify>
    - `grep -n "useSmartDefaults" frontend/components/items/create-item-wizard/details-step.tsx` shows 3 hook usages
    - `grep -n "recordSelection" frontend/components/items/create-item-wizard/details-step.tsx` shows onBlur handlers
    - `grep -n "getDefault" frontend/components/items/create-item-wizard/details-step.tsx` shows pre-fill logic
  </verify>
  <done>
    - Brand, manufacturer, purchased_from fields pre-fill with recent values
    - When user enters values and blurs, selections are recorded
    - Returning to wizard shows previously used values as defaults
  </done>
</task>

</tasks>

<verification>
1. Open Create Item wizard at /dashboard/items/new
2. Select a category and fill brand/manufacturer
3. Submit or cancel the form
4. Open wizard again - category, brand, manufacturer should pre-fill
5. Check localStorage for keys: hws-smart-defaults-item-category, hws-smart-defaults-item-brand, etc.
</verification>

<success_criteria>
- useSmartDefaults hook imported and used in both step components
- Category select field exists with smart defaults integration
- Brand/manufacturer/purchased_from fields record and restore recent values
- TODO comment removed from basic-step.tsx
- Verification gap "Smart defaults pre-fill category/location from recent selections" is now PASSED
</success_criteria>

<output>
After completion, create `.planning/phases/21-mobile-form-improvements/21-06-SUMMARY.md`
</output>
