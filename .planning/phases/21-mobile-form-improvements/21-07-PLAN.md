---
phase: 21-mobile-form-improvements
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/components/forms/multi-step-form.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "On iOS with keyboard open, form navigation buttons remain visible above keyboard"
    - "When keyboard closes, buttons return to normal bottom position"
    - "Non-iOS devices unaffected (hook returns static style)"
  artifacts:
    - path: "frontend/components/forms/multi-step-form.tsx"
      provides: "iOS keyboard-aware form navigation"
      contains: "useIOSKeyboard"
  key_links:
    - from: "multi-step-form.tsx"
      to: "use-ios-keyboard.ts"
      via: "import and hook call"
      pattern: "useIOSKeyboard\\(\\)"
    - from: "multi-step-form.tsx"
      to: "getFixedBottomStyle"
      via: "style application"
      pattern: "getFixedBottomStyle\\(\\)"
---

<objective>
Integrate the orphaned useIOSKeyboard hook into the MultiStepForm component

Purpose: Close the verification gap - the hook was created to detect iOS keyboard visibility and provide positioning styles, but it's never used. On iOS, the keyboard may hide navigation buttons, requiring users to dismiss the keyboard to proceed.

Output: Form navigation buttons stay visible above the iOS keyboard when input is focused
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/21-mobile-form-improvements/21-VERIFICATION.md
@frontend/lib/hooks/use-ios-keyboard.ts
@frontend/components/forms/multi-step-form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate iOS keyboard detection into MultiStepForm</name>
  <files>frontend/components/forms/multi-step-form.tsx</files>
  <action>
1. Import useIOSKeyboard from "@/lib/hooks/use-ios-keyboard"

2. Inside MultiStepForm component, call the hook:
   ```
   const { isKeyboardOpen, getFixedBottomStyle } = useIOSKeyboard()
   ```

3. The current form structure renders step content via children(). The navigation buttons are INSIDE each step component (BasicStep, DetailsStep, PhotosStep), not in MultiStepForm itself.

   **Option A (Recommended):** Pass keyboard context to children so step components can use it.

   Update the children render props to include:
   ```
   children({
     currentStep,
     goNext,
     goBack,
     isFirstStep,
     isLastStep,
     isSubmitting,
     keyboardStyle: getFixedBottomStyle(),  // NEW
     isKeyboardOpen,  // NEW
   })
   ```

   Update the MultiStepFormProps interface to add these to the children props type:
   ```
   children: (props: {
     currentStep: number;
     goNext: () => Promise<boolean>;
     goBack: () => void;
     isFirstStep: boolean;
     isLastStep: boolean;
     isSubmitting: boolean;
     keyboardStyle: React.CSSProperties;  // NEW
     isKeyboardOpen: boolean;  // NEW
   }) => React.ReactNode;
   ```

4. This approach allows step components to optionally apply the keyboard style to their navigation buttons:
   ```
   // In step components (optional usage):
   <div style={keyboardStyle} className="flex justify-between pt-4 border-t">
   ```

5. For immediate effect without modifying all step components, add a wrapper inside the form element:
   - Wrap the children() call in a div that applies keyboard offset to the bottom padding:
   ```
   <div style={{ paddingBottom: isKeyboardOpen ? keyboardStyle.bottom : undefined }}>
     {children({ ... })}
   </div>
   ```

   This ensures content scrolls up when keyboard opens, keeping navigation visible.

**Alternative simpler approach:** Just add keyboard context to children props. The step components already have the buttons - they can use the style if needed. This keeps MultiStepForm as a pass-through for keyboard info.
  </action>
  <verify>
    - `grep -n "useIOSKeyboard" frontend/components/forms/multi-step-form.tsx` shows import and usage
    - `grep -n "keyboardStyle\|isKeyboardOpen" frontend/components/forms/multi-step-form.tsx` shows props added
    - TypeScript compiles without errors: `cd frontend && npx tsc --noEmit`
  </verify>
  <done>
    - useIOSKeyboard imported and called in MultiStepForm
    - Keyboard context passed to children render props
    - Step components can access keyboardStyle for iOS keyboard handling
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply keyboard style to step navigation buttons</name>
  <files>
    frontend/components/items/create-item-wizard/basic-step.tsx
    frontend/components/items/create-item-wizard/details-step.tsx
    frontend/components/items/create-item-wizard/photos-step.tsx
  </files>
  <action>
1. Update BasicStepProps interface to accept keyboardStyle and isKeyboardOpen:
   ```
   interface BasicStepProps {
     onNext: () => Promise<boolean>;
     isSubmitting: boolean;
     keyboardStyle?: React.CSSProperties;
     isKeyboardOpen?: boolean;
   }
   ```

2. Update the navigation div to apply the keyboard style when keyboard is open:
   ```
   <div
     className={cn(
       "flex justify-end pt-4 border-t",
       isKeyboardOpen && "fixed left-0 right-0 bg-background px-4 pb-4 shadow-lg"
     )}
     style={isKeyboardOpen ? keyboardStyle : undefined}
   >
   ```

3. Import cn from "@/lib/utils" if not already imported

4. Repeat for DetailsStep and PhotosStep (update props interface and navigation div)

5. Update the wizard index.tsx to pass keyboardStyle to each step:
   ```
   {currentStep === 0 && (
     <BasicStep
       onNext={goNext}
       isSubmitting={isSubmitting}
       keyboardStyle={keyboardStyle}
       isKeyboardOpen={isKeyboardOpen}
     />
   )}
   ```

Note: The PhotosStep uses `type="submit"` button, so handle it the same way.
  </action>
  <verify>
    - `grep -n "keyboardStyle" frontend/components/items/create-item-wizard/*.tsx` shows usage in all 3 steps
    - `grep -n "isKeyboardOpen" frontend/components/items/create-item-wizard/index.tsx` shows prop passing
    - Build completes: `cd frontend && bun run build` (or at least typecheck passes)
  </verify>
  <done>
    - All step components accept and use keyboardStyle prop
    - Navigation buttons use fixed positioning when iOS keyboard is open
    - Buttons stay visible above keyboard during form input
  </done>
</task>

</tasks>

<verification>
1. On iOS device in Safari or PWA standalone mode:
   - Open /dashboard/items/new
   - Tap SKU field to open keyboard
   - Observe: "Next" button should remain visible above keyboard
   - Tap brand field in Step 2 - same behavior
2. On Android/Desktop:
   - Form should behave normally (no fixed positioning)
3. Check that keyboard close returns buttons to normal position
</verification>

<success_criteria>
- useIOSKeyboard hook imported and used in MultiStepForm
- Keyboard context passed to step components via render props
- Step navigation buttons apply fixed positioning on iOS keyboard open
- Verification gap "Form handles iOS keyboard correctly with Visual Viewport API" is now PASSED
</success_criteria>

<output>
After completion, create `.planning/phases/21-mobile-form-improvements/21-07-SUMMARY.md`
</output>
