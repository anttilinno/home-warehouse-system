---
phase: 21-mobile-form-improvements
plan: 05
type: execute
wave: 3
depends_on: ["21-02", "21-03", "21-04"]
files_modified:
  - frontend/components/items/create-item-wizard/index.tsx
  - frontend/components/items/create-item-wizard/basic-step.tsx
  - frontend/components/items/create-item-wizard/details-step.tsx
  - frontend/components/items/create-item-wizard/photos-step.tsx
  - frontend/components/items/create-item-wizard/schema.ts
  - frontend/app/[locale]/(dashboard)/dashboard/items/new/page.tsx
autonomous: true

must_haves:
  truths:
    - "Create Item form shows as multi-step wizard"
    - "Basic info is on step 1, details on step 2, photos on step 3"
    - "Advanced fields are in collapsible sections"
    - "Form drafts are recovered on return"
    - "Smart defaults pre-fill category/location from recent selections"
  artifacts:
    - path: "frontend/components/items/create-item-wizard/index.tsx"
      provides: "Wizard entry point"
      exports: ["CreateItemWizard"]
    - path: "frontend/components/items/create-item-wizard/schema.ts"
      provides: "Zod validation schema"
      exports: ["createItemSchema"]
    - path: "frontend/app/[locale]/(dashboard)/dashboard/items/new/page.tsx"
      provides: "New item page route"
  key_links:
    - from: "frontend/components/items/create-item-wizard/index.tsx"
      to: "frontend/components/forms/multi-step-form.tsx"
      via: "MultiStepForm wrapper"
      pattern: "import.*MultiStepForm"
    - from: "frontend/components/items/create-item-wizard/basic-step.tsx"
      to: "frontend/components/forms/mobile-form-field.tsx"
      via: "MobileFormField inputs"
      pattern: "MobileFormField"
---

<objective>
Create a mobile-optimized Create Item wizard using the multi-step form infrastructure.

Purpose: Demonstrates all Phase 21 components working together. Implements FORM-01 through FORM-08 requirements in a real use case. Provides a template for other form improvements.

Output: CreateItemWizard component with 3 steps (Basic, Details, Photos), progressive disclosure sections, and a new /dashboard/items/new route.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-mobile-form-improvements/21-RESEARCH.md
@.planning/phases/21-mobile-form-improvements/21-02-SUMMARY.md
@.planning/phases/21-mobile-form-improvements/21-03-SUMMARY.md
@.planning/phases/21-mobile-form-improvements/21-04-SUMMARY.md

@frontend/lib/types/items.ts
@frontend/components/forms/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create schema and basic step</name>
  <files>
    frontend/components/items/create-item-wizard/schema.ts
    frontend/components/items/create-item-wizard/basic-step.tsx
  </files>
  <action>
1. Create schema.ts with Zod validation:

```typescript
import { z } from "zod";

export const createItemSchema = z.object({
  // Step 1: Basic (required)
  sku: z.string().min(1, "SKU is required"),
  name: z.string().min(1, "Name is required"),
  category_id: z.string().optional(),
  description: z.string().optional(),

  // Step 2: Details
  brand: z.string().optional(),
  model: z.string().optional(),
  manufacturer: z.string().optional(),
  serial_number: z.string().optional(),
  barcode: z.string().optional(),
  purchased_from: z.string().optional(),

  // Step 2: Inventory (in collapsible)
  min_stock_level: z.coerce.number().min(0).default(0),

  // Step 2: Advanced (in collapsible)
  is_insured: z.boolean().default(false),
  lifetime_warranty: z.boolean().default(false),
  warranty_details: z.string().optional(),
  short_code: z.string().optional(),
});

export type CreateItemFormData = z.infer<typeof createItemSchema>;

// Default values matching schema
export const createItemDefaults: CreateItemFormData = {
  sku: "",
  name: "",
  category_id: undefined,
  description: "",
  brand: "",
  model: "",
  manufacturer: "",
  serial_number: "",
  barcode: "",
  purchased_from: "",
  min_stock_level: 0,
  is_insured: false,
  lifetime_warranty: false,
  warranty_details: "",
  short_code: "",
};

// Fields validated on each step
export const stepFields: (keyof CreateItemFormData)[][] = [
  ["sku", "name"], // Step 1: Basic
  [], // Step 2: Details (all optional)
  [], // Step 3: Photos (handled separately)
];
```

2. Create basic-step.tsx for Step 1:

```typescript
"use client";

import { useFormContext } from "react-hook-form";
import { useTranslations } from "next-intl";

import { MobileFormField, MobileFormTextarea } from "@/components/forms";
import { Button } from "@/components/ui/button";
import type { CreateItemFormData } from "./schema";

interface BasicStepProps {
  onNext: () => Promise<boolean>;
  isSubmitting: boolean;
}

export function BasicStep({ onNext, isSubmitting }: BasicStepProps) {
  const t = useTranslations("items.create");
  const { formState: { errors } } = useFormContext<CreateItemFormData>();

  const handleNext = async () => {
    const valid = await onNext();
    if (!valid) {
      // Validation failed, errors will be shown by fields
    }
  };

  return (
    <div className="space-y-6">
      <div className="space-y-1">
        <h2 className="text-lg font-semibold">{t("steps.basic")}</h2>
        <p className="text-sm text-muted-foreground">
          {t("steps.basicDescription")}
        </p>
      </div>

      <div className="space-y-4">
        {/* SKU - required */}
        <MobileFormField<CreateItemFormData>
          name="sku"
          label={t("fields.sku")}
          required
          placeholder={t("placeholders.sku")}
          autoComplete="off"
        />

        {/* Name - required */}
        <MobileFormField<CreateItemFormData>
          name="name"
          label={t("fields.name")}
          required
          placeholder={t("placeholders.name")}
        />

        {/* Category - optional, will add select later */}
        {/* TODO: Add category select with smart defaults */}

        {/* Description - optional */}
        <MobileFormTextarea<CreateItemFormData>
          name="description"
          label={t("fields.description")}
          placeholder={t("placeholders.description")}
          rows={3}
        />
      </div>

      {/* Navigation */}
      <div className="flex justify-end pt-4 border-t">
        <Button
          type="button"
          onClick={handleNext}
          disabled={isSubmitting}
          className="min-h-[44px] min-w-[120px]"
        >
          {t("next")}
        </Button>
      </div>
    </div>
  );
}
```
  </action>
  <verify>TypeScript compilation passes</verify>
  <done>Schema and BasicStep created with SKU/name required validation</done>
</task>

<task type="auto">
  <name>Task 2: Create details step with collapsible sections</name>
  <files>frontend/components/items/create-item-wizard/details-step.tsx</files>
  <action>
Create details-step.tsx for Step 2 with progressive disclosure:

```typescript
"use client";

import { useFormContext } from "react-hook-form";
import { useTranslations } from "next-intl";

import {
  MobileFormField,
  MobileFormTextarea,
  CollapsibleSection,
} from "@/components/forms";
import { Button } from "@/components/ui/button";
import { Checkbox } from "@/components/ui/checkbox";
import { Label } from "@/components/ui/label";
import type { CreateItemFormData } from "./schema";

interface DetailsStepProps {
  onNext: () => Promise<boolean>;
  onBack: () => void;
  isSubmitting: boolean;
}

export function DetailsStep({ onNext, onBack, isSubmitting }: DetailsStepProps) {
  const t = useTranslations("items.create");
  const { register, watch, setValue } = useFormContext<CreateItemFormData>();

  const isInsured = watch("is_insured");
  const lifetimeWarranty = watch("lifetime_warranty");

  return (
    <div className="space-y-6">
      <div className="space-y-1">
        <h2 className="text-lg font-semibold">{t("steps.details")}</h2>
        <p className="text-sm text-muted-foreground">
          {t("steps.detailsDescription")}
        </p>
      </div>

      {/* Product details - always visible */}
      <div className="space-y-4">
        <MobileFormField<CreateItemFormData>
          name="brand"
          label={t("fields.brand")}
          placeholder={t("placeholders.brand")}
        />

        <MobileFormField<CreateItemFormData>
          name="model"
          label={t("fields.model")}
          placeholder={t("placeholders.model")}
        />

        <MobileFormField<CreateItemFormData>
          name="manufacturer"
          label={t("fields.manufacturer")}
          placeholder={t("placeholders.manufacturer")}
        />
      </div>

      {/* Identification - collapsible */}
      <CollapsibleSection
        title={t("sections.identification")}
        description={t("sections.identificationDescription")}
      >
        <div className="space-y-4">
          <MobileFormField<CreateItemFormData>
            name="serial_number"
            label={t("fields.serialNumber")}
            placeholder={t("placeholders.serialNumber")}
          />

          <MobileFormField<CreateItemFormData>
            name="barcode"
            label={t("fields.barcode")}
            placeholder={t("placeholders.barcode")}
          />

          <MobileFormField<CreateItemFormData>
            name="short_code"
            label={t("fields.shortCode")}
            placeholder={t("placeholders.shortCode")}
          />
        </div>
      </CollapsibleSection>

      {/* Purchase info - collapsible */}
      <CollapsibleSection
        title={t("sections.purchase")}
        description={t("sections.purchaseDescription")}
      >
        <div className="space-y-4">
          <MobileFormField<CreateItemFormData>
            name="purchased_from"
            label={t("fields.purchasedFrom")}
            placeholder={t("placeholders.purchasedFrom")}
          />

          <MobileFormField<CreateItemFormData>
            name="min_stock_level"
            label={t("fields.minStockLevel")}
            inputMode="numeric"
            type="text"
            placeholder="0"
          />
        </div>
      </CollapsibleSection>

      {/* Warranty & Insurance - collapsible */}
      <CollapsibleSection
        title={t("sections.warranty")}
        description={t("sections.warrantyDescription")}
      >
        <div className="space-y-4">
          {/* Is Insured checkbox */}
          <div className="flex items-center space-x-3 min-h-[44px]">
            <Checkbox
              id="is_insured"
              checked={isInsured}
              onCheckedChange={(checked) =>
                setValue("is_insured", checked === true)
              }
              className="h-5 w-5"
            />
            <Label
              htmlFor="is_insured"
              className="text-base font-normal cursor-pointer"
            >
              {t("fields.isInsured")}
            </Label>
          </div>

          {/* Lifetime Warranty checkbox */}
          <div className="flex items-center space-x-3 min-h-[44px]">
            <Checkbox
              id="lifetime_warranty"
              checked={lifetimeWarranty}
              onCheckedChange={(checked) =>
                setValue("lifetime_warranty", checked === true)
              }
              className="h-5 w-5"
            />
            <Label
              htmlFor="lifetime_warranty"
              className="text-base font-normal cursor-pointer"
            >
              {t("fields.lifetimeWarranty")}
            </Label>
          </div>

          {/* Warranty Details */}
          <MobileFormTextarea<CreateItemFormData>
            name="warranty_details"
            label={t("fields.warrantyDetails")}
            placeholder={t("placeholders.warrantyDetails")}
            rows={2}
          />
        </div>
      </CollapsibleSection>

      {/* Navigation */}
      <div className="flex justify-between pt-4 border-t">
        <Button
          type="button"
          variant="outline"
          onClick={onBack}
          disabled={isSubmitting}
          className="min-h-[44px] min-w-[100px]"
        >
          {t("back")}
        </Button>
        <Button
          type="button"
          onClick={onNext}
          disabled={isSubmitting}
          className="min-h-[44px] min-w-[120px]"
        >
          {t("next")}
        </Button>
      </div>
    </div>
  );
}
```

Key features:
- Progressive disclosure with CollapsibleSection
- Product details (brand/model/manufacturer) always visible
- Identification, Purchase, and Warranty sections collapsible
- 44px touch targets on checkboxes
  </action>
  <verify>TypeScript compilation passes</verify>
  <done>DetailsStep uses CollapsibleSection for advanced fields</done>
</task>

<task type="auto">
  <name>Task 3: Create photos step and wizard entry point</name>
  <files>
    frontend/components/items/create-item-wizard/photos-step.tsx
    frontend/components/items/create-item-wizard/index.tsx
  </files>
  <action>
1. Create photos-step.tsx for Step 3:

```typescript
"use client";

import { useState, useCallback } from "react";
import { useTranslations } from "next-intl";
import { Loader2 } from "lucide-react";

import { InlinePhotoCapture } from "@/components/forms";
import { Button } from "@/components/ui/button";

interface CapturedPhoto {
  file: File;
  preview: string;
}

interface PhotosStepProps {
  onBack: () => void;
  isLastStep: boolean;
  isSubmitting: boolean;
  onPhotosChange: (photos: File[]) => void;
}

export function PhotosStep({
  onBack,
  isLastStep,
  isSubmitting,
  onPhotosChange,
}: PhotosStepProps) {
  const t = useTranslations("items.create");
  const [photos, setPhotos] = useState<CapturedPhoto[]>([]);

  const handleCapture = useCallback((file: File, preview: string) => {
    setPhotos((prev) => {
      const updated = [...prev, { file, preview }];
      onPhotosChange(updated.map((p) => p.file));
      return updated;
    });
  }, [onPhotosChange]);

  const handleRemove = useCallback((index: number) => {
    setPhotos((prev) => {
      const updated = prev.filter((_, i) => i !== index);
      onPhotosChange(updated.map((p) => p.file));
      return updated;
    });
  }, [onPhotosChange]);

  return (
    <div className="space-y-6">
      <div className="space-y-1">
        <h2 className="text-lg font-semibold">{t("steps.photos")}</h2>
        <p className="text-sm text-muted-foreground">
          {t("steps.photosDescription")}
        </p>
      </div>

      {/* Photo captures */}
      <div className="space-y-4">
        {photos.map((photo, index) => (
          <div key={index} className="relative">
            <InlinePhotoCapture
              label={`${t("fields.photo")} ${index + 1}`}
              preview={photo.preview}
              onCapture={() => {}}
              onRemove={() => handleRemove(index)}
            />
          </div>
        ))}

        {/* Add new photo */}
        {photos.length < 5 && (
          <InlinePhotoCapture
            label={photos.length === 0 ? t("fields.addPhoto") : t("fields.addAnotherPhoto")}
            onCapture={(file) => {
              const preview = URL.createObjectURL(file);
              handleCapture(file, preview);
            }}
            onRemove={() => {}}
          />
        )}

        {photos.length >= 5 && (
          <p className="text-sm text-muted-foreground">
            {t("fields.maxPhotosReached")}
          </p>
        )}
      </div>

      {/* Navigation */}
      <div className="flex justify-between pt-4 border-t">
        <Button
          type="button"
          variant="outline"
          onClick={onBack}
          disabled={isSubmitting}
          className="min-h-[44px] min-w-[100px]"
        >
          {t("back")}
        </Button>
        <Button
          type="submit"
          disabled={isSubmitting}
          className="min-h-[44px] min-w-[120px]"
        >
          {isSubmitting ? (
            <>
              <Loader2 className="mr-2 h-4 w-4 animate-spin" />
              {t("creating")}
            </>
          ) : (
            t("createItem")
          )}
        </Button>
      </div>
    </div>
  );
}
```

2. Create index.tsx as the wizard entry point:

```typescript
"use client";

import { useState, useCallback } from "react";
import { useRouter } from "next/navigation";
import { useTranslations } from "next-intl";
import { toast } from "sonner";

import { MultiStepForm, type Step } from "@/components/forms";
import { useWorkspace } from "@/lib/hooks/use-workspace";
import { itemsApi } from "@/lib/api";
import { BasicStep } from "./basic-step";
import { DetailsStep } from "./details-step";
import { PhotosStep } from "./photos-step";
import {
  createItemSchema,
  createItemDefaults,
  stepFields,
  type CreateItemFormData,
} from "./schema";

export function CreateItemWizard() {
  const t = useTranslations("items.create");
  const router = useRouter();
  const { workspaceId } = useWorkspace();
  const [capturedPhotos, setCapturedPhotos] = useState<File[]>([]);

  const steps: Step[] = [
    { id: "basic", title: t("steps.basic") },
    { id: "details", title: t("steps.details") },
    { id: "photos", title: t("steps.photos") },
  ];

  const handleSubmit = useCallback(
    async (data: CreateItemFormData) => {
      if (!workspaceId) {
        toast.error(t("errors.noWorkspace"));
        return;
      }

      try {
        // Create the item
        const item = await itemsApi.create(workspaceId, {
          sku: data.sku,
          name: data.name,
          description: data.description || undefined,
          category_id: data.category_id || undefined,
          brand: data.brand || undefined,
          model: data.model || undefined,
          manufacturer: data.manufacturer || undefined,
          serial_number: data.serial_number || undefined,
          barcode: data.barcode || undefined,
          is_insured: data.is_insured,
          lifetime_warranty: data.lifetime_warranty,
          warranty_details: data.warranty_details || undefined,
          purchased_from: data.purchased_from || undefined,
          min_stock_level: data.min_stock_level,
          short_code: data.short_code || undefined,
        });

        // Upload photos if any
        if (capturedPhotos.length > 0) {
          const { itemPhotosApi } = await import("@/lib/api/item-photos");
          for (const photo of capturedPhotos) {
            try {
              await itemPhotosApi.uploadItemPhoto(workspaceId, item.id, photo);
            } catch (err) {
              console.error("Failed to upload photo:", err);
              // Continue with other photos
            }
          }
        }

        toast.success(t("success"));
        router.push(`/dashboard/items/${item.id}`);
      } catch (error) {
        console.error("Failed to create item:", error);
        toast.error(t("errors.createFailed"));
      }
    },
    [workspaceId, capturedPhotos, t, router]
  );

  const handleCancel = useCallback(() => {
    router.push("/dashboard/items");
  }, [router]);

  return (
    <MultiStepForm
      schema={createItemSchema}
      defaultValues={createItemDefaults}
      steps={steps}
      onSubmit={handleSubmit}
      onCancel={handleCancel}
      formType="createItem"
      stepFields={stepFields}
      className="max-w-2xl mx-auto"
    >
      {({ currentStep, goNext, goBack, isFirstStep, isLastStep, isSubmitting }) => (
        <>
          {currentStep === 0 && (
            <BasicStep onNext={goNext} isSubmitting={isSubmitting} />
          )}
          {currentStep === 1 && (
            <DetailsStep
              onNext={goNext}
              onBack={goBack}
              isSubmitting={isSubmitting}
            />
          )}
          {currentStep === 2 && (
            <PhotosStep
              onBack={goBack}
              isLastStep={isLastStep}
              isSubmitting={isSubmitting}
              onPhotosChange={setCapturedPhotos}
            />
          )}
        </>
      )}
    </MultiStepForm>
  );
}

export default CreateItemWizard;
```
  </action>
  <verify>TypeScript compilation passes</verify>
  <done>PhotosStep and CreateItemWizard entry point created</done>
</task>

<task type="auto">
  <name>Task 4: Create new item page route and translations</name>
  <files>
    frontend/app/[locale]/(dashboard)/dashboard/items/new/page.tsx
    frontend/messages/en.json
  </files>
  <action>
1. Create the page route:

```typescript
"use client";

import { ArrowLeft } from "lucide-react";
import { useRouter } from "next/navigation";
import { useTranslations } from "next-intl";

import { Button } from "@/components/ui/button";
import { CreateItemWizard } from "@/components/items/create-item-wizard";

export default function NewItemPage() {
  const router = useRouter();
  const t = useTranslations("items");

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center gap-4">
        <Button
          variant="ghost"
          size="icon"
          onClick={() => router.push("/dashboard/items")}
        >
          <ArrowLeft className="h-5 w-5" />
        </Button>
        <div>
          <h1 className="text-2xl font-bold tracking-tight">
            {t("create.title")}
          </h1>
          <p className="text-muted-foreground">
            {t("create.subtitle")}
          </p>
        </div>
      </div>

      {/* Wizard */}
      <CreateItemWizard />
    </div>
  );
}
```

2. Add translations to en.json. Merge into existing "items" section:

```json
{
  "items": {
    "create": {
      "title": "Create New Item",
      "subtitle": "Add a new item to your inventory",
      "steps": {
        "basic": "Basic Info",
        "basicDescription": "Enter the essential item information",
        "details": "Details",
        "detailsDescription": "Add product details and advanced settings",
        "photos": "Photos",
        "photosDescription": "Add photos of your item (optional)"
      },
      "sections": {
        "identification": "Identification",
        "identificationDescription": "Serial numbers, barcodes, and codes",
        "purchase": "Purchase & Stock",
        "purchaseDescription": "Purchase history and stock levels",
        "warranty": "Warranty & Insurance",
        "warrantyDescription": "Protection and coverage details"
      },
      "fields": {
        "sku": "SKU",
        "name": "Name",
        "description": "Description",
        "brand": "Brand",
        "model": "Model",
        "manufacturer": "Manufacturer",
        "serialNumber": "Serial Number",
        "barcode": "Barcode",
        "shortCode": "Short Code",
        "purchasedFrom": "Purchased From",
        "minStockLevel": "Minimum Stock Level",
        "isInsured": "Item is insured",
        "lifetimeWarranty": "Has lifetime warranty",
        "warrantyDetails": "Warranty Details",
        "photo": "Photo",
        "addPhoto": "Add Photo",
        "addAnotherPhoto": "Add Another Photo",
        "maxPhotosReached": "Maximum 5 photos allowed"
      },
      "placeholders": {
        "sku": "e.g., ITEM-001",
        "name": "Enter item name",
        "description": "Optional description",
        "brand": "e.g., Apple",
        "model": "e.g., iPhone 15 Pro",
        "manufacturer": "e.g., Apple Inc.",
        "serialNumber": "e.g., ABC123XYZ",
        "barcode": "e.g., 1234567890123",
        "shortCode": "Auto-generated if empty",
        "purchasedFrom": "e.g., Amazon",
        "warrantyDetails": "Describe warranty coverage"
      },
      "next": "Next",
      "back": "Back",
      "createItem": "Create Item",
      "creating": "Creating...",
      "success": "Item created successfully",
      "errors": {
        "noWorkspace": "No workspace selected",
        "createFailed": "Failed to create item"
      }
    }
  }
}
```

Add corresponding translations to fi.json and other language files.
  </action>
  <verify>
    - `cd frontend && bun run build` succeeds
    - `/dashboard/items/new` route loads without errors
  </verify>
  <done>New item page route and all translations created</done>
</task>

</tasks>

<verification>
1. `cd frontend && bun run build` completes without errors
2. `cd frontend && bun run lint` passes
3. Navigation to `/dashboard/items/new` loads the wizard
4. All 3 steps are accessible via StepIndicator
5. Validation prevents proceeding without SKU and name
6. CollapsibleSection works on Details step
7. InlinePhotoCapture works on Photos step
8. Form submission creates item via API
</verification>

<success_criteria>
- Create Item wizard shows 3 steps: Basic, Details, Photos
- Step 1 validates SKU and name before allowing next
- Step 2 uses CollapsibleSection for advanced fields
- Step 3 uses InlinePhotoCapture for photos
- Form data persists across steps (shouldUnregister: false)
- Draft auto-saves to IndexedDB and recovers on return
- Successful submission creates item and uploads photos
- All touch targets are 44px minimum
- All inputs use 16px font (text-base)
</success_criteria>

<output>
After completion, create `.planning/phases/21-mobile-form-improvements/21-05-SUMMARY.md`
</output>
