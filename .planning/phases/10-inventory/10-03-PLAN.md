---
phase: 10-inventory
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/app/[locale]/(dashboard)/dashboard/inventory/page.tsx
autonomous: true
user_setup: []
gap_closure: true

must_haves:
  truths:
    - "User can update inventory quantity while offline and see changes immediately"
    - "User can update inventory condition while offline and see changes immediately"
    - "User can update inventory status while offline and see changes immediately"
    - "Updated inventory rows show pending badge until synced"
  artifacts:
    - path: "frontend/app/[locale]/(dashboard)/dashboard/inventory/page.tsx"
      provides: "Inline edit handlers wired to updateInventoryOffline"
      contains: "updateInventoryOffline"
  key_links:
    - from: "handleUpdateQuantity"
      to: "updateInventoryOffline"
      via: "Direct call with _entityId"
      pattern: "updateInventoryOffline.*_entityId.*quantity"
    - from: "handleUpdateCondition"
      to: "updateInventoryOffline"
      via: "Direct call with _entityId"
      pattern: "updateInventoryOffline.*_entityId.*condition"
    - from: "handleUpdateStatus"
      to: "updateInventoryOffline"
      via: "Direct call with _entityId"
      pattern: "updateInventoryOffline.*_entityId.*status"
---

<objective>
Wire inline edit handlers to use updateInventoryOffline for offline update support

Purpose: Close the verification gap where handleUpdateQuantity, handleUpdateCondition, and handleUpdateStatus call the API directly instead of using offline mutations. This blocks INV-02: "User can update inventory record while offline with optimistic UI".

Output: Updated inventory page where all inline edit handlers use updateInventoryOffline, enabling offline updates with optimistic state.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-inventory/10-VERIFICATION.md (gap source)
@frontend/app/[locale]/(dashboard)/dashboard/inventory/page.tsx (target file)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire inline edit handlers to use updateInventoryOffline</name>
  <files>frontend/app/[locale]/(dashboard)/dashboard/inventory/page.tsx</files>
  <action>
Modify the three inline edit handler functions to use the existing updateInventoryOffline hook instead of calling the API directly.

**Current issue (lines 992-1046):**
- `handleUpdateQuantity` calls `inventoryApi.updateQuantity`
- `handleUpdateCondition` calls `inventoryApi.update`
- `handleUpdateStatus` calls `inventoryApi.updateStatus`

**Required changes:**

1. **Update handleUpdateQuantity** (around line 992):
   Replace the current implementation with:
   ```typescript
   const handleUpdateQuantity = async (inventoryId: string, value: string) => {
     const quantity = parseInt(value, 10);
     if (isNaN(quantity) || quantity < 0) {
       throw new Error("Quantity must be a positive number");
     }
     try {
       await updateInventoryOffline({ _entityId: inventoryId, quantity });
       toast.success(navigator.onLine ? "Quantity updated" : "Quantity update queued");
     } catch (error) {
       const errorMessage = error instanceof Error ? error.message : "Failed to update quantity";
       toast.error("Update failed", { description: errorMessage });
       throw error;
     }
   };
   ```

2. **Update handleUpdateCondition** (around line 1008):
   Replace the current implementation with:
   ```typescript
   const handleUpdateCondition = async (inventoryId: string, condition: string) => {
     try {
       await updateInventoryOffline({ _entityId: inventoryId, condition: condition as InventoryCondition });
       toast.success(navigator.onLine ? "Condition updated" : "Condition update queued");
     } catch (error) {
       const errorMessage = error instanceof Error ? error.message : "Failed to update condition";
       toast.error("Update failed", { description: errorMessage });
       throw error;
     }
   };
   ```

3. **Update handleUpdateStatus** (around line 1037):
   Replace the current implementation with:
   ```typescript
   const handleUpdateStatus = async (inventoryId: string, status: string) => {
     try {
       await updateInventoryOffline({ _entityId: inventoryId, status: status as InventoryStatus });
       toast.success(navigator.onLine ? "Status updated" : "Status update queued");
     } catch (error) {
       const errorMessage = error instanceof Error ? error.message : "Failed to update status";
       toast.error("Update failed", { description: errorMessage });
       throw error;
     }
   };
   ```

**Key changes:**
- Remove `refetch()` calls - sync events already handle refetching when mutation syncs
- Use `updateInventoryOffline` with `_entityId` field to identify the entity being updated
- Update toast messages to indicate when updates are queued vs immediate
- Simplify condition update - no longer need to rebuild entire payload with all fields, just send the changed field

**Note:** The `updateInventoryOffline` hook (line 549-568) already handles:
- Adding the entity to optimistic state with `_pending: true`
- Merging updates into existing optimistic or fetched records
- The sync event subscription (line 575-580) removes optimistic state and calls refetch on sync
  </action>
  <verify>
    TypeScript compilation: `cd frontend && npx tsc --noEmit` passes without errors
    Grep check: `grep -n "updateInventoryOffline.*_entityId" frontend/app/[locale]/\(dashboard\)/dashboard/inventory/page.tsx` shows 3 matches
    Grep check: `grep -n "inventoryApi.update" frontend/app/[locale]/\(dashboard\)/dashboard/inventory/page.tsx` shows NO matches (only in handleArchive which is correct)
  </verify>
  <done>
    handleUpdateQuantity uses updateInventoryOffline with { _entityId, quantity }
    handleUpdateCondition uses updateInventoryOffline with { _entityId, condition }
    handleUpdateStatus uses updateInventoryOffline with { _entityId, status }
    Toast messages indicate queued vs immediate based on online status
    No direct API calls remain in inline edit handlers
  </done>
</task>

<task type="auto">
  <name>Task 2: Test offline update flow manually</name>
  <files>frontend/app/[locale]/(dashboard)/dashboard/inventory/page.tsx</files>
  <action>
Verify the offline update behavior works correctly:

1. Start the dev server if not running: `cd frontend && bun run dev`
2. Navigate to /en/dashboard/inventory
3. Create at least one inventory record if none exist
4. Test online update:
   - Click on a quantity cell, change value, verify "Quantity updated" toast
   - Click on a condition dropdown, change value, verify "Condition updated" toast
   - Click on a status dropdown, change value, verify "Status updated" toast
5. Test offline update:
   - Open DevTools > Network > check "Offline"
   - Verify offline indicator appears
   - Click on a quantity cell, change value, verify "Quantity update queued" toast
   - Click on a condition dropdown, change value, verify "Condition update queued" toast
   - Click on a status dropdown, change value, verify "Status update queued" toast
   - Verify the row shows pending badge with amber background
6. Test sync:
   - Uncheck "Offline" in DevTools
   - Verify pending badge disappears
   - Verify values persist after page refresh
  </action>
  <verify>
    Manual test: Online updates show immediate success toast
    Manual test: Offline updates show "queued" toast and pending badge
    Manual test: Going online syncs pending updates
  </verify>
  <done>
    Inline quantity/condition/status updates work offline
    Optimistic state shows pending badge
    Sync completes when back online
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. handleUpdateQuantity calls updateInventoryOffline instead of inventoryApi.updateQuantity
3. handleUpdateCondition calls updateInventoryOffline instead of inventoryApi.update
4. handleUpdateStatus calls updateInventoryOffline instead of inventoryApi.updateStatus
5. Offline update: Go offline, edit quantity/condition/status, see "queued" toast and pending badge
6. Online sync: Go online, pending badge disappears, changes persist
</verification>

<success_criteria>
- INV-02 requirement satisfied: User can update inventory record while offline with optimistic UI
- All three inline edit handlers (quantity, condition, status) use updateInventoryOffline
- Updated rows show pending badge until synced
- Toast messages differentiate between immediate and queued updates
</success_criteria>

<output>
After completion, create `.planning/phases/10-inventory/10-03-SUMMARY.md`
</output>
