---
phase: 29-account-deletion
plan: 02
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - frontend/lib/api/auth.ts
  - frontend/components/settings/delete-account-dialog.tsx
  - frontend/components/settings/security-settings.tsx
  - frontend/messages/en.json
  - frontend/messages/fi.json
autonomous: true

must_haves:
  truths:
    - "User can see Delete Account button in settings page"
    - "User must type DELETE to enable confirmation button"
    - "User sees blocking workspaces if deletion prevented"
    - "User is logged out and redirected after successful deletion"
    - "Error toast shown on deletion failure"
  artifacts:
    - path: "frontend/components/settings/delete-account-dialog.tsx"
      provides: "Type-to-confirm deletion dialog"
      exports: ["DeleteAccountDialog"]
    - path: "frontend/lib/api/auth.ts"
      provides: "API methods for account deletion"
      contains: "deleteAccount"
    - path: "frontend/components/settings/security-settings.tsx"
      provides: "Danger Zone section with delete button"
      contains: "DeleteAccountDialog"
  key_links:
    - from: "delete-account-dialog.tsx"
      to: "authApi.deleteAccount"
      via: "API call on confirm"
      pattern: "authApi\\.deleteAccount"
    - from: "delete-account-dialog.tsx"
      to: "authApi.canDeleteAccount"
      via: "Pre-check on dialog open"
      pattern: "authApi\\.canDeleteAccount"
    - from: "security-settings.tsx"
      to: "DeleteAccountDialog"
      via: "Component import"
      pattern: "import.*DeleteAccountDialog"
---

<objective>
Implement frontend account deletion UI with type-to-confirm safeguard

Purpose: Enable users to safely delete their account from the settings page with appropriate friction to prevent accidental deletion. Shows blocking workspaces if deletion is prevented.

Output: DeleteAccountDialog component, Danger Zone section in SecuritySettings
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/29-account-deletion/29-RESEARCH.md
@.planning/phases/29-account-deletion/29-01-SUMMARY.md

# Codebase patterns
@frontend/lib/api/auth.ts
@frontend/components/settings/security-settings.tsx
@frontend/components/settings/password-change.tsx
@frontend/components/ui/alert-dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add API methods for account deletion</name>
  <files>
    frontend/lib/api/auth.ts
  </files>
  <action>
Add two new methods to authApi object:

1. canDeleteAccount - checks if user can delete their account:
```typescript
canDeleteAccount: async (): Promise<{
  can_delete: boolean;
  blocking_workspaces: Array<{ id: string; name: string; slug: string }>;
}> => {
  return apiClient.get("/users/me/can-delete");
},
```

2. deleteAccount - performs account deletion:
```typescript
deleteAccount: async (confirmation: string): Promise<void> => {
  await apiClient.delete("/users/me", { confirmation });
  // Clear local state same as logout
  apiClient.setToken(null);
  if (typeof window !== "undefined") {
    localStorage.removeItem("workspace_id");
  }
},
```

Add corresponding TypeScript interface:
```typescript
export interface CanDeleteResponse {
  can_delete: boolean;
  blocking_workspaces: Array<{ id: string; name: string; slug: string }>;
}
```
  </action>
  <verify>
Run `bun run typecheck` in frontend directory - should pass with no errors.
  </verify>
  <done>
authApi has canDeleteAccount and deleteAccount methods. TypeScript types defined.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DeleteAccountDialog component</name>
  <files>
    frontend/components/settings/delete-account-dialog.tsx
    frontend/messages/en.json
    frontend/messages/fi.json
  </files>
  <action>
1. Create DeleteAccountDialog component at frontend/components/settings/delete-account-dialog.tsx:

Features:
- AlertDialog from shadcn/ui for accessible modal
- useState for confirmText, isDeleting, blockingWorkspaces, canDelete
- On dialog open, call authApi.canDeleteAccount() to pre-check eligibility
- If cannot delete, show list of blocking workspaces with warning
- Input field for typing "DELETE" (case-insensitive comparison)
- Button disabled until confirmText.toUpperCase() === "DELETE"
- On confirm: call authApi.deleteAccount(confirmText), show success toast, call logout from auth context, redirect to "/"
- On error: show error toast, keep dialog open
- Loading state with Loader2 spinner during deletion

Component structure:
```tsx
"use client";

import { useState, useEffect } from "react";
import { useTranslations } from "next-intl";
import { useRouter } from "next/navigation";
import { AlertTriangle, Loader2 } from "lucide-react";
import {
  AlertDialog,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from "@/components/ui/alert-dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { authApi } from "@/lib/api/auth";
import { useAuth } from "@/lib/contexts/auth-context";
import { toast } from "sonner";

export function DeleteAccountDialog() {
  const t = useTranslations("settings.dangerZone");
  const { logout } = useAuth();
  const router = useRouter();
  // ... state and handlers
}
```

2. Add translations to en.json under settings.dangerZone:
```json
"dangerZone": {
  "title": "Danger Zone",
  "description": "Irreversible actions that permanently affect your account.",
  "deleteButton": "Delete Account",
  "deleteTitle": "Delete Your Account",
  "deleteWarning": "This action cannot be undone. This will permanently delete your account and all your data.",
  "typeConfirm": "Type {word} to confirm",
  "confirmPlaceholder": "DELETE",
  "confirmDelete": "Delete My Account",
  "deleting": "Deleting...",
  "deleted": "Your account has been deleted",
  "deleteError": "Failed to delete account. Please try again.",
  "cannotDelete": "Cannot Delete Account",
  "cannotDeleteDescription": "You must transfer ownership of the following workspaces before deleting your account:",
  "cancel": "Cancel"
}
```

3. Add Finnish translations to fi.json under settings.dangerZone:
```json
"dangerZone": {
  "title": "Vaaravyohyke",
  "description": "Peruuttamattomia toimintoja, jotka vaikuttavat pysyvasti tiliisi.",
  "deleteButton": "Poista tili",
  "deleteTitle": "Poista tilisi",
  "deleteWarning": "Tata toimintoa ei voi peruuttaa. Tama poistaa pysyvasti tilisi ja kaikki tietosi.",
  "typeConfirm": "Kirjoita {word} vahvistaaksesi",
  "confirmPlaceholder": "DELETE",
  "confirmDelete": "Poista tilini",
  "deleting": "Poistetaan...",
  "deleted": "Tilisi on poistettu",
  "deleteError": "Tilin poistaminen epaonnistui. Yrita uudelleen.",
  "cannotDelete": "Tilia ei voi poistaa",
  "cannotDeleteDescription": "Sinun taytyy siirtaa seuraavien tyotilojen omistajuus ennen tilin poistamista:",
  "cancel": "Peruuta"
}
```

Note: Use ASCII characters for Finnish translations (no special characters like a-umlaut) - the codebase already handles this pattern.
  </action>
  <verify>
Run `bun run typecheck` - should pass.
Run `bun run lint` - should pass.
Check component imports resolve correctly.
  </verify>
  <done>
DeleteAccountDialog component exists with type-to-confirm pattern.
Translations added for both English and Finnish.
Dialog shows blocking workspaces when user cannot delete.
Successful deletion logs out user and redirects to home.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Danger Zone section to SecuritySettings</name>
  <files>
    frontend/components/settings/security-settings.tsx
  </files>
  <action>
Update SecuritySettings component to add Danger Zone section:

1. Import AlertTriangle icon from lucide-react
2. Import DeleteAccountDialog component
3. Add new section after Sessions section with:
   - Separator or divider
   - h3 with AlertTriangle icon and "Danger Zone" title (use t("dangerZone.title"))
   - Description text (use t("dangerZone.description"))
   - DeleteAccountDialog component (which renders its own trigger button)

Structure:
```tsx
{/* Danger Zone Section */}
<div className="space-y-4 border-t pt-6">
  <h3 className="text-sm font-medium flex items-center gap-2 text-destructive">
    <AlertTriangle className="h-4 w-4" />
    {t("dangerZone.title")}
  </h3>
  <p className="text-sm text-muted-foreground">
    {t("dangerZone.description")}
  </p>
  <DeleteAccountDialog />
</div>
```

The section should use text-destructive color for the title to visually warn users this is a dangerous area.
  </action>
  <verify>
Run `bun run dev` and navigate to Settings page.
Verify Danger Zone section appears below Sessions section.
Verify Delete Account button is visible and styled as destructive variant.
Click button, verify dialog opens with type-to-confirm input.
  </verify>
  <done>
SecuritySettings has Danger Zone section with DeleteAccountDialog.
Section is visually distinct with destructive styling.
Delete Account button opens confirmation dialog.
  </done>
</task>

</tasks>

<verification>
1. `bun run typecheck` passes
2. `bun run lint` passes
3. `bun run build` succeeds
4. Manual test - Settings page shows Danger Zone section
5. Manual test - Clicking Delete Account opens AlertDialog
6. Manual test - Confirm button disabled until "DELETE" typed
7. Manual test - If user is sole owner of workspace, dialog shows blocking workspaces
8. Manual test - Successful deletion logs out and redirects to home
9. Manual test - Translations work for both English and Finnish
</verification>

<success_criteria>
- Delete Account button visible in Settings under Danger Zone section
- AlertDialog opens on button click
- Dialog shows blocking workspaces if user cannot delete
- Confirm button disabled until "DELETE" typed (case-insensitive)
- Loading state shown during deletion
- Success toast and redirect on successful deletion
- Error toast on failure
- User logged out and redirected to "/" after deletion
- Translations complete for en and fi
</success_criteria>

<output>
After completion, create `.planning/phases/29-account-deletion/29-02-SUMMARY.md`
</output>
