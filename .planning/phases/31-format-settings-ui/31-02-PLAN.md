---
phase: 31-format-settings-ui
plan: 02
type: execute
wave: 2
depends_on: ["31-01"]
files_modified:
  - frontend/components/settings/number-format-settings.tsx
  - frontend/app/[locale]/(dashboard)/dashboard/settings/page.tsx
  - frontend/messages/en.json
autonomous: true

must_haves:
  truths:
    - "User can select thousand separator (comma, period, space) from settings page"
    - "User can select decimal separator (period, comma) from settings page"
    - "User sees a live preview of a sample number formatted with their chosen separators"
    - "User cannot select the same character for both thousand and decimal separator (conflict prevented)"
    - "Number format changes persist immediately and apply across the app without page reload"
  artifacts:
    - path: "frontend/components/settings/number-format-settings.tsx"
      provides: "NumberFormatSettings component with Select dropdowns, conflict validation, and live preview"
      contains: "Select"
    - path: "frontend/app/[locale]/(dashboard)/dashboard/settings/page.tsx"
      provides: "Settings page with all three format cards (date, time, number)"
      contains: "NumberFormatSettings"
    - path: "frontend/messages/en.json"
      provides: "Translation keys for numberFormat section"
      contains: "numberFormat"
  key_links:
    - from: "frontend/components/settings/number-format-settings.tsx"
      to: "/users/me/preferences"
      via: "fetch PATCH on Select change with conflict validation"
      pattern: "PATCH.*preferences.*(thousand_separator|decimal_separator)"
    - from: "frontend/components/settings/number-format-settings.tsx"
      to: "frontend/lib/hooks/use-number-format.ts"
      via: "import types for separator options"
      pattern: "import.*ThousandSeparator|DecimalSeparator"
    - from: "frontend/app/[locale]/(dashboard)/dashboard/settings/page.tsx"
      to: "frontend/components/settings/number-format-settings.tsx"
      via: "import and render"
      pattern: "import.*NumberFormatSettings"
---

<objective>
Create the NumberFormatSettings component with separator conflict validation and wire it to the settings page to complete all format settings UI.

Purpose: Users need a UI to configure their number format preferences (thousand separator and decimal separator) with live preview showing how numbers will appear. The separator conflict validation prevents users from choosing the same character for both separators (which the backend rejects). This satisfies SETTINGS-03, NUM-09, and completes SETTINGS-04.

Output: NumberFormatSettings component, final settings page with all three format cards, translation keys for number format section.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-format-settings-ui/31-RESEARCH.md
@.planning/phases/31-format-settings-ui/31-01-SUMMARY.md

Key source files to reference:
@frontend/components/settings/date-format-settings.tsx  (PATTERN for save logic)
@frontend/components/settings/time-format-settings.tsx  (created in plan 01 - pattern for Card layout)
@frontend/lib/hooks/use-number-format.ts  (ThousandSeparator, DecimalSeparator types, formatNumber)
@frontend/app/[locale]/(dashboard)/dashboard/settings/page.tsx  (add NumberFormatSettings)
@frontend/messages/en.json  (add numberFormat translation keys)
@frontend/components/ui/select.tsx  (Select component to use for dropdowns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NumberFormatSettings component with conflict validation</name>
  <files>
    frontend/components/settings/number-format-settings.tsx
    frontend/messages/en.json
  </files>
  <action>
Create `frontend/components/settings/number-format-settings.tsx`:

1. **Component structure:** Card with CardHeader (Hash icon from lucide-react, title, description) and CardContent with two Select dropdowns and a live number preview.

2. **Options arrays:**
```typescript
const THOUSAND_SEPARATOR_OPTIONS: { value: ThousandSeparator; labelKey: string }[] = [
  { value: ",", labelKey: "comma" },
  { value: ".", labelKey: "period" },
  { value: " ", labelKey: "space" },
];

const DECIMAL_SEPARATOR_OPTIONS: { value: DecimalSeparator; labelKey: string }[] = [
  { value: ".", labelKey: "decimalPeriod" },
  { value: ",", labelKey: "decimalComma" },
];
```
Import `ThousandSeparator` and `DecimalSeparator` types from `@/lib/hooks/use-number-format`.

3. **State and current values:**
   - Get current separators from `useAuth()` user object:
     - `thousandSep = (user?.thousand_separator as ThousandSeparator) || ","` (default comma)
     - `decimalSep = (user?.decimal_separator as DecimalSeparator) || "."` (default period)
   - `isUpdating` state (boolean) to disable Selects during save
   - `conflictError` state (string) for showing conflict message

4. **Conflict validation function:**
```typescript
const hasConflict = (newThousand: string, newDecimal: string): boolean => {
  return newThousand === newDecimal;
};
```

5. **handleThousandChange(value: string):**
   - Check conflict: if `hasConflict(value, decimalSep)`, set conflictError to translation key and return early (do NOT call API)
   - Clear conflictError
   - Set isUpdating=true
   - PATCH `/users/me/preferences` with `{ thousand_separator: value }` (same fetch pattern as DateFormatSettings)
   - Call refreshUser(), toast.success, finally isUpdating=false

6. **handleDecimalChange(value: string):**
   - Check conflict: if `hasConflict(thousandSep, value)`, set conflictError and return early
   - Clear conflictError
   - Set isUpdating=true
   - PATCH `/users/me/preferences` with `{ decimal_separator: value }`
   - Call refreshUser(), toast.success, finally isUpdating=false

7. **Layout inside CardContent:**
```tsx
<div className="space-y-4">
  {/* Thousand Separator */}
  <div className="space-y-2">
    <Label>{t("thousandSeparator")}</Label>
    <Select value={thousandSep} onValueChange={handleThousandChange} disabled={isUpdating}>
      <SelectTrigger>
        <SelectValue />
      </SelectTrigger>
      <SelectContent>
        {THOUSAND_SEPARATOR_OPTIONS.map((opt) => (
          <SelectItem key={opt.value} value={opt.value}>
            {t(opt.labelKey)}
          </SelectItem>
        ))}
      </SelectContent>
    </Select>
  </div>

  {/* Decimal Separator */}
  <div className="space-y-2">
    <Label>{t("decimalSeparator")}</Label>
    <Select value={decimalSep} onValueChange={handleDecimalChange} disabled={isUpdating}>
      <SelectTrigger>
        <SelectValue />
      </SelectTrigger>
      <SelectContent>
        {DECIMAL_SEPARATOR_OPTIONS.map((opt) => (
          <SelectItem key={opt.value} value={opt.value}>
            {t(opt.labelKey)}
          </SelectItem>
        ))}
      </SelectContent>
    </Select>
  </div>

  {/* Conflict Error */}
  {conflictError && (
    <p className="text-sm text-destructive">{conflictError}</p>
  )}

  {/* Live Preview */}
  <div className="rounded-lg border p-3 bg-muted/50">
    <p className="text-sm text-muted-foreground mb-1">{t("preview")}</p>
    <p className="text-lg font-mono">{previewNumber}</p>
  </div>
</div>
```

8. **Live preview number:** Format the number 1234567.89 using the current effective separators. Compute this directly (do NOT use the useNumberFormat hook since we need to show the effective current values from user state, not the hook's cached value):
```typescript
const previewNumber = useMemo(() => {
  const integer = "1234567";
  const decimal = "89";
  const formatted = integer.replace(/\B(?=(\d{3})+(?!\d))/g, thousandSep);
  return `${formatted}${decimalSep}${decimal}`;
}, [thousandSep, decimalSep]);
```
This shows e.g. "1,234,567.89" or "1.234.567,89" or "1 234 567,89".

9. **Special handling for space separator value:** The Select component's value for space separator is `" "` (a single space). This works fine with radix Select. The label should make it clear it's a space: "Space (1 000)".

10. **Translation keys:** Use `useTranslations("settings.numberFormat")`. Add to `frontend/messages/en.json` inside the `settings` object, after the `timeFormat` section:
```json
"numberFormat": {
  "title": "Number Format",
  "description": "Configure how numbers are displayed throughout the app",
  "thousandSeparator": "Thousand separator",
  "decimalSeparator": "Decimal separator",
  "comma": "Comma (1,000)",
  "period": "Period (1.000)",
  "space": "Space (1 000)",
  "decimalPeriod": "Period (0.99)",
  "decimalComma": "Comma (0,99)",
  "saved": "Number format updated",
  "saveError": "Failed to update number format",
  "conflictError": "Thousand and decimal separators must be different",
  "preview": "Preview"
}
```

11. **Imports:** "use client", useState/useMemo from react, useTranslations from next-intl, Hash from lucide-react, Card components, Label, Select/SelectContent/SelectItem/SelectTrigger/SelectValue from `@/components/ui/select`, useAuth, toast from sonner, ThousandSeparator/DecimalSeparator from `@/lib/hooks/use-number-format`.
  </action>
  <verify>
Run `cd /home/antti/Repos/Misc/home-warehouse-system/frontend && npx tsc --noEmit` to verify no type errors. Confirm the component file exists and exports `NumberFormatSettings`. Verify en.json has `settings.numberFormat` section with all keys.
  </verify>
  <done>NumberFormatSettings component renders a Card with Hash icon, title, description, two Select dropdowns (thousand/decimal separator), conflict validation that prevents selecting the same separator for both, and a live preview showing a sample number with current format. Changes save immediately via PATCH API. Translation keys added to en.json.</done>
</task>

<task type="auto">
  <name>Task 2: Wire NumberFormatSettings to settings page</name>
  <files>
    frontend/app/[locale]/(dashboard)/dashboard/settings/page.tsx
  </files>
  <action>
Update `frontend/app/[locale]/(dashboard)/dashboard/settings/page.tsx` to add NumberFormatSettings:

1. **Add import:**
```typescript
import { NumberFormatSettings } from "@/components/settings/number-format-settings";
```

2. **Render NumberFormatSettings** after TimeFormatSettings, before Active Sessions:
```tsx
{/* Format Settings */}
<DateFormatSettings />
<TimeFormatSettings />
<NumberFormatSettings />

{/* Active Sessions card - existing */}
```

The final settings page order should be:
1. Page header (title + description)
2. Data Management card
3. DateFormatSettings card
4. TimeFormatSettings card
5. NumberFormatSettings card
6. Active Sessions card
  </action>
  <verify>
Run `cd /home/antti/Repos/Misc/home-warehouse-system/frontend && npx tsc --noEmit` to verify no type errors. Confirm the settings page imports and renders all three format settings components: DateFormatSettings, TimeFormatSettings, NumberFormatSettings.
  </verify>
  <done>Settings page renders all three format settings cards (date, time, number) between Data Management and Active Sessions. Complete format settings UI is available to users.</done>
</task>

</tasks>

<verification>
1. `cd /home/antti/Repos/Misc/home-warehouse-system/frontend && npx tsc --noEmit` -- no TypeScript errors
2. `frontend/components/settings/number-format-settings.tsx` exists and exports NumberFormatSettings
3. `frontend/app/[locale]/(dashboard)/dashboard/settings/page.tsx` imports and renders DateFormatSettings, TimeFormatSettings, and NumberFormatSettings
4. `frontend/messages/en.json` contains `settings.numberFormat` section with all required keys
5. NumberFormatSettings has conflict validation: selecting same separator for both thousand and decimal shows error, does NOT call API
6. NumberFormatSettings shows live preview number formatted with current separators
7. All three format cards save immediately on selection change via PATCH API
</verification>

<success_criteria>
- NumberFormatSettings component has two Select dropdowns with proper options
- Separator conflict validation prevents same character for both separators
- Live preview shows sample number (1,234,567.89) formatted with current separators
- Settings page shows all three format cards: Date, Time, Number
- TypeScript compiles without errors
- All Phase 31 requirements satisfied: SETTINGS-01, SETTINGS-02, SETTINGS-03, SETTINGS-04, TIME-05, NUM-09
</success_criteria>

<output>
After completion, create `.planning/phases/31-format-settings-ui/31-02-SUMMARY.md`
</output>
