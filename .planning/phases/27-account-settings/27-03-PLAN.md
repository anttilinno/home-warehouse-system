---
phase: 27-account-settings
plan: 03
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - frontend/lib/hooks/use-date-format.ts
  - frontend/components/settings/date-format-settings.tsx
  - frontend/app/[locale]/(dashboard)/dashboard/settings/page.tsx
  - frontend/app/[locale]/(dashboard)/dashboard/loans/page.tsx
  - frontend/app/[locale]/(dashboard)/dashboard/inventory/page.tsx
  - frontend/app/[locale]/(dashboard)/dashboard/items/page.tsx
  - frontend/app/[locale]/(dashboard)/dashboard/sync-history/page.tsx
  - frontend/app/[locale]/(dashboard)/dashboard/imports/page.tsx
  - frontend/components/dashboard/activity-feed.tsx
  - frontend/messages/en.json
autonomous: true

must_haves:
  truths:
    - "User can select date format preference from settings"
    - "Date format preference persists across sessions"
    - "Dates display in user's chosen format throughout the app"
    - "Three format options available: MM/DD/YY, DD/MM/YYYY, YYYY-MM-DD"
  artifacts:
    - path: "frontend/lib/hooks/use-date-format.ts"
      provides: "Hook for formatting dates according to user preference"
      min_lines: 30
      exports: ["useDateFormat"]
    - path: "frontend/components/settings/date-format-settings.tsx"
      provides: "Date format selector component"
      min_lines: 50
  key_links:
    - from: "frontend/app/[locale]/(dashboard)/dashboard/loans/page.tsx"
      to: "frontend/lib/hooks/use-date-format.ts"
      via: "useDateFormat hook"
      pattern: "useDateFormat|formatDate"
    - from: "frontend/components/settings/date-format-settings.tsx"
      to: "frontend/lib/api/auth.ts"
      via: "PATCH /users/me/preferences"
      pattern: "authApi|preferences"
---

<objective>
Implement date format preference with application-wide formatting

Purpose: Allow users to personalize how dates are displayed throughout the application, improving usability for users in different regions with different date format conventions.

Output: useDateFormat hook, DateFormatSettings component, date format selector on settings page, and consistent date formatting across all pages.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-account-settings/27-RESEARCH.md

# Date formatting patterns (find existing usage)
@frontend/app/[locale]/(dashboard)/dashboard/loans/page.tsx
@frontend/app/[locale]/(dashboard)/dashboard/inventory/page.tsx
@frontend/components/dashboard/activity-feed.tsx
@frontend/lib/contexts/auth-context.tsx
@frontend/lib/api/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useDateFormat hook</name>
  <files>
    frontend/lib/hooks/use-date-format.ts
  </files>
  <action>
Create frontend/lib/hooks/use-date-format.ts:

```typescript
"use client";

import { useCallback, useMemo } from "react";
import { format as dateFnsFormat, parseISO, isValid } from "date-fns";
import { useAuth } from "@/lib/contexts/auth-context";

// Supported date formats
export type DateFormatOption = "MM/DD/YY" | "DD/MM/YYYY" | "YYYY-MM-DD";

// Map user-friendly format strings to date-fns format strings
const FORMAT_MAP: Record<DateFormatOption, string> = {
  "MM/DD/YY": "MM/dd/yy",
  "DD/MM/YYYY": "dd/MM/yyyy",
  "YYYY-MM-DD": "yyyy-MM-dd",
};

// Default format if not set
const DEFAULT_FORMAT: DateFormatOption = "YYYY-MM-DD";

export interface UseDateFormatReturn {
  /** User's selected format (e.g., "MM/DD/YY") */
  format: DateFormatOption;
  /** Format a date according to user preference */
  formatDate: (date: Date | string | null | undefined) => string;
  /** Format a date with time according to user preference */
  formatDateTime: (date: Date | string | null | undefined) => string;
  /** Get date-fns format string for custom formatting */
  dateFnsFormat: string;
}

/**
 * Hook for formatting dates according to user's preference.
 *
 * @example
 * const { formatDate } = useDateFormat();
 * return <span>{formatDate(item.created_at)}</span>;
 */
export function useDateFormat(): UseDateFormatReturn {
  const { user } = useAuth();

  // Get user's format preference, fallback to default
  const format = useMemo<DateFormatOption>(() => {
    const userFormat = user?.date_format as DateFormatOption | undefined;
    if (userFormat && FORMAT_MAP[userFormat]) {
      return userFormat;
    }
    return DEFAULT_FORMAT;
  }, [user?.date_format]);

  const dateFnsFormatStr = FORMAT_MAP[format];

  const formatDate = useCallback((date: Date | string | null | undefined): string => {
    if (!date) return "-";

    try {
      const dateObj = typeof date === "string" ? parseISO(date) : date;
      if (!isValid(dateObj)) return "-";
      return dateFnsFormat(dateObj, dateFnsFormatStr);
    } catch {
      return "-";
    }
  }, [dateFnsFormatStr]);

  const formatDateTime = useCallback((date: Date | string | null | undefined): string => {
    if (!date) return "-";

    try {
      const dateObj = typeof date === "string" ? parseISO(date) : date;
      if (!isValid(dateObj)) return "-";
      // Add time component to date format
      return dateFnsFormat(dateObj, `${dateFnsFormatStr} HH:mm`);
    } catch {
      return "-";
    }
  }, [dateFnsFormatStr]);

  return {
    format,
    formatDate,
    formatDateTime,
    dateFnsFormat: dateFnsFormatStr,
  };
}
```

This hook:
- Gets user's date_format from auth context
- Maps to date-fns format string
- Provides formatDate function that handles null/undefined/invalid gracefully
- Provides formatDateTime for timestamps
- Exports format for display purposes
  </action>
  <verify>
Run: `cd frontend && bun run typecheck`
No TypeScript errors
  </verify>
  <done>
useDateFormat hook created with formatDate and formatDateTime functions
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DateFormatSettings component and integrate into settings page</name>
  <files>
    frontend/components/settings/date-format-settings.tsx
    frontend/app/[locale]/(dashboard)/dashboard/settings/page.tsx
    frontend/messages/en.json
  </files>
  <action>
Create frontend/components/settings/date-format-settings.tsx:

```typescript
"use client";

import { useState } from "react";
import { useTranslations } from "next-intl";
import { Calendar } from "lucide-react";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Label } from "@/components/ui/label";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { useAuth } from "@/lib/contexts/auth-context";
import { authApi } from "@/lib/api/auth";
import { toast } from "sonner";
import { format } from "date-fns";
import type { DateFormatOption } from "@/lib/hooks/use-date-format";

const DATE_FORMAT_OPTIONS: { value: DateFormatOption; label: string; dateFns: string }[] = [
  { value: "MM/DD/YY", label: "MM/DD/YY", dateFns: "MM/dd/yy" },
  { value: "DD/MM/YYYY", label: "DD/MM/YYYY", dateFns: "dd/MM/yyyy" },
  { value: "YYYY-MM-DD", label: "YYYY-MM-DD", dateFns: "yyyy-MM-dd" },
];

export function DateFormatSettings() {
  const t = useTranslations("settings.dateFormat");
  const { user, refreshUser } = useAuth();
  const [isUpdating, setIsUpdating] = useState(false);

  // Current selection (default to YYYY-MM-DD if not set)
  const currentFormat = (user?.date_format as DateFormatOption) || "YYYY-MM-DD";

  // Example date for preview
  const exampleDate = new Date();

  const handleChange = async (value: string) => {
    if (value === currentFormat) return;

    setIsUpdating(true);
    try {
      // Use existing preferences endpoint
      await fetch(`${process.env.NEXT_PUBLIC_API_URL}/users/me/preferences`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${localStorage.getItem("auth_token")}`,
        },
        credentials: "include",
        body: JSON.stringify({ date_format: value }),
      });
      await refreshUser();
      toast.success(t("saved"));
    } catch (error) {
      toast.error(t("saveError"));
    } finally {
      setIsUpdating(false);
    }
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <Calendar className="h-5 w-5" />
          {t("title")}
        </CardTitle>
        <CardDescription>{t("description")}</CardDescription>
      </CardHeader>
      <CardContent>
        <RadioGroup
          value={currentFormat}
          onValueChange={handleChange}
          disabled={isUpdating}
          className="space-y-3"
        >
          {DATE_FORMAT_OPTIONS.map((option) => (
            <div
              key={option.value}
              className="flex items-center space-x-3 rounded-lg border p-3 hover:bg-muted/50 transition-colors"
            >
              <RadioGroupItem value={option.value} id={option.value} />
              <Label
                htmlFor={option.value}
                className="flex-1 flex justify-between items-center cursor-pointer"
              >
                <span className="font-medium">{option.label}</span>
                <span className="text-muted-foreground text-sm">
                  {format(exampleDate, option.dateFns)}
                </span>
              </Label>
            </div>
          ))}
        </RadioGroup>
      </CardContent>
    </Card>
  );
}
```

Update frontend/app/[locale]/(dashboard)/dashboard/settings/page.tsx:
- Import DateFormatSettings
- Add it to the grid (after AccountSettings, before the Security placeholder)

```typescript
import { DateFormatSettings } from "@/components/settings/date-format-settings";

// In the grid:
<AccountSettings />
<DateFormatSettings />
// ... notification settings, security placeholder
```

Add translations to frontend/messages/en.json:
```json
{
  "settings": {
    "dateFormat": {
      "title": "Date Format",
      "description": "Choose how dates are displayed throughout the app",
      "saved": "Date format updated",
      "saveError": "Failed to update date format"
    }
  }
}
```
  </action>
  <verify>
Run: `cd frontend && bun run typecheck`
Run: `cd frontend && bun run lint`
No errors
  </verify>
  <done>
DateFormatSettings component created with radio group, integrated into settings page
  </done>
</task>

<task type="auto">
  <name>Task 3: Apply useDateFormat hook throughout the application</name>
  <files>
    frontend/app/[locale]/(dashboard)/dashboard/loans/page.tsx
    frontend/app/[locale]/(dashboard)/dashboard/inventory/page.tsx
    frontend/app/[locale]/(dashboard)/dashboard/items/page.tsx
    frontend/app/[locale]/(dashboard)/dashboard/sync-history/page.tsx
    frontend/app/[locale]/(dashboard)/dashboard/imports/page.tsx
    frontend/components/dashboard/activity-feed.tsx
  </files>
  <action>
Search for all date formatting in the frontend and update to use useDateFormat hook.

Pattern to find: `format(`, `formatDate`, `formatDistanceToNow`, hardcoded date patterns

For each file, apply the pattern:

1. Import the hook:
```typescript
import { useDateFormat } from "@/lib/hooks/use-date-format";
```

2. Use it in the component:
```typescript
const { formatDate, formatDateTime } = useDateFormat();
```

3. Replace existing date formatting:
- `format(date, "yyyy-MM-dd")` -> `formatDate(date)`
- `format(date, "MM/dd/yy")` -> `formatDate(date)`
- `format(date, "yyyy-MM-dd HH:mm")` -> `formatDateTime(date)`

Files to update:

**loans/page.tsx** - Loan dates (borrowed_at, due_date, returned_at)
- Find table cells showing loan dates
- Replace with `formatDate(loan.due_date)` etc.

**inventory/page.tsx** - Any inventory dates
- Update any date columns in tables

**items/page.tsx** - Item creation/update dates
- Update any date displays

**sync-history/page.tsx** - Sync timestamps
- Use formatDateTime for these as they include time

**imports/page.tsx** - Import job dates
- Use formatDateTime for job timestamps

**activity-feed.tsx** - Event timestamps
- This uses formatDistanceToNow which is relative ("5 minutes ago") - KEEP AS IS
- Relative time is appropriate for activity feeds

Note: formatDistanceToNow is for relative time ("5 minutes ago") which is contextually different from absolute dates. Keep using it where relative time makes sense (activity feeds, recent actions). Use formatDate for absolute date displays (due dates, creation dates).

Only update ABSOLUTE date displays, not relative timestamps.
  </action>
  <verify>
Run: `cd frontend && bun run typecheck`
Run: `cd frontend && bun run build`
Build succeeds

Manual verification:
1. Go to Settings -> Date Format
2. Select "DD/MM/YYYY" format
3. Navigate to Loans page
4. Verify dates display in DD/MM/YYYY format
5. Return to Settings -> Date Format
6. Select "YYYY-MM-DD" format
7. Navigate to Loans page
8. Verify dates now display in YYYY-MM-DD format
  </verify>
  <done>
Date formatting uses useDateFormat hook throughout the app, dates display according to user preference
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `cd frontend && bun run typecheck` passes
2. `cd frontend && bun run build` succeeds
3. Settings page shows Date Format selector with three options
4. Each option shows preview with today's date in that format
5. Selecting a format saves immediately (radio button)
6. Format persists after page refresh
7. Loans page shows dates in selected format
8. Imports page shows dates in selected format
9. All date displays (except relative times) respect user format
</verification>

<success_criteria>
- useDateFormat hook provides formatDate function
- DateFormatSettings component shows radio options with previews
- Date format preference saves via /users/me/preferences endpoint
- At least 5 pages use the useDateFormat hook
- Dates display correctly in all three formats
- Activity feed keeps using relative time (formatDistanceToNow)
</success_criteria>

<output>
After completion, create `.planning/phases/27-account-settings/27-03-SUMMARY.md`
</output>
