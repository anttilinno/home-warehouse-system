---
phase: 27-account-settings
plan: 02
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - frontend/lib/api/auth.ts
  - frontend/components/settings/account-settings.tsx
  - frontend/components/settings/avatar-upload.tsx
  - frontend/app/[locale]/(dashboard)/dashboard/settings/page.tsx
  - frontend/components/dashboard/user-menu.tsx
  - frontend/messages/en.json
autonomous: true

must_haves:
  truths:
    - "User can view their current profile (name, email) on settings page"
    - "User can edit their full name and save changes"
    - "User can edit their email and save changes"
    - "User can upload an avatar image that displays immediately"
    - "User can remove their avatar"
    - "Avatar displays in user menu header after upload"
  artifacts:
    - path: "frontend/components/settings/account-settings.tsx"
      provides: "Profile editing form"
      min_lines: 80
    - path: "frontend/components/settings/avatar-upload.tsx"
      provides: "Avatar upload component with preview"
      min_lines: 60
    - path: "frontend/lib/api/auth.ts"
      provides: "API functions for profile and avatar"
      exports: ["authApi"]
  key_links:
    - from: "frontend/components/settings/account-settings.tsx"
      to: "frontend/lib/api/auth.ts"
      via: "authApi.updateProfile"
      pattern: "authApi\\.updateProfile"
    - from: "frontend/components/settings/avatar-upload.tsx"
      to: "frontend/lib/api/auth.ts"
      via: "authApi.uploadAvatar"
      pattern: "authApi\\.(uploadAvatar|deleteAvatar)"
---

<objective>
Build frontend account settings UI with profile editing and avatar upload

Purpose: Allow users to manage their profile information and personalize their account with an avatar image through an intuitive settings interface.

Output: AccountSettings component with profile form, AvatarUpload component with drag-and-drop, updated settings page, and avatar display in user menu.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-account-settings/27-RESEARCH.md
@.planning/phases/27-account-settings/27-01-SUMMARY.md

# Frontend patterns
@frontend/lib/api/auth.ts
@frontend/lib/contexts/auth-context.tsx
@frontend/app/[locale]/(dashboard)/dashboard/settings/page.tsx
@frontend/components/settings/notification-settings.tsx
@frontend/components/dashboard/user-menu.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend auth API with profile update and avatar operations</name>
  <files>
    frontend/lib/api/auth.ts
  </files>
  <action>
Update frontend/lib/api/auth.ts:

1. Update User interface to include avatar_url:
```typescript
export interface User {
  id: string;
  email: string;
  full_name: string;
  is_active: boolean;
  date_format: string;
  language: string;
  theme: string;
  avatar_url: string | null;  // ADD THIS
  created_at: string;
  updated_at: string;
}
```

2. Add UpdateProfileData interface:
```typescript
export interface UpdateProfileData {
  full_name?: string;
  email?: string;
}
```

3. Add new API functions to authApi object:
```typescript
updateProfile: async (data: UpdateProfileData): Promise<User> => {
  return apiClient.patch<User>("/users/me", data);
},

uploadAvatar: async (file: File): Promise<User> => {
  const formData = new FormData();
  formData.append("avatar", file);
  return apiClient.postForm<User>("/users/me/avatar", formData);
},

deleteAvatar: async (): Promise<void> => {
  await apiClient.delete("/users/me/avatar");
},
```

4. Add postForm method to apiClient if not exists (in frontend/lib/api/client.ts):
```typescript
postForm: async <T>(url: string, formData: FormData): Promise<T> => {
  const response = await fetch(`${API_URL}${url}`, {
    method: "POST",
    headers: {
      Authorization: `Bearer ${getToken()}`,
      // Note: Do NOT set Content-Type - browser sets it with boundary for multipart
    },
    credentials: "include",
    body: formData,
  });
  // ... handle response
}
```
  </action>
  <verify>
Run: `cd frontend && bun run typecheck`
No TypeScript errors
  </verify>
  <done>
Auth API extended with updateProfile, uploadAvatar, and deleteAvatar functions. User type includes avatar_url.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AccountSettings and AvatarUpload components</name>
  <files>
    frontend/components/settings/account-settings.tsx
    frontend/components/settings/avatar-upload.tsx
    frontend/messages/en.json
  </files>
  <action>
Create frontend/components/settings/avatar-upload.tsx:
```typescript
"use client";

import { useState, useRef, useCallback } from "react";
import { useTranslations } from "next-intl";
import { Upload, X, Camera, Loader2 } from "lucide-react";
import { Avatar, AvatarImage, AvatarFallback } from "@/components/ui/avatar";
import { Button } from "@/components/ui/button";
import { authApi } from "@/lib/api/auth";
import { useAuth } from "@/lib/contexts/auth-context";
import { toast } from "sonner";

interface AvatarUploadProps {
  onUpdate?: () => void;
}

export function AvatarUpload({ onUpdate }: AvatarUploadProps) {
  const t = useTranslations("settings.account.avatar");
  const { user, refreshUser } = useAuth();
  const [isUploading, setIsUploading] = useState(false);
  const [isDeleting, setIsDeleting] = useState(false);
  const [isDragging, setIsDragging] = useState(false);
  const fileInputRef = useRef<HTMLInputElement>(null);

  const initials = user?.full_name
    ?.split(" ")
    .map((n) => n[0])
    .join("")
    .toUpperCase()
    .slice(0, 2) || "??";

  const handleFile = useCallback(async (file: File) => {
    // Validate file type
    if (!["image/jpeg", "image/png", "image/webp"].includes(file.type)) {
      toast.error(t("invalidType"));
      return;
    }
    // Validate file size (2MB max)
    if (file.size > 2 * 1024 * 1024) {
      toast.error(t("tooLarge"));
      return;
    }

    setIsUploading(true);
    try {
      await authApi.uploadAvatar(file);
      await refreshUser();
      onUpdate?.();
      toast.success(t("uploadSuccess"));
    } catch (error) {
      toast.error(t("uploadError"));
    } finally {
      setIsUploading(false);
    }
  }, [t, refreshUser, onUpdate]);

  const handleDelete = async () => {
    setIsDeleting(true);
    try {
      await authApi.deleteAvatar();
      await refreshUser();
      onUpdate?.();
      toast.success(t("deleteSuccess"));
    } catch (error) {
      toast.error(t("deleteError"));
    } finally {
      setIsDeleting(false);
    }
  };

  // ... drag and drop handlers, file input, render
  // Include:
  // - Avatar preview (current or new)
  // - Upload button/drop zone
  // - Remove button (if avatar exists)
  // - Loading states
}
```

Create frontend/components/settings/account-settings.tsx:
```typescript
"use client";

import { useTranslations } from "next-intl";
import { User } from "lucide-react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { authApi } from "@/lib/api/auth";
import { useAuth } from "@/lib/contexts/auth-context";
import { AvatarUpload } from "./avatar-upload";
import { toast } from "sonner";
import { useState } from "react";

const profileSchema = z.object({
  full_name: z.string().min(1, "Name is required").max(100),
  email: z.string().email("Invalid email address"),
});

type ProfileFormValues = z.infer<typeof profileSchema>;

export function AccountSettings() {
  const t = useTranslations("settings.account");
  const { user, refreshUser } = useAuth();
  const [isSubmitting, setIsSubmitting] = useState(false);

  const form = useForm<ProfileFormValues>({
    resolver: zodResolver(profileSchema),
    defaultValues: {
      full_name: user?.full_name || "",
      email: user?.email || "",
    },
  });

  const onSubmit = async (data: ProfileFormValues) => {
    setIsSubmitting(true);
    try {
      await authApi.updateProfile(data);
      await refreshUser();
      toast.success(t("saved"));
    } catch (error) {
      toast.error(t("saveError"));
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <User className="h-5 w-5" />
          {t("title")}
        </CardTitle>
        <CardDescription>{t("description")}</CardDescription>
      </CardHeader>
      <CardContent className="space-y-6">
        {/* Avatar Upload Section */}
        <div className="flex flex-col items-center sm:flex-row sm:items-start gap-6">
          <AvatarUpload />
          <div className="flex-1 space-y-4 w-full">
            {/* Profile Form */}
            <Form {...form}>
              <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
                <FormField
                  control={form.control}
                  name="full_name"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>{t("fullName")}</FormLabel>
                      <FormControl>
                        <Input {...field} className="min-h-[44px]" />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
                <FormField
                  control={form.control}
                  name="email"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>{t("email")}</FormLabel>
                      <FormControl>
                        <Input {...field} type="email" className="min-h-[44px]" />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
                <Button type="submit" disabled={isSubmitting}>
                  {isSubmitting ? t("saving") : t("save")}
                </Button>
              </form>
            </Form>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
```

Add translations to frontend/messages/en.json under settings.account:
```json
{
  "settings": {
    "account": {
      "title": "Account",
      "description": "Manage your profile information",
      "fullName": "Full Name",
      "email": "Email Address",
      "save": "Save Changes",
      "saving": "Saving...",
      "saved": "Profile updated successfully",
      "saveError": "Failed to update profile",
      "avatar": {
        "title": "Profile Photo",
        "upload": "Upload Photo",
        "change": "Change Photo",
        "remove": "Remove",
        "dropHere": "Drop image here or click to upload",
        "invalidType": "Please upload a JPEG, PNG, or WebP image",
        "tooLarge": "Image must be less than 2MB",
        "uploadSuccess": "Avatar updated",
        "uploadError": "Failed to upload avatar",
        "deleteSuccess": "Avatar removed",
        "deleteError": "Failed to remove avatar"
      }
    }
  }
}
```
  </action>
  <verify>
Run: `cd frontend && bun run typecheck`
Run: `cd frontend && bun run lint`
No errors
  </verify>
  <done>
AccountSettings component with profile form created, AvatarUpload component with drag-drop created, translations added
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate account settings into settings page and user menu avatar</name>
  <files>
    frontend/app/[locale]/(dashboard)/dashboard/settings/page.tsx
    frontend/components/dashboard/user-menu.tsx
  </files>
  <action>
Update frontend/app/[locale]/(dashboard)/dashboard/settings/page.tsx:
- Import AccountSettings component
- Replace the placeholder "Account" Card (the one with opacity-50 and "Coming Soon") with the real AccountSettings component
- Keep the Security card as placeholder for Phase 28

```typescript
import { AccountSettings } from "@/components/settings/account-settings";

// In the grid, replace the Account placeholder card with:
<AccountSettings />
```

Update frontend/components/dashboard/user-menu.tsx:
- Update the Avatar component to use user.avatar_url when available
- Keep initials as fallback

Find the Avatar usage in user-menu.tsx and update:
```typescript
<Avatar className="h-8 w-8">
  <AvatarImage
    src={user?.avatar_url || undefined}
    alt={user?.full_name || "User"}
  />
  <AvatarFallback className="text-xs">{initials}</AvatarFallback>
</Avatar>
```

Note: The Avatar component from shadcn/ui already handles the fallback gracefully when src is undefined or fails to load.
  </action>
  <verify>
Run: `cd frontend && bun run build`
Build succeeds without errors
Run dev server and manually verify:
1. Settings page shows AccountSettings card (not placeholder)
2. Profile form displays current name and email
3. Form validates and submits
4. Avatar upload works
5. User menu shows avatar after upload
  </verify>
  <done>
Settings page shows real AccountSettings, user menu displays uploaded avatar, profile editing works end-to-end
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `cd frontend && bun run typecheck` passes
2. `cd frontend && bun run lint` passes
3. `cd frontend && bun run build` succeeds
4. Settings page at /dashboard/settings shows Account Settings card
5. User can edit name and email, save succeeds
6. User can upload avatar, preview shows immediately
7. User can remove avatar
8. Avatar appears in top-right user menu after upload
9. Avatar persists across page refreshes
</verification>

<success_criteria>
- AccountSettings component renders profile form with name and email
- AvatarUpload component supports drag-drop and click-to-upload
- Form validation works (name required, email format)
- API calls succeed for profile update and avatar operations
- User menu shows avatar image when set
- All states have loading indicators
- Error messages display via toast
</success_criteria>

<output>
After completion, create `.planning/phases/27-account-settings/27-02-SUMMARY.md`
</output>
