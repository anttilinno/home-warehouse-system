---
phase: 27-account-settings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/db/migrations/010_user_avatar.sql
  - backend/db/queries/users.sql
  - backend/db/sqlc/models.go
  - backend/db/sqlc/users.sql.go
  - backend/internal/domain/auth/user/entity.go
  - backend/internal/domain/auth/user/service.go
  - backend/internal/domain/auth/user/repository.go
  - backend/internal/domain/auth/user/handler.go
  - backend/cmd/server/main.go
autonomous: true

must_haves:
  truths:
    - "User profile includes avatar_path field"
    - "User can update their email via PATCH /users/me"
    - "User can upload avatar via POST /users/me/avatar"
    - "User can delete avatar via DELETE /users/me/avatar"
    - "Avatar is served at GET /users/me/avatar"
  artifacts:
    - path: "backend/db/migrations/010_user_avatar.sql"
      provides: "avatar_path column migration"
      contains: "avatar_path"
    - path: "backend/internal/domain/auth/user/handler.go"
      provides: "Avatar upload/serve/delete endpoints"
      exports: ["RegisterProtectedRoutes"]
  key_links:
    - from: "backend/internal/domain/auth/user/handler.go"
      to: "backend/internal/domain/warehouse/itemphoto"
      via: "Storage interface reuse"
      pattern: "Storage"
---

<objective>
Add avatar support and email update to user backend

Purpose: Enable users to personalize their profile with an avatar image and update their email address. This provides the backend foundation for the account settings UI.

Output: Database migration for avatar_path, extended user entity, avatar upload/serve/delete endpoints, and email update in profile endpoint.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-account-settings/27-RESEARCH.md

# Key existing patterns
@backend/internal/domain/auth/user/handler.go
@backend/internal/domain/auth/user/entity.go
@backend/internal/domain/auth/user/service.go
@backend/internal/domain/warehouse/itemphoto/handler.go
@backend/internal/domain/warehouse/itemphoto/storage.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration and sqlc updates for avatar_path</name>
  <files>
    backend/db/migrations/010_user_avatar.sql
    backend/db/queries/users.sql
  </files>
  <action>
Create migration 010_user_avatar.sql:
```sql
-- migrate:up
ALTER TABLE auth.users ADD COLUMN avatar_path VARCHAR(500);

COMMENT ON COLUMN auth.users.avatar_path IS
'Storage path to user avatar image. Null if user has no custom avatar.';

-- migrate:down
ALTER TABLE auth.users DROP COLUMN avatar_path;
```

Update backend/db/queries/users.sql to add:
1. UpdateUserAvatar query - sets avatar_path for a user
2. UpdateUserEmail query - updates email address for a user
3. Update existing GetUserByID, GetUserByEmail queries to include avatar_path in SELECT
4. Update UpdateUser and UpdateUserPreferences to include avatar_path in RETURNING

Run `mise run sqlc` to regenerate Go code.
Run `mise run migrate` to apply the migration.
  </action>
  <verify>
Run: `mise run sqlc && mise run migrate`
Check that backend/db/sqlc/models.go includes AvatarPath field in User struct
Check that backend/db/sqlc/users.sql.go has UpdateUserAvatar and UpdateUserEmail functions
  </verify>
  <done>
Migration applied, sqlc code regenerated with avatar_path support in all user queries
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend user entity and service with avatar and email update</name>
  <files>
    backend/internal/domain/auth/user/entity.go
    backend/internal/domain/auth/user/service.go
    backend/internal/domain/auth/user/repository.go
  </files>
  <action>
Update entity.go:
- Add avatarPath *string field to User struct
- Add AvatarPath() *string getter method
- Add UpdateAvatar(path *string) method
- Update NewUser and newUserFromDB to handle avatar_path

Update service.go:
- Add UpdateAvatar(ctx, userID, avatarPath *string) (*User, error) method
- Update UpdateProfile to accept optional email field
- Add UpdateEmail(ctx, userID uuid.UUID, newEmail string) (*User, error) method with validation

Update repository.go:
- Add UpdateAvatar(ctx, id uuid.UUID, path *string) (*User, error) method using sqlc UpdateUserAvatar
- Add UpdateEmail(ctx, id uuid.UUID, email string) (*User, error) method using sqlc UpdateUserEmail
- Update existing mapping functions to include avatarPath

Update ServiceInterface in interface.go (if exists) or service.go to include new methods.

Note: Email update does NOT require current password in this phase (per research - verification deferred to future phase). Just validate email format.
  </action>
  <verify>
Run: `cd backend && go build ./...`
Verify no compilation errors
  </verify>
  <done>
User entity includes avatarPath field with getter/setter, service has UpdateAvatar and UpdateEmail methods
  </done>
</task>

<task type="auto">
  <name>Task 3: Add avatar upload/serve/delete endpoints and email in profile update</name>
  <files>
    backend/internal/domain/auth/user/handler.go
    backend/cmd/server/main.go
  </files>
  <action>
Update handler.go:

1. Update Handler struct to include Storage interface (reuse from itemphoto):
```go
type Handler struct {
    svc          ServiceInterface
    jwtService   jwt.ServiceInterface
    workspaceSvc workspace.ServiceInterface
    storage      itemphoto.Storage  // Add storage for avatars
}
```

2. Update NewHandler to accept storage parameter

3. Update UpdateMeInput to accept optional email:
```go
type UpdateMeInput struct {
    Body struct {
        FullName string  `json:"full_name,omitempty"`
        Email    string  `json:"email,omitempty" format:"email"`
    }
}
```

4. Update updateMe handler to handle email update (validate email format, call service)

5. Update UserResponse to include avatar_url field:
```go
type UserResponse struct {
    // ... existing fields
    AvatarURL *string `json:"avatar_url,omitempty"`
}
```

6. Add avatar URL generation helper that constructs /users/me/avatar URL when avatarPath is set

7. Add new handlers for avatar operations:

POST /users/me/avatar - UploadAvatarHandler
- Accept multipart form with "avatar" file field
- Validate file type (JPEG, PNG, WebP only)
- Validate file size (max 2MB)
- Save to storage in avatars/{user_id}/{filename} path
- Generate 150x150 thumbnail using disintegration/imaging (square crop from center)
- Store thumbnail path in database (thumbnail is what we serve)
- Update user avatarPath via service
- Return updated user response

GET /users/me/avatar - ServeAvatarHandler
- Get user from context
- If no avatar_path, return 404
- Serve file from storage with cache headers (1 year, immutable)

DELETE /users/me/avatar - DeleteAvatarHandler
- Get user from context
- Delete file from storage
- Set avatarPath to nil
- Return 204

Register new routes in RegisterProtectedRoutes using Chi router for multipart handling (like itemphoto does).

Update cmd/server/main.go:
- Pass storage instance to NewHandler
- Ensure avatar routes are registered on the protected router
  </action>
  <verify>
Run: `cd backend && go build ./...`
Run: `mise run dev` and test endpoints:
- curl -X PATCH http://localhost:8000/users/me -d '{"email":"new@example.com"}' (with auth)
- File upload test will be verified in integration
  </verify>
  <done>
Avatar upload/serve/delete endpoints added, email update added to profile endpoint, UserResponse includes avatar_url
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `mise run migrate` succeeds with 010_user_avatar.sql applied
2. `cd backend && go build ./...` compiles without errors
3. `mise run test-unit` passes (no regressions)
4. API endpoints respond correctly:
   - GET /users/me returns user with avatar_url field (null if no avatar)
   - PATCH /users/me with email field updates email
   - POST /users/me/avatar accepts file upload (multipart)
   - GET /users/me/avatar serves avatar image or 404
   - DELETE /users/me/avatar removes avatar
</verification>

<success_criteria>
- Database has avatar_path column in auth.users
- User entity and service support avatar operations
- Profile update supports email change
- Avatar upload endpoint saves and processes images
- Avatar is served with proper cache headers
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/27-account-settings/27-01-SUMMARY.md`
</output>
