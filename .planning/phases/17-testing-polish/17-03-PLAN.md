---
phase: 17-testing-polish
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/internal/domain/warehouse/inventory/handler_test.go
  - backend/internal/domain/warehouse/favorite/handler_test.go
  - backend/internal/domain/warehouse/attachment/handler_test.go
autonomous: true

must_haves:
  truths:
    - "Inventory handler SSE events are verified by tests (all operations emit inventory.updated)"
    - "Favorite handler SSE toggle event is verified by tests"
    - "Attachment handler SSE events are verified by tests (including primary_changed)"
  artifacts:
    - path: "backend/internal/domain/warehouse/inventory/handler_test.go"
      provides: "SSE event tests for inventory CRUD and special operations"
      contains: "TestInventoryHandler_Create_PublishesEvent"
    - path: "backend/internal/domain/warehouse/favorite/handler_test.go"
      provides: "SSE event test for favorite toggle"
      contains: "TestFavoriteHandler_Toggle_PublishesEvent"
    - path: "backend/internal/domain/warehouse/attachment/handler_test.go"
      provides: "SSE event tests for attachment operations"
      contains: "TestAttachmentHandler_Create_PublishesEvent"
  key_links:
    - from: "handler_test.go files"
      to: "testutil.EventCapture"
      via: "NewEventCapture, Start, Stop, WaitForEvents"
      pattern: "testutil\\.NewEventCapture"
---

<objective>
Add SSE event publishing tests to inventory, favorite, and attachment handlers

Purpose: Verify that complex entity operations publish correct SSE events for real-time UI updates
Output: 14 new test functions covering SSE event publishing for 3 handlers with special operations
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-testing-polish/17-RESEARCH.md

# Reference patterns
@backend/internal/domain/warehouse/item/handler_test.go (SSE test pattern)
@backend/internal/testutil/event_capture.go (EventCapture utility)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SSE tests to inventory handler</name>
  <files>backend/internal/domain/warehouse/inventory/handler_test.go</files>
  <action>
Add SSE event publishing tests to the inventory handler test file:

1. Add required imports if missing: `"time"`, `"github.com/stretchr/testify/assert"`

2. Add test functions at end of file (8 tests total):

- `TestInventoryHandler_Create_PublishesEvent`: Create inventory, verify `inventory.created` event

- `TestInventoryHandler_Update_PublishesEvent`: Update inventory, verify `inventory.updated` event

- `TestInventoryHandler_UpdateStatus_PublishesEvent`: Update status, verify `inventory.updated` event (NOT status_changed - handler emits updated with status in Data)

- `TestInventoryHandler_UpdateQuantity_PublishesEvent`: Update quantity, verify `inventory.updated` event (NOT quantity_changed - handler emits updated with quantity in Data)

- `TestInventoryHandler_Move_PublishesEvent`: Move inventory, verify `inventory.updated` event (NOT moved - handler emits updated with location data in Data)

- `TestInventoryHandler_Archive_PublishesEvent`: Archive inventory, verify `inventory.deleted` event

- `TestInventoryHandler_Restore_PublishesEvent`: Restore inventory, verify `inventory.created` event (restore emits created)

- `TestInventoryHandler_Create_NilBroadcaster_NoError`: Nil broadcaster safety test

IMPORTANT: The inventory handler emits `inventory.updated` for ALL of UpdateStatus, UpdateQuantity, and Move operations. There are NO specialized event types like `inventory.status_changed`, `inventory.quantity_changed`, or `inventory.moved`. The Data field contains the operation-specific details. Verify by checking inventory/handler.go.

Inventory factory example:
```go
itemID := uuid.New()
locationID := uuid.New()
testInv, _ := inventory.NewInventory(setup.WorkspaceID, itemID, locationID, nil, 10, inventory.ConditionNew, inventory.StatusAvailable, nil, nil, nil)
```

Mock patterns for special operations:
- UpdateStatus: `mockSvc.On("UpdateStatus", mock.Anything, invID, setup.WorkspaceID, inventory.StatusInUse).Return(testInv, nil).Once()`
- UpdateQuantity: `mockSvc.On("UpdateQuantity", mock.Anything, invID, setup.WorkspaceID, 5).Return(testInv, nil).Once()`
- Move: `mockSvc.On("Move", mock.Anything, invID, setup.WorkspaceID, newLocID, mock.Anything).Return(testInv, nil).Once()`
  </action>
  <verify>Run `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/warehouse/inventory/... -run "PublishesEvent|NilBroadcaster" -v` - all 8 tests pass</verify>
  <done>Inventory handler has 8 SSE tests: create, update, status update (updated event), quantity update (updated event), move (updated event), archive, restore events plus nil broadcaster safety</done>
</task>

<task type="auto">
  <name>Task 2: Add SSE tests to favorite handler</name>
  <files>backend/internal/domain/warehouse/favorite/handler_test.go</files>
  <action>
Add SSE event publishing tests to the favorite handler test file:

1. Add required imports if missing: `"time"`, `"github.com/stretchr/testify/assert"`

2. Add test functions at end of file (2 tests total):

- `TestFavoriteHandler_Toggle_PublishesEvent`: Toggle favorite, verify `favorite.toggled` event with Data containing `item_id` and `is_favorite`

- `TestFavoriteHandler_Toggle_NilBroadcaster_NoError`: Nil broadcaster safety test

Check favorite/handler.go for exact event structure. Favorite only has toggle operation.

The toggle endpoint returns the new favorite state. Mock pattern:
```go
result := &favorite.Favorite{ItemID: itemID, IsFavorite: true}
mockSvc.On("Toggle", mock.Anything, setup.WorkspaceID, setup.UserID, itemID).Return(result, nil).Once()
```

Route: POST `/items/{id}/favorite`
  </action>
  <verify>Run `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/warehouse/favorite/... -run "PublishesEvent|NilBroadcaster" -v` - all 2 tests pass</verify>
  <done>Favorite handler has 2 SSE tests: toggle event plus nil broadcaster safety</done>
</task>

<task type="auto">
  <name>Task 3: Add SSE tests to attachment handler</name>
  <files>backend/internal/domain/warehouse/attachment/handler_test.go</files>
  <action>
Add SSE event publishing tests to the attachment handler test file:

1. Add required imports if missing: `"time"`, `"github.com/stretchr/testify/assert"`

2. Add test functions at end of file (5 tests total):

- `TestAttachmentHandler_Create_PublishesEvent`: Upload attachment, verify `attachment.created` event

- `TestAttachmentHandler_SetPrimary_PublishesEvent`: Set primary attachment, verify `attachment.primary_changed` event

- `TestAttachmentHandler_Delete_PublishesEvent`: Delete attachment, verify `attachment.deleted` event

- `TestAttachmentHandler_Create_NilBroadcaster_NoError`: Nil broadcaster safety test

Check attachment/handler.go for exact event types. Attachment has item_id as parent entity reference.

Note: Attachment upload may need multipart form data. Check existing attachment tests for the correct request format. If upload is complex, test can focus on the mock service returning successfully and verifying the event gets published.

For simpler testing, mock the service to return a created attachment:
```go
testAttachment := &attachment.Attachment{
    ID: uuid.New(),
    ItemID: itemID,
    // ... other fields
}
mockSvc.On("Create", mock.Anything, mock.Anything).Return(testAttachment, nil).Once()
```
  </action>
  <verify>Run `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/warehouse/attachment/... -run "PublishesEvent|NilBroadcaster" -v` - all tests pass</verify>
  <done>Attachment handler has SSE tests: create, primary_changed, delete events plus nil broadcaster safety</done>
</task>

</tasks>

<verification>
Run all new SSE tests together:
```bash
cd /home/antti/Repos/Misc/home-warehouse-system/backend
go test ./internal/domain/warehouse/inventory/... ./internal/domain/warehouse/favorite/... ./internal/domain/warehouse/attachment/... -run "PublishesEvent|NilBroadcaster" -v
```

Expected: All 14+ new tests pass (8 inventory + 2 favorite + 4+ attachment)
</verification>

<success_criteria>
- 8 SSE tests added to inventory handler (create, update, status->updated, quantity->updated, move->updated, archive, restore + nil safety)
- 2 SSE tests added to favorite handler (toggle + nil safety)
- 4+ SSE tests added to attachment handler (create, primary_changed, delete + nil safety)
- All tests verify event Type, EntityType, WorkspaceID, UserID, EntityID
- All tests use 500ms timeout for WaitForEvents (CI-friendly)
- No regressions in existing handler tests
</success_criteria>

<output>
After completion, create `.planning/phases/17-testing-polish/17-03-SUMMARY.md`
</output>
