---
phase: 17-testing-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/internal/domain/warehouse/borrower/handler_test.go
  - backend/internal/domain/warehouse/company/handler_test.go
  - backend/internal/domain/warehouse/label/handler_test.go
autonomous: true

must_haves:
  truths:
    - "Borrower handler SSE events are verified by tests"
    - "Company handler SSE events are verified by tests"
    - "Label handler SSE events are verified by tests"
  artifacts:
    - path: "backend/internal/domain/warehouse/borrower/handler_test.go"
      provides: "SSE event tests for borrower CRUD"
      contains: "TestBorrowerHandler_Create_PublishesEvent"
    - path: "backend/internal/domain/warehouse/company/handler_test.go"
      provides: "SSE event tests for company CRUD"
      contains: "TestCompanyHandler_Create_PublishesEvent"
    - path: "backend/internal/domain/warehouse/label/handler_test.go"
      provides: "SSE event tests for label CRUD"
      contains: "TestLabelHandler_Create_PublishesEvent"
  key_links:
    - from: "handler_test.go files"
      to: "testutil.EventCapture"
      via: "NewEventCapture, Start, Stop, WaitForEvents"
      pattern: "testutil\\.NewEventCapture"
---

<objective>
Add SSE event publishing tests to borrower, company, and label handlers

Purpose: Verify that create/update/delete operations publish correct SSE events for real-time UI updates
Output: 12 new test functions covering SSE event publishing for 3 handlers
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-testing-polish/17-RESEARCH.md

# Reference patterns
@backend/internal/domain/warehouse/item/handler_test.go (SSE test pattern)
@backend/internal/testutil/event_capture.go (EventCapture utility)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SSE tests to borrower handler</name>
  <files>backend/internal/domain/warehouse/borrower/handler_test.go</files>
  <action>
Add SSE event publishing tests to the borrower handler test file:

1. Add required imports: `"time"`, `"github.com/stretchr/testify/assert"`

2. Add test functions at end of file (4 tests total):

- `TestBorrowerHandler_Create_PublishesEvent`: Create borrower, verify `borrower.created` event with correct WorkspaceID, UserID, EntityID, EntityType, and Data fields (id, name)

- `TestBorrowerHandler_Update_PublishesEvent`: Update borrower, verify `borrower.updated` event

- `TestBorrowerHandler_Delete_PublishesEvent`: Delete/Archive borrower, verify `borrower.deleted` event

- `TestBorrowerHandler_Create_NilBroadcaster_NoError`: Verify handler works without crashing when broadcaster is nil

Follow the exact pattern from item/handler_test.go:
```go
capture := testutil.NewEventCapture(setup.WorkspaceID, setup.UserID)
capture.Start()
defer capture.Stop()
borrower.RegisterRoutes(setup.API, mockSvc, capture.GetBroadcaster())
// ... make request ...
assert.True(t, capture.WaitForEvents(1, 500*time.Millisecond))
event := capture.GetLastEvent()
assert.Equal(t, "borrower.created", event.Type)
```
  </action>
  <verify>Run `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/warehouse/borrower/... -run "PublishesEvent|NilBroadcaster" -v` - all 4 tests pass</verify>
  <done>Borrower handler has 4 SSE tests: create, update, delete events plus nil broadcaster safety</done>
</task>

<task type="auto">
  <name>Task 2: Add SSE tests to company handler</name>
  <files>backend/internal/domain/warehouse/company/handler_test.go</files>
  <action>
Add SSE event publishing tests to the company handler test file:

1. Add required imports if missing: `"time"`, `"github.com/stretchr/testify/assert"`

2. Add test functions at end of file (5 tests total):

- `TestCompanyHandler_Create_PublishesEvent`: Create company, verify `company.created` event

- `TestCompanyHandler_Update_PublishesEvent`: Update company, verify `company.updated` event

- `TestCompanyHandler_Archive_PublishesEvent`: Archive company, verify `company.deleted` event (archive emits deleted, not archived)

- `TestCompanyHandler_Restore_PublishesEvent`: Restore company, verify `company.created` event (restore emits created, not restored)

- `TestCompanyHandler_Create_NilBroadcaster_NoError`: Nil broadcaster safety test

IMPORTANT: The company handler emits `company.deleted` for archive and `company.created` for restore - NOT `company.archived`/`company.restored`. Verify by checking company/handler.go.

Follow same EventCapture pattern as Task 1.
  </action>
  <verify>Run `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/warehouse/company/... -run "PublishesEvent|NilBroadcaster" -v` - all 5 tests pass</verify>
  <done>Company handler has 5 SSE tests: create, update, archive (deleted event), restore (created event) plus nil broadcaster safety</done>
</task>

<task type="auto">
  <name>Task 3: Add SSE tests to label handler</name>
  <files>backend/internal/domain/warehouse/label/handler_test.go</files>
  <action>
Add SSE event publishing tests to the label handler test file:

1. Add required imports if missing: `"time"`, `"github.com/stretchr/testify/assert"`

2. Add test functions at end of file (5 tests total):

- `TestLabelHandler_Create_PublishesEvent`: Create label, verify `label.created` event

- `TestLabelHandler_Update_PublishesEvent`: Update label, verify `label.updated` event

- `TestLabelHandler_Archive_PublishesEvent`: Archive label, verify `label.deleted` event (archive emits deleted, not archived)

- `TestLabelHandler_Restore_PublishesEvent`: Restore label, verify `label.created` event (restore emits created, not restored)

- `TestLabelHandler_Create_NilBroadcaster_NoError`: Nil broadcaster safety test

IMPORTANT: The label handler emits `label.deleted` for archive and `label.created` for restore - NOT `label.archived`/`label.restored`. Verify by checking label/handler.go.

Labels have color field in their data.

Follow same EventCapture pattern as previous tasks.
  </action>
  <verify>Run `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/warehouse/label/... -run "PublishesEvent|NilBroadcaster" -v` - all 5 tests pass</verify>
  <done>Label handler has 5 SSE tests: create, update, archive (deleted event), restore (created event) plus nil broadcaster safety</done>
</task>

</tasks>

<verification>
Run all new SSE tests together:
```bash
cd /home/antti/Repos/Misc/home-warehouse-system/backend
go test ./internal/domain/warehouse/borrower/... ./internal/domain/warehouse/company/... ./internal/domain/warehouse/label/... -run "PublishesEvent|NilBroadcaster" -v
```

Expected: All 14 new tests pass (4 borrower + 5 company + 5 label)
</verification>

<success_criteria>
- 4 SSE tests added to borrower handler (create, update, delete + nil safety)
- 5 SSE tests added to company handler (create, update, archive->deleted, restore->created + nil safety)
- 5 SSE tests added to label handler (create, update, archive->deleted, restore->created + nil safety)
- All tests verify event Type, EntityType, WorkspaceID, UserID, EntityID
- All tests use 500ms timeout for WaitForEvents (CI-friendly)
- No regressions in existing handler tests
</success_criteria>

<output>
After completion, create `.planning/phases/17-testing-polish/17-01-SUMMARY.md`
</output>
