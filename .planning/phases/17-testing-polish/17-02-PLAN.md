---
phase: 17-testing-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/internal/domain/warehouse/location/handler_test.go
  - backend/internal/domain/warehouse/container/handler_test.go
  - backend/internal/domain/warehouse/category/handler_test.go
autonomous: true

must_haves:
  truths:
    - "Location handler SSE events are verified by tests"
    - "Container handler SSE events are verified by tests"
    - "Category handler SSE events are verified by tests"
  artifacts:
    - path: "backend/internal/domain/warehouse/location/handler_test.go"
      provides: "SSE event tests for location CRUD with archive/restore"
      contains: "TestLocationHandler_Create_PublishesEvent"
    - path: "backend/internal/domain/warehouse/container/handler_test.go"
      provides: "SSE event tests for container CRUD with archive/restore"
      contains: "TestContainerHandler_Create_PublishesEvent"
    - path: "backend/internal/domain/warehouse/category/handler_test.go"
      provides: "SSE event tests for category CRUD with archive/restore"
      contains: "TestCategoryHandler_Create_PublishesEvent"
  key_links:
    - from: "handler_test.go files"
      to: "testutil.EventCapture"
      via: "NewEventCapture, Start, Stop, WaitForEvents"
      pattern: "testutil\\.NewEventCapture"
---

<objective>
Add SSE event publishing tests to location, container, and category handlers

Purpose: Verify that hierarchical entity CRUD operations (including archive/restore) publish correct SSE events
Output: 18 new test functions covering SSE event publishing for 3 hierarchical handlers
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-testing-polish/17-RESEARCH.md

# Reference patterns
@backend/internal/domain/warehouse/item/handler_test.go (SSE test pattern)
@backend/internal/testutil/event_capture.go (EventCapture utility)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SSE tests to location handler</name>
  <files>backend/internal/domain/warehouse/location/handler_test.go</files>
  <action>
Add SSE event publishing tests to the location handler test file:

1. Add required imports if missing: `"time"`, `"github.com/stretchr/testify/assert"`

2. Add test functions at end of file (6 tests total):

- `TestLocationHandler_Create_PublishesEvent`: Create location, verify `location.created` event with WorkspaceID, UserID, EntityID, EntityType="location", and Data (id, name, short_code)

- `TestLocationHandler_Update_PublishesEvent`: Update location, verify `location.updated` event

- `TestLocationHandler_Archive_PublishesEvent`: Archive location, verify `location.archived` event

- `TestLocationHandler_Restore_PublishesEvent`: Restore location, verify `location.restored` event

- `TestLocationHandler_Delete_PublishesEvent`: Hard delete location, verify `location.deleted` event

- `TestLocationHandler_Create_NilBroadcaster_NoError`: Nil broadcaster safety test

Check location/handler.go for exact event types and data fields. Location entity has NewLocation factory.

Pattern for each test:
```go
func TestLocationHandler_Create_PublishesEvent(t *testing.T) {
    setup := testutil.NewHandlerTestSetup()
    mockSvc := new(MockService)
    capture := testutil.NewEventCapture(setup.WorkspaceID, setup.UserID)
    capture.Start()
    defer capture.Stop()

    location.RegisterRoutes(setup.API, mockSvc, capture.GetBroadcaster())

    testLoc, _ := location.NewLocation(setup.WorkspaceID, "Warehouse", nil, nil, "WH-A")

    mockSvc.On("Create", mock.Anything, mock.MatchedBy(func(input location.CreateInput) bool {
        return input.Name == "Warehouse"
    })).Return(testLoc, nil).Once()

    body := `{"name":"Warehouse","short_code":"WH-A"}`
    rec := setup.Post("/locations", body)

    testutil.AssertStatus(t, rec, http.StatusOK)
    mockSvc.AssertExpectations(t)

    assert.True(t, capture.WaitForEvents(1, 500*time.Millisecond), "Event should be published")

    event := capture.GetLastEvent()
    assert.NotNil(t, event)
    assert.Equal(t, "location.created", event.Type)
    assert.Equal(t, "location", event.EntityType)
    assert.Equal(t, setup.WorkspaceID, event.WorkspaceID)
    assert.Equal(t, setup.UserID, event.UserID)
    assert.Equal(t, testLoc.ID().String(), event.EntityID)
}
```
  </action>
  <verify>Run `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/warehouse/location/... -run "PublishesEvent|NilBroadcaster" -v` - all 6 tests pass</verify>
  <done>Location handler has 6 SSE tests: create, update, archive, restore, delete events plus nil broadcaster safety</done>
</task>

<task type="auto">
  <name>Task 2: Add SSE tests to container handler</name>
  <files>backend/internal/domain/warehouse/container/handler_test.go</files>
  <action>
Add SSE event publishing tests to the container handler test file:

1. Add required imports if missing: `"time"`, `"github.com/stretchr/testify/assert"`

2. Add test functions at end of file (6 tests total):

- `TestContainerHandler_Create_PublishesEvent`: Create container, verify `container.created` event

- `TestContainerHandler_Update_PublishesEvent`: Update container, verify `container.updated` event

- `TestContainerHandler_Archive_PublishesEvent`: Archive container, verify `container.archived` event

- `TestContainerHandler_Restore_PublishesEvent`: Restore container, verify `container.restored` event

- `TestContainerHandler_Delete_PublishesEvent`: Hard delete container, verify `container.deleted` event

- `TestContainerHandler_Create_NilBroadcaster_NoError`: Nil broadcaster safety test

Check container/handler.go for exact event types. Container requires a location_id for creation - use uuid.New() for mock location ID.

Container factory: `container.NewContainer(workspaceID, locationID, "Box A", nil, nil, "BOX-A")`
  </action>
  <verify>Run `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/warehouse/container/... -run "PublishesEvent|NilBroadcaster" -v` - all 6 tests pass</verify>
  <done>Container handler has 6 SSE tests: create, update, archive, restore, delete events plus nil broadcaster safety</done>
</task>

<task type="auto">
  <name>Task 3: Add SSE tests to category handler</name>
  <files>backend/internal/domain/warehouse/category/handler_test.go</files>
  <action>
Add SSE event publishing tests to the category handler test file:

1. Add required imports if missing: `"time"`, `"github.com/stretchr/testify/assert"`

2. Add test functions at end of file (6 tests total):

- `TestCategoryHandler_Create_PublishesEvent`: Create category, verify `category.created` event

- `TestCategoryHandler_Update_PublishesEvent`: Update category, verify `category.updated` event

- `TestCategoryHandler_Archive_PublishesEvent`: Archive category, verify `category.archived` event

- `TestCategoryHandler_Restore_PublishesEvent`: Restore category, verify `category.restored` event

- `TestCategoryHandler_Delete_PublishesEvent`: Hard delete category, verify `category.deleted` event

- `TestCategoryHandler_Create_NilBroadcaster_NoError`: Nil broadcaster safety test

Check category/handler.go for exact event types. Category is hierarchical with optional parent_category_id.

Category factory: `category.NewCategory(workspaceID, "Electronics", nil, nil)` - (workspaceID, name, description, parentCategoryID)
  </action>
  <verify>Run `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/warehouse/category/... -run "PublishesEvent|NilBroadcaster" -v` - all 6 tests pass</verify>
  <done>Category handler has 6 SSE tests: create, update, archive, restore, delete events plus nil broadcaster safety</done>
</task>

</tasks>

<verification>
Run all new SSE tests together:
```bash
cd /home/antti/Repos/Misc/home-warehouse-system/backend
go test ./internal/domain/warehouse/location/... ./internal/domain/warehouse/container/... ./internal/domain/warehouse/category/... -run "PublishesEvent|NilBroadcaster" -v
```

Expected: All 18 new tests pass (6 location + 6 container + 6 category)
</verification>

<success_criteria>
- 6 SSE tests added to location handler (create, update, archive, restore, delete + nil safety)
- 6 SSE tests added to container handler (create, update, archive, restore, delete + nil safety)
- 6 SSE tests added to category handler (create, update, archive, restore, delete + nil safety)
- All tests verify event Type, EntityType, WorkspaceID, UserID, EntityID
- All tests use 500ms timeout for WaitForEvents (CI-friendly)
- No regressions in existing handler tests
</success_criteria>

<output>
After completion, create `.planning/phases/17-testing-polish/17-02-SUMMARY.md`
</output>
