---
phase: 17-testing-polish
plan: 04
type: execute
wave: 2
depends_on: ["17-01", "17-02", "17-03"]
files_modified:
  - docs/IMPORT_TESTING_CHECKLIST.md
autonomous: true

must_haves:
  truths:
    - "Import workflow has documented manual testing checklist"
    - "All handler tests pass without regressions"
    - "SSE tests across all 9 handlers pass"
  artifacts:
    - path: "docs/IMPORT_TESTING_CHECKLIST.md"
      provides: "Manual testing checklist for import workflow"
      contains: "Import Workflow Manual Testing Checklist"
  key_links:
    - from: "docs/IMPORT_TESTING_CHECKLIST.md"
      to: "import feature endpoints"
      via: "documented test scenarios"
      pattern: "/workspaces/.*/import"
---

<objective>
Create import workflow manual testing checklist and run full test suite to verify no regressions

Purpose: Document the import workflow testing process and validate Phase 17 test coverage completion
Output: Import testing checklist document and verified passing test suite
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-testing-polish/17-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create import workflow manual testing checklist</name>
  <files>docs/IMPORT_TESTING_CHECKLIST.md</files>
  <action>
Create a comprehensive manual testing checklist for the import workflow at `docs/IMPORT_TESTING_CHECKLIST.md`:

```markdown
# Import Workflow Manual Testing Checklist

This checklist documents manual testing procedures for the CSV import feature.

## Pre-requisites

- [ ] Backend server running (`mise run dev`)
- [ ] Worker process running (`mise run worker`)
- [ ] Redis running (`mise run dc-up`)
- [ ] PostgreSQL running
- [ ] Test workspace created with at least one user

## Test Environment Setup

1. Note your workspace ID: `________________`
2. Note your auth token (from login): `________________`
3. Base URL: `http://localhost:8000`

## Supported Entity Types

| Entity | Endpoint | Required Fields | Optional Fields |
|--------|----------|-----------------|-----------------|
| items | `/workspaces/{id}/import/items` | name, sku | description, brand, model, manufacturer |
| locations | `/workspaces/{id}/import/locations` | name | parent_location, description, short_code |
| containers | `/workspaces/{id}/import/containers` | name, location | description, capacity, short_code |
| categories | `/workspaces/{id}/import/categories` | name | parent_category, description |
| borrowers | `/workspaces/{id}/import/borrowers` | name | email, phone, notes |
| inventory | `/workspaces/{id}/import/inventory` | item, location, quantity | container, condition, status |

---

## Test 1: Items Import - Happy Path

**Objective:** Verify basic item import works correctly

**CSV Content:**
```csv
name,sku,description,brand
Test Item A,SKU-001,A test item,BrandX
Test Item B,SKU-002,Another test item,BrandY
Test Item C,SKU-003,Third test item,BrandZ
```

**Steps:**
1. [ ] Save CSV to file `test-items.csv`
2. [ ] POST to `/workspaces/{id}/import/items` with form data (file upload)
3. [ ] Verify response is 200 with job ID in response
4. [ ] Check worker logs show "Processing import job..."
5. [ ] Wait for job completion (check `/import-jobs/{jobId}`)
6. [ ] Verify job status is "completed"
7. [ ] Verify success_count = 3, error_count = 0
8. [ ] GET `/items` and verify all 3 items exist

**Result:** [ ] PASS / [ ] FAIL
**Notes:** ________________________________

---

## Test 2: Items Import - Validation Errors

**Objective:** Verify row-level validation errors are captured

**CSV Content:**
```csv
name,sku
,SKU-EMPTY-NAME
Valid Item,SKU-VALID
Another Valid,
```

**Steps:**
1. [ ] Import the CSV
2. [ ] Verify job completes with error_count > 0
3. [ ] Check import_errors for job (GET `/import-jobs/{jobId}/errors`)
4. [ ] Verify error for row 1 (empty name)
5. [ ] Verify error for row 3 (empty SKU)
6. [ ] Verify "Valid Item" was created successfully

**Result:** [ ] PASS / [ ] FAIL
**Notes:** ________________________________

---

## Test 3: Locations Import with Hierarchy

**Objective:** Verify parent-child location relationships

**CSV Content:**
```csv
name,short_code,parent_location
Main Warehouse,MW-1,
Shelf A,SH-A,Main Warehouse
Shelf B,SH-B,Main Warehouse
Bin 1,BN-1,Shelf A
```

**Steps:**
1. [ ] Import locations CSV
2. [ ] Verify job completes successfully
3. [ ] GET `/locations` and check structure:
   - Main Warehouse has no parent
   - Shelf A and Shelf B have parent = Main Warehouse ID
   - Bin 1 has parent = Shelf A ID
4. [ ] Verify breadcrumb API returns correct hierarchy

**Result:** [ ] PASS / [ ] FAIL
**Notes:** ________________________________

---

## Test 4: Inventory Import with References

**Objective:** Verify inventory links to existing items/locations

**Prerequisites:**
- Create items: "Test Product" (SKU: TP-001)
- Create locations: "Storage Room" (short_code: SR-1)

**CSV Content:**
```csv
item,location,quantity,condition,status
TP-001,SR-1,10,NEW,AVAILABLE
TP-001,SR-1,5,GOOD,IN_USE
```

**Steps:**
1. [ ] Create prerequisite items and locations
2. [ ] Import inventory CSV
3. [ ] Verify job completes successfully
4. [ ] GET inventory and verify:
   - Records linked to correct item ID
   - Records linked to correct location ID
   - Quantities match CSV
   - Conditions and statuses match

**Result:** [ ] PASS / [ ] FAIL
**Notes:** ________________________________

---

## Test 5: SSE Progress Events

**Objective:** Verify real-time progress updates during import

**Setup:** Prepare large CSV (50+ rows of items)

**Steps:**
1. [ ] Connect to SSE endpoint: `/workspaces/{id}/events`
2. [ ] Start import of large CSV in another terminal/tab
3. [ ] Observe SSE events in connected client
4. [ ] Verify `import.progress` events received
5. [ ] Verify progress percentage increases (0% -> 25% -> 50% -> 75% -> 100%)
6. [ ] Verify final event shows status = "completed"

**Result:** [ ] PASS / [ ] FAIL
**Notes:** ________________________________

---

## Test 6: Export-Import Round Trip

**Objective:** Verify data integrity through export/import cycle

**Steps:**
1. [ ] Create 5 items manually with various data
2. [ ] Export items: GET `/workspaces/{id}/export/items?format=csv`
3. [ ] Save exported CSV
4. [ ] Delete the 5 items
5. [ ] Import the exported CSV
6. [ ] Verify all 5 items restored with matching data
7. [ ] Compare field values (names, SKUs, etc.)

**Result:** [ ] PASS / [ ] FAIL
**Notes:** ________________________________

---

## Test 7: Error Handling

**Objective:** Verify appropriate error responses

### 7a: Invalid entity type
- [ ] POST to `/workspaces/{id}/import/invalid_entity`
- [ ] Verify 400 Bad Request with clear error message

### 7b: Malformed CSV
- [ ] Upload file with invalid CSV syntax (mismatched quotes)
- [ ] Verify job fails with parsing error

### 7c: Duplicate SKUs
- [ ] Import items with duplicate SKUs
- [ ] Verify first succeeds, duplicate fails with constraint error

### 7d: Missing required fields
- [ ] Import categories without name field
- [ ] Verify validation error in import_errors table

**Result:** [ ] PASS / [ ] FAIL
**Notes:** ________________________________

---

## Test 8: Concurrent Imports

**Objective:** Verify system handles multiple concurrent imports

**Steps:**
1. [ ] Start import of items CSV
2. [ ] Immediately start import of locations CSV
3. [ ] Verify both jobs complete successfully
4. [ ] Verify no data corruption or race conditions

**Result:** [ ] PASS / [ ] FAIL
**Notes:** ________________________________

---

## Summary

| Test | Status | Notes |
|------|--------|-------|
| 1. Items Happy Path | | |
| 2. Validation Errors | | |
| 3. Location Hierarchy | | |
| 4. Inventory References | | |
| 5. SSE Progress | | |
| 6. Export-Import Round Trip | | |
| 7. Error Handling | | |
| 8. Concurrent Imports | | |

**Tested By:** ________________
**Date:** ________________
**Overall Result:** [ ] ALL PASS / [ ] SOME FAILURES

---

## Appendix: API Reference

### Import Endpoint
```
POST /workspaces/{workspace_id}/import/{entity_type}
Content-Type: multipart/form-data

Form fields:
- file: CSV file
```

### Import Job Status
```
GET /import-jobs/{job_id}

Response:
{
  "id": "uuid",
  "status": "pending|processing|completed|failed",
  "entity_type": "items",
  "total_rows": 100,
  "processed_rows": 100,
  "success_count": 95,
  "error_count": 5,
  "progress": 100,
  "created_at": "timestamp",
  "completed_at": "timestamp"
}
```

### Import Errors
```
GET /import-jobs/{job_id}/errors

Response:
{
  "errors": [
    {
      "row_number": 5,
      "error": "name is required",
      "data": {"sku": "SKU-005"}
    }
  ]
}
```
```
  </action>
  <verify>File exists at `docs/IMPORT_TESTING_CHECKLIST.md` with comprehensive test scenarios</verify>
  <done>Import workflow manual testing checklist created with 8 test scenarios covering happy paths, errors, hierarchy, references, SSE events, and round-trip validation</done>
</task>

<task type="auto">
  <name>Task 2: Run full test suite and verify no regressions</name>
  <files></files>
  <action>
Run the complete backend test suite to verify all SSE tests pass and there are no regressions:

1. Run all handler tests (including new SSE tests):
```bash
cd /home/antti/Repos/Misc/home-warehouse-system/backend
go test ./internal/domain/warehouse/... -v -count=1 2>&1 | tee test-output.txt
```

2. Check for any failures in the output

3. Run specific SSE event tests to confirm all 9 handlers are covered:
```bash
go test ./internal/domain/warehouse/... -run "PublishesEvent" -v
```

4. Count total SSE tests - should be approximately:
   - item: 5 tests (existing)
   - loan: 4 tests (existing)
   - borrower: 4 tests (new)
   - company: 6 tests (new)
   - label: 6 tests (new)
   - location: 6 tests (new)
   - container: 6 tests (new)
   - category: 6 tests (new)
   - inventory: 8 tests (new)
   - favorite: 2 tests (new)
   - attachment: 4+ tests (new)
   - Total: ~57 SSE tests

If any tests fail, document the failures but do not block - the tests themselves are the deliverable.
  </action>
  <verify>Run `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/warehouse/... -run "PublishesEvent" -v 2>&1 | grep -E "(PASS|FAIL|ok|---)" | tail -30` shows all SSE tests passing</verify>
  <done>Full test suite run confirms all new SSE tests pass and no regressions in existing tests</done>
</task>

</tasks>

<verification>
1. Import testing checklist exists and is comprehensive:
```bash
cat docs/IMPORT_TESTING_CHECKLIST.md | head -50
```

2. All SSE tests pass:
```bash
cd /home/antti/Repos/Misc/home-warehouse-system/backend
go test ./internal/domain/warehouse/... -run "PublishesEvent" -v 2>&1 | grep -c "PASS"
```
Expected: ~50+ tests passing
</verification>

<success_criteria>
- Import testing checklist document created at `docs/IMPORT_TESTING_CHECKLIST.md`
- Checklist covers: happy path, validation errors, hierarchy, references, SSE progress, round-trip, error handling
- All 9 new handler SSE test files have passing tests
- No regressions in existing test suite
- Total SSE coverage: item, loan, borrower, inventory, location, container, category, label, company, favorite, attachment
</success_criteria>

<output>
After completion, create `.planning/phases/17-testing-polish/17-04-SUMMARY.md`
</output>
