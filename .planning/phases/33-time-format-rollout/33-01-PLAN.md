---
phase: 33-time-format-rollout
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/hooks/use-date-format.ts
  - frontend/app/[locale]/(dashboard)/dashboard/approvals/page.tsx
  - frontend/app/[locale]/(dashboard)/dashboard/approvals/[id]/page.tsx
  - frontend/app/[locale]/(dashboard)/dashboard/my-changes/page.tsx
  - frontend/components/pending-changes-drawer.tsx
  - frontend/components/scanner/scan-history-list.tsx
autonomous: true

must_haves:
  truths:
    - "User who selects 12-hour format sees AM/PM timestamps (e.g., '2:30 PM') in import job detail, approvals, my-changes, and pending changes drawer"
    - "User who selects 24-hour format sees 24-hour timestamps (e.g., '14:30') throughout the application"
    - "Changing time format in settings immediately updates all datetime displays without page reload"
    - "Relative time displays ('3 hours ago', 'just now') remain unchanged"
    - "Scan history entries older than 24 hours show datetime in user's preferred format"
  artifacts:
    - path: "frontend/lib/hooks/use-date-format.ts"
      provides: "Time-format-aware formatDateTime that composes date + time format strings"
      contains: "timeFormatStr"
    - path: "frontend/app/[locale]/(dashboard)/dashboard/approvals/page.tsx"
      provides: "Approvals list with user-formatted datetime"
      contains: "formatDateTime"
    - path: "frontend/app/[locale]/(dashboard)/dashboard/approvals/[id]/page.tsx"
      provides: "Approval detail with user-formatted datetime"
      contains: "formatDateTime"
    - path: "frontend/app/[locale]/(dashboard)/dashboard/my-changes/page.tsx"
      provides: "My changes list with user-formatted datetime"
      contains: "formatDateTime"
    - path: "frontend/components/pending-changes-drawer.tsx"
      provides: "Pending changes drawer with hook-based datetime formatting"
      contains: "formatDateTime"
    - path: "frontend/components/scanner/scan-history-list.tsx"
      provides: "Scan history list with hook-based datetime fallback"
      contains: "formatDateTime"
  key_links:
    - from: "frontend/lib/hooks/use-date-format.ts"
      to: "user?.time_format"
      via: "useAuth context"
      pattern: "user\\?\\.time_format"
    - from: "frontend/app/[locale]/(dashboard)/dashboard/approvals/page.tsx"
      to: "frontend/lib/hooks/use-date-format.ts"
      via: "useDateFormat import"
      pattern: "useDateFormat"
    - from: "frontend/components/pending-changes-drawer.tsx"
      to: "frontend/lib/hooks/use-date-format.ts"
      via: "useDateFormat import replacing module-level formatTimestamp"
      pattern: "formatDateTime.*new Date"
---

<objective>
Fix the formatDateTime function in useDateFormat to respect user's 12h/24h time preference, and convert all remaining toLocaleString() datetime displays to use the corrected formatDateTime hook.

Purpose: Fulfill TIME-03 (all timestamps display per user's time format preference) and TIME-04 (verify readiness -- no time inputs exist to convert).
Output: All datetime displays across the application respect the user's chosen time format.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-time-format-rollout/33-RESEARCH.md

# Source files to modify
@frontend/lib/hooks/use-date-format.ts
@frontend/lib/hooks/use-time-format.ts
@frontend/app/[locale]/(dashboard)/dashboard/approvals/page.tsx
@frontend/app/[locale]/(dashboard)/dashboard/approvals/[id]/page.tsx
@frontend/app/[locale]/(dashboard)/dashboard/my-changes/page.tsx
@frontend/components/pending-changes-drawer.tsx
@frontend/components/scanner/scan-history-list.tsx
@frontend/lib/scanner/scan-history.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix formatDateTime in useDateFormat to compose date + time format</name>
  <files>frontend/lib/hooks/use-date-format.ts</files>
  <action>
Fix the critical bug where formatDateTime hardcodes `HH:mm` regardless of user's time preference.

In `use-date-format.ts`:

1. Add a `TIME_FORMAT_MAP` constant at module level (after the existing FORMAT_MAP):
```typescript
const TIME_FORMAT_MAP: Record<string, string> = {
  "12h": "h:mm a",
  "24h": "HH:mm",
};
```

2. Inside the `useDateFormat` function, after the existing `dateFnsFormatStr` line, add a `timeFormatStr` useMemo:
```typescript
const timeFormatStr = useMemo(() => {
  const tf = user?.time_format;
  return TIME_FORMAT_MAP[tf as string] || "HH:mm";
}, [user?.time_format]);
```

3. Update `formatDateTime` to use `timeFormatStr` instead of hardcoded `HH:mm`:
- Change: `` dateFnsFormat(dateObj, `${dateFnsFormatStr} HH:mm`) ``
- To: `` dateFnsFormat(dateObj, `${dateFnsFormatStr} ${timeFormatStr}`) ``

4. Update `formatDateTime`'s useCallback dependency array:
- Change: `[dateFnsFormatStr]`
- To: `[dateFnsFormatStr, timeFormatStr]`

Do NOT change anything else in the hook. The `formatDate`, `parseDate`, and `placeholder` functions remain untouched.
  </action>
  <verify>
Run `cd /home/antti/Repos/Misc/home-warehouse-system/frontend && npx tsc --noEmit 2>&1 | head -30` to confirm no TypeScript errors in the modified file.

Verify the fix is correct:
- `grep -n "timeFormatStr" frontend/lib/hooks/use-date-format.ts` should show the new variable and its usage in formatDateTime
- `grep -n "HH:mm" frontend/lib/hooks/use-date-format.ts` should show only the TIME_FORMAT_MAP entry, NOT the old hardcoded usage in formatDateTime
  </verify>
  <done>
formatDateTime in useDateFormat composes the date format string with the user's time format preference. A 12h user sees "h:mm a" suffix, a 24h user sees "HH:mm" suffix. The useCallback dependency array includes timeFormatStr so the function re-creates when time preference changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert all toLocaleString datetime displays and non-React utilities to use formatDateTime</name>
  <files>
    frontend/app/[locale]/(dashboard)/dashboard/approvals/page.tsx
    frontend/app/[locale]/(dashboard)/dashboard/approvals/[id]/page.tsx
    frontend/app/[locale]/(dashboard)/dashboard/my-changes/page.tsx
    frontend/components/pending-changes-drawer.tsx
    frontend/components/scanner/scan-history-list.tsx
  </files>
  <action>
Convert all remaining datetime display sites to use the (now-fixed) formatDateTime from useDateFormat.

**A. Approvals list page** (`approvals/page.tsx`):
- Add import: `import { useDateFormat } from "@/lib/hooks/use-date-format";`
- Add hook call inside the component: `const { formatDateTime } = useDateFormat();`
- Line 199: Replace `{new Date(change.created_at).toLocaleString()}` with `{formatDateTime(change.created_at)}`
- Line 207: Replace `{new Date(change.reviewed_at).toLocaleString()}` with `{formatDateTime(change.reviewed_at)}`

**B. Approval detail page** (`approvals/[id]/page.tsx`):
- Add import: `import { useDateFormat } from "@/lib/hooks/use-date-format";`
- Add hook call inside the component: `const { formatDateTime } = useDateFormat();`
- Line 410: Replace `{new Date(change.created_at).toLocaleString()}` with `{formatDateTime(change.created_at)}`
- Line 454: Replace `new Date(change.reviewed_at).toLocaleString()` with `formatDateTime(change.reviewed_at)` (keep the ternary for null check)

**C. My Changes page** (`my-changes/page.tsx`):
- Add import: `import { useDateFormat } from "@/lib/hooks/use-date-format";`
- Add hook call inside the component: `const { formatDateTime } = useDateFormat();`
- Line 135: Replace `{new Date(change.created_at).toLocaleString()}` with `{formatDateTime(change.created_at)}`
- Line 143: Replace `{new Date(change.reviewed_at).toLocaleString()}` with `{formatDateTime(change.reviewed_at)}`

**D. Pending changes drawer** (`pending-changes-drawer.tsx`):
- Add import: `import { useDateFormat } from "@/lib/hooks/use-date-format";`
- DELETE the module-level `formatTimestamp` function (lines 67-75)
- Inside the `PendingChangesDrawer` component function, add: `const { formatDateTime } = useDateFormat();`
- Find all usages of `formatTimestamp(mutation.timestamp)` and replace with `formatDateTime(new Date(mutation.timestamp))`
  Note: `mutation.timestamp` is a number (Unix ms), so wrap in `new Date()` before passing to `formatDateTime` which accepts `Date | string`.

**E. Scan history list** (`scan-history-list.tsx`):
- Remove `formatScanTime` from the import: change `import { getScanHistory, clearScanHistory, formatScanTime, type ScanHistoryEntry } from "@/lib/scanner";` to `import { getScanHistory, clearScanHistory, type ScanHistoryEntry } from "@/lib/scanner";`
- Add import: `import { useDateFormat } from "@/lib/hooks/use-date-format";`
- Inside the `ScanHistoryList` component, add: `const { formatDateTime } = useDateFormat();`
- Create a local helper function inside the component (after the hook call):
```typescript
const formatScanTimestamp = (timestamp: number): string => {
  const now = Date.now();
  const diffMs = now - timestamp;
  const diffSec = Math.floor(diffMs / 1000);
  const diffMin = Math.floor(diffSec / 60);
  const diffHour = Math.floor(diffMin / 60);

  if (diffMin < 1) return "Just now";
  if (diffMin < 60) return `${diffMin} min ago`;
  if (diffHour < 24) return `${diffHour} hr ago`;
  return formatDateTime(new Date(timestamp));
};
```
- Replace `{formatScanTime(entry.timestamp)}` with `{formatScanTimestamp(entry.timestamp)}`

Do NOT modify `frontend/lib/scanner/scan-history.ts` -- the `formatScanTime` function stays exported for backwards compatibility but is no longer used by `ScanHistoryList`.

Do NOT touch any relative time displays (formatDistanceToNow, formatRelativeTime).
Do NOT touch any number toLocaleString calls.
  </action>
  <verify>
Run `cd /home/antti/Repos/Misc/home-warehouse-system/frontend && npx tsc --noEmit 2>&1 | head -30` to confirm no TypeScript errors.

Run `cd /home/antti/Repos/Misc/home-warehouse-system/frontend && bun run build 2>&1 | tail -20` to confirm production build succeeds.

Verify no remaining datetime toLocaleString calls:
- `grep -rn "toLocaleString()" frontend/app/[locale]/(dashboard)/dashboard/approvals/ frontend/app/[locale]/(dashboard)/dashboard/my-changes/ frontend/components/pending-changes-drawer.tsx` should return NO results
- `grep -rn "formatTimestamp" frontend/components/pending-changes-drawer.tsx` should return NO results (module-level function removed)
- `grep -rn "formatScanTime" frontend/components/scanner/scan-history-list.tsx` should return NO results (import removed)
  </verify>
  <done>
All 6 toLocaleString() datetime displays in approvals, my-changes, and pending-changes-drawer are converted to formatDateTime. The scan-history-list component uses a local helper with relative time for recent entries and formatDateTime for older entries. No relative time displays or number formatting calls were modified.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no new errors
2. `bun run build` succeeds
3. Zero `toLocaleString()` calls remain in approvals, my-changes, or pending-changes-drawer
4. `formatDateTime` in use-date-format.ts uses `timeFormatStr` (not hardcoded `HH:mm`)
5. `timeFormatStr` depends on `user?.time_format` via useMemo
6. All formatDateTime usages pass Date or ISO string (not raw timestamps)
7. Relative time displays (formatDistanceToNow, "X ago") are untouched
8. Number toLocaleString calls are untouched
</verification>

<success_criteria>
- TIME-03 fulfilled: All datetime timestamps in the application respect the user's 12h/24h time format preference
- TIME-04 verified: No time inputs exist to convert; the useTimeFormat hook and timeFormatString are ready for future time inputs
- Import job detail page (already using formatDateTime) automatically benefits from the fix
- Scan history entries older than 24h display datetime in user's format
- No regression in date-only formatting (formatDate unchanged)
</success_criteria>

<output>
After completion, create `.planning/phases/33-time-format-rollout/33-01-SUMMARY.md`
</output>
