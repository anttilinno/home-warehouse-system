---
phase: 23-backend-business-logic-tests
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/internal/domain/warehouse/repairlog/service_test.go
  - backend/internal/domain/warehouse/repairlog/handler_test.go
autonomous: true

must_haves:
  truths:
    - "Service methods have error path tests (SetWarrantyClaim, SetReminderDate, GetTotalRepairCost)"
    - "Handler has HTTP tests for all endpoints"
    - "repairlog package reaches 80%+ coverage"
  artifacts:
    - path: "backend/internal/domain/warehouse/repairlog/handler_test.go"
      provides: "HTTP handler tests for repair log endpoints"
      min_lines: 200
    - path: "backend/internal/domain/warehouse/repairlog/service_test.go"
      provides: "Extended service tests with error paths"
      contains: "TestSetWarrantyClaim"
  key_links:
    - from: "handler_test.go"
      to: "handler.go endpoints"
      via: "httptest and mock service"
      pattern: "func TestHandler_"
---

<objective>
Add handler tests and service error path tests to bring repairlog package from 36% to 80%+ coverage.

Purpose: handler.go (514 lines) has zero tests. Service has partial coverage missing error paths for SetWarrantyClaim, SetReminderDate, GetTotalRepairCost.
Output: New handler_test.go and extended service_test.go.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-backend-business-logic-tests/23-RESEARCH.md
@backend/internal/domain/warehouse/repairlog/service.go
@backend/internal/domain/warehouse/repairlog/service_test.go
@backend/internal/domain/warehouse/repairlog/handler.go
@backend/internal/domain/warehouse/repairlog/entity.go
@backend/internal/domain/warehouse/repairlog/entity_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive handler_test.go</name>
  <files>backend/internal/domain/warehouse/repairlog/handler_test.go</files>
  <action>
Create HTTP handler tests for all repair log endpoints.

1. Study handler.go to identify all endpoints:
   - Create repair log (POST)
   - Get repair log by ID (GET)
   - List repair logs (GET with filters)
   - List by inventory (GET)
   - Update repair log (PUT/PATCH)
   - Delete repair log (DELETE)
   - Start repair (POST)
   - Complete repair (POST)
   - Set warranty claim (POST)
   - Set reminder date (POST)
   - Get total repair cost (GET)

2. Create MockService interface with testify/mock.

3. Write table-driven tests for each handler:

TestHandler_Create:
   - Success: Valid input returns 201
   - Invalid input: Missing required fields returns 400
   - Inventory not found: Returns 404

TestHandler_Get:
   - Success: Returns repair log
   - Not found: Returns 404

TestHandler_List:
   - Success: Returns paginated list
   - With filters: Status, date range
   - Empty: Returns empty array

TestHandler_ListByInventory:
   - Success: Returns repairs for inventory
   - Invalid inventory ID: Returns 400

TestHandler_Update:
   - Success: Returns updated repair
   - Not found: Returns 404
   - Invalid input: Returns 400

TestHandler_Delete:
   - Success: Returns 204
   - Not found: Returns 404

TestHandler_StartRepair:
   - Success: Status changed
   - Invalid state: Returns 422

TestHandler_Complete:
   - Success: Status changed, completion notes saved
   - Invalid state: Returns 422

TestHandler_SetWarrantyClaim:
   - Success: Warranty info saved
   - Invalid input: Returns 400

TestHandler_SetReminderDate:
   - Success: Reminder set
   - Invalid date: Returns 400

TestHandler_GetTotalRepairCost:
   - Success: Returns sum
   - No repairs: Returns 0

Use httptest.NewRequest and httptest.NewRecorder.
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/warehouse/repairlog/... -run TestHandler -v`
All tests pass.
  </verify>
  <done>handler_test.go exists with tests for all HTTP endpoints</done>
</task>

<task type="auto">
  <name>Task 2: Add service error path tests</name>
  <files>backend/internal/domain/warehouse/repairlog/service_test.go</files>
  <action>
Extend service_test.go with missing error path coverage.

1. Review existing tests to identify gaps.

2. Add tests for SetWarrantyClaim():
   - Success: Warranty claim info saved
   - Repair not found: Error returned
   - Invalid status (already completed?): Error returned
   - Repository save error: Error propagated
   - Nil input validation

3. Add tests for SetReminderDate():
   - Success: Reminder date set
   - Repair not found: Error returned
   - Past date: Validation behavior
   - Clear reminder (nil date): Success
   - Repository error: Error propagated

4. Add tests for GetTotalRepairCost():
   - Multiple repairs with costs: Sum correct
   - Some repairs have nil cost: Handle gracefully
   - No repairs: Returns 0
   - Repository error: Error propagated

5. Add tests for any other untested service methods:
   - ListByStatus
   - ListByDateRange
   - Update error paths
   - Delete error paths

Use existing mock patterns from service_test.go.
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/warehouse/repairlog/... -run "TestSet|TestGetTotal" -v`
All tests pass.
  </verify>
  <done>service_test.go has error path tests for all service methods</done>
</task>

<task type="auto">
  <name>Task 3: Verify 80%+ coverage and fill gaps</name>
  <files>
backend/internal/domain/warehouse/repairlog/handler_test.go
backend/internal/domain/warehouse/repairlog/service_test.go
backend/internal/domain/warehouse/repairlog/entity_test.go
  </files>
  <action>
1. Run coverage analysis:
   `go test ./internal/domain/warehouse/repairlog/... -coverprofile=coverage.out -covermode=atomic`
   `go tool cover -func=coverage.out | grep repairlog`

2. Review uncovered lines:
   `go tool cover -html=coverage.out`

3. Add targeted tests for uncovered code:
   - Entity validation edge cases
   - Status transition error paths
   - Repository interface methods

4. Review entity_test.go - add tests for:
   - All status transitions (Pending -> InProgress -> Completed)
   - Invalid transitions (Completed -> Pending)
   - Validation: required fields, string lengths
   - Reconstruct function edge cases

5. Re-run coverage until 80%+ achieved.
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/warehouse/repairlog/... -cover`
Coverage shows 80%+ for repairlog package.
  </verify>
  <done>repairlog package has 80%+ test coverage (BE-06 satisfied)</done>
</task>

</tasks>

<verification>
- [ ] handler_test.go exists with tests for all endpoints
- [ ] Service error paths are tested
- [ ] Entity state machine tests are complete
- [ ] Coverage is 80%+ for repairlog package
</verification>

<success_criteria>
repairlog package test coverage reaches 80%+ (up from 36%), with new HTTP handler tests, service error path tests, and complete entity state machine coverage.
</success_criteria>

<output>
After completion, create `.planning/phases/23-backend-business-logic-tests/23-06-SUMMARY.md`
</output>
