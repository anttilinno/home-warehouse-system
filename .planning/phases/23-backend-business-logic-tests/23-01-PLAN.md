---
phase: 23-backend-business-logic-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/internal/domain/importexport/workspace_backup_test.go
  - backend/internal/domain/importexport/workspace_restore_test.go
autonomous: true

must_haves:
  truths:
    - "workspace_backup.go has tests for ExportWorkspace flow"
    - "workspace_restore.go has tests for ImportWorkspace flow"
    - "importexport package reaches 80%+ coverage"
  artifacts:
    - path: "backend/internal/domain/importexport/workspace_backup_test.go"
      provides: "Tests for workspace export functionality"
      min_lines: 200
    - path: "backend/internal/domain/importexport/workspace_restore_test.go"
      provides: "Tests for workspace import functionality"
      min_lines: 200
  key_links:
    - from: "workspace_backup_test.go"
      to: "ExportWorkspace function"
      via: "mock queries interface"
      pattern: "func TestExportWorkspace"
    - from: "workspace_restore_test.go"
      to: "ImportWorkspace function"
      via: "mock queries interface"
      pattern: "func TestImportWorkspace"
---

<objective>
Add comprehensive tests for workspace backup and restore functionality to bring importexport package from 31% to 80%+ coverage.

Purpose: workspace_backup.go (697 lines) and workspace_restore.go (767 lines) have zero tests - they are the primary coverage gap.
Output: Two new test files covering export/import flows with mocked database queries.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-backend-business-logic-tests/23-RESEARCH.md
@backend/internal/domain/importexport/workspace_backup.go
@backend/internal/domain/importexport/workspace_restore.go
@backend/internal/domain/importexport/service_test.go
@backend/internal/testutil/factory/factory.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create workspace_backup_test.go with mock queries interface</name>
  <files>backend/internal/domain/importexport/workspace_backup_test.go</files>
  <action>
Create comprehensive tests for workspace backup functionality:

1. Create a mock interface for queries.Queries that workspace_backup.go uses. Study the actual queries interface methods called in workspace_backup.go (GetCategories, GetLocations, GetContainers, GetItems, GetInventory, GetBorrowers, GetLabels, GetItemLabels, GetLoans, GetItemPhotos, GetRepairLogs).

2. Create mock implementation using testify/mock pattern from existing service_test.go.

3. Write table-driven tests for ExportWorkspace():
   - Success case: All entities exported correctly
   - Empty workspace: No data to export
   - Partial data: Some entity types empty
   - Error cases: Database errors during fetch

4. Write tests for generateExcel() helper if accessible, or test via ExportWorkspace.

5. Write tests for fetchAllData() - mock each repository call returning test data, verify aggregation.

Use factory pattern from Phase 22 where applicable (Item, Location, Container, etc.).
Follow existing test patterns in service_test.go.
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/importexport/... -run TestExportWorkspace -v`
All tests pass.
  </verify>
  <done>workspace_backup_test.go exists with tests for ExportWorkspace, fetchAllData, and error paths</done>
</task>

<task type="auto">
  <name>Task 2: Create workspace_restore_test.go with import flow tests</name>
  <files>backend/internal/domain/importexport/workspace_restore_test.go</files>
  <action>
Create comprehensive tests for workspace restore functionality:

1. Extend or reuse the mock queries interface from Task 1.

2. Write table-driven tests for ImportWorkspace():
   - Success case: Valid Excel file imports all entities
   - Invalid file format: Not an Excel file
   - Malformed data: Missing required columns
   - Partial success: Some rows fail validation
   - Empty file: No data to import

3. Write tests for parse*FromRows() functions (parseCategories, parseLocations, parseContainers, parseItems, etc.):
   - Valid data parsing
   - Missing required fields
   - Invalid data types
   - Duplicate handling

4. Write tests for import*() functions (importCategories, importLocations, etc.):
   - Success with mock repository
   - Repository error handling

Use testify/assert for assertions.
Create minimal test Excel files in-memory using excelize library (already in project) or mock the parsing.
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/importexport/... -run TestImportWorkspace -v`
All tests pass.
  </verify>
  <done>workspace_restore_test.go exists with tests for ImportWorkspace, parse functions, and error paths</done>
</task>

<task type="auto">
  <name>Task 3: Verify 80%+ coverage and add gap-filling tests</name>
  <files>
backend/internal/domain/importexport/workspace_backup_test.go
backend/internal/domain/importexport/workspace_restore_test.go
  </files>
  <action>
1. Run coverage analysis:
   `go test ./internal/domain/importexport/... -coverprofile=coverage.out -covermode=atomic`
   `go tool cover -func=coverage.out | grep importexport`

2. Identify remaining uncovered lines using:
   `go tool cover -html=coverage.out` (review visually)

3. Add targeted tests for any uncovered branches:
   - Error handling paths
   - Edge cases in parsing
   - Validation failures

4. Re-run coverage until 80%+ achieved.

If 80% is not achievable due to unexportable internal functions, document the gap and target the highest coverage possible (minimum 70%).
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/importexport/... -cover`
Coverage shows 80%+ (or documented reason if lower).
  </verify>
  <done>importexport package has 80%+ test coverage (BE-01 satisfied)</done>
</task>

</tasks>

<verification>
- [ ] workspace_backup_test.go exists and tests pass
- [ ] workspace_restore_test.go exists and tests pass
- [ ] Coverage is 80%+ for importexport package
- [ ] All tests use established patterns (testify/mock, table-driven)
</verification>

<success_criteria>
importexport package test coverage reaches 80%+ (up from 31%), with new tests for workspace_backup.go and workspace_restore.go that cover export/import flows, error handling, and edge cases.
</success_criteria>

<output>
After completion, create `.planning/phases/23-backend-business-logic-tests/23-01-SUMMARY.md`
</output>
