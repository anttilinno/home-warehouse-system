---
phase: 23-backend-business-logic-tests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/internal/domain/warehouse/pendingchange/service_test.go
autonomous: true

must_haves:
  truths:
    - "All 8 entity apply methods have tests (applyCategoryChange, applyLocationChange, etc.)"
    - "Create, update, and delete operations tested for each entity type"
    - "pendingchange package reaches 80%+ coverage"
  artifacts:
    - path: "backend/internal/domain/warehouse/pendingchange/service_test.go"
      provides: "Tests for all apply* methods and handler tests"
      contains: "TestApplyCategoryChange"
  key_links:
    - from: "service_test.go"
      to: "applyCategoryChange"
      via: "mock category repository"
      pattern: "func TestApply.*Change"
---

<objective>
Add comprehensive tests for the 7 untested entity apply methods in pendingchange service to bring package from 29% to 80%+ coverage.

Purpose: Only applyItemChange is tested - 7 other apply methods (Category, Location, Container, Inventory, Borrower, Loan, Label) have zero tests.
Output: Extended service_test.go with tests for all 8 entity types' CRUD operations through approval pipeline.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-backend-business-logic-tests/23-RESEARCH.md
@backend/internal/domain/warehouse/pendingchange/service.go
@backend/internal/domain/warehouse/pendingchange/service_test.go
@backend/internal/domain/warehouse/pendingchange/entity.go
@backend/internal/testutil/factory/factory.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tests for applyCategoryChange and applyLocationChange</name>
  <files>backend/internal/domain/warehouse/pendingchange/service_test.go</files>
  <action>
Study existing applyItemChange tests in service_test.go and replicate the pattern for Category and Location.

1. Create MockCategoryRepository and MockLocationRepository following the existing MockItemRepository pattern (testify/mock).

2. Add table-driven tests for applyCategoryChange():
   - Create action: New category created successfully
   - Update action: Existing category updated
   - Delete action: Category deleted
   - Error: Repository save fails
   - Error: Category not found for update/delete

3. Add table-driven tests for applyLocationChange():
   - Create action: New location created (with optional parent)
   - Update action: Existing location updated
   - Delete action: Location deleted
   - Error: Repository save fails
   - Error: Location not found for update/delete
   - Edge case: Hierarchical location with parent

Use factory.New().Category() and factory.New().Location() for test data.
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/warehouse/pendingchange/... -run "TestApply(Category|Location)Change" -v`
All tests pass.
  </verify>
  <done>Tests exist for applyCategoryChange and applyLocationChange covering create/update/delete and error paths</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for applyContainerChange, applyInventoryChange, applyBorrowerChange</name>
  <files>backend/internal/domain/warehouse/pendingchange/service_test.go</files>
  <action>
Continue the pattern from Task 1 for Container, Inventory, and Borrower entities.

1. Create MockContainerRepository, MockInventoryRepository, MockBorrowerRepository.

2. Add table-driven tests for applyContainerChange():
   - Create: Container at location
   - Update: Container name/short_code changed
   - Delete: Container removed
   - Error paths

3. Add table-driven tests for applyInventoryChange():
   - Create: Inventory record (item at location/container)
   - Update: Status, condition, quantity changes
   - Delete: Inventory record removed
   - Error paths

4. Add table-driven tests for applyBorrowerChange():
   - Create: New borrower
   - Update: Contact info changed
   - Delete: Borrower removed
   - Error paths

Use factories: factory.New().Container(locationID), factory.New().Inventory(itemID, locationID), factory.New().Borrower().
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/warehouse/pendingchange/... -run "TestApply(Container|Inventory|Borrower)Change" -v`
All tests pass.
  </verify>
  <done>Tests exist for applyContainerChange, applyInventoryChange, applyBorrowerChange covering CRUD and error paths</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for applyLoanChange, applyLabelChange and verify 80%+ coverage</name>
  <files>backend/internal/domain/warehouse/pendingchange/service_test.go</files>
  <action>
Complete the remaining entity types and verify coverage.

1. Create MockLoanRepository, MockLabelRepository.

2. Add table-driven tests for applyLoanChange():
   - Create: New loan (borrower, inventory, due date)
   - Update: Due date extended, return noted
   - Delete: Loan record removed
   - Error paths

3. Add table-driven tests for applyLabelChange():
   - Create: New label with color
   - Update: Label name/color changed
   - Delete: Label removed
   - Error paths

4. Run coverage analysis:
   `go test ./internal/domain/warehouse/pendingchange/... -coverprofile=coverage.out -covermode=atomic`
   `go tool cover -func=coverage.out | grep pendingchange`

5. Identify and add tests for any remaining uncovered code (handler error paths, middleware adapter if testable).

Target 80%+. If middleware_adapter.go or handlers are hard to test, focus on service layer tests.
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/warehouse/pendingchange/... -cover`
Coverage shows 80%+ for pendingchange package.
  </verify>
  <done>pendingchange package has 80%+ test coverage (BE-02 satisfied)</done>
</task>

</tasks>

<verification>
- [ ] Tests exist for all 8 apply* methods
- [ ] Each entity type has create/update/delete test cases
- [ ] Error paths are covered
- [ ] Coverage is 80%+ for pendingchange package
</verification>

<success_criteria>
pendingchange package test coverage reaches 80%+ (up from 29%), with tests for all 8 entity apply methods covering create, update, and delete operations with proper error handling.
</success_criteria>

<output>
After completion, create `.planning/phases/23-backend-business-logic-tests/23-02-SUMMARY.md`
</output>
