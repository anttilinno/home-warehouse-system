---
phase: 23-backend-business-logic-tests
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/internal/domain/warehouse/importjob/handler_test.go
  - backend/internal/domain/warehouse/importjob/upload_handler_test.go
autonomous: true

must_haves:
  truths:
    - "handler.go has HTTP tests for list, get, cancel, list-errors endpoints"
    - "upload_handler.go has tests for file upload validation"
    - "importjob package reaches 80%+ coverage"
  artifacts:
    - path: "backend/internal/domain/warehouse/importjob/handler_test.go"
      provides: "HTTP handler tests for import job CRUD"
      min_lines: 150
    - path: "backend/internal/domain/warehouse/importjob/upload_handler_test.go"
      provides: "Tests for file upload handling"
      min_lines: 100
  key_links:
    - from: "handler_test.go"
      to: "handler.go ListImportJobs"
      via: "httptest and mock service"
      pattern: "func TestHandler_List"
---

<objective>
Add HTTP handler tests for importjob package to bring coverage from 38% to 80%+.

Purpose: handler.go (279 lines) and upload_handler.go (152 lines) have zero tests - only entity.go is tested.
Output: Two new test files covering all HTTP endpoints and file upload validation.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-backend-business-logic-tests/23-RESEARCH.md
@backend/internal/domain/warehouse/importjob/handler.go
@backend/internal/domain/warehouse/importjob/upload_handler.go
@backend/internal/domain/warehouse/importjob/entity.go
@backend/internal/domain/warehouse/importjob/entity_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create handler_test.go with HTTP endpoint tests</name>
  <files>backend/internal/domain/warehouse/importjob/handler_test.go</files>
  <action>
Create comprehensive HTTP handler tests for import job operations.

1. Study handler.go to understand the endpoints:
   - List import jobs (GET)
   - Get import job by ID (GET)
   - Cancel import job (POST/DELETE)
   - List import errors for job (GET)

2. Create mock service interface following testify/mock pattern.

3. Write table-driven tests for each handler:

TestHandler_ListImportJobs:
   - Success: Returns list of jobs
   - Empty list: No jobs found
   - Error: Service error returns 500

TestHandler_GetImportJob:
   - Success: Returns job details
   - Not found: Returns 404
   - Invalid UUID: Returns 400

TestHandler_CancelImportJob:
   - Success: Job cancelled
   - Already completed: Returns error
   - Not found: Returns 404

TestHandler_ListImportErrors:
   - Success: Returns error list
   - Empty: No errors
   - Job not found: Returns 404

Use httptest.NewRequest and httptest.NewRecorder.
Set up context with workspace_id and user_id using chi router context if needed.
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/warehouse/importjob/... -run TestHandler -v`
All tests pass.
  </verify>
  <done>handler_test.go exists with tests for all 4 HTTP endpoints</done>
</task>

<task type="auto">
  <name>Task 2: Create upload_handler_test.go with file upload tests</name>
  <files>backend/internal/domain/warehouse/importjob/upload_handler_test.go</files>
  <action>
Create tests for file upload validation and processing.

1. Study upload_handler.go to understand:
   - File size limits
   - MIME type validation
   - Multipart form handling
   - Entity type parameter validation

2. Write table-driven tests for upload handler:

TestUploadHandler_ValidCSV:
   - Valid CSV file accepted
   - Correct entity type parsed

TestUploadHandler_ValidExcel:
   - Valid .xlsx file accepted

TestUploadHandler_InvalidMIMEType:
   - Non-CSV/Excel rejected with 400

TestUploadHandler_FileTooLarge:
   - Over size limit rejected

TestUploadHandler_MissingFile:
   - No file attached returns 400

TestUploadHandler_InvalidEntityType:
   - Unknown entity type returns 400

Use bytes.Buffer to create multipart form requests:
```go
body := &bytes.Buffer{}
writer := multipart.NewWriter(body)
part, _ := writer.CreateFormFile("file", "test.csv")
part.Write([]byte("col1,col2\nval1,val2"))
writer.Close()
```
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/warehouse/importjob/... -run TestUpload -v`
All tests pass.
  </verify>
  <done>upload_handler_test.go exists with tests for file upload validation</done>
</task>

<task type="auto">
  <name>Task 3: Verify 80%+ coverage and add gap-filling tests</name>
  <files>
backend/internal/domain/warehouse/importjob/handler_test.go
backend/internal/domain/warehouse/importjob/upload_handler_test.go
  </files>
  <action>
1. Run coverage analysis:
   `go test ./internal/domain/warehouse/importjob/... -coverprofile=coverage.out -covermode=atomic`
   `go tool cover -func=coverage.out | grep importjob`

2. Review uncovered lines:
   `go tool cover -html=coverage.out`

3. Add targeted tests for uncovered branches:
   - Error handling in file reading
   - Edge cases in request parsing
   - Pagination parameters for list endpoints

4. If entity.go has low coverage, add tests to entity_test.go for:
   - All status transition methods
   - Validation edge cases
   - Error reconstruction

5. Re-run coverage until 80%+ achieved.
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/warehouse/importjob/... -cover`
Coverage shows 80%+ for importjob package.
  </verify>
  <done>importjob package has 80%+ test coverage (BE-03 satisfied)</done>
</task>

</tasks>

<verification>
- [ ] handler_test.go exists and tests pass
- [ ] upload_handler_test.go exists and tests pass
- [ ] All endpoints have success and error tests
- [ ] Coverage is 80%+ for importjob package
</verification>

<success_criteria>
importjob package test coverage reaches 80%+ (up from 38%), with new HTTP handler tests covering all endpoints and file upload validation scenarios.
</success_criteria>

<output>
After completion, create `.planning/phases/23-backend-business-logic-tests/23-03-SUMMARY.md`
</output>
