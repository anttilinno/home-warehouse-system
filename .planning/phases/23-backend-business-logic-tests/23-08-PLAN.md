---
phase: 23-backend-business-logic-tests
plan: 08
type: verify
wave: 1
depends_on: []
files_modified: []
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Unit test coverage ceiling for jobs package is documented"
    - "All ProcessTask unmarshal error paths are already tested"
    - "Coverage at 20.1% represents architectural ceiling for unit tests"
  artifacts:
    - path: "backend/internal/jobs/repair_reminders_test.go"
      provides: "ProcessTask unmarshal error tests"
      contains: "TestRepairReminderProcessor_ProcessTask_InvalidPayload"
    - path: "backend/internal/jobs/loan_reminders_test.go"
      provides: "ProcessTask unmarshal error tests"
      contains: "TestLoanReminderProcessor_ProcessTask_InvalidPayload"
    - path: "backend/internal/jobs/thumbnail_processor_test.go"
      provides: "ProcessTask unmarshal error tests"
      contains: "TestThumbnailProcessor_ProcessTask_InvalidPayload"
  key_links:
    - from: "*_test.go"
      to: "*_processor.go"
      via: "ProcessTask with invalid payloads"
      pattern: "json\\.Unmarshal"
---

<objective>
Verify gap BE-04: Confirm jobs package has reached unit test coverage ceiling.

Purpose: The VERIFICATION.md identified that ~80% of jobs package code requires database (pgxpool.Pool) or Redis/asynq dependencies that cannot be unit tested. This plan VERIFIES that all unit-testable paths are already covered (they are - tests were added in 23-04):
- ✓ All payload serialization/deserialization tested
- ✓ All constructor functions tested
- ✓ ProcessTask unmarshal errors tested for ALL processors
- ✓ Edge cases in testable helper logic covered

Current coverage: 20.1% (at unit test ceiling)
60%+ target not achievable - requires integration tests

Output: Documentation confirming coverage ceiling reached.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/23-backend-business-logic-tests/23-VERIFICATION.md
@backend/internal/jobs/repair_reminders.go
@backend/internal/jobs/loan_reminders.go
@backend/internal/jobs/thumbnail_processor.go
@backend/internal/jobs/repair_reminders_test.go (existing tests)
@backend/internal/jobs/thumbnail_processor_test.go (existing tests)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify existing ProcessTask unmarshal tests</name>
  <files>backend/internal/jobs/repair_reminders_test.go, backend/internal/jobs/loan_reminders_test.go, backend/internal/jobs/thumbnail_processor_test.go</files>
  <action>
Verify that ProcessTask unmarshal error tests ALREADY EXIST for all processors:

1. Check repair_reminders_test.go for:
   - TestRepairReminderProcessor_ProcessTask_InvalidPayload
   - TestRepairReminderProcessor_ProcessTask_InvalidUUID
   - TestRepairReminderProcessor_ProcessTask_InvalidPayloadTypes
   - TestRepairReminderProcessor_ProcessTask_PartiallyInvalidPayload

2. Check loan_reminders_test.go for:
   - TestLoanReminderProcessor_ProcessTask_InvalidPayload
   - TestLoanReminderProcessor_ProcessTask_EmptyPayload
   - TestLoanReminderProcessor_ProcessTask_InvalidUUID

3. Check thumbnail_processor_test.go for:
   - TestThumbnailProcessor_ProcessTask_InvalidPayload
   - TestThumbnailProcessor_ProcessTask_EmptyPayload

All these tests were added in 23-04. Confirm they exist and pass.
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test -v ./internal/jobs/... -run "ProcessTask" -count=1 | head -50`
All ProcessTask tests pass.
  </verify>
  <done>
Confirmed: All ProcessTask unmarshal error tests exist and pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Document coverage ceiling</name>
  <files></files>
  <action>
Run coverage analysis and document the ceiling:

```bash
cd backend && go test -coverprofile=coverage.out ./internal/jobs/... && go tool cover -func=coverage.out | grep jobs
```

Expected result: ~20.1% coverage

Document in summary:
- Current coverage: 20.1%
- Coverage ceiling: ~20-25% (unit tests only)
- Remaining ~75-80% requires integration tests due to:
  - pgxpool.Pool for database queries (ProcessTask methods)
  - asynq.Client for scheduling (ScheduleReminders)
  - webpush.Sender for push notifications
  - Redis for scheduler registration

The 60%+ target in REQUIREMENTS.md is not achievable with unit tests alone. This is an architectural constraint, not a test gap.
  </action>
  <verify>
Coverage output confirms 20.1% (stable from baseline).
  </verify>
  <done>
Coverage ceiling documented. BE-04 gap is architectural, not a test gap.
  </done>
</task>

</tasks>

<verification>
1. All jobs tests pass: `go test ./internal/jobs/... -v -count=1`
2. Coverage measured: `go test -cover ./internal/jobs/...` shows ~20.1%
3. All ProcessTask unmarshal error paths are already tested
4. Coverage ceiling is documented - remaining code requires integration tests
</verification>

<success_criteria>
- Confirmed: ProcessTask unmarshal error tests exist for all 3 processors
- Confirmed: All constructor functions are tested
- Jobs package coverage at ~20.1% (architectural ceiling)
- All tests pass without errors
- Coverage ceiling documented
</success_criteria>

<output>
After completion, create `.planning/phases/23-backend-business-logic-tests/23-08-SUMMARY.md`

Note in SUMMARY.md:
- Coverage: 20.1% (at unit test ceiling)
- Original 60%+ target not achievable with unit tests
- All unit-testable code is already covered
- JOBS-COV-01 decision confirmed: 20% is the architectural ceiling
</output>
