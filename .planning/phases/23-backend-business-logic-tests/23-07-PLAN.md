---
phase: 23-backend-business-logic-tests
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/internal/domain/warehouse/pendingchange/handler_test.go
  - backend/internal/domain/warehouse/pendingchange/middleware_adapter_test.go
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "handler.go achieves 70%+ unit test coverage"
    - "middleware_adapter.go achieves 90%+ unit test coverage"
    - "All HTTP endpoints (List, GetByID, ListMy, Approve, Reject) have unit tests"
    - "pendingchange package total coverage increases to 70%+"
  artifacts:
    - path: "backend/internal/domain/warehouse/pendingchange/handler_test.go"
      provides: "Handler unit tests with MockServiceInterface"
      min_lines: 400
    - path: "backend/internal/domain/warehouse/pendingchange/middleware_adapter_test.go"
      provides: "Middleware adapter unit tests"
      min_lines: 80
  key_links:
    - from: "handler_test.go"
      to: "handler.go"
      via: "MockServiceInterface + httptest"
      pattern: "httptest\\.NewRecorder"
    - from: "middleware_adapter_test.go"
      to: "middleware_adapter.go"
      via: "MockService"
      pattern: "CreatePendingChange"
---

<objective>
Close gap BE-02: Add unit tests for pendingchange handler.go (402 lines, 0% coverage) and middleware_adapter.go (54 lines, 0% coverage) to bring package coverage above 70%.

Purpose: The service layer is comprehensively tested (57.3% package coverage), but handler.go and middleware_adapter.go have 0% unit test coverage. These files are tested via integration tests, but unit tests are missing. This plan adds unit tests to close the coverage gap.

Output: Two test files with comprehensive unit test coverage for HTTP handlers and middleware adapter.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/23-backend-business-logic-tests/23-VERIFICATION.md
@backend/internal/domain/warehouse/pendingchange/handler.go
@backend/internal/domain/warehouse/pendingchange/middleware_adapter.go
@backend/internal/domain/warehouse/pendingchange/service_test.go (mock patterns)
@backend/internal/domain/warehouse/itemphoto/handler_test.go (handler test patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create handler_test.go with MockServiceInterface</name>
  <files>backend/internal/domain/warehouse/pendingchange/handler_test.go</files>
  <action>
Create comprehensive unit tests for handler.go using existing patterns from itemphoto/handler_test.go.

**MockServiceInterface setup:**
- Create MockPendingChangeService implementing ServiceInterface (ListPendingForWorkspace, ApproveChange, RejectChange)
- Create MockUserRepository for enriching responses with user details
- Create MockRepository for FindByID, FindByWorkspace, FindByRequester
- Use testify/mock for all mocks

**Test cases for each endpoint:**

1. **GET /pending-changes** (ListPendingChanges):
   - Success: Returns list with user details enriched
   - 401: Missing workspace context
   - 401: Missing auth user
   - 403: Non-admin/owner user (mock canReviewChanges returns false)
   - 400: Invalid status filter
   - 500: repo.FindByWorkspace error
   - 500: userRepo.FindByID error (enrichment fails)

2. **GET /pending-changes/{id}** (GetPendingChange):
   - Success: Returns single change with user details
   - 401: Missing workspace/auth
   - 404: Change not found
   - 404: Change belongs to different workspace
   - 403: Not requester and not admin
   - Success: Requester can view own change
   - Success: Admin can view any change

3. **GET /my-pending-changes** (ListMyPendingChanges):
   - Success: Returns only requester's changes filtered by workspace
   - 401: Missing workspace/auth
   - 400: Invalid status filter
   - 500: repo.FindByRequester error

4. **POST /pending-changes/{id}/approve** (Approve):
   - Success: Approves and returns updated change
   - 401: Missing workspace/auth
   - 403: Non-admin user
   - 404: Change not found
   - 404: Wrong workspace
   - 400: ErrChangeAlreadyReviewed
   - 403: ErrUnauthorized from service
   - 500: Other ApproveChange errors

5. **POST /pending-changes/{id}/reject** (Reject):
   - Success: Rejects with reason and returns updated change
   - 401: Missing workspace/auth
   - 403: Non-admin user
   - 404: Change not found
   - 404: Wrong workspace
   - 400: ErrChangeAlreadyReviewed
   - 403: ErrUnauthorized from service
   - 500: Other RejectChange errors

**Test helper functions:**
- Helper to create test PendingChange entities with all fields
- Helper to set up Chi router with workspace/auth middleware mocked via context
- Use testutil.NewHandlerTestSetup() pattern from itemphoto tests if available, or set up Chi router manually

**Note:** RegisterRoutes uses huma.API which requires special setup. Follow the pattern from itemphoto/handler_test.go which uses testutil.NewHandlerTestSetup() to create the API.
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test -v ./internal/domain/warehouse/pendingchange/... -run "TestHandler" -count=1`
All handler tests pass.
  </verify>
  <done>
handler_test.go exists with 25+ test cases covering all 5 endpoints. Tests pass and handler.go coverage exceeds 70%.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create middleware_adapter_test.go</name>
  <files>backend/internal/domain/warehouse/pendingchange/middleware_adapter_test.go</files>
  <action>
Create unit tests for middleware_adapter.go (54 lines).

**Tests for MiddlewareAdapter.CreatePendingChange:**
1. Success: Valid action string converts and calls service.CreatePendingChange, returns change ID
2. Error: Invalid action string (not "create"/"update"/"delete") returns error
3. Error: service.CreatePendingChange returns error, propagates it
4. Valid action strings: Test "create", "update", "delete" all parse correctly

**Test for NewMiddlewareAdapter:**
1. Constructor returns non-nil adapter with service attached

**Mock setup:**
- Create mock Service with CreatePendingChange method
- Use testify/mock

**Test implementation:**
```go
func TestMiddlewareAdapter_CreatePendingChange_Success(t *testing.T) {
    // Create mock service
    // Call adapter.CreatePendingChange with valid params
    // Assert service.CreatePendingChange was called with correct Action type
    // Assert returned changeID matches expected
}

func TestMiddlewareAdapter_CreatePendingChange_InvalidAction(t *testing.T) {
    // Call with action="invalid"
    // Assert error returned, service.CreatePendingChange NOT called
}

func TestMiddlewareAdapter_CreatePendingChange_ServiceError(t *testing.T) {
    // Mock service to return error
    // Assert error propagated
}
```
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test -v ./internal/domain/warehouse/pendingchange/... -run "TestMiddlewareAdapter" -count=1`
All middleware adapter tests pass.
  </verify>
  <done>
middleware_adapter_test.go exists with 5+ test cases. Tests pass and middleware_adapter.go coverage exceeds 90%.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify coverage improvement</name>
  <files>backend/internal/domain/warehouse/pendingchange/handler_test.go, backend/internal/domain/warehouse/pendingchange/middleware_adapter_test.go</files>
  <action>
Run coverage analysis to verify gap is closed.

1. Run full package coverage:
```bash
cd backend && go test -coverprofile=coverage.out ./internal/domain/warehouse/pendingchange/...
go tool cover -func=coverage.out | grep pendingchange
```

2. Verify:
   - Package coverage is now 70%+ (was 57.3%)
   - handler.go coverage is 70%+
   - middleware_adapter.go coverage is 90%+

3. If coverage is below target:
   - Identify uncovered lines
   - Add additional test cases for uncovered branches
   - Re-run coverage until targets met

4. Run all existing tests to ensure no regressions:
```bash
go test ./internal/domain/warehouse/pendingchange/... -count=1
```
  </action>
  <verify>
Coverage output shows:
- pendingchange package total: 70%+
- handler.go: 70%+
- middleware_adapter.go: 90%+
All tests pass (including existing service_test.go and entity_test.go).
  </verify>
  <done>
Package coverage improved from 57.3% to 70%+. All tests pass. Gap BE-02 closed.
  </done>
</task>

</tasks>

<verification>
1. All new tests pass: `go test ./internal/domain/warehouse/pendingchange/... -v`
2. Coverage improved: `go test -cover ./internal/domain/warehouse/pendingchange/...` shows 70%+
3. No test regressions: Existing service_test.go and entity_test.go still pass
</verification>

<success_criteria>
- handler_test.go exists with 25+ test cases
- middleware_adapter_test.go exists with 5+ test cases
- pendingchange package coverage >= 70%
- handler.go coverage >= 70%
- middleware_adapter.go coverage >= 90%
- All tests pass without errors
</success_criteria>

<output>
After completion, create `.planning/phases/23-backend-business-logic-tests/23-07-SUMMARY.md`
</output>
