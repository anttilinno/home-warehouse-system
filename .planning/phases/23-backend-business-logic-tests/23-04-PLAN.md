---
phase: 23-backend-business-logic-tests
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/internal/jobs/thumbnail_processor_test.go
  - backend/internal/jobs/repair_reminders_test.go
autonomous: true

must_haves:
  truths:
    - "thumbnail_processor.go has tests for image processing logic"
    - "Task processor ProcessTask methods have tests for error paths"
    - "jobs package reaches 60%+ coverage (relaxed target due to external deps)"
  artifacts:
    - path: "backend/internal/jobs/thumbnail_processor_test.go"
      provides: "Tests for thumbnail generation logic"
      min_lines: 100
  key_links:
    - from: "thumbnail_processor_test.go"
      to: "ThumbnailProcessor.ProcessTask"
      via: "mock storage and image processor"
      pattern: "func TestThumbnailProcessor"
---

<objective>
Add tests for thumbnail processor and strengthen existing job processor tests to bring jobs package from 17% to 60%+ coverage.

Purpose: thumbnail_processor.go (207 lines) has zero tests, and ProcessTask methods in other processors need error path coverage. 80% is not realistic due to Redis/asynq external dependencies.
Output: New thumbnail_processor_test.go and enhanced existing processor tests.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-backend-business-logic-tests/23-RESEARCH.md
@backend/internal/jobs/thumbnail_processor.go
@backend/internal/jobs/loan_reminders.go
@backend/internal/jobs/loan_reminders_test.go
@backend/internal/jobs/repair_reminders.go
@backend/internal/jobs/repair_reminders_test.go
@backend/internal/jobs/scheduler_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create thumbnail_processor_test.go with mock dependencies</name>
  <files>backend/internal/jobs/thumbnail_processor_test.go</files>
  <action>
Create tests for thumbnail processing without requiring actual image files or Redis.

1. Study thumbnail_processor.go to understand:
   - ThumbnailProcessor struct and dependencies
   - ProcessTask method signature
   - Multi-size thumbnail generation
   - Storage interactions
   - SSE event publishing

2. Create mock interfaces:
   - MockStorage: For file read/write operations
   - MockImageProcessor: For resize operations
   - MockSSEHub: For event publishing

3. Write table-driven tests for ThumbnailProcessor:

TestThumbnailProcessor_ProcessTask_Success:
   - Valid task with photo ID
   - Mock storage returns image bytes
   - Mock processor generates thumbnails
   - Verify all sizes generated

TestThumbnailProcessor_ProcessTask_PhotoNotFound:
   - Photo ID not in storage
   - Returns appropriate error

TestThumbnailProcessor_ProcessTask_InvalidPayload:
   - Malformed task payload
   - Returns error without processing

TestThumbnailProcessor_ProcessTask_StorageError:
   - Storage fails during read
   - Error handled gracefully

TestThumbnailProcessor_ProcessTask_ProcessingError:
   - Image resize fails
   - Error logged, task fails

4. Test NewThumbnailProcessor constructor if applicable.

Use testify/mock and table-driven patterns from existing scheduler_test.go.
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/jobs/... -run TestThumbnailProcessor -v`
All tests pass.
  </verify>
  <done>thumbnail_processor_test.go exists with tests for ProcessTask success and error paths</done>
</task>

<task type="auto">
  <name>Task 2: Strengthen loan and repair reminder processor tests</name>
  <files>
backend/internal/jobs/loan_reminders_test.go
backend/internal/jobs/repair_reminders_test.go
  </files>
  <action>
Review existing tests and add missing error path coverage.

1. Review loan_reminders_test.go and repair_reminders_test.go for gaps:
   - ProcessTask method tests
   - Repository error scenarios
   - Email sender error handling
   - Malformed payload handling

2. Add tests for LoanReminderProcessor.ProcessTask():
   - Success: Loan found, email sent
   - Loan not found: Error logged
   - Email send failure: Error returned
   - Invalid payload: Error returned

3. Add tests for RepairReminderProcessor.ProcessTask():
   - Success: Repair found, email sent
   - Repair not found: Error logged
   - Email send failure: Error returned
   - Invalid payload: Error returned

4. If processors have query methods (GetDueLoans, GetUpcomingRepairs), add tests for:
   - Empty results
   - Database error handling
   - Date filtering logic

Follow existing mock patterns in the test files.
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/jobs/... -run "Test(Loan|Repair)Reminder" -v`
All tests pass.
  </verify>
  <done>loan_reminders_test.go and repair_reminders_test.go have ProcessTask error path coverage</done>
</task>

<task type="auto">
  <name>Task 3: Verify 60%+ coverage (relaxed target)</name>
  <files>
backend/internal/jobs/thumbnail_processor_test.go
backend/internal/jobs/loan_reminders_test.go
backend/internal/jobs/repair_reminders_test.go
  </files>
  <action>
1. Run coverage analysis:
   `go test ./internal/jobs/... -coverprofile=coverage.out -covermode=atomic`
   `go tool cover -func=coverage.out | grep jobs`

2. Review uncovered lines:
   `go tool cover -html=coverage.out`

3. Identify what CAN be tested without Redis/asynq:
   - Pure functions
   - Type validation
   - Error handling logic
   - Configuration parsing

4. Add tests for any testable uncovered code:
   - scheduler.go config functions (some exist)
   - cleanup.go logic if mockable
   - Task type constants and parsing

5. Document why certain code is not covered:
   - Redis client creation requires real Redis
   - asynq task enqueueing requires real asynq server
   - Integration tests exist for these scenarios

Target: 60%+ is acceptable due to external dependencies.
Document in summary if lower, with explanation.
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/jobs/... -cover`
Coverage shows 60%+ (or documented reason if lower).
  </verify>
  <done>jobs package has 60%+ test coverage (BE-04 satisfied with relaxed target)</done>
</task>

</tasks>

<verification>
- [ ] thumbnail_processor_test.go exists and tests pass
- [ ] Existing processor tests have error path coverage
- [ ] Coverage is 60%+ for jobs package
- [ ] Any coverage gap is documented with reason
</verification>

<success_criteria>
jobs package test coverage reaches 60%+ (up from 17%), with new tests for thumbnail_processor.go and enhanced error path coverage for loan/repair reminder processors. Lower coverage accepted due to Redis/asynq external dependencies.
</success_criteria>

<output>
After completion, create `.planning/phases/23-backend-business-logic-tests/23-04-SUMMARY.md`
</output>
