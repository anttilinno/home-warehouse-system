---
phase: 23-backend-business-logic-tests
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/internal/domain/warehouse/itemphoto/service_test.go
  - backend/internal/domain/warehouse/itemphoto/handler_test.go
autonomous: true

must_haves:
  truths:
    - "Bulk operations (BulkDeletePhotos, BulkUpdateCaptions) have comprehensive tests"
    - "CheckDuplicates has tests for similarity detection"
    - "itemphoto package reaches 80%+ coverage"
  artifacts:
    - path: "backend/internal/domain/warehouse/itemphoto/service_test.go"
      provides: "Tests for bulk operations and duplicate detection"
      contains: "TestBulkDeletePhotos"
    - path: "backend/internal/domain/warehouse/itemphoto/handler_test.go"
      provides: "HTTP handler tests for photo endpoints"
      contains: "TestHandler_"
  key_links:
    - from: "service_test.go"
      to: "BulkDeletePhotos method"
      via: "mock repository"
      pattern: "func TestBulkDeletePhotos"
---

<objective>
Add comprehensive tests for bulk operations, duplicate detection, and remaining handlers to bring itemphoto package from 40% to 80%+ coverage.

Purpose: Bulk operations and CheckDuplicates have partial tests. Handler tests exist but need expansion.
Output: Extended service_test.go and handler_test.go with full coverage of bulk ops and duplicate detection.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-backend-business-logic-tests/23-RESEARCH.md
@backend/internal/domain/warehouse/itemphoto/service.go
@backend/internal/domain/warehouse/itemphoto/service_test.go
@backend/internal/domain/warehouse/itemphoto/handler.go
@backend/internal/domain/warehouse/itemphoto/handler_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add comprehensive tests for bulk operations</name>
  <files>backend/internal/domain/warehouse/itemphoto/service_test.go</files>
  <action>
Extend service_test.go with thorough bulk operation tests.

1. Review existing BulkDeletePhotos and BulkUpdateCaptions tests.

2. Add table-driven tests for BulkDeletePhotos():
   - Success: Multiple photos deleted
   - Partial success: Some photos don't exist (behavior depends on implementation)
   - Empty list: No-op or error
   - Single photo: Works like single delete
   - Authorization: Photos belong to different items/workspaces
   - Repository error: Transaction rollback

3. Add table-driven tests for BulkUpdateCaptions():
   - Success: All captions updated
   - Partial match: Some photo IDs don't exist
   - Empty captions: Cleared or rejected
   - Long captions: Validation behavior
   - Repository error: Error propagation

4. Test any bulk reorder functionality if it exists:
   - Reorder display positions
   - Invalid positions
   - Gaps in ordering

Use existing mock patterns from service_test.go.
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/warehouse/itemphoto/... -run "TestBulk" -v`
All tests pass.
  </verify>
  <done>service_test.go has comprehensive bulk operation tests with edge cases</done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive tests for CheckDuplicates</name>
  <files>backend/internal/domain/warehouse/itemphoto/service_test.go</files>
  <action>
Add thorough duplicate detection tests.

1. Review CheckDuplicates implementation in service.go:
   - How are perceptual hashes compared?
   - What similarity threshold is used?
   - What data structure is returned?

2. Write table-driven tests for CheckDuplicates():
   - No duplicates: All photos unique
   - Exact duplicates: Same hash returns match
   - Similar images: Above threshold returns match
   - Below threshold: Not flagged as duplicate
   - Empty item: No photos to check
   - Single photo: Nothing to compare
   - Cross-item check: Photos from different items
   - Hash not calculated: Photos without hashes

3. Test edge cases:
   - Nil hash values
   - Zero-length hash
   - Very large photo set (performance)

4. If CheckDuplicates uses a separate similarity function, test that directly:
   - calculateSimilarity(hash1, hash2) behavior
   - Hamming distance or similar metric

Mock the repository to return photos with specific hash values.
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/warehouse/itemphoto/... -run "TestCheckDuplicates" -v`
All tests pass.
  </verify>
  <done>service_test.go has comprehensive duplicate detection tests</done>
</task>

<task type="auto">
  <name>Task 3: Expand handler tests and verify 80%+ coverage</name>
  <files>backend/internal/domain/warehouse/itemphoto/handler_test.go</files>
  <action>
1. Review existing handler_test.go coverage.

2. Add tests for any untested handlers:
   - File serving (GET /photos/:id/file)
   - Thumbnail serving (GET /photos/:id/thumbnail/:size)
   - Bulk delete endpoint
   - Bulk update captions endpoint
   - Duplicate check endpoint
   - Reorder endpoint if exists

3. For each handler, test:
   - Success response
   - Not found (404)
   - Unauthorized (401/403)
   - Invalid input (400)
   - Server error (500)

4. Run coverage analysis:
   `go test ./internal/domain/warehouse/itemphoto/... -coverprofile=coverage.out -covermode=atomic`
   `go tool cover -func=coverage.out | grep itemphoto`

5. Add targeted tests for uncovered lines until 80%+ achieved.

Use httptest for request/response handling.
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/warehouse/itemphoto/... -cover`
Coverage shows 80%+ for itemphoto package.
  </verify>
  <done>itemphoto package has 80%+ test coverage (BE-05 satisfied)</done>
</task>

</tasks>

<verification>
- [ ] Bulk operations have comprehensive tests
- [ ] CheckDuplicates has thorough tests
- [ ] Handler tests cover all endpoints
- [ ] Coverage is 80%+ for itemphoto package
</verification>

<success_criteria>
itemphoto package test coverage reaches 80%+ (up from 40%), with comprehensive tests for bulk operations, duplicate detection, and all HTTP handlers.
</success_criteria>

<output>
After completion, create `.planning/phases/23-backend-business-logic-tests/23-05-SUMMARY.md`
</output>
