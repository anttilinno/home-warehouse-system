---
phase: 02-mutation-queue
plan: 04
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - frontend/components/sync-status-indicator.tsx
  - frontend/components/pending-changes-drawer.tsx
  - frontend/app/[locale]/(workspace)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "User can see count of pending changes in sync indicator"
    - "User can open drawer to view pending changes"
    - "User can cancel individual pending changes"
    - "User can retry failed changes"
    - "User can clear all pending changes with confirmation"
  artifacts:
    - path: "frontend/components/sync-status-indicator.tsx"
      provides: "Enhanced indicator with pending count badge"
      contains: "pendingMutationCount"
    - path: "frontend/components/pending-changes-drawer.tsx"
      provides: "Drawer UI for queue management"
      exports: ["PendingChangesDrawer"]
      min_lines: 100
  key_links:
    - from: "frontend/components/sync-status-indicator.tsx"
      to: "frontend/lib/contexts/offline-context.tsx"
      via: "pendingMutationCount from context"
      pattern: "pendingMutationCount"
    - from: "frontend/components/pending-changes-drawer.tsx"
      to: "frontend/lib/sync/mutation-queue.ts"
      via: "Queue operations for cancel/retry"
      pattern: "removeMutation|getMutationQueue"
---

<objective>
Enhance the sync status indicator and create the pending changes drawer UI.

Purpose: Give users visibility into their pending offline changes. Show a badge with pending count, allow viewing queued mutations, and provide controls to cancel, retry, or clear changes.

Output:
- Enhanced SyncStatusIndicator with pending count badge
- PendingChangesDrawer component for queue management
- Integration in workspace layout
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-mutation-queue/02-RESEARCH.md
@.planning/phases/02-mutation-queue/02-02-PLAN.md

# Existing components
@frontend/components/sync-status-indicator.tsx
@frontend/lib/contexts/offline-context.tsx

# Dependencies
@frontend/lib/sync/mutation-queue.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance SyncStatusIndicator with pending count badge</name>
  <files>frontend/components/sync-status-indicator.tsx</files>
  <action>
Update SyncStatusIndicator to show pending mutation count:

1. Import additional context values:
   ```typescript
   const {
     isOnline,
     isSyncing,
     lastSyncTimestamp,
     triggerSync,
     pendingMutationCount,
     isMutationSyncing,
   } = useOffline();
   ```

2. Add state for drawer:
   ```typescript
   import { useState } from 'react';

   const [drawerOpen, setDrawerOpen] = useState(false);
   ```

3. Update the badge to show pending count when > 0:
   ```typescript
   // After the existing states, add pending indicator
   if (pendingMutationCount > 0) {
     // Show pending count as separate element or combined
   }
   ```

4. Revised component structure:
   ```typescript
   export function SyncStatusIndicator() {
     const {
       isOnline,
       isSyncing,
       lastSyncTimestamp,
       triggerSync,
       pendingMutationCount,
       isMutationSyncing,
     } = useOffline();
     const [drawerOpen, setDrawerOpen] = useState(false);

     // Offline state - highest priority
     if (!isOnline) {
       return (
         <>
           <Badge variant="secondary" className="gap-1.5 text-xs">
             <CloudOff className="h-3 w-3" />
             Offline
             {pendingMutationCount > 0 && (
               <span className="ml-1 rounded-full bg-yellow-500 px-1.5 text-[10px] text-white">
                 {pendingMutationCount}
               </span>
             )}
           </Badge>
           <PendingChangesDrawer open={drawerOpen} onOpenChange={setDrawerOpen} />
         </>
       );
     }

     // Syncing state (either data sync or mutation sync)
     if (isSyncing || isMutationSyncing) {
       return (
         <>
           <Badge variant="secondary" className="gap-1.5 text-xs">
             <RefreshCw className="h-3 w-3 animate-spin" />
             Syncing...
             {pendingMutationCount > 0 && (
               <span className="ml-1 rounded-full bg-blue-500 px-1.5 text-[10px] text-white">
                 {pendingMutationCount}
               </span>
             )}
           </Badge>
           <PendingChangesDrawer open={drawerOpen} onOpenChange={setDrawerOpen} />
         </>
       );
     }

     // Has pending changes
     if (pendingMutationCount > 0) {
       return (
         <>
           <Badge
             variant="secondary"
             className="gap-1.5 text-xs cursor-pointer hover:bg-accent"
             onClick={() => setDrawerOpen(true)}
             title="Click to view pending changes"
           >
             <Clock className="h-3 w-3 text-yellow-500" />
             {pendingMutationCount} pending
           </Badge>
           <PendingChangesDrawer open={drawerOpen} onOpenChange={setDrawerOpen} />
         </>
       );
     }

     // Synced state with timestamp
     if (lastSyncTimestamp) {
       return (
         <Badge
           variant="outline"
           className="gap-1.5 text-xs cursor-pointer hover:bg-accent"
           onClick={triggerSync}
           title="Click to sync now"
         >
           <Check className="h-3 w-3 text-green-500" />
           {formatRelativeTime(lastSyncTimestamp)}
         </Badge>
       );
     }

     // Never synced
     return (
       <Badge variant="outline" className="gap-1.5 text-xs">
         <Cloud className="h-3 w-3" />
         Not synced
       </Badge>
     );
   }
   ```

5. Import Clock icon:
   ```typescript
   import { Cloud, CloudOff, RefreshCw, Check, Clock } from "lucide-react";
   ```

6. Import PendingChangesDrawer (will be created in Task 2):
   ```typescript
   import { PendingChangesDrawer } from "./pending-changes-drawer";
   ```
  </action>
  <verify>
    - `bun run build` succeeds
    - `grep "pendingMutationCount" frontend/components/sync-status-indicator.tsx` shows usage
    - `grep "Clock" frontend/components/sync-status-indicator.tsx` shows icon import
    - `grep "PendingChangesDrawer" frontend/components/sync-status-indicator.tsx` shows import
  </verify>
  <done>
    - Pending count shown in badge
    - Click opens PendingChangesDrawer
    - Different visual states: offline, syncing, pending, synced
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PendingChangesDrawer component</name>
  <files>frontend/components/pending-changes-drawer.tsx</files>
  <action>
Create `frontend/components/pending-changes-drawer.tsx`:

```typescript
"use client";

import { useState, useEffect, useCallback } from "react";
import {
  getMutationQueue,
  removeMutation,
  updateMutationStatus,
  cleanExpiredMutations,
} from "@/lib/sync/mutation-queue";
import { syncManager } from "@/lib/sync/sync-manager";
import type { MutationQueueEntry } from "@/lib/db/types";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from "@/components/ui/alert-dialog";
import {
  Trash2,
  RefreshCw,
  Clock,
  AlertCircle,
  CheckCircle2,
  Loader2,
  Package,
  MapPin,
  Boxes,
  FolderTree,
  Users,
  Receipt,
} from "lucide-react";

interface PendingChangesDrawerProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
}

const entityIcons: Record<string, React.ElementType> = {
  items: Package,
  inventory: Boxes,
  locations: MapPin,
  containers: Boxes,
  categories: FolderTree,
  borrowers: Users,
  loans: Receipt,
};

const statusColors: Record<string, string> = {
  pending: "bg-yellow-500",
  syncing: "bg-blue-500",
  failed: "bg-red-500",
};

function formatTimestamp(timestamp: number): string {
  const date = new Date(timestamp);
  return date.toLocaleString(undefined, {
    month: "short",
    day: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  });
}

function formatPayloadPreview(payload: Record<string, unknown>): string {
  // Try to extract a meaningful preview
  const name = payload.name || payload.title || payload.sku || "";
  if (typeof name === "string" && name.length > 0) {
    return name.length > 30 ? name.substring(0, 30) + "..." : name;
  }
  return "...";
}

export function PendingChangesDrawer({ open, onOpenChange }: PendingChangesDrawerProps) {
  const [mutations, setMutations] = useState<MutationQueueEntry[]>([]);
  const [loading, setLoading] = useState(true);
  const [actionInProgress, setActionInProgress] = useState<number | null>(null);

  const loadMutations = useCallback(async () => {
    setLoading(true);
    try {
      const queue = await getMutationQueue();
      setMutations(queue.sort((a, b) => b.timestamp - a.timestamp));
    } catch (error) {
      console.error("Failed to load mutation queue:", error);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    if (open) {
      loadMutations();
    }
  }, [open, loadMutations]);

  const handleCancel = async (id: number) => {
    setActionInProgress(id);
    try {
      await removeMutation(id);
      await loadMutations();
    } catch (error) {
      console.error("Failed to cancel mutation:", error);
    } finally {
      setActionInProgress(null);
    }
  };

  const handleRetry = async (id: number) => {
    setActionInProgress(id);
    try {
      await updateMutationStatus(id, { status: "pending", retries: 0 });
      if (syncManager && navigator.onLine) {
        await syncManager.processQueue();
      }
      await loadMutations();
    } catch (error) {
      console.error("Failed to retry mutation:", error);
    } finally {
      setActionInProgress(null);
    }
  };

  const handleClearAll = async () => {
    setLoading(true);
    try {
      for (const mutation of mutations) {
        await removeMutation(mutation.id);
      }
      setMutations([]);
    } catch (error) {
      console.error("Failed to clear mutations:", error);
    } finally {
      setLoading(false);
    }
  };

  const handleSyncNow = async () => {
    if (syncManager) {
      await syncManager.processQueue();
      await loadMutations();
    }
  };

  const pendingCount = mutations.filter((m) => m.status === "pending").length;
  const failedCount = mutations.filter((m) => m.status === "failed").length;

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-md">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <Clock className="h-5 w-5" />
            Pending Changes
          </DialogTitle>
          <DialogDescription>
            {mutations.length === 0
              ? "All changes have been synced."
              : `${pendingCount} pending, ${failedCount} failed`}
          </DialogDescription>
        </DialogHeader>

        {loading ? (
          <div className="flex items-center justify-center py-8">
            <Loader2 className="h-6 w-6 animate-spin text-muted-foreground" />
          </div>
        ) : mutations.length === 0 ? (
          <div className="flex flex-col items-center justify-center py-8 text-center">
            <CheckCircle2 className="h-12 w-12 text-green-500 mb-3" />
            <p className="text-sm text-muted-foreground">
              All changes have been synced to the server.
            </p>
          </div>
        ) : (
          <>
            <div className="flex gap-2 mb-4">
              <Button
                variant="outline"
                size="sm"
                onClick={handleSyncNow}
                disabled={!navigator.onLine || pendingCount === 0}
              >
                <RefreshCw className="h-4 w-4 mr-1" />
                Sync Now
              </Button>
              <AlertDialog>
                <AlertDialogTrigger asChild>
                  <Button variant="destructive" size="sm">
                    <Trash2 className="h-4 w-4 mr-1" />
                    Clear All
                  </Button>
                </AlertDialogTrigger>
                <AlertDialogContent>
                  <AlertDialogHeader>
                    <AlertDialogTitle>Clear all pending changes?</AlertDialogTitle>
                    <AlertDialogDescription>
                      This will permanently remove {mutations.length} pending{" "}
                      {mutations.length === 1 ? "change" : "changes"}. This action cannot
                      be undone.
                    </AlertDialogDescription>
                  </AlertDialogHeader>
                  <AlertDialogFooter>
                    <AlertDialogCancel>Cancel</AlertDialogCancel>
                    <AlertDialogAction onClick={handleClearAll}>
                      Clear All
                    </AlertDialogAction>
                  </AlertDialogFooter>
                </AlertDialogContent>
              </AlertDialog>
            </div>

            <div className="max-h-[400px] overflow-y-auto">
              <div className="space-y-3">
                {mutations.map((mutation) => {
                  const EntityIcon = entityIcons[mutation.entity] || Package;
                  const isProcessing = actionInProgress === mutation.id;

                  return (
                    <div
                      key={mutation.id}
                      className="flex items-start gap-3 p-3 rounded-lg border bg-card"
                    >
                      <div className="flex-shrink-0 mt-0.5">
                        <EntityIcon className="h-4 w-4 text-muted-foreground" />
                      </div>

                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 mb-1">
                          <span className="text-sm font-medium capitalize">
                            {mutation.operation} {mutation.entity.slice(0, -1)}
                          </span>
                          <Badge
                            variant="secondary"
                            className={`text-[10px] text-white ${statusColors[mutation.status]}`}
                          >
                            {mutation.status}
                          </Badge>
                        </div>

                        <p className="text-xs text-muted-foreground truncate">
                          {formatPayloadPreview(mutation.payload)}
                        </p>

                        <p className="text-xs text-muted-foreground mt-1">
                          {formatTimestamp(mutation.timestamp)}
                          {mutation.retries > 0 && ` Â· ${mutation.retries} retries`}
                        </p>

                        {mutation.lastError && (
                          <p className="text-xs text-red-500 mt-1 flex items-center gap-1">
                            <AlertCircle className="h-3 w-3" />
                            {mutation.lastError.length > 50
                              ? mutation.lastError.substring(0, 50) + "..."
                              : mutation.lastError}
                          </p>
                        )}
                      </div>

                      <div className="flex-shrink-0 flex gap-1">
                        {mutation.status === "failed" && (
                          <Button
                            variant="ghost"
                            size="icon"
                            className="h-8 w-8"
                            onClick={() => handleRetry(mutation.id)}
                            disabled={isProcessing}
                            title="Retry"
                          >
                            {isProcessing ? (
                              <Loader2 className="h-4 w-4 animate-spin" />
                            ) : (
                              <RefreshCw className="h-4 w-4" />
                            )}
                          </Button>
                        )}
                        <Button
                          variant="ghost"
                          size="icon"
                          className="h-8 w-8 text-destructive hover:text-destructive"
                          onClick={() => handleCancel(mutation.id)}
                          disabled={isProcessing}
                          title="Cancel"
                        >
                          {isProcessing ? (
                            <Loader2 className="h-4 w-4 animate-spin" />
                          ) : (
                            <Trash2 className="h-4 w-4" />
                          )}
                        </Button>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </>
        )}
      </DialogContent>
    </Dialog>
  );
}
```

Note: This uses Dialog (modal) instead of a slide-out drawer because it's simpler and meets the requirements. The scrollable area uses a plain div with `max-h-[400px] overflow-y-auto` for deterministic styling.
  </action>
  <verify>
    - `bun run build` succeeds
    - `wc -l frontend/components/pending-changes-drawer.tsx` shows >= 100 lines
    - `grep "PendingChangesDrawer" frontend/components/pending-changes-drawer.tsx` shows export
    - `grep "removeMutation" frontend/components/pending-changes-drawer.tsx` shows queue integration
    - `grep "max-h-\[400px\] overflow-y-auto" frontend/components/pending-changes-drawer.tsx` shows scrollable div
  </verify>
  <done>
    - PendingChangesDrawer component created
    - Shows list of pending mutations with status
    - Cancel individual changes
    - Retry failed changes
    - Clear all with confirmation
    - Sync now button
    - Uses plain div for scrollable area (no ScrollArea dependency)
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `cd frontend && bun run build` - TypeScript compiles
2. Start dev server, verify SyncStatusIndicator shows pending count when mutations queued
3. Click the indicator with pending count to open drawer
4. Verify drawer shows mutation list with cancel/retry buttons
</verification>

<success_criteria>
- [ ] SyncStatusIndicator shows pending count badge when > 0
- [ ] Clicking indicator opens PendingChangesDrawer
- [ ] Drawer shows list of pending mutations
- [ ] Each mutation shows: operation, entity, status, timestamp, error (if any)
- [ ] Cancel button removes mutation from queue (QM-3)
- [ ] Retry button resets failed mutation to pending (QM-4)
- [ ] Clear All button with confirmation dialog (QM-5)
- [ ] Sync Now button triggers queue processing
- [ ] Empty state shown when queue is empty
</success_criteria>

<output>
After completion, create `.planning/phases/02-mutation-queue/02-04-SUMMARY.md`
</output>
