---
phase: 13-repair-log-extensions
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - backend/internal/domain/warehouse/repairphoto/entity.go
  - backend/internal/domain/warehouse/repairphoto/repository.go
  - backend/internal/domain/warehouse/repairphoto/service.go
  - backend/internal/domain/warehouse/repairphoto/handler.go
  - backend/internal/domain/warehouse/repairlog/entity.go
  - backend/internal/domain/warehouse/repairlog/service.go
  - backend/internal/domain/warehouse/repairlog/handler.go
  - backend/internal/domain/warehouse/repairlog/repository.go
  - backend/cmd/server/main.go
autonomous: true

must_haves:
  truths:
    - "User can upload before/during/after photos to a repair entry"
    - "User can list photos for a repair log"
    - "User can delete photos from a repair log"
    - "Repair log can be marked as warranty claim"
    - "Repair log can have reminder date set"
  artifacts:
    - path: "backend/internal/domain/warehouse/repairphoto/entity.go"
      provides: "RepairPhoto entity with PhotoType enum"
      contains: "PhotoType"
    - path: "backend/internal/domain/warehouse/repairphoto/service.go"
      provides: "Photo upload/delete with storage and thumbnails"
      contains: "UploadPhoto"
    - path: "backend/internal/domain/warehouse/repairphoto/handler.go"
      provides: "Multipart upload endpoint and photo management"
      contains: "handleUpload"
  key_links:
    - from: "repairphoto/service.go"
      to: "infra/storage"
      via: "Storage interface injection"
      pattern: "type Storage interface"
    - from: "repairphoto/handler.go"
      to: "/api/v1/workspaces/{workspaceId}/repairs/{repairLogId}/photos"
      via: "Chi router registration"
      pattern: "repairs.*photos"
---

<objective>
Create the repairphoto domain following the itemphoto pattern, and extend repairlog entity/service for warranty claims and reminders.

Purpose: Enable photo documentation of repairs and add warranty/reminder fields to repair logs
Output: New repairphoto domain, extended repairlog with warranty/reminder support
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/13-repair-log-extensions/13-RESEARCH.md
@.planning/phases/13-repair-log-extensions/13-01-SUMMARY.md
@backend/internal/domain/warehouse/itemphoto/entity.go
@backend/internal/domain/warehouse/itemphoto/service.go
@backend/internal/domain/warehouse/itemphoto/handler.go
@backend/internal/domain/warehouse/repairlog/entity.go
@backend/internal/domain/warehouse/repairlog/service.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create repairphoto domain entity and repository</name>
  <files>
    backend/internal/domain/warehouse/repairphoto/entity.go
    backend/internal/domain/warehouse/repairphoto/repository.go
  </files>
  <action>
Create backend/internal/domain/warehouse/repairphoto/ directory and files:

1. entity.go - Mirror itemphoto/entity.go structure:
   - PhotoType enum: BEFORE, DURING, AFTER with IsValid() method
   - RepairPhoto struct with fields: ID, RepairLogID (instead of ItemID), WorkspaceID, PhotoType, Filename, StoragePath, ThumbnailPath, FileSize, MimeType, Width, Height, DisplayOrder, Caption, UploadedBy, CreatedAt, UpdatedAt
   - NewRepairPhoto constructor with validation
   - Reconstruct function for database loading
   - Validate() method checking required fields
   - IsValidMimeType() checking against allowed types (JPEG, PNG, WEBP)
   - GetThumbnailURL(baseURL) and GetFullSizeURL(baseURL) methods
   - Same MIME type constants as itemphoto

2. repository.go - Repository interface and implementation:
   - Repository interface: Create, GetByID, ListByRepairLog, UpdateCaption, UpdateDisplayOrder, Delete, GetMaxDisplayOrder
   - PostgresRepository implementation using sqlc queries from 13-01
   - Map between domain entity and sqlc types
  </action>
  <verify>go build ./backend/internal/domain/warehouse/repairphoto/...</verify>
  <done>repairphoto package compiles with entity and repository</done>
</task>

<task type="auto">
  <name>Task 2: Create repairphoto service and handler</name>
  <files>
    backend/internal/domain/warehouse/repairphoto/service.go
    backend/internal/domain/warehouse/repairphoto/handler.go
    backend/cmd/server/main.go
  </files>
  <action>
1. service.go - Mirror itemphoto/service.go:
   - Service struct with repo, storage (Storage interface), processor (ImageProcessor interface), uploadDir
   - UploadPhoto(ctx, repairLogID, workspaceID, userID, photoType, file, header, caption) - validates file, generates thumbnail, saves to storage at path "workspaces/{workspaceID}/repairs/{repairLogID}/photos/{uuid}.{ext}", creates entity
   - GetPhoto(ctx, id, workspaceID)
   - ListByRepairLog(ctx, repairLogID, workspaceID)
   - UpdateCaption(ctx, id, workspaceID, caption)
   - DeletePhoto(ctx, id, workspaceID) - deletes from storage AND database
   - Use same Storage and ImageProcessor interfaces as itemphoto (import from infra)

2. handler.go - Mirror itemphoto/handler.go:
   - Handler struct with service
   - Register routes under: /api/v1/workspaces/{workspaceId}/repairs/{repairLogId}/photos
     - POST / - Upload photo (multipart, accepts photo_type in form field)
     - GET / - List photos for repair
     - GET /{photoId} - Get single photo (serves file)
     - GET /{photoId}/thumbnail - Get thumbnail
     - PATCH /{photoId} - Update caption
     - DELETE /{photoId} - Delete photo
   - Use Huma for OpenAPI spec (same as itemphoto)

3. main.go - Register repairphoto handler:
   - Create repairphoto.Service with storage, processor dependencies
   - Create repairphoto.Handler
   - Register routes in the workspace router group
  </action>
  <verify>go build ./backend/cmd/server/... && grep -r "repairs.*photos" backend/internal/domain/warehouse/repairphoto/handler.go</verify>
  <done>Server compiles with repairphoto routes registered</done>
</task>

<task type="auto">
  <name>Task 3: Extend repairlog entity and service for warranty and reminders</name>
  <files>
    backend/internal/domain/warehouse/repairlog/entity.go
    backend/internal/domain/warehouse/repairlog/repository.go
    backend/internal/domain/warehouse/repairlog/service.go
    backend/internal/domain/warehouse/repairlog/handler.go
  </files>
  <action>
1. entity.go - Add new fields:
   - isWarrantyClaim bool field
   - reminderDate *time.Time field
   - reminderSent bool field
   - Update NewRepairLog() to accept isWarrantyClaim parameter (default false)
   - Update Reconstruct() to include new fields
   - Add getters: IsWarrantyClaim(), ReminderDate(), ReminderSent()
   - Add SetWarrantyClaim(bool), SetReminderDate(*time.Time) methods (only on non-completed repairs)
   - Add MarkReminderSent() method

2. repository.go - Update repository:
   - Update Create/Update to include new columns
   - Add MarkReminderSent(ctx, id) method

3. service.go - Update service:
   - Extend Create to accept isWarrantyClaim
   - Add SetWarrantyClaim(ctx, id, workspaceID, isWarrantyClaim) method
   - Add SetReminderDate(ctx, id, workspaceID, reminderDate) method
   - Add GetTotalRepairCost(ctx, inventoryID, workspaceID) method returning []RepairCostSummary{CurrencyCode, TotalCents, RepairCount}

4. handler.go - Update handler:
   - Add is_warranty_claim to create/update request DTOs
   - Add reminder_date to create/update request DTOs
   - Add GET /inventory/{inventoryId}/repair-cost endpoint returning cost summary
   - Ensure SSE events include new fields
  </action>
  <verify>go build ./backend/cmd/server/... && go test ./backend/internal/domain/warehouse/repairlog/...</verify>
  <done>repairlog package extended with warranty/reminder support, tests pass</done>
</task>

</tasks>

<verification>
- [ ] Server compiles: `go build ./backend/cmd/server/...`
- [ ] repairphoto domain tests pass: `go test ./backend/internal/domain/warehouse/repairphoto/...`
- [ ] repairlog tests pass: `go test ./backend/internal/domain/warehouse/repairlog/...`
- [ ] Routes registered: grep for "repairs.*photos" in handler code
- [ ] Photo upload endpoint accepts photo_type parameter
</verification>

<success_criteria>
Users can upload before/during/after photos to repairs via API. Repair logs support warranty claims and reminder dates. Lifecycle cost can be queried by inventory ID.
</success_criteria>

<output>
After completion, create `.planning/phases/13-repair-log-extensions/13-02-SUMMARY.md`
</output>
