---
phase: 13-repair-log-extensions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/db/migrations/20260125_repair_log_extensions.sql
  - backend/db/queries/repair_logs.sql
  - backend/db/queries/repair_photos.sql
  - backend/db/queries/repair_attachments.sql
  - backend/internal/infra/queries/*.go
autonomous: true

must_haves:
  truths:
    - "Database has repair_photos table with photo_type enum (BEFORE/DURING/AFTER)"
    - "Database has repair_attachments junction table linking to files"
    - "repair_logs table has is_warranty_claim, reminder_date, reminder_sent columns"
    - "sqlc generates query functions for all new tables and columns"
  artifacts:
    - path: "backend/db/migrations/20260125_repair_log_extensions.sql"
      provides: "Schema extensions for photos, attachments, warranty, reminders"
      contains: "CREATE TABLE warehouse.repair_photos"
    - path: "backend/db/queries/repair_photos.sql"
      provides: "CRUD queries for repair photos"
      contains: "InsertRepairPhoto"
    - path: "backend/db/queries/repair_attachments.sql"
      provides: "CRUD queries for repair attachments"
      contains: "InsertRepairAttachment"
  key_links:
    - from: "backend/db/queries/repair_photos.sql"
      to: "backend/internal/infra/queries/repair_photos.sql.go"
      via: "sqlc generate"
      pattern: "func.*InsertRepairPhoto"
---

<objective>
Create database schema extensions and sqlc queries for repair photos, attachments, warranty claims, and maintenance reminders.

Purpose: Foundation layer for Phase 13 features - all domain code depends on these schema changes
Output: New migration file, sqlc query files, regenerated query code
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-repair-log-extensions/13-RESEARCH.md
@backend/db/migrations/001_initial_schema.sql
@backend/db/queries/repair_logs.sql
@backend/db/queries/item_photos.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration for repair log extensions</name>
  <files>backend/db/migrations/20260125_repair_log_extensions.sql</files>
  <action>
Create migration file with:

1. Add columns to warehouse.repair_logs:
   - is_warranty_claim BOOLEAN DEFAULT false
   - reminder_date DATE (nullable)
   - reminder_sent BOOLEAN DEFAULT false
   - Add partial index on reminder_date WHERE reminder_date IS NOT NULL AND reminder_sent = false

2. Create warehouse.repair_photo_type_enum:
   - BEFORE, DURING, AFTER

3. Create warehouse.repair_photos table:
   - id UUID PRIMARY KEY DEFAULT uuidv7()
   - repair_log_id UUID NOT NULL REFERENCES warehouse.repair_logs(id) ON DELETE CASCADE
   - workspace_id UUID NOT NULL REFERENCES auth.workspaces(id) ON DELETE CASCADE
   - photo_type warehouse.repair_photo_type_enum NOT NULL DEFAULT 'DURING'
   - filename VARCHAR(255) NOT NULL
   - storage_path VARCHAR(500) NOT NULL
   - thumbnail_path VARCHAR(500) NOT NULL
   - file_size BIGINT NOT NULL
   - mime_type VARCHAR(100) NOT NULL
   - width INTEGER NOT NULL
   - height INTEGER NOT NULL
   - display_order INTEGER NOT NULL DEFAULT 0
   - caption TEXT
   - uploaded_by UUID NOT NULL REFERENCES auth.users(id)
   - created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
   - updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
   - Add indexes: (repair_log_id, display_order), (workspace_id)

4. Create warehouse.repair_attachments table:
   - id UUID PRIMARY KEY DEFAULT uuidv7()
   - repair_log_id UUID NOT NULL REFERENCES warehouse.repair_logs(id) ON DELETE CASCADE
   - workspace_id UUID NOT NULL REFERENCES auth.workspaces(id) ON DELETE CASCADE
   - file_id UUID NOT NULL REFERENCES warehouse.files(id) ON DELETE CASCADE
   - attachment_type warehouse.attachment_type_enum NOT NULL (reuse existing enum)
   - title VARCHAR(200)
   - created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
   - updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
   - Add indexes: (repair_log_id), (workspace_id)

Include migrate:down section that drops tables and columns.
  </action>
  <verify>mise run migrate && mise run sqlc</verify>
  <done>Migration runs successfully, no errors on sqlc generate</done>
</task>

<task type="auto">
  <name>Task 2: Create sqlc queries for repair photos</name>
  <files>backend/db/queries/repair_photos.sql</files>
  <action>
Create sqlc query file following item_photos.sql pattern with:

1. InsertRepairPhoto - Insert new photo with all fields
2. GetRepairPhoto - Get single photo by ID and workspace_id
3. ListRepairPhotosByRepairLog - List photos for a repair, ordered by display_order
4. UpdateRepairPhotoCaption - Update caption by ID
5. UpdateRepairPhotoDisplayOrder - Update display_order by ID
6. DeleteRepairPhoto - Delete by ID and workspace_id
7. CountRepairPhotosByRepairLog - Count photos for a repair
8. GetMaxRepairPhotoDisplayOrder - Get max display_order for a repair (for auto-increment)

All queries MUST include workspace_id in WHERE clause for multi-tenant security.
  </action>
  <verify>mise run sqlc && grep -l "InsertRepairPhoto" backend/internal/infra/queries/repair_photos.sql.go</verify>
  <done>Generated repair_photos.sql.go contains all query functions</done>
</task>

<task type="auto">
  <name>Task 3: Create sqlc queries for repair attachments and cost aggregation</name>
  <files>backend/db/queries/repair_attachments.sql, backend/db/queries/repair_logs.sql</files>
  <action>
1. Create backend/db/queries/repair_attachments.sql with:
   - InsertRepairAttachment - Insert new attachment linking repair to file
   - GetRepairAttachment - Get single attachment by ID and workspace_id
   - ListRepairAttachmentsByRepairLog - List attachments for a repair with file info (JOIN warehouse.files)
   - DeleteRepairAttachment - Delete by ID and workspace_id

2. Add to existing backend/db/queries/repair_logs.sql:
   - GetTotalRepairCostByInventory - Sum cost grouped by currency_code for completed repairs on an inventory item
   - ListRepairsNeedingReminder - Select repairs where reminder_date <= $1 AND reminder_sent = false, join inventory + items for item_name
   - MarkRepairReminderSent - Update reminder_sent = true by ID

All queries MUST include workspace_id where appropriate.
  </action>
  <verify>mise run sqlc && grep -l "GetTotalRepairCostByInventory" backend/internal/infra/queries/repair_logs.sql.go</verify>
  <done>Generated query files contain attachment and cost aggregation functions</done>
</task>

</tasks>

<verification>
- [ ] Migration applies without errors: `mise run migrate`
- [ ] sqlc generates without errors: `mise run sqlc`
- [ ] repair_photos.sql.go exists with InsertRepairPhoto function
- [ ] repair_attachments.sql.go exists with InsertRepairAttachment function
- [ ] repair_logs.sql.go has GetTotalRepairCostByInventory and ListRepairsNeedingReminder
</verification>

<success_criteria>
All database schema changes applied and sqlc queries generated. Backend code can now use the new tables and columns.
</success_criteria>

<output>
After completion, create `.planning/phases/13-repair-log-extensions/13-01-SUMMARY.md`
</output>
