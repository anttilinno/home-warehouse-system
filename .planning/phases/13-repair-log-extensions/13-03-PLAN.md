---
phase: 13-repair-log-extensions
plan: 03
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - backend/internal/domain/warehouse/repairattachment/entity.go
  - backend/internal/domain/warehouse/repairattachment/repository.go
  - backend/internal/domain/warehouse/repairattachment/service.go
  - backend/internal/domain/warehouse/repairattachment/handler.go
  - backend/internal/jobs/tasks.go
  - backend/internal/jobs/repair_reminders.go
  - backend/internal/jobs/scheduler.go
  - backend/internal/domain/auth/notification/entity.go
  - backend/cmd/server/main.go
  - backend/cmd/worker/main.go
autonomous: true

must_haves:
  truths:
    - "User can link attachments (receipts, warranty docs) to repair entries"
    - "System sends reminder notifications for repairs with reminder_date"
    - "Repair reminder job runs on schedule and marks reminders as sent"
  artifacts:
    - path: "backend/internal/domain/warehouse/repairattachment/entity.go"
      provides: "RepairAttachment entity linking repairs to files"
      contains: "RepairAttachment"
    - path: "backend/internal/jobs/repair_reminders.go"
      provides: "Scheduled job for maintenance reminders"
      contains: "TypeRepairReminder"
    - path: "backend/internal/domain/auth/notification/entity.go"
      provides: "TypeRepairReminder notification type"
      contains: "TypeRepairReminder"
  key_links:
    - from: "jobs/repair_reminders.go"
      to: "queries.ListRepairsNeedingReminder"
      via: "sqlc query"
      pattern: "ListRepairsNeedingReminder"
    - from: "jobs/scheduler.go"
      to: "jobs/repair_reminders.go"
      via: "task handler registration"
      pattern: "TypeRepairReminder"
---

<objective>
Create repair attachment domain for linking documents to repairs, and implement maintenance reminder background job.

Purpose: Complete the backend support for attachments and scheduled reminders
Output: repairattachment domain, repair reminder job following loan reminder pattern
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/13-repair-log-extensions/13-RESEARCH.md
@.planning/phases/13-repair-log-extensions/13-01-SUMMARY.md
@backend/internal/domain/warehouse/attachment/entity.go
@backend/internal/jobs/loan_reminders.go
@backend/internal/jobs/tasks.go
@backend/internal/jobs/scheduler.go
@backend/internal/domain/auth/notification/entity.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create repairattachment domain</name>
  <files>
    backend/internal/domain/warehouse/repairattachment/entity.go
    backend/internal/domain/warehouse/repairattachment/repository.go
    backend/internal/domain/warehouse/repairattachment/service.go
    backend/internal/domain/warehouse/repairattachment/handler.go
    backend/cmd/server/main.go
  </files>
  <action>
Create backend/internal/domain/warehouse/repairattachment/ directory and files:

1. entity.go:
   - RepairAttachment struct: ID, RepairLogID, WorkspaceID, FileID, AttachmentType (reuse attachment.AttachmentType), Title, CreatedAt, UpdatedAt
   - NewRepairAttachment(repairLogID, workspaceID, fileID, attachmentType, title) constructor with validation
   - Reconstruct function
   - Getters for all fields
   - RepairAttachmentWithFile struct for joined queries (includes file metadata: OriginalName, MimeType, SizeBytes, StorageKey)

2. repository.go:
   - Repository interface: Create, GetByID, ListByRepairLog (returns []RepairAttachmentWithFile), Delete
   - PostgresRepository using sqlc queries from 13-01
   - ListByRepairLog should JOIN with files table to include file info

3. service.go:
   - Service struct with repo, fileService (for validating file exists and belongs to workspace)
   - Create(ctx, repairLogID, workspaceID, fileID, attachmentType, title) - verify file exists in workspace first
   - GetByID(ctx, id, workspaceID)
   - ListByRepairLog(ctx, repairLogID, workspaceID)
   - Delete(ctx, id, workspaceID) - only deletes junction record, not the underlying file

4. handler.go:
   - Routes under /api/v1/workspaces/{workspaceId}/repairs/{repairLogId}/attachments
     - POST / - Link existing file to repair (accepts file_id, attachment_type, title in JSON)
     - GET / - List attachments for repair (includes file info)
     - DELETE /{attachmentId} - Unlink attachment from repair

5. main.go - Register repairattachment handler
  </action>
  <verify>go build ./backend/cmd/server/... && grep -r "repairs.*attachments" backend/internal/domain/warehouse/repairattachment/handler.go</verify>
  <done>repairattachment domain compiles, routes registered</done>
</task>

<task type="auto">
  <name>Task 2: Implement repair reminder background job</name>
  <files>
    backend/internal/jobs/tasks.go
    backend/internal/jobs/repair_reminders.go
    backend/internal/jobs/scheduler.go
    backend/internal/domain/auth/notification/entity.go
  </files>
  <action>
1. tasks.go - Add new task type:
   - TypeRepairReminder = "repair:reminder"

2. notification/entity.go - Add notification type:
   - TypeRepairReminder NotificationType = "REPAIR_REMINDER"

3. repair_reminders.go - Create new file following loan_reminders.go pattern:
   - RepairReminderPayload struct: RepairLogID, WorkspaceID, ItemName, Description, ReminderDate
   - RepairReminderProcessor struct with pool, pushSender (no email for now, just push + in-app notification)
   - ProcessTask(ctx, task) - sends push notification to workspace owners/admins, creates in-app notification
   - RepairReminderScheduler struct with pool, client
   - ScheduleReminders(ctx) - queries ListRepairsNeedingReminder (reminders within next 3 days), enqueues tasks, marks reminder_sent after enqueue
   - NewScheduleRepairRemindersTask() for periodic scheduling

4. scheduler.go - Register repair reminder:
   - Add handler for TypeRepairReminder in mux
   - Register periodic task for repair reminder scheduling (same schedule as loan reminders, e.g., daily at 9am)
  </action>
  <verify>go build ./backend/cmd/worker/... && grep "TypeRepairReminder" backend/internal/jobs/tasks.go</verify>
  <done>Worker compiles with repair reminder job registered</done>
</task>

<task type="auto">
  <name>Task 3: Wire repair reminder into worker and test</name>
  <files>
    backend/cmd/worker/main.go
    backend/internal/jobs/repair_reminders_test.go
  </files>
  <action>
1. worker/main.go:
   - Create RepairReminderProcessor with pool and pushSender
   - Create RepairReminderScheduler with pool and asynq client
   - Register task handler for TypeRepairReminder
   - Add repair reminder scheduling to periodic tasks

2. repair_reminders_test.go - Unit tests:
   - Test RepairReminderPayload marshaling/unmarshaling
   - Test ScheduleReminders finds repairs needing reminders
   - Test ProcessTask creates notification (mock dependencies)
   - Follow loan_reminders_test.go pattern
  </action>
  <verify>go test ./backend/internal/jobs/... -run Repair</verify>
  <done>Repair reminder tests pass</done>
</task>

</tasks>

<verification>
- [ ] Server compiles: `go build ./backend/cmd/server/...`
- [ ] Worker compiles: `go build ./backend/cmd/worker/...`
- [ ] repairattachment routes registered for attachments
- [ ] TypeRepairReminder in tasks.go
- [ ] Repair reminder tests pass
</verification>

<success_criteria>
Users can link existing files as attachments to repairs. Background job checks for repairs with upcoming reminder dates and sends notifications to workspace admins.
</success_criteria>

<output>
After completion, create `.planning/phases/13-repair-log-extensions/13-03-SUMMARY.md`
</output>
