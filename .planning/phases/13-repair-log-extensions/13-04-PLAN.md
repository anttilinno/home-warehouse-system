---
phase: 13-repair-log-extensions
plan: 04
type: execute
wave: 3
depends_on: ["13-02", "13-03"]
files_modified:
  - frontend/lib/types/repair-log.ts
  - frontend/lib/api/repair-logs.ts
  - frontend/components/inventory/repair-history.tsx
  - frontend/components/inventory/repair-photo-upload.tsx
  - frontend/components/inventory/repair-attachments.tsx
  - frontend/messages/en.json
  - frontend/messages/et.json
  - frontend/messages/ru.json
autonomous: true

must_haves:
  truths:
    - "User can view before/after photos in repair history UI"
    - "User can upload photos to repair entries with type selection"
    - "User can link existing attachments to repairs"
    - "User can see total lifecycle repair cost on inventory"
    - "User can toggle warranty claim checkbox on repairs"
    - "User can set reminder date for future maintenance"
  artifacts:
    - path: "frontend/lib/types/repair-log.ts"
      provides: "Extended types with photos, attachments, warranty, reminder"
      contains: "isWarrantyClaim"
    - path: "frontend/components/inventory/repair-photo-upload.tsx"
      provides: "Photo upload component with before/during/after selection"
      contains: "PhotoType"
    - path: "frontend/components/inventory/repair-history.tsx"
      provides: "Extended repair history with photos, cost, warranty, reminder UI"
      contains: "isWarrantyClaim"
  key_links:
    - from: "repair-history.tsx"
      to: "repairLogsApi"
      via: "API calls for photos and attachments"
      pattern: "uploadPhoto|linkAttachment"
    - from: "repair-history.tsx"
      to: "repair-photo-upload.tsx"
      via: "component composition"
      pattern: "RepairPhotoUpload"
---

<objective>
Extend the frontend repair history UI to support photos, attachments, lifecycle cost, warranty claims, and maintenance reminders.

Purpose: Complete the user-facing features for Phase 13 requirements
Output: Extended TypeScript types, photo upload component, enriched repair history UI
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/13-repair-log-extensions/13-RESEARCH.md
@.planning/phases/13-repair-log-extensions/13-02-SUMMARY.md
@.planning/phases/13-repair-log-extensions/13-03-SUMMARY.md
@frontend/lib/types/repair-log.ts
@frontend/lib/api/repair-logs.ts
@frontend/components/inventory/repair-history.tsx
@frontend/components/items/photo-upload.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend TypeScript types and API client</name>
  <files>
    frontend/lib/types/repair-log.ts
    frontend/lib/api/repair-logs.ts
  </files>
  <action>
1. lib/types/repair-log.ts - Add new types:
   ```typescript
   export type RepairPhotoType = 'BEFORE' | 'DURING' | 'AFTER';

   export interface RepairPhoto {
     id: string;
     repairLogId: string;
     workspaceId: string;
     photoType: RepairPhotoType;
     filename: string;
     thumbnailUrl: string;
     fullSizeUrl: string;
     fileSize: number;
     mimeType: string;
     width: number;
     height: number;
     displayOrder: number;
     caption?: string;
     uploadedBy: string;
     createdAt: string;
     updatedAt: string;
   }

   export interface RepairAttachment {
     id: string;
     repairLogId: string;
     fileId: string;
     attachmentType: 'PHOTO' | 'MANUAL' | 'RECEIPT' | 'WARRANTY' | 'OTHER';
     title?: string;
     file: {
       originalName: string;
       mimeType: string;
       sizeBytes: number;
     };
     createdAt: string;
   }

   export interface RepairCostSummary {
     currencyCode: string;
     totalCents: number;
     repairCount: number;
   }
   ```

   Update RepairLog interface:
   - Add isWarrantyClaim: boolean
   - Add reminderDate?: string
   - Add reminderSent: boolean

   Update RepairLogCreate:
   - Add isWarrantyClaim?: boolean
   - Add reminderDate?: string

2. lib/api/repair-logs.ts - Add new API methods:
   - uploadPhoto(workspaceId, repairLogId, file, photoType, caption?) - multipart upload
   - listPhotos(workspaceId, repairLogId) -> RepairPhoto[]
   - deletePhoto(workspaceId, repairLogId, photoId)
   - linkAttachment(workspaceId, repairLogId, fileId, attachmentType, title?) -> RepairAttachment
   - listAttachments(workspaceId, repairLogId) -> RepairAttachment[]
   - unlinkAttachment(workspaceId, repairLogId, attachmentId)
   - getRepairCost(workspaceId, inventoryId) -> RepairCostSummary[]
   - setWarrantyClaim(workspaceId, repairLogId, isWarrantyClaim)
   - setReminderDate(workspaceId, repairLogId, reminderDate)
  </action>
  <verify>bun run type-check (from frontend directory)</verify>
  <done>TypeScript types compile without errors</done>
</task>

<task type="auto">
  <name>Task 2: Create repair photo upload component</name>
  <files>
    frontend/components/inventory/repair-photo-upload.tsx
  </files>
  <action>
Create new component following photo-upload.tsx pattern:

```typescript
interface RepairPhotoUploadProps {
  workspaceId: string;
  repairLogId: string;
  photos: RepairPhoto[];
  onPhotosChange: () => void;
}
```

Features:
- Photo type selector (Before/During/After) with icons
- Drag-and-drop zone for file upload (reuse existing DnD patterns)
- Upload progress indicator
- Photo grid showing existing photos grouped by type
- Thumbnails with hover for full size
- Caption editing (inline or modal)
- Delete button with confirmation
- Display photos grouped: Before section, During section, After section
- Use lucide icons: Camera for Before, Wrench for During, CheckCircle for After
  </action>
  <verify>bun run type-check && grep -l "RepairPhotoUpload" frontend/components/inventory/repair-photo-upload.tsx</verify>
  <done>RepairPhotoUpload component created and compiles</done>
</task>

<task type="auto">
  <name>Task 3: Extend repair history with photos, warranty, reminders, and cost</name>
  <files>
    frontend/components/inventory/repair-history.tsx
    frontend/components/inventory/repair-attachments.tsx
    frontend/messages/en.json
    frontend/messages/et.json
    frontend/messages/ru.json
  </files>
  <action>
1. Create repair-attachments.tsx:
   - Simple component listing attachments for a repair
   - File picker to link existing files (from workspace files)
   - Display attachment type badge, file name, size
   - Delete (unlink) button

2. Extend repair-history.tsx:
   - Add warranty claim toggle (Checkbox) in create/edit forms
   - Add reminder date picker (DatePicker) in create/edit forms
   - Add "Photos" tab or expandable section showing RepairPhotoUpload
   - Add "Attachments" tab or expandable section showing RepairAttachments
   - Add lifecycle cost summary at top of dialog (fetch on open)
     - Show total per currency: "Total repair cost: EUR 150.00 (3 repairs)"
   - Show warranty badge on repairs where isWarrantyClaim = true
   - Show reminder icon with date on repairs with reminderDate
   - Use Tabs component if adding Photos/Attachments tabs

3. Update translations (en.json, et.json, ru.json):
   - repairs.warrantyClaim: "Warranty Claim"
   - repairs.reminderDate: "Reminder Date"
   - repairs.photos: "Photos"
   - repairs.attachments: "Attachments"
   - repairs.beforePhotos: "Before"
   - repairs.duringPhotos: "During"
   - repairs.afterPhotos: "After"
   - repairs.uploadPhoto: "Upload Photo"
   - repairs.linkAttachment: "Link Attachment"
   - repairs.totalCost: "Total Repair Cost"
   - repairs.noPhotos: "No photos attached"
   - repairs.noAttachments: "No attachments linked"
  </action>
  <verify>bun run build (from frontend directory)</verify>
  <done>Frontend builds successfully with all new features</done>
</task>

</tasks>

<verification>
- [ ] Frontend type-check passes: `cd frontend && bun run type-check`
- [ ] Frontend builds: `cd frontend && bun run build`
- [ ] RepairPhotoUpload component exists with photo type selection
- [ ] Repair history shows warranty toggle and reminder date picker
- [ ] Lifecycle cost displayed at top of repair history dialog
- [ ] All three language files have new translation keys
</verification>

<success_criteria>
Users can:
1. Upload before/during/after photos to repairs with visual grouping
2. Link attachments (receipts, warranty docs) to repairs
3. See total lifecycle repair cost per inventory item
4. Toggle warranty claim flag on repairs
5. Set reminder dates for future maintenance
</success_criteria>

<output>
After completion, create `.planning/phases/13-repair-log-extensions/13-04-SUMMARY.md`
</output>
