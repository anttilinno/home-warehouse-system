---
phase: 16-bulk-photo-operations
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - frontend/components/items/photo-gallery.tsx
  - frontend/components/items/photo-gallery-container.tsx
  - frontend/components/items/photo-selection-bar.tsx
  - frontend/components/items/duplicate-warning-dialog.tsx
  - frontend/components/items/photo-upload.tsx
  - frontend/lib/api/item-photos.ts
  - frontend/lib/types/item-photo.ts
  - frontend/messages/en.json
  - frontend/messages/fi.json
autonomous: true

must_haves:
  truths:
    - "User can toggle selection mode in photo gallery"
    - "User can select multiple photos with checkboxes"
    - "User can bulk delete selected photos with confirmation"
    - "User can bulk edit captions for selected photos"
    - "User can download selected or all photos as zip"
    - "User sees warning when uploading duplicate photo"
  artifacts:
    - path: "frontend/components/items/photo-gallery.tsx"
      provides: "Selection mode toggle, checkbox overlay on photos"
      contains: "selectionMode"
    - path: "frontend/components/items/photo-selection-bar.tsx"
      provides: "Bulk action bar for photo operations"
      min_lines: 50
    - path: "frontend/components/items/duplicate-warning-dialog.tsx"
      provides: "Dialog showing similar photos before upload"
      min_lines: 40
    - path: "frontend/lib/api/item-photos.ts"
      provides: "API client methods for bulk operations"
      exports: ["bulkDelete", "bulkUpdateCaptions", "downloadAsZip", "checkDuplicates"]
  key_links:
    - from: "photo-gallery.tsx"
      to: "useBulkSelection hook"
      via: "selection state management"
      pattern: "useBulkSelection"
    - from: "photo-selection-bar.tsx"
      to: "item-photos.ts API"
      via: "bulk operation calls"
      pattern: "itemPhotosApi\\.(bulkDelete|bulkUpdateCaptions|downloadAsZip)"
---

<objective>
Integrate selection mode into photo gallery with bulk actions for delete, caption edit, and zip download, plus duplicate detection during upload.

Purpose: Enable users to efficiently manage multiple photos at once, reducing repetitive individual operations.
Output: Interactive photo gallery with selection mode, bulk action bar, and duplicate warning during upload.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-bulk-photo-operations/16-RESEARCH.md
@.planning/phases/16-bulk-photo-operations/16-01-SUMMARY.md

# Existing UI infrastructure
@frontend/components/items/photo-gallery.tsx
@frontend/lib/hooks/use-bulk-selection.ts
@frontend/components/ui/bulk-action-bar.tsx
@frontend/lib/api/item-photos.ts
@frontend/lib/types/item-photo.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: API client and types for bulk operations</name>
  <files>
    - frontend/lib/types/item-photo.ts
    - frontend/lib/api/item-photos.ts
  </files>
  <action>
**Update item-photo.ts types** - Add:
```typescript
/**
 * Request for bulk delete operation
 */
export interface BulkDeleteRequest {
  photo_ids: string[];
}

/**
 * Single caption update for bulk operation
 */
export interface CaptionUpdate {
  photo_id: string;
  caption: string | null;
}

/**
 * Request for bulk caption update
 */
export interface BulkCaptionRequest {
  updates: CaptionUpdate[];
}

/**
 * Duplicate photo information
 */
export interface DuplicateInfo {
  photo_id: string;
  distance: number;
  similarity_percent: number;
  thumbnail_url: string | null;
}

/**
 * Response from duplicate check endpoint
 */
export interface DuplicateCheckResponse {
  duplicates: DuplicateInfo[];
  has_exact: boolean;
}
```

**Update item-photos.ts API client** - Add methods:

```typescript
/**
 * Bulk delete multiple photos
 */
bulkDelete: async (
  workspaceId: string,
  itemId: string,
  photoIds: string[]
): Promise<void> => {
  await apiClient.post(
    `/workspaces/${workspaceId}/items/${itemId}/photos/bulk-delete`,
    { photo_ids: photoIds },
    workspaceId
  );
},

/**
 * Bulk update captions for multiple photos
 */
bulkUpdateCaptions: async (
  workspaceId: string,
  itemId: string,
  updates: CaptionUpdate[]
): Promise<void> => {
  await apiClient.post(
    `/workspaces/${workspaceId}/items/${itemId}/photos/bulk-caption`,
    { updates },
    workspaceId
  );
},

/**
 * Download photos as zip file
 * Uses fetch+blob to include auth headers (window.open cannot send headers)
 * @param photoIds - Optional array of photo IDs. If empty, downloads all photos.
 */
downloadAsZip: async (
  workspaceId: string,
  itemId: string,
  photoIds?: string[]
): Promise<void> => {
  const token = apiClient.getToken();
  const apiUrl = process.env.NEXT_PUBLIC_API_URL || "http://localhost:8000";
  let url = `${apiUrl}/workspaces/${workspaceId}/items/${itemId}/photos/download`;
  if (photoIds && photoIds.length > 0) {
    url += `?ids=${photoIds.join(",")}`;
  }

  const response = await fetch(url, {
    method: "GET",
    headers: {
      ...(token ? { Authorization: `Bearer ${token}` } : {}),
      "X-Workspace-ID": workspaceId,
    },
    credentials: "include",
  });

  if (!response.ok) {
    throw new Error(`Download failed: ${response.status}`);
  }

  // Create blob and trigger download
  const blob = await response.blob();
  const downloadUrl = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = downloadUrl;
  link.download = `photos-${itemId.slice(0, 8)}.zip`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(downloadUrl);
},

/**
 * Check for duplicate photos before upload
 */
checkDuplicates: async (
  workspaceId: string,
  itemId: string,
  file: File
): Promise<DuplicateCheckResponse> => {
  const formData = new FormData();
  formData.append("photo", file);

  const token = apiClient.getToken();
  const apiUrl = process.env.NEXT_PUBLIC_API_URL || "http://localhost:8000";

  const response = await fetch(
    `${apiUrl}/workspaces/${workspaceId}/items/${itemId}/photos/check-duplicate`,
    {
      method: "POST",
      headers: {
        ...(token ? { Authorization: `Bearer ${token}` } : {}),
        "X-Workspace-ID": workspaceId,
      },
      credentials: "include",
      body: formData,
    }
  );

  if (!response.ok) {
    throw new Error(`HTTP ${response.status}`);
  }

  return response.json();
},
```
  </action>
  <verify>
    - TypeScript compilation passes: `bun run type-check` or `bun run build`
    - No import errors in dependent files
  </verify>
  <done>
    - All bulk operation types exported from item-photo.ts
    - API client has bulkDelete, bulkUpdateCaptions, downloadAsZip, checkDuplicates methods
  </done>
</task>

<task type="auto">
  <name>Task 2: Photo gallery selection mode and bulk action components</name>
  <files>
    - frontend/components/items/photo-gallery.tsx
    - frontend/components/items/photo-selection-bar.tsx
    - frontend/messages/en.json
    - frontend/messages/fi.json
  </files>
  <action>
**Create photo-selection-bar.tsx** - Bulk action bar specific to photos:
```typescript
"use client";

import * as React from "react";
import { Trash2, Edit3, Download, X } from "lucide-react";
import { useTranslations } from "next-intl";
import { Button } from "@/components/ui/button";
import { BulkActionBar } from "@/components/ui/bulk-action-bar";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";

interface PhotoSelectionBarProps {
  selectedCount: number;
  onClear: () => void;
  onBulkDelete: () => Promise<void>;
  onBulkCaption: (caption: string) => Promise<void>;
  onDownload: () => void;
  isDeleting?: boolean;
  isUpdating?: boolean;
}

export function PhotoSelectionBar({
  selectedCount,
  onClear,
  onBulkDelete,
  onBulkCaption,
  onDownload,
  isDeleting = false,
  isUpdating = false,
}: PhotoSelectionBarProps) {
  const t = useTranslations("photos.bulk");
  const [showDeleteDialog, setShowDeleteDialog] = React.useState(false);
  const [showCaptionDialog, setShowCaptionDialog] = React.useState(false);
  const [caption, setCaption] = React.useState("");

  const handleDelete = async () => {
    await onBulkDelete();
    setShowDeleteDialog(false);
  };

  const handleCaption = async () => {
    await onBulkCaption(caption);
    setShowCaptionDialog(false);
    setCaption("");
  };

  return (
    <>
      <BulkActionBar selectedCount={selectedCount} onClear={onClear}>
        <Button
          variant="outline"
          size="sm"
          onClick={onDownload}
        >
          <Download className="mr-2 h-4 w-4" />
          {t("download")}
        </Button>
        <Button
          variant="outline"
          size="sm"
          onClick={() => setShowCaptionDialog(true)}
          disabled={isUpdating}
        >
          <Edit3 className="mr-2 h-4 w-4" />
          {t("editCaptions")}
        </Button>
        <Button
          variant="destructive"
          size="sm"
          onClick={() => setShowDeleteDialog(true)}
          disabled={isDeleting}
        >
          <Trash2 className="mr-2 h-4 w-4" />
          {t("delete")}
        </Button>
      </BulkActionBar>

      {/* Delete confirmation dialog */}
      <AlertDialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>{t("deleteTitle")}</AlertDialogTitle>
            <AlertDialogDescription>
              {t("deleteDescription", { count: selectedCount })}
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel disabled={isDeleting}>
              {t("cancel")}
            </AlertDialogCancel>
            <AlertDialogAction
              onClick={handleDelete}
              disabled={isDeleting}
              className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
            >
              {isDeleting ? t("deleting") : t("confirmDelete")}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>

      {/* Caption edit dialog */}
      <Dialog open={showCaptionDialog} onOpenChange={setShowCaptionDialog}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>{t("captionTitle")}</DialogTitle>
            <DialogDescription>
              {t("captionDescription", { count: selectedCount })}
            </DialogDescription>
          </DialogHeader>
          <div className="py-4">
            <Label htmlFor="caption">{t("captionLabel")}</Label>
            <Textarea
              id="caption"
              value={caption}
              onChange={(e) => setCaption(e.target.value)}
              placeholder={t("captionPlaceholder")}
              className="mt-2"
            />
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setShowCaptionDialog(false)}>
              {t("cancel")}
            </Button>
            <Button onClick={handleCaption} disabled={isUpdating}>
              {isUpdating ? t("updating") : t("applyCaption")}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </>
  );
}
```

**Update photo-gallery.tsx** - Add selection mode:

1. Add new props to PhotoGalleryProps:
   ```typescript
   selectionMode?: boolean;
   selectedIds?: string[];
   onToggleSelect?: (photoId: string) => void;
   onSelectAll?: () => void;
   ```

2. Update PointerSensor to disable drag when in selection mode:
   ```typescript
   useSensor(PointerSensor, {
     activationConstraint: {
       distance: selectionMode ? Infinity : 8, // Disable drag in selection mode
     },
   }),
   ```

3. Update SortablePhotoItem to show checkbox when in selection mode:
   - Add `selectionMode`, `isSelected`, `onToggleSelect` props
   - When selectionMode=true, show Checkbox overlay in top-left corner
   - Clicking photo toggles selection instead of opening lightbox
   - Hide drag handle in selection mode

4. Add "Select" / "Cancel" button above gallery (passed via onToggleSelectionMode prop or internal state)

5. Add "Select All" checkbox when in selection mode

**Update photo-gallery-container.tsx** - Add selection mode orchestration:
1. Import useBulkSelection from "@/lib/hooks/use-bulk-selection"
2. Import PhotoSelectionBar from "./photo-selection-bar"
3. Add state: `selectionMode`, `setSelectionMode` via useState
4. Use `useBulkSelection<string>()` for selectedIds management
5. Pass selection props to PhotoGallery: `selectionMode`, `selectedIds`, `onToggleSelect`, `onSelectAll`
6. Render PhotoSelectionBar when `selectedCount > 0` with bulk action handlers:
   - `onBulkDelete`: call `itemPhotosApi.bulkDelete()`, then refresh photos
   - `onBulkCaption`: call `itemPhotosApi.bulkUpdateCaptions()`, then refresh photos
   - `onDownload`: call `itemPhotosApi.downloadAsZip()` with selected IDs
7. Add "Select" / "Cancel" toggle button above the gallery grid

**Add translations** to en.json and fi.json under "photos.bulk":
```json
{
  "photos": {
    "bulk": {
      "select": "Select",
      "cancel": "Cancel",
      "selectAll": "Select All",
      "download": "Download",
      "editCaptions": "Edit Captions",
      "delete": "Delete",
      "deleteTitle": "Delete Photos",
      "deleteDescription": "Are you sure you want to delete {count} photos? This action cannot be undone.",
      "deleting": "Deleting...",
      "confirmDelete": "Delete Photos",
      "captionTitle": "Edit Captions",
      "captionDescription": "Set the same caption for {count} selected photos.",
      "captionLabel": "Caption",
      "captionPlaceholder": "Enter caption for all selected photos...",
      "updating": "Updating...",
      "applyCaption": "Apply Caption"
    }
  }
}
```
  </action>
  <verify>
    - `bun run build` completes without errors
    - PhotoGallery renders with selection mode toggle
    - Checkboxes appear on photos when selection mode is active
  </verify>
  <done>
    - PhotoGallery has working selection mode toggle
    - Photos show checkbox overlay when selection mode active
    - Drag-and-drop disabled during selection mode
    - PhotoSelectionBar shows bulk action buttons
    - Delete and caption dialogs work
  </done>
</task>

<task type="auto">
  <name>Task 3: Duplicate warning during upload and integration</name>
  <files>
    - frontend/components/items/duplicate-warning-dialog.tsx
    - frontend/components/items/photo-upload.tsx
    - frontend/messages/en.json
    - frontend/messages/fi.json
  </files>
  <action>
**Create duplicate-warning-dialog.tsx**:
```typescript
"use client";

import * as React from "react";
import Image from "next/image";
import { AlertTriangle } from "lucide-react";
import { useTranslations } from "next-intl";
import { Button } from "@/components/ui/button";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import type { DuplicateInfo } from "@/lib/types/item-photo";

interface DuplicateWarningDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  duplicates: DuplicateInfo[];
  hasExact: boolean;
  onProceed: () => void;
  onCancel: () => void;
  isUploading?: boolean;
}

export function DuplicateWarningDialog({
  open,
  onOpenChange,
  duplicates,
  hasExact,
  onProceed,
  onCancel,
  isUploading = false,
}: DuplicateWarningDialogProps) {
  const t = useTranslations("photos.duplicates");

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-md">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <AlertTriangle className="h-5 w-5 text-yellow-500" />
            {hasExact ? t("exactTitle") : t("similarTitle")}
          </DialogTitle>
          <DialogDescription>
            {hasExact ? t("exactDescription") : t("similarDescription")}
          </DialogDescription>
        </DialogHeader>

        <div className="py-4">
          <p className="text-sm text-muted-foreground mb-3">
            {t("foundCount", { count: duplicates.length })}
          </p>
          <div className="flex gap-2 flex-wrap">
            {duplicates.slice(0, 4).map((dup) => (
              <div key={dup.photo_id} className="relative">
                {dup.thumbnail_url ? (
                  <Image
                    src={dup.thumbnail_url}
                    alt={t("existingPhoto")}
                    width={80}
                    height={80}
                    className="rounded border object-cover"
                  />
                ) : (
                  <div className="w-20 h-20 rounded border bg-muted flex items-center justify-center">
                    <span className="text-xs text-muted-foreground">No preview</span>
                  </div>
                )}
                <span className="absolute bottom-1 right-1 bg-black/70 text-white text-xs px-1 rounded">
                  {dup.similarity_percent}%
                </span>
              </div>
            ))}
            {duplicates.length > 4 && (
              <div className="w-20 h-20 rounded border bg-muted flex items-center justify-center">
                <span className="text-sm text-muted-foreground">
                  +{duplicates.length - 4}
                </span>
              </div>
            )}
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onCancel} disabled={isUploading}>
            {t("cancel")}
          </Button>
          <Button onClick={onProceed} disabled={isUploading}>
            {isUploading ? t("uploading") : t("uploadAnyway")}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

**Integrate duplicate check into photo-upload.tsx**:

In the `uploadFile()` function (around line 139), before calling `itemPhotosApi.uploadItemPhoto`:

1. Add state at component level:
   ```typescript
   const [pendingUploadIndex, setPendingUploadIndex] = useState<number | null>(null);
   const [duplicateInfo, setDuplicateInfo] = useState<DuplicateCheckResponse | null>(null);
   const [showDuplicateWarning, setShowDuplicateWarning] = useState(false);
   ```

2. In `uploadFile()`, before the upload call, add duplicate check:
   ```typescript
   // Check for duplicates before upload
   try {
     const duplicateResult = await itemPhotosApi.checkDuplicates(workspaceId, itemId, fileToUpload);
     if (duplicateResult.duplicates.length > 0) {
       // Store pending upload and show warning
       setPendingUploadIndex(index);
       setDuplicateInfo(duplicateResult);
       setShowDuplicateWarning(true);
       return; // Don't upload yet - wait for user decision
     }
   } catch (err) {
     // If duplicate check fails, proceed with upload anyway
     console.warn("Duplicate check failed:", err);
   }
   ```

3. Add handler for proceeding after warning:
   ```typescript
   const handleProceedWithUpload = async () => {
     setShowDuplicateWarning(false);
     if (pendingUploadIndex !== null) {
       // Continue with upload (skip duplicate check this time)
       await uploadFileInternal(pendingUploadIndex);
     }
     setPendingUploadIndex(null);
     setDuplicateInfo(null);
   };
   ```

4. Render DuplicateWarningDialog at end of component:
   ```typescript
   <DuplicateWarningDialog
     open={showDuplicateWarning}
     onOpenChange={setShowDuplicateWarning}
     duplicates={duplicateInfo?.duplicates ?? []}
     hasExact={duplicateInfo?.has_exact ?? false}
     onProceed={handleProceedWithUpload}
     onCancel={() => {
       setShowDuplicateWarning(false);
       setPendingUploadIndex(null);
       setDuplicateInfo(null);
     }}
   />
   ```

**Add translations** to en.json and fi.json under "photos.duplicates":
```json
{
  "photos": {
    "duplicates": {
      "exactTitle": "Duplicate Photo Detected",
      "similarTitle": "Similar Photos Found",
      "exactDescription": "This photo appears to already exist in this item.",
      "similarDescription": "We found photos that look similar to the one you're uploading.",
      "foundCount": "{count} similar photo(s) found:",
      "existingPhoto": "Existing photo",
      "cancel": "Cancel",
      "uploadAnyway": "Upload Anyway",
      "uploading": "Uploading..."
    }
  }
}
```
  </action>
  <verify>
    - `bun run build` completes
    - DuplicateWarningDialog renders with mock data
    - Upload flow checks for duplicates before uploading
  </verify>
  <done>
    - DuplicateWarningDialog component created
    - Upload flow calls checkDuplicates before upload
    - User sees warning with similar photo thumbnails
    - User can choose to proceed or cancel upload
  </done>
</task>

</tasks>

<verification>
Complete user flows work:
1. Selection mode: Click "Select" button -> checkboxes appear on photos
2. Bulk delete: Select photos -> click Delete -> confirm -> photos removed
3. Bulk caption: Select photos -> click Edit Captions -> enter text -> all selected get same caption
4. Zip download: Select photos -> click Download -> zip file downloads in browser
5. Duplicate warning: Try to upload similar photo -> warning dialog appears with thumbnails
</verification>

<success_criteria>
- Photo gallery has working selection mode toggle
- Drag-and-drop disabled when selection mode active
- Bulk delete removes selected photos with confirmation
- Bulk caption updates all selected photos with same text
- Download triggers zip file download (selected or all)
- Upload shows duplicate warning when similar photos exist
- All translations present for en and fi locales
- No visual regressions in normal gallery mode
</success_criteria>

<output>
After completion, create `.planning/phases/16-bulk-photo-operations/16-02-SUMMARY.md`
</output>
