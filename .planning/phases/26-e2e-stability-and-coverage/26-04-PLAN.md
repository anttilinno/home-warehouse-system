---
phase: 26-e2e-stability-and-coverage
plan: 04
type: execute
wave: 2
depends_on: ["26-01", "26-02"]
files_modified:
  - frontend/e2e/dashboard/loans.spec.ts
  - frontend/e2e/pages/LoansPage.ts
autonomous: false

must_haves:
  truths:
    - "Test suite passes 10 consecutive runs without flaky failures"
    - "Coverage gaps are documented for future work"
    - "Complete loan flow can be tested E2E"
  artifacts:
    - path: "frontend/e2e/dashboard/loans.spec.ts"
      provides: "Enhanced loan tests with CRUD flow"
      min_lines: 150
  key_links:
    - from: "frontend/e2e/dashboard/loans.spec.ts"
      to: "frontend/e2e/pages/LoansPage.ts"
      via: "Page Object usage"
      pattern: "new LoansPage"
---

<objective>
Verify E2E test stability and add loan CRUD flow tests to fill the most critical gap.

Purpose: The existing loan tests check UI elements but don't complete actual create/return flows. This plan adds actual CRUD completion and validates overall test stability.

Output: Enhanced loan tests with actual flow completion, and stability verification across the test suite.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-e2e-stability-and-coverage/26-RESEARCH.md

@frontend/e2e/dashboard/loans.spec.ts
@frontend/e2e/pages/LoansPage.ts
@frontend/e2e/dashboard/items.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add loan CRUD flow tests</name>
  <files>frontend/e2e/dashboard/loans.spec.ts, frontend/e2e/pages/LoansPage.ts</files>
  <action>
Add comprehensive CRUD tests to loans.spec.ts that actually complete operations:

1. First, check LoansPage.ts for existing methods and add any missing ones for CRUD:
   ```typescript
   // Add to LoansPage.ts if not present:
   async selectFirstInventory(): Promise<void> {
     const inventorySelect = this.createDialog.locator('button[role="combobox"]').first();
     await inventorySelect.click();
     const firstOption = this.page.locator('[role="option"]').first();
     await firstOption.click();
   }

   async selectFirstBorrower(): Promise<void> {
     const borrowerSelect = this.createDialog.locator('button[role="combobox"]').nth(1);
     await borrowerSelect.click();
     const firstOption = this.page.locator('[role="option"]').first();
     await firstOption.click();
   }

   async submitLoanForm(): Promise<void> {
     await this.dialogSubmitButton.click();
     await this.createDialog.waitFor({ state: "hidden", timeout: 5000 });
   }
   ```

2. Add a new test describe block for CRUD flows in loans.spec.ts:
   ```typescript
   test.describe("Loan CRUD Flows", () => {
     test.describe.configure({ mode: "serial" });

     let loansPage: LoansPage;

     test.beforeAll(async ({ browser }) => {
       // Note: These tests require existing inventory and borrowers
       // They will be skipped if prerequisites don't exist
     });

     test("can create a new loan when prerequisites exist", async ({ page }) => {
       loansPage = new LoansPage(page);
       await loansPage.goto();
       await loansPage.waitForPageLoaded();

       await loansPage.openCreateDialog();
       await expect(loansPage.createDialog).toBeVisible();

       // Check if we have any inventory options
       const inventorySelect = loansPage.createDialog.locator('button[role="combobox"]').first();
       await inventorySelect.click();

       const hasOptions = await page.locator('[role="option"]').count() > 0;

       if (!hasOptions) {
         test.skip();
         return;
       }

       // Select first inventory
       await page.locator('[role="option"]').first().click();

       // Select borrower
       const borrowerSelect = loansPage.createDialog.locator('button[role="combobox"]').nth(1);
       await borrowerSelect.click();

       const hasBorrowers = await page.locator('[role="option"]').count() > 0;
       if (!hasBorrowers) {
         test.skip();
         return;
       }

       await page.locator('[role="option"]').first().click();

       // Set due date (optional)
       const dueDateInput = loansPage.createDialog.locator('input[type="date"]');
       if (await dueDateInput.isVisible()) {
         const futureDate = new Date();
         futureDate.setDate(futureDate.getDate() + 7);
         await dueDateInput.fill(futureDate.toISOString().split('T')[0]);
       }

       // Submit
       await loansPage.dialogSubmitButton.click();

       // Verify success - either dialog closes or toast appears
       await expect(
         loansPage.createDialog.or(page.getByText(/created|success|queued/i))
       ).toBeVisible({ timeout: 5000 });
     });

     test("can view loan details after creation", async ({ page }) => {
       loansPage = new LoansPage(page);
       await loansPage.goto();
       await loansPage.waitForPageLoaded();

       const rows = loansPage.getAllLoanRows();
       const rowCount = await rows.count();

       if (rowCount === 0) {
         test.skip();
         return;
       }

       // Click first loan row
       await rows.first().click();

       // Should navigate to detail page or show detail modal
       await expect(
         page.locator('[role="dialog"]').or(page)
       ).toHaveURL(/\/loans\/|dialog/);
     });

     test("can return a loan", async ({ page }) => {
       loansPage = new LoansPage(page);
       await loansPage.goto();
       await loansPage.waitForPageLoaded();

       // Filter to active loans only
       const activeFilter = page.getByRole("button", { name: /active|on loan/i });
       if (await activeFilter.isVisible()) {
         await activeFilter.click();
       }

       const rows = loansPage.getAllLoanRows();
       const rowCount = await rows.count();

       if (rowCount === 0) {
         test.skip();
         return;
       }

       // Find return button on first row
       const firstRow = rows.first();
       const returnButton = firstRow.getByRole("button", { name: /return/i });

       if (await returnButton.isVisible()) {
         await returnButton.click();

         // Confirm return if dialog appears
         const confirmButton = page.getByRole("button", { name: /confirm|return/i });
         if (await confirmButton.isVisible({ timeout: 2000 }).catch(() => false)) {
           await confirmButton.click();
         }

         // Verify success
         await expect(page.getByText(/returned|success/i)).toBeVisible({ timeout: 5000 });
       }
     });
   });
   ```
  </action>
  <verify>
```bash
cd frontend && bun run test:e2e -- e2e/dashboard/loans.spec.ts --project=chromium
```
Tests should pass or be skipped gracefully if prerequisites don't exist.
  </verify>
  <done>Loan CRUD flow tests added with proper skip conditions for missing prerequisites.</done>
</task>

<task type="auto">
  <name>Task 2: Run 10 consecutive E2E test runs for stability verification</name>
  <files>(none - verification task)</files>
  <action>
Run the critical test files 10 times to verify stability:

```bash
cd frontend

# Create a script to run tests 10 times
for i in {1..10}; do
  echo "=== Run $i of 10 ==="
  bun run test:e2e -- e2e/auth.setup.ts e2e/dashboard/navigation.spec.ts e2e/dashboard/items.spec.ts --project=chromium --retries=0
  if [ $? -ne 0 ]; then
    echo "FAILURE on run $i"
    exit 1
  fi
done
echo "All 10 runs passed!"
```

Track results:
- Run 1: Pass/Fail
- Run 2: Pass/Fail
- ...
- Run 10: Pass/Fail

If any failures:
1. Identify the failing test
2. Check if it's a timing issue (add proper wait)
3. Fix and re-run from the beginning
  </action>
  <verify>
All 10 runs pass without any flaky failures. Zero retries needed.
  </verify>
  <done>Test suite passes 10 consecutive runs without flaky failures.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
E2E test stability improvements:
1. Auth setup rewritten with proper waits (no waitForTimeout)
2. High-risk files stabilized (theme, categories-dnd, approval-detail, register, items)
3. Inventory page tests added (new coverage)
4. Loan CRUD flow tests added (enhanced coverage)
5. 10 consecutive test runs passed
  </what-built>
  <how-to-verify>
1. Run the full E2E test suite:
   ```bash
   cd frontend && bun run test:e2e --project=chromium
   ```
2. Verify no flaky failures in CI (if available, check recent CI runs)
3. Confirm auth setup completes quickly and reliably
4. Verify the new inventory tests run correctly
  </how-to-verify>
  <resume-signal>Type "approved" if tests are stable, or describe any flaky tests that need attention.</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Document remaining coverage gaps</name>
  <files>(summary documentation)</files>
  <action>
Document the remaining E2E coverage gaps for future work:

**Covered by this phase:**
- Auth setup timing (E2E-01) - FIXED
- Flaky tests in high-risk files (E2E-02) - FIXED (theme, categories-dnd, approval-detail, register, items)
- Inventory page tests (E2E-03) - ADDED
- Loan CRUD flows (E2E-03) - ADDED

**Remaining gaps (for future phases):**
1. **Complete CRUD in existing specs:**
   - items.spec.ts - Opens dialog but doesn't submit
   - locations.spec.ts - Opens dialog but doesn't submit
   - containers.spec.ts - Opens dialog but doesn't submit
   - borrowers.spec.ts - Opens dialog but doesn't submit
   - categories.spec.ts - Opens dialog but doesn't submit

2. **Remaining waitForTimeout instances:**
   - Run `grep -r "waitForTimeout" e2e/` to find remaining files
   - Lower priority files not addressed in this phase

3. **Multi-entity flows:**
   - Create item -> Create inventory -> Create loan flow
   - Full approval workflow (member creates, admin approves)

4. **Error handling tests:**
   - Validation error displays
   - API failure handling
   - Network offline behavior (partially covered in offline/ folder)

Include this gap analysis in the SUMMARY.md.
  </action>
  <verify>
Gap documentation is comprehensive and actionable for future phases.
  </verify>
  <done>Coverage gaps documented for future prioritization.</done>
</task>

</tasks>

<verification>
1. Loan CRUD tests exist in loans.spec.ts
2. Test suite passes 10 consecutive runs: `for i in {1..10}; do bun run test:e2e -- --project=chromium; done`
3. No flaky failures in the modified files
4. Coverage gaps are documented in the summary
</verification>

<success_criteria>
- Loan CRUD flow tests added with proper skip conditions
- Test suite passes 10 consecutive runs without flaky failures
- Coverage gaps documented for future work
- User approves overall stability
</success_criteria>

<output>
After completion, create `.planning/phases/26-e2e-stability-and-coverage/26-04-SUMMARY.md`
</output>
