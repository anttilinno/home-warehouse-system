---
phase: 26-e2e-stability-and-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/e2e/auth.setup.ts
autonomous: true

must_haves:
  truths:
    - "Auth setup completes within 5 seconds consistently"
    - "Auth state is verified before saving storage state"
    - "No waitForTimeout calls remain in auth.setup.ts"
  artifacts:
    - path: "frontend/e2e/auth.setup.ts"
      provides: "Reliable authentication setup for all E2E tests"
      contains: "waitForURL"
  key_links:
    - from: "frontend/e2e/auth.setup.ts"
      to: "playwright/.auth/user.json"
      via: "storageState save after verified auth"
      pattern: "storageState.*path"
---

<objective>
Fix auth.setup.ts timing issues to eliminate flaky authentication in E2E tests.

Purpose: The current auth setup uses `waitForTimeout(2000)` which causes unreliable test runs. Tests fail when auth isn't ready, but pass on retry.

Output: Reliable auth.setup.ts that uses proper wait conditions and verifies authentication state before saving.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-e2e-stability-and-coverage/26-RESEARCH.md

@frontend/e2e/auth.setup.ts
@frontend/e2e/fixtures/authenticated.ts
@frontend/playwright.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite auth.setup.ts with proper wait conditions</name>
  <files>frontend/e2e/auth.setup.ts</files>
  <action>
Replace the flaky auth setup with a robust implementation:

1. Remove `waitForTimeout(2000)` on line 22
2. After registration form submission, use `Promise.race` to wait for:
   - Dashboard URL redirect: `page.waitForURL(/\/dashboard/, { timeout: 10000 })`
   - OR user-exists error: `expect(page.getByText(/already exists|already registered/i)).toBeVisible({ timeout: 10000 }).catch(() => {})`
3. If not on dashboard after race, login instead:
   - Navigate to `/en/login`
   - Fill credentials
   - Click sign in
   - Wait for dashboard with `waitForURL`
4. CRITICAL: Verify auth state before saving:
   - `await expect(page).toHaveURL(/\/dashboard/)`
   - Wait for user-specific content to be visible (user menu, sidebar, or dashboard shell)
   - Use `page.locator('[data-testid="user-menu"]').or(page.getByRole('button', { name: /account|user|profile/i })).or(page.locator('nav'))` to find any auth-indicating element
5. Only then save storage state

Pattern to follow from RESEARCH.md:
```typescript
// Wait for either success redirect OR error (user exists)
await Promise.race([
  page.waitForURL(/\/dashboard/, { timeout: 10000 }),
  expect(page.getByText(/already exists|already registered/i)).toBeVisible({ timeout: 10000 })
    .catch(() => {}),
]);

// If not on dashboard, user exists - login instead
if (!page.url().includes("/dashboard")) {
  await page.goto("/en/login");
  // ... login flow
}

// CRITICAL: Verify authentication before saving state
await expect(page).toHaveURL(/\/dashboard/);
await expect(
  page.locator('[data-testid="user-menu"]').or(
    page.getByRole('button', { name: /account|user|profile/i })
  ).or(page.locator('aside nav, [data-testid="sidebar"]'))
).toBeVisible({ timeout: 5000 });
```
  </action>
  <verify>
Run auth setup in isolation:
```bash
cd frontend && bun run test:e2e -- --project=setup
```
Should complete without waitForTimeout and save auth state.
  </verify>
  <done>Auth setup uses waitForURL and proper assertions instead of arbitrary timeouts, verifies auth before saving state.</done>
</task>

<task type="auto">
  <name>Task 2: Add timeout safeguard and improve error handling</name>
  <files>frontend/e2e/auth.setup.ts</files>
  <action>
Enhance the auth setup with better error handling:

1. Add a top-level setup timeout annotation:
   ```typescript
   setup.setTimeout(30000); // 30 second total timeout for auth setup
   ```

2. Wrap the entire auth flow in try/catch:
   - On any failure, take a screenshot for debugging
   - Re-throw with descriptive error message

3. Add explicit logging for CI debugging:
   ```typescript
   console.log('[Auth Setup] Starting authentication...');
   console.log('[Auth Setup] Registration attempt...');
   console.log('[Auth Setup] Checking for dashboard redirect...');
   console.log('[Auth Setup] Auth verified, saving state...');
   ```

4. Ensure all waits have explicit timeouts (no implicit defaults):
   - `waitForURL` should have `{ timeout: 10000 }`
   - `toBeVisible` should have `{ timeout: 5000 }`
  </action>
  <verify>
Run with verbose logging:
```bash
cd frontend && bun run test:e2e -- --project=setup --debug
```
Should show clear progress logs and fail fast on errors.
  </verify>
  <done>Auth setup has proper error handling with screenshots on failure and explicit timeouts.</done>
</task>

<task type="auto">
  <name>Task 3: Verify auth stability with repeated runs</name>
  <files>frontend/e2e/auth.setup.ts</files>
  <action>
Test the auth setup reliability:

1. Run the auth setup 5 times consecutively to verify stability:
   ```bash
   for i in {1..5}; do
     echo "Run $i"
     rm -f playwright/.auth/user.json
     bun run test:e2e -- --project=setup
   done
   ```

2. If any failures occur, identify the root cause and fix

3. Run a few authenticated tests to verify the saved auth state works:
   ```bash
   bun run test:e2e -- e2e/dashboard/navigation.spec.ts --project=chromium
   ```

4. Document any edge cases discovered in a code comment
  </action>
  <verify>
All 5 consecutive runs pass without timing failures. Authenticated tests run successfully using saved auth state.
  </verify>
  <done>Auth setup passes 5 consecutive runs and authenticated tests work with saved state.</done>
</task>

</tasks>

<verification>
1. `grep -c "waitForTimeout" frontend/e2e/auth.setup.ts` returns 0
2. `grep -c "waitForURL" frontend/e2e/auth.setup.ts` returns at least 1
3. Auth setup completes in under 5 seconds on average
4. Running `bun run test:e2e -- --project=setup` passes reliably
5. Authenticated tests pass using the saved auth state
</verification>

<success_criteria>
- No `waitForTimeout` calls in auth.setup.ts
- Auth setup uses `waitForURL` for navigation detection
- Auth state is verified before saving (dashboard URL + visible element)
- Auth setup completes in under 5 seconds
- Tests no longer fail due to auth timing issues
</success_criteria>

<output>
After completion, create `.planning/phases/26-e2e-stability-and-coverage/26-01-SUMMARY.md`
</output>
