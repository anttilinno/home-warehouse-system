---
phase: 26-e2e-stability-and-coverage
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/e2e/features/theme.spec.ts
  - frontend/e2e/dashboard/categories-dnd.spec.ts
  - frontend/e2e/dashboard/approval-detail.spec.ts
  - frontend/e2e/auth/register.spec.ts
  - frontend/e2e/dashboard/items.spec.ts
  - frontend/e2e/pages/ItemsPage.ts
  - frontend/e2e/pages/CategoriesPage.ts
autonomous: true

must_haves:
  truths:
    - "High-risk files have zero waitForTimeout calls"
    - "Tests use condition-based waits (toBeVisible, toBeHidden, waitForURL)"
    - "Page Object wait methods use proper assertions"
  artifacts:
    - path: "frontend/e2e/features/theme.spec.ts"
      provides: "Theme switching tests without arbitrary waits"
      min_lines: 100
    - path: "frontend/e2e/dashboard/categories-dnd.spec.ts"
      provides: "Drag-and-drop tests without arbitrary waits"
      min_lines: 100
    - path: "frontend/e2e/dashboard/approval-detail.spec.ts"
      provides: "Approval detail tests without arbitrary waits"
      min_lines: 200
  key_links:
    - from: "frontend/e2e/features/theme.spec.ts"
      to: "theme toggle"
      via: "expect().toHaveClass instead of waitForTimeout"
      pattern: "toHaveClass.*dark"
---

<objective>
Stabilize flaky tests by replacing waitForTimeout with condition-based waits.

Purpose: 85+ `waitForTimeout` instances across the test suite cause flakiness in CI. Focus on the highest-risk files first.

Output: High-risk test files stabilized with proper Playwright auto-wait patterns.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-e2e-stability-and-coverage/26-RESEARCH.md

@frontend/e2e/features/theme.spec.ts
@frontend/e2e/dashboard/categories-dnd.spec.ts
@frontend/e2e/dashboard/approval-detail.spec.ts
@frontend/e2e/auth/register.spec.ts
@frontend/e2e/dashboard/items.spec.ts
@frontend/e2e/pages/ItemsPage.ts
@frontend/e2e/pages/CategoriesPage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix theme.spec.ts (7 waitForTimeout instances)</name>
  <files>frontend/e2e/features/theme.spec.ts</files>
  <action>
Replace all 7 `waitForTimeout` calls in theme.spec.ts with proper assertions:

Pattern replacements:
1. After theme toggle click:
   ```typescript
   // BEFORE
   await themeToggle.click();
   await page.waitForTimeout(100);

   // AFTER
   await themeToggle.click();
   // Theme class updates immediately, use assertion retry
   ```

2. For theme class verification:
   ```typescript
   // BEFORE
   await page.waitForTimeout(100);
   const newClass = await html.getAttribute("class");

   // AFTER
   // Use expect with retry - it will poll until condition is met or timeout
   if (wasDark) {
     await expect(html).not.toHaveClass(/dark/, { timeout: 2000 });
   } else {
     await expect(html).toHaveClass(/dark/, { timeout: 2000 });
   }
   ```

3. For icon change verification:
   ```typescript
   // BEFORE
   await themeToggle.click();
   await page.waitForTimeout(100);
   const newIcon = await themeToggle.locator("svg").first().innerHTML();

   // AFTER
   await themeToggle.click();
   // Wait for icon to change using Playwright's auto-wait
   await expect(async () => {
     const currentIcon = await themeToggle.locator("svg").first().innerHTML().catch(() => "");
     expect(currentIcon).not.toBe(initialIcon);
   }).toPass({ timeout: 2000 });
   ```

Apply these patterns to all 7 instances in the file.
  </action>
  <verify>
```bash
cd frontend && grep -c "waitForTimeout" e2e/features/theme.spec.ts
```
Should return 0.
```bash
cd frontend && bun run test:e2e -- e2e/features/theme.spec.ts --project=chromium
```
All tests should pass.
  </verify>
  <done>theme.spec.ts has zero waitForTimeout calls and all tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Fix categories-dnd.spec.ts (7 waitForTimeout instances)</name>
  <files>frontend/e2e/dashboard/categories-dnd.spec.ts, frontend/e2e/pages/CategoriesPage.ts</files>
  <action>
Replace all 7 `waitForTimeout` calls in categories-dnd.spec.ts:

1. After hover for drag handle visibility:
   ```typescript
   // BEFORE
   await firstNode.hover();
   await page.waitForTimeout(100);

   // AFTER
   await firstNode.hover();
   // Drag handle appears on hover - wait for it
   const dragHandle = categoriesPage.dragHandle(name.trim());
   await expect(dragHandle).toBeVisible({ timeout: 2000 });
   ```

2. During drag operations:
   ```typescript
   // BEFORE
   await page.waitForTimeout(100); // Wait for visual feedback

   // AFTER
   // For drag visual feedback, wait for opacity or overlay class
   await expect(
     page.locator('[data-dnd-kit-dragging], [class*="opacity-50"]')
   ).toBeVisible({ timeout: 2000 }).catch(() => {});
   // Note: Some DnD libraries don't add visible indicators
   ```

3. After drag completion:
   ```typescript
   // BEFORE
   await page.mouse.up();
   await page.waitForTimeout(200);
   await page.waitForTimeout(300);

   // AFTER
   await page.mouse.up();
   // Wait for any API call or DOM update to complete
   await page.waitForLoadState('domcontentloaded');
   // Or wait for specific UI state if known
   ```

Also update CategoriesPage.ts if it has a `waitForCategoriesLoaded` method to use proper waits.
  </action>
  <verify>
```bash
cd frontend && grep -c "waitForTimeout" e2e/dashboard/categories-dnd.spec.ts
```
Should return 0.
```bash
cd frontend && bun run test:e2e -- e2e/dashboard/categories-dnd.spec.ts --project=chromium
```
All tests should pass.
  </verify>
  <done>categories-dnd.spec.ts has zero waitForTimeout calls and tests pass.</done>
</task>

<task type="auto">
  <name>Task 3: Fix approval-detail.spec.ts and remaining high-risk files</name>
  <files>frontend/e2e/dashboard/approval-detail.spec.ts, frontend/e2e/auth/register.spec.ts, frontend/e2e/dashboard/items.spec.ts, frontend/e2e/pages/ItemsPage.ts</files>
  <action>
Fix remaining high-risk files:

**approval-detail.spec.ts (5 instances):**
1. After status filter:
   ```typescript
   // BEFORE
   await approvalsPage.filterByStatus("pending");
   await page.waitForTimeout(300);

   // AFTER
   await approvalsPage.filterByStatus("pending");
   // Wait for filter to apply by checking URL or content
   await expect(page.locator('[data-status="pending"], [class*="pending"]')).toBeVisible({ timeout: 3000 }).catch(() => {});
   // Or simply wait for network to settle
   await page.waitForLoadState('domcontentloaded');
   ```

**register.spec.ts (3 instances):**
1. After form submission for validation:
   ```typescript
   // BEFORE
   await page.waitForTimeout(500);
   await expect(page).toHaveURL(/\/register/);

   // AFTER
   // Just use the assertion - it has built-in retry
   await expect(page).toHaveURL(/\/register/);
   ```

2. After email validation blur:
   ```typescript
   // BEFORE
   await registerPage.emailInput.blur();
   await page.waitForTimeout(100);

   // AFTER
   await registerPage.emailInput.blur();
   // Validation runs on blur - wait for error to appear
   await expect(page.locator('.text-destructive').first()).toBeVisible({ timeout: 2000 }).catch(() => {});
   ```

**items.spec.ts (1 instance in search test):**
```typescript
// BEFORE
await itemsPage.search("zzz-unlikely-search-term-xyz");
await page.waitForTimeout(500);

// AFTER
await itemsPage.search("zzz-unlikely-search-term-xyz");
// Wait for table to update (either fewer rows or empty state)
await expect(async () => {
  const rows = await itemsPage.getAllItemRows().count();
  const hasEmpty = await itemsPage.hasEmptyState();
  expect(rows === 0 || hasEmpty).toBe(true);
}).toPass({ timeout: 3000 }).catch(() => {});
```

**ItemsPage.ts (2 instances in search method):**
```typescript
// BEFORE
async search(query: string): Promise<void> {
  await this.searchInput.fill(query);
  await this.page.waitForTimeout(400); // debounce
}

// AFTER
async search(query: string): Promise<void> {
  await this.searchInput.fill(query);
  // Wait for debounced search to trigger and results to load
  // Table or empty state will update when search completes
  await this.page.waitForLoadState('domcontentloaded');
}
```
  </action>
  <verify>
```bash
cd frontend && grep -c "waitForTimeout" e2e/dashboard/approval-detail.spec.ts e2e/auth/register.spec.ts e2e/dashboard/items.spec.ts e2e/pages/ItemsPage.ts
```
All files should return 0.
```bash
cd frontend && bun run test:e2e -- e2e/dashboard/approval-detail.spec.ts e2e/auth/register.spec.ts e2e/dashboard/items.spec.ts --project=chromium
```
All tests should pass.
  </verify>
  <done>All high-risk files have zero waitForTimeout calls and tests pass.</done>
</task>

</tasks>

<verification>
1. Total waitForTimeout count in high-risk files is 0:
   ```bash
   grep -c "waitForTimeout" frontend/e2e/features/theme.spec.ts frontend/e2e/dashboard/categories-dnd.spec.ts frontend/e2e/dashboard/approval-detail.spec.ts frontend/e2e/auth/register.spec.ts frontend/e2e/dashboard/items.spec.ts frontend/e2e/pages/ItemsPage.ts
   ```
2. All modified test files pass:
   ```bash
   bun run test:e2e -- e2e/features/theme.spec.ts e2e/dashboard/categories-dnd.spec.ts e2e/dashboard/approval-detail.spec.ts e2e/auth/register.spec.ts e2e/dashboard/items.spec.ts --project=chromium
   ```
3. Tests use `expect().toBeVisible()`, `expect().toHaveClass()`, or `waitForLoadState()` instead
</verification>

<success_criteria>
- theme.spec.ts: 0 waitForTimeout (was 7)
- categories-dnd.spec.ts: 0 waitForTimeout (was 7)
- approval-detail.spec.ts: 0 waitForTimeout (was 5)
- register.spec.ts: 0 waitForTimeout (was 3)
- items.spec.ts + ItemsPage.ts: 0 waitForTimeout (was 3)
- All modified tests pass reliably
</success_criteria>

<output>
After completion, create `.planning/phases/26-e2e-stability-and-coverage/26-02-SUMMARY.md`
</output>
