---
phase: 11-conflict-history
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/sync/conflict-resolver.ts
  - frontend/app/[locale]/(dashboard)/dashboard/sync-history/page.tsx
  - frontend/components/dashboard/sidebar.tsx
  - frontend/messages/en.json
  - frontend/messages/et.json
  - frontend/messages/ru.json
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can navigate to conflict history page from sidebar"
    - "User can see list of resolved conflicts with entity type, ID, fields, resolution, timestamp"
    - "User can filter conflicts by entity type using dropdown"
    - "User can filter conflicts by date range using date inputs"
    - "Combined filters (entity type + date range) work together"
  artifacts:
    - path: "frontend/lib/sync/conflict-resolver.ts"
      provides: "getFilteredConflicts function for IndexedDB queries"
      exports: ["getFilteredConflicts"]
    - path: "frontend/app/[locale]/(dashboard)/dashboard/sync-history/page.tsx"
      provides: "Sync history page with filtering UI"
      min_lines: 150
    - path: "frontend/components/dashboard/sidebar.tsx"
      provides: "Navigation link to sync-history"
      contains: "sync-history"
    - path: "frontend/messages/en.json"
      provides: "Translations for sync history page"
      contains: "syncHistory"
  key_links:
    - from: "frontend/app/[locale]/(dashboard)/dashboard/sync-history/page.tsx"
      to: "frontend/lib/sync/conflict-resolver.ts"
      via: "getFilteredConflicts import"
      pattern: "import.*getFilteredConflicts.*from.*conflict-resolver"
    - from: "frontend/components/dashboard/sidebar.tsx"
      to: "/dashboard/sync-history"
      via: "navItems href"
      pattern: "href.*sync-history"
---

<objective>
Build conflict history UI page showing all resolved sync conflicts from IndexedDB

Purpose: Allow users to review their sync conflict history, understand what conflicts occurred, and see how they were resolved. This completes the offline sync visibility story for v1.1.

Output: Working `/dashboard/sync-history` page with entity type and date range filtering, accessible from sidebar navigation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-conflict-history/11-RESEARCH.md

# Existing infrastructure
@frontend/lib/sync/conflict-resolver.ts
@frontend/lib/db/types.ts
@frontend/lib/db/offline-db.ts

# UI patterns to follow
@frontend/app/[locale]/(dashboard)/dashboard/approvals/page.tsx
@frontend/components/dashboard/sidebar.tsx
@frontend/messages/en.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add IndexedDB filter query function</name>
  <files>frontend/lib/sync/conflict-resolver.ts</files>
  <action>
Add a new function `getFilteredConflicts` to conflict-resolver.ts that queries the conflictLog IndexedDB store with optional filters.

Function signature:
```typescript
export async function getFilteredConflicts(
  filters: {
    entityType?: MutationEntityType;
    fromDate?: number; // ms since epoch
    toDate?: number;   // ms since epoch
  },
  limit: number = 100
): Promise<ConflictLogEntry[]>
```

Implementation approach (from RESEARCH.md Pattern 2):
1. Use `IDBKeyRange.bound()` for date range filtering on timestamp index
2. Apply entity type filter client-side after date range fetch
3. Return results in newest-first order

Handle edge cases:
- If only fromDate provided, use `IDBKeyRange.lowerBound(fromDate)`
- If only toDate provided, use `IDBKeyRange.upperBound(toDate)`
- If neither date provided, fetch all and apply entity type filter
- Respect limit parameter to avoid memory issues
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd frontend && bun run typecheck
```
  </verify>
  <done>
getFilteredConflicts function exported from conflict-resolver.ts, handles entity type filter, date range filter, and combined filters.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create sync history page with filtering</name>
  <files>frontend/app/[locale]/(dashboard)/dashboard/sync-history/page.tsx</files>
  <action>
Create the sync history page following the approvals page pattern.

Page structure:
1. "use client" directive (IndexedDB requires client-side)
2. Page header with title and subtitle
3. Filters row:
   - Entity type dropdown (Select component) with options: all, items, inventory, locations, containers, categories, borrowers, loans
   - Date range inputs (native HTML5 date inputs with clear button)
4. Conflict list (Card components)
5. Empty state when no conflicts

Each conflict card displays:
- Entity type icon (reuse entityTypeIcons from approvals page)
- Entity type badge
- Entity ID (as fallback for entity name - per RESEARCH.md open question)
- Resolution badge (local/server/merged with appropriate colors)
- Conflict fields list (comma-separated, use formatFieldName helper)
- Timestamp (formatted with date-fns formatDistanceToNow)
- resolvedAt if available

Use existing components:
- Card, CardContent from @/components/ui/card
- Badge from @/components/ui/badge
- Select, SelectContent, SelectItem, SelectTrigger, SelectValue from @/components/ui/select
- Input from @/components/ui/input (type="date")
- Button from @/components/ui/button (for clear dates)
- EmptyState from @/components/ui/empty-state

State management:
- entityTypeFilter: MutationEntityType | "all"
- fromDate: string | undefined (YYYY-MM-DD format for input)
- toDate: string | undefined
- conflicts: ConflictLogEntry[]
- isLoading: boolean

Load conflicts on mount and when filters change. Convert date strings to ms for getFilteredConflicts.

Use useTranslations("syncHistory") for i18n.
  </action>
  <verify>
TypeScript compiles and page renders:
```bash
cd frontend && bun run typecheck
cd frontend && bun run dev
# Visit http://localhost:3000/en/dashboard/sync-history
```
  </verify>
  <done>
Sync history page loads, displays conflicts from IndexedDB, entity type filter works, date range filter works, combined filters work.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add sidebar navigation and translations</name>
  <files>
frontend/components/dashboard/sidebar.tsx
frontend/messages/en.json
frontend/messages/et.json
frontend/messages/ru.json
  </files>
  <action>
**sidebar.tsx changes:**

1. Add History icon import from lucide-react
2. Add nav item to navItems array (after myChanges, before settings):
```typescript
{ icon: History, label: t("syncHistory"), href: "/dashboard/sync-history" },
```

**Translation files changes:**

Add to each messages file under "dashboard.nav":
```json
"syncHistory": "Sync History"
```

Add new "syncHistory" namespace with translations:
```json
"syncHistory": {
  "title": "Sync History",
  "subtitle": "Review resolved conflicts from offline sync",
  "empty": "No sync conflicts",
  "emptyDescription": "No conflicts have been recorded yet. Conflicts are logged when offline changes differ from server data.",
  "filter": {
    "allTypes": "All entity types",
    "items": "Items",
    "inventory": "Inventory",
    "locations": "Locations",
    "containers": "Containers",
    "categories": "Categories",
    "borrowers": "Borrowers",
    "loans": "Loans"
  },
  "dateRange": {
    "from": "From",
    "to": "To",
    "clear": "Clear dates"
  },
  "card": {
    "entityId": "ID",
    "resolution": "Resolution",
    "conflictFields": "Conflicting fields",
    "detected": "Detected",
    "resolved": "Resolved"
  },
  "resolution": {
    "local": "Kept local",
    "server": "Accepted server",
    "merged": "Merged"
  }
}
```

For et.json and ru.json, translate the above strings appropriately:
- Estonian: "Sünkroonimise ajalugu", "Konfliktid puuduvad", etc.
- Russian: "История синхронизации", "Нет конфликтов", etc.
  </action>
  <verify>
```bash
cd frontend && bun run typecheck
cd frontend && bun run dev
# Visit http://localhost:3000/en/dashboard - verify Sync History nav link appears
# Click link - navigates to sync-history page
# Check /et/dashboard and /ru/dashboard for translations
```
  </verify>
  <done>
Sidebar shows "Sync History" link with History icon, clicking navigates to sync-history page, translations appear correctly in all 3 locales.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Navigation works:**
   - Log into dashboard
   - Sidebar shows "Sync History" link
   - Clicking navigates to `/dashboard/sync-history`

2. **Page displays correctly:**
   - Title "Sync History" visible
   - Entity type filter dropdown works
   - Date range inputs work
   - If no conflicts exist, empty state shows

3. **Filtering works:**
   - Select entity type - list filters
   - Enter date range - list filters
   - Combine both - both filters apply
   - Clear dates - returns to unfiltered

4. **Build passes:**
   ```bash
   cd frontend && bun run build
   ```

5. **TypeScript clean:**
   ```bash
   cd frontend && bun run typecheck
   ```
</verification>

<success_criteria>
- [ ] User can navigate to sync history page from sidebar
- [ ] Page shows list of resolved conflicts (or empty state if none)
- [ ] Each conflict shows entity type, entity ID, conflicting fields, resolution, and timestamp
- [ ] Entity type filter works
- [ ] Date range filter works
- [ ] Combined filters work
- [ ] Page works in all 3 locales (en, et, ru)
- [ ] Build and typecheck pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-conflict-history/11-01-SUMMARY.md`
</output>
