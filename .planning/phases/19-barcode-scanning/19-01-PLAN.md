---
phase: 19-barcode-scanning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/scanner/init-polyfill.ts
  - frontend/lib/scanner/feedback.ts
  - frontend/lib/scanner/types.ts
autonomous: true

must_haves:
  truths:
    - "Barcode Detection API polyfill is registered on app load"
    - "Audio beep plays via Web Audio API"
    - "Haptic feedback triggers on Android devices"
  artifacts:
    - path: "frontend/lib/scanner/init-polyfill.ts"
      provides: "Polyfill registration for Safari/Firefox"
      contains: "barcode-detector/polyfill"
    - path: "frontend/lib/scanner/feedback.ts"
      provides: "Audio beep and haptic vibration utilities"
      exports: ["playBeep", "triggerHaptic"]
    - path: "frontend/lib/scanner/types.ts"
      provides: "Scanner type definitions"
      exports: ["EntityMatch", "ScanHistoryEntry"]
  key_links:
    - from: "frontend/lib/scanner/init-polyfill.ts"
      to: "barcode-detector/polyfill"
      via: "dynamic import"
      pattern: 'import.*barcode-detector/polyfill'
---

<objective>
Install barcode scanning dependencies and create scanner infrastructure utilities.

Purpose: Establish the foundation for barcode scanning - polyfill registration for cross-browser support and feedback utilities for user interaction.
Output: Scanner library utilities (polyfill, feedback, types) ready for component consumption.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-barcode-scanning/19-RESEARCH.md

Reference for existing patterns:
@frontend/lib/db/offline-db.ts (module structure pattern)
@frontend/lib/search/offline-search.ts (export patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install barcode scanning dependencies</name>
  <files>frontend/package.json</files>
  <action>
Install required npm packages:
```bash
cd frontend && bun add @yudiel/react-qr-scanner@^2.5.1 barcode-detector@^3.0.0
```

Verify packages are added to package.json with correct versions.
  </action>
  <verify>
```bash
cd frontend && grep -E "@yudiel/react-qr-scanner|barcode-detector" package.json
```
Both packages should appear with versions.
  </verify>
  <done>@yudiel/react-qr-scanner and barcode-detector installed in frontend/package.json</done>
</task>

<task type="auto">
  <name>Task 2: Create scanner types and polyfill initialization</name>
  <files>
    frontend/lib/scanner/types.ts
    frontend/lib/scanner/init-polyfill.ts
  </files>
  <action>
Create `frontend/lib/scanner/types.ts`:
```typescript
/**
 * Scanner Types
 *
 * Type definitions for barcode scanning functionality.
 */

import type { Item } from "@/lib/types/items";
import type { Container } from "@/lib/types/containers";
import type { Location } from "@/lib/types/locations";

/**
 * Result of looking up a scanned code in IndexedDB.
 */
export type EntityMatch =
  | { type: "item"; entity: Item }
  | { type: "container"; entity: Container }
  | { type: "location"; entity: Location }
  | { type: "not_found"; code: string };

/**
 * Entry in the scan history stored in localStorage.
 */
export interface ScanHistoryEntry {
  /** The raw scanned code value */
  code: string;
  /** Barcode format (qr_code, ean_13, etc) */
  format: string;
  /** Entity type if found, 'unknown' otherwise */
  entityType: "item" | "container" | "location" | "unknown";
  /** Entity ID if found */
  entityId?: string;
  /** Entity name for display */
  entityName?: string;
  /** Unix timestamp of scan */
  timestamp: number;
}

/**
 * Supported barcode formats for scanning.
 * Based on Barcode Detection API format strings.
 */
export const SUPPORTED_FORMATS = [
  "qr_code",
  "ean_13",
  "ean_8",
  "upc_a",
  "upc_e",
  "code_128",
] as const;

export type BarcodeFormat = (typeof SUPPORTED_FORMATS)[number];
```

Create `frontend/lib/scanner/init-polyfill.ts`:
```typescript
/**
 * Barcode Detection API Polyfill Initialization
 *
 * Registers the barcode-detector polyfill for browsers that don't support
 * the native Barcode Detection API (Safari, Firefox).
 *
 * IMPORTANT: Import this module before using any scanner components.
 * The polyfill only loads on the client and only if the native API is missing.
 *
 * @see https://github.com/AEC-Lab/package-barcode-detector
 */
"use client";

let polyfillLoaded = false;

/**
 * Initialize the Barcode Detection API polyfill.
 * Safe to call multiple times - only loads once.
 */
export async function initBarcodePolyfill(): Promise<void> {
  // Skip if already loaded or not in browser
  if (polyfillLoaded || typeof window === "undefined") {
    return;
  }

  // Skip if native API is available
  if ("BarcodeDetector" in window) {
    console.log("[Scanner] Native Barcode Detection API available");
    polyfillLoaded = true;
    return;
  }

  try {
    // Dynamic import the polyfill
    await import("barcode-detector/polyfill");
    polyfillLoaded = true;
    console.log("[Scanner] Barcode Detection API polyfill registered");
  } catch (error) {
    console.error("[Scanner] Failed to load barcode polyfill:", error);
    throw new Error("Barcode scanning not supported in this browser");
  }
}

/**
 * Check if the Barcode Detection API is available (native or polyfilled).
 */
export function isBarcodeDetectionAvailable(): boolean {
  return typeof window !== "undefined" && "BarcodeDetector" in window;
}
```
  </action>
  <verify>
```bash
ls -la frontend/lib/scanner/
cat frontend/lib/scanner/types.ts | head -30
cat frontend/lib/scanner/init-polyfill.ts | head -30
```
Both files exist with proper exports.
  </verify>
  <done>Scanner types defined (EntityMatch, ScanHistoryEntry) and polyfill initialization module created</done>
</task>

<task type="auto">
  <name>Task 3: Create feedback utilities (audio beep + haptic)</name>
  <files>frontend/lib/scanner/feedback.ts</files>
  <action>
Create `frontend/lib/scanner/feedback.ts`:
```typescript
/**
 * Scanner Feedback Utilities
 *
 * Provides audio and haptic feedback for successful barcode scans.
 * Uses Web Audio API for beep sounds (no external files needed).
 *
 * IMPORTANT:
 * - iOS Safari does not support navigator.vibrate()
 * - AudioContext requires user gesture before first use on iOS
 * - Call initAudioContext() on first user interaction
 */
"use client";

let audioContext: AudioContext | null = null;
let audioInitialized = false;

/**
 * Initialize the AudioContext.
 * Must be called during a user gesture (tap/click) on iOS.
 * Safe to call multiple times.
 */
export function initAudioContext(): void {
  if (audioInitialized || typeof window === "undefined") {
    return;
  }

  try {
    const AudioContextClass =
      window.AudioContext ||
      (window as unknown as { webkitAudioContext: typeof AudioContext })
        .webkitAudioContext;

    if (AudioContextClass) {
      audioContext = new AudioContextClass();
      audioInitialized = true;
      console.log("[Feedback] AudioContext initialized");
    }
  } catch (error) {
    console.warn("[Feedback] Failed to initialize AudioContext:", error);
  }
}

/**
 * Get or create the AudioContext.
 * Attempts initialization if not done yet.
 */
function getAudioContext(): AudioContext | null {
  if (!audioContext) {
    initAudioContext();
  }

  // Resume if suspended (iOS requires this)
  if (audioContext?.state === "suspended") {
    audioContext.resume().catch(() => {
      // Ignore resume errors
    });
  }

  return audioContext;
}

/**
 * Play a beep sound using Web Audio API.
 *
 * @param frequency - Tone frequency in Hz (default: 800)
 * @param duration - Duration in milliseconds (default: 150)
 * @param volume - Volume from 0 to 1 (default: 0.3)
 */
export function playBeep(
  frequency: number = 800,
  duration: number = 150,
  volume: number = 0.3
): void {
  const ctx = getAudioContext();
  if (!ctx) {
    console.warn("[Feedback] AudioContext not available");
    return;
  }

  try {
    const oscillator = ctx.createOscillator();
    const gainNode = ctx.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(ctx.destination);

    oscillator.frequency.value = frequency;
    oscillator.type = "sine";
    gainNode.gain.value = volume;

    const startTime = ctx.currentTime;
    const endTime = startTime + duration / 1000;

    oscillator.start(startTime);
    oscillator.stop(endTime);

    // Cleanup
    oscillator.onended = () => {
      oscillator.disconnect();
      gainNode.disconnect();
    };
  } catch (error) {
    console.warn("[Feedback] Audio beep failed:", error);
  }
}

/**
 * Play a success beep (higher pitch, short duration).
 */
export function playSuccessBeep(): void {
  playBeep(880, 100, 0.25);
}

/**
 * Play an error beep (lower pitch, longer duration).
 */
export function playErrorBeep(): void {
  playBeep(300, 200, 0.3);
}

/**
 * Trigger haptic feedback via the Vibration API.
 *
 * NOTE: Not supported on iOS Safari - fails silently.
 *
 * @param pattern - Vibration duration in ms, or pattern array [vibrate, pause, vibrate...]
 */
export function triggerHaptic(pattern: number | number[] = 50): void {
  if (typeof navigator === "undefined" || !navigator.vibrate) {
    // Vibration API not supported (iOS Safari)
    return;
  }

  try {
    navigator.vibrate(pattern);
  } catch (error) {
    // Ignore vibration errors
    console.warn("[Feedback] Haptic feedback failed:", error);
  }
}

/**
 * Trigger combined feedback for successful scan.
 * Plays beep and vibrates (on supported devices).
 */
export function triggerScanFeedback(): void {
  playSuccessBeep();
  triggerHaptic(50);
}
```
  </action>
  <verify>
```bash
cat frontend/lib/scanner/feedback.ts | grep -E "^export (function|const)"
```
Should show: initAudioContext, playBeep, playSuccessBeep, playErrorBeep, triggerHaptic, triggerScanFeedback
  </verify>
  <done>Feedback utilities created with playBeep, triggerHaptic, and triggerScanFeedback functions</done>
</task>

</tasks>

<verification>
1. Both packages installed: `grep -E "@yudiel|barcode-detector" frontend/package.json`
2. Scanner directory exists with all files: `ls frontend/lib/scanner/`
3. Types export correctly: `grep "export type EntityMatch" frontend/lib/scanner/types.ts`
4. Polyfill exports correctly: `grep "export async function initBarcodePolyfill" frontend/lib/scanner/init-polyfill.ts`
5. Feedback exports correctly: `grep "export function triggerScanFeedback" frontend/lib/scanner/feedback.ts`
</verification>

<success_criteria>
- @yudiel/react-qr-scanner@^2.5.1 and barcode-detector@^3.0.0 in package.json
- frontend/lib/scanner/types.ts exports EntityMatch and ScanHistoryEntry
- frontend/lib/scanner/init-polyfill.ts exports initBarcodePolyfill
- frontend/lib/scanner/feedback.ts exports playBeep, triggerHaptic, triggerScanFeedback
</success_criteria>

<output>
After completion, create `.planning/phases/19-barcode-scanning/19-01-SUMMARY.md`
</output>
