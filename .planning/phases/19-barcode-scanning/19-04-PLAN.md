---
phase: 19-barcode-scanning
plan: 04
type: execute
wave: 2
depends_on: ["19-02"]
files_modified:
  - frontend/components/scanner/quick-action-menu.tsx
  - frontend/components/scanner/manual-entry-input.tsx
  - frontend/components/scanner/scan-history-list.tsx
  - frontend/components/scanner/index.ts
autonomous: true

must_haves:
  truths:
    - "Quick action menu shows context-aware actions based on entity type"
    - "Not found state offers create option"
    - "Manual entry input allows typing barcode when camera fails"
    - "Scan history list shows recent scans with timestamps"
  artifacts:
    - path: "frontend/components/scanner/quick-action-menu.tsx"
      provides: "Post-scan action menu"
      min_lines: 80
      contains: "QuickActionMenu"
    - path: "frontend/components/scanner/manual-entry-input.tsx"
      provides: "Manual barcode entry fallback"
      exports: ["ManualEntryInput"]
    - path: "frontend/components/scanner/scan-history-list.tsx"
      provides: "Recent scans display"
      exports: ["ScanHistoryList"]
  key_links:
    - from: "frontend/components/scanner/quick-action-menu.tsx"
      to: "frontend/lib/scanner/types.ts"
      via: "EntityMatch import"
      pattern: 'import.*EntityMatch.*from.*scanner'
---

<objective>
Create QuickActionMenu, ManualEntryInput, and ScanHistoryList components.

Purpose: Provide post-scan UI for actions, fallback input when camera fails, and history access.
Output: Supporting scanner components ready for scan page integration.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-barcode-scanning/19-RESEARCH.md
@.planning/phases/19-barcode-scanning/19-02-SUMMARY.md

Reference for existing patterns:
@frontend/components/ui/card.tsx (Card patterns)
@frontend/components/ui/button.tsx (Button patterns)
@frontend/components/ui/input.tsx (Input patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create QuickActionMenu component</name>
  <files>frontend/components/scanner/quick-action-menu.tsx</files>
  <action>
Create `frontend/components/scanner/quick-action-menu.tsx`:
```typescript
/**
 * QuickActionMenu Component
 *
 * Post-scan action menu that displays context-aware actions based on entity type.
 * For items: view, loan, move, repair
 * For containers/locations: view, move
 * For not found: create new item option
 *
 * Designed to overlay on top of scanner without unmounting it (iOS PWA compatibility).
 */
"use client";

import { useTranslations } from "next-intl";
import { useRouter } from "next/navigation";
import {
  Package,
  MapPin,
  Box,
  Wrench,
  ArrowRight,
  Eye,
  Plus,
  ScanLine,
  X,
} from "lucide-react";

import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import type { EntityMatch } from "@/lib/scanner";

export interface QuickActionMenuProps {
  /** The entity match result from scan lookup */
  match: EntityMatch;
  /** Called when user selects an action */
  onAction: (action: QuickAction) => void;
  /** Called when user wants to scan again */
  onClose: () => void;
  /** Additional CSS classes */
  className?: string;
}

export type QuickAction =
  | "view"
  | "loan"
  | "move"
  | "repair"
  | "create"
  | "scan-again";

const ENTITY_ICONS = {
  item: Package,
  container: Box,
  location: MapPin,
  not_found: ScanLine,
} as const;

const ACTION_ICONS = {
  view: Eye,
  loan: ArrowRight,
  move: MapPin,
  repair: Wrench,
  create: Plus,
  "scan-again": ScanLine,
} as const;

export function QuickActionMenu({
  match,
  onAction,
  onClose,
  className,
}: QuickActionMenuProps) {
  const t = useTranslations("scanner");
  const router = useRouter();

  // Get icon for entity type
  const EntityIcon = ENTITY_ICONS[match.type];

  // Determine available actions based on entity type
  const getActions = (): QuickAction[] => {
    switch (match.type) {
      case "item":
        return ["view", "loan", "move", "repair"];
      case "container":
      case "location":
        return ["view", "move"];
      case "not_found":
        return ["create"];
    }
  };

  // Handle action selection
  const handleAction = (action: QuickAction) => {
    // For view action, navigate directly
    if (action === "view" && match.type !== "not_found") {
      const url = getEntityUrl(match);
      if (url) {
        router.push(url);
        return;
      }
    }

    // For create action, navigate to items create with barcode pre-filled
    if (action === "create" && match.type === "not_found") {
      router.push(`/dashboard/items/new?barcode=${encodeURIComponent(match.code)}`);
      return;
    }

    // For other actions, delegate to parent
    onAction(action);
  };

  // Get navigation URL for entity
  function getEntityUrl(match: EntityMatch): string | null {
    switch (match.type) {
      case "item":
        return `/dashboard/items/${match.entity.id}`;
      case "container":
        return `/dashboard/containers?selected=${match.entity.id}`;
      case "location":
        return `/dashboard/locations?selected=${match.entity.id}`;
      case "not_found":
        return null;
    }
  }

  const actions = getActions();

  // Not found state
  if (match.type === "not_found") {
    return (
      <Card className={className}>
        <CardHeader className="pb-3">
          <div className="flex items-center justify-between">
            <CardTitle className="text-lg flex items-center gap-2">
              <EntityIcon className="h-5 w-5 text-muted-foreground" />
              {t("notFound.title")}
            </CardTitle>
            <Button
              variant="ghost"
              size="icon"
              className="h-8 w-8"
              onClick={onClose}
              aria-label={t("close")}
            >
              <X className="h-4 w-4" />
            </Button>
          </div>
        </CardHeader>
        <CardContent className="space-y-3">
          <p className="text-sm text-muted-foreground">
            {t("notFound.description", { code: match.code })}
          </p>
          <div className="flex gap-2">
            <Button variant="outline" onClick={onClose} className="flex-1">
              <ScanLine className="h-4 w-4 mr-2" />
              {t("actions.scanAgain")}
            </Button>
            <Button onClick={() => handleAction("create")} className="flex-1">
              <Plus className="h-4 w-4 mr-2" />
              {t("actions.createItem")}
            </Button>
          </div>
        </CardContent>
      </Card>
    );
  }

  // Found entity state
  const entityName = match.entity.name;
  const entityShortCode =
    "short_code" in match.entity ? match.entity.short_code : null;

  return (
    <Card className={className}>
      <CardHeader className="pb-3">
        <div className="flex items-center justify-between">
          <div>
            <CardTitle className="text-lg flex items-center gap-2">
              <EntityIcon className="h-5 w-5 text-primary" />
              {entityName}
            </CardTitle>
            <p className="text-sm text-muted-foreground capitalize mt-0.5">
              {match.type}
              {entityShortCode && ` • ${entityShortCode}`}
            </p>
          </div>
          <Button
            variant="ghost"
            size="icon"
            className="h-8 w-8"
            onClick={onClose}
            aria-label={t("close")}
          >
            <X className="h-4 w-4" />
          </Button>
        </div>
      </CardHeader>
      <CardContent>
        <div className="grid grid-cols-2 gap-2">
          {actions.map((action) => {
            const ActionIcon = ACTION_ICONS[action];
            return (
              <Button
                key={action}
                variant="outline"
                onClick={() => handleAction(action)}
                className="justify-start h-11"
              >
                <ActionIcon className="h-4 w-4 mr-2" />
                {t(`actions.${action}`)}
              </Button>
            );
          })}
        </div>
        <Button
          variant="ghost"
          onClick={onClose}
          className="w-full mt-3 text-muted-foreground"
        >
          <ScanLine className="h-4 w-4 mr-2" />
          {t("actions.scanAgain")}
        </Button>
      </CardContent>
    </Card>
  );
}

export default QuickActionMenu;
```
  </action>
  <verify>
```bash
cat frontend/components/scanner/quick-action-menu.tsx | head -50
grep "export function QuickActionMenu" frontend/components/scanner/quick-action-menu.tsx
```
Component exists with proper exports.
  </verify>
  <done>QuickActionMenu created with context-aware actions and not-found state with create option</done>
</task>

<task type="auto">
  <name>Task 2: Create ManualEntryInput component</name>
  <files>frontend/components/scanner/manual-entry-input.tsx</files>
  <action>
Create `frontend/components/scanner/manual-entry-input.tsx`:
```typescript
/**
 * ManualEntryInput Component
 *
 * Fallback input for manually entering barcodes when camera scanning fails.
 * Useful for damaged barcodes or devices without camera access.
 */
"use client";

import { useState, useCallback, useRef, useEffect } from "react";
import { useTranslations } from "next-intl";
import { Search, X } from "lucide-react";

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";

export interface ManualEntryInputProps {
  /** Called when user submits a barcode */
  onSubmit: (code: string) => void;
  /** Whether the input is disabled */
  disabled?: boolean;
  /** Placeholder text */
  placeholder?: string;
  /** Auto-focus the input on mount */
  autoFocus?: boolean;
  /** Additional CSS classes */
  className?: string;
}

export function ManualEntryInput({
  onSubmit,
  disabled = false,
  placeholder,
  autoFocus = false,
  className,
}: ManualEntryInputProps) {
  const t = useTranslations("scanner.manualEntry");
  const [value, setValue] = useState("");
  const inputRef = useRef<HTMLInputElement>(null);

  // Auto-focus if requested
  useEffect(() => {
    if (autoFocus && inputRef.current) {
      inputRef.current.focus();
    }
  }, [autoFocus]);

  // Handle form submission
  const handleSubmit = useCallback(
    (e: React.FormEvent) => {
      e.preventDefault();
      const trimmed = value.trim();
      if (trimmed) {
        onSubmit(trimmed);
        setValue("");
      }
    },
    [value, onSubmit]
  );

  // Handle clear
  const handleClear = useCallback(() => {
    setValue("");
    inputRef.current?.focus();
  }, []);

  return (
    <form onSubmit={handleSubmit} className={className}>
      <Label htmlFor="manual-barcode" className="text-sm font-medium mb-2 block">
        {t("label")}
      </Label>
      <div className="flex gap-2">
        <div className="relative flex-1">
          <Input
            ref={inputRef}
            id="manual-barcode"
            type="text"
            value={value}
            onChange={(e) => setValue(e.target.value)}
            placeholder={placeholder || t("placeholder")}
            disabled={disabled}
            className="pr-8"
            autoComplete="off"
            autoCapitalize="off"
            autoCorrect="off"
            spellCheck={false}
          />
          {value && (
            <Button
              type="button"
              variant="ghost"
              size="icon"
              className="absolute right-1 top-1/2 -translate-y-1/2 h-6 w-6"
              onClick={handleClear}
              aria-label={t("clear")}
            >
              <X className="h-3 w-3" />
            </Button>
          )}
        </div>
        <Button type="submit" disabled={disabled || !value.trim()}>
          <Search className="h-4 w-4 mr-2" />
          {t("submit")}
        </Button>
      </div>
      <p className="text-xs text-muted-foreground mt-1.5">{t("hint")}</p>
    </form>
  );
}

export default ManualEntryInput;
```
  </action>
  <verify>
```bash
cat frontend/components/scanner/manual-entry-input.tsx | head -30
grep "export function ManualEntryInput" frontend/components/scanner/manual-entry-input.tsx
```
Component exists with proper exports.
  </verify>
  <done>ManualEntryInput created with form submission and clear button</done>
</task>

<task type="auto">
  <name>Task 3: Create ScanHistoryList component</name>
  <files>frontend/components/scanner/scan-history-list.tsx</files>
  <action>
Create `frontend/components/scanner/scan-history-list.tsx`:
```typescript
/**
 * ScanHistoryList Component
 *
 * Displays recent scan history with timestamps.
 * Allows users to quickly access previously scanned items.
 */
"use client";

import { useMemo } from "react";
import { useTranslations } from "next-intl";
import { Package, Box, MapPin, HelpCircle, Clock, Trash2 } from "lucide-react";

import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { ScrollArea } from "@/components/ui/scroll-area";
import {
  getScanHistory,
  clearScanHistory,
  formatScanTime,
  type ScanHistoryEntry,
} from "@/lib/scanner";

export interface ScanHistoryListProps {
  /** Called when user taps a history entry */
  onSelect: (entry: ScanHistoryEntry) => void;
  /** Maximum entries to display */
  maxEntries?: number;
  /** Additional CSS classes */
  className?: string;
}

const ENTITY_ICONS = {
  item: Package,
  container: Box,
  location: MapPin,
  unknown: HelpCircle,
} as const;

export function ScanHistoryList({
  onSelect,
  maxEntries = 10,
  className,
}: ScanHistoryListProps) {
  const t = useTranslations("scanner.history");

  // Load history from localStorage
  const history = useMemo(() => {
    return getScanHistory().slice(0, maxEntries);
  }, [maxEntries]);

  // Handle clear all
  const handleClearAll = () => {
    clearScanHistory();
    // Force re-render by using window event
    window.dispatchEvent(new Event("storage"));
  };

  if (history.length === 0) {
    return (
      <Card className={className}>
        <CardContent className="py-8 text-center">
          <Clock className="h-8 w-8 mx-auto text-muted-foreground mb-2" />
          <p className="text-sm text-muted-foreground">{t("empty")}</p>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card className={className}>
      <CardHeader className="pb-2">
        <div className="flex items-center justify-between">
          <CardTitle className="text-base flex items-center gap-2">
            <Clock className="h-4 w-4" />
            {t("title")}
          </CardTitle>
          <Button
            variant="ghost"
            size="sm"
            onClick={handleClearAll}
            className="h-8 text-muted-foreground hover:text-destructive"
          >
            <Trash2 className="h-3 w-3 mr-1" />
            {t("clearAll")}
          </Button>
        </div>
      </CardHeader>
      <CardContent className="pt-0">
        <ScrollArea className="h-[200px]">
          <div className="space-y-1">
            {history.map((entry, index) => {
              const Icon = ENTITY_ICONS[entry.entityType];
              return (
                <button
                  key={`${entry.code}-${entry.timestamp}`}
                  onClick={() => onSelect(entry)}
                  className="w-full flex items-center gap-3 p-2 rounded-md hover:bg-muted transition-colors text-left"
                >
                  <Icon className="h-4 w-4 text-muted-foreground flex-shrink-0" />
                  <div className="flex-1 min-w-0">
                    <p className="text-sm font-medium truncate">
                      {entry.entityName || entry.code}
                    </p>
                    <p className="text-xs text-muted-foreground truncate">
                      {entry.entityType !== "unknown"
                        ? `${entry.entityType} • ${entry.code}`
                        : entry.code}
                    </p>
                  </div>
                  <span className="text-xs text-muted-foreground flex-shrink-0">
                    {formatScanTime(entry.timestamp)}
                  </span>
                </button>
              );
            })}
          </div>
        </ScrollArea>
      </CardContent>
    </Card>
  );
}

export default ScanHistoryList;
```
  </action>
  <verify>
```bash
cat frontend/components/scanner/scan-history-list.tsx | head -30
grep "export function ScanHistoryList" frontend/components/scanner/scan-history-list.tsx
```
Component exists with proper exports.
  </verify>
  <done>ScanHistoryList created with localStorage history display and clear functionality</done>
</task>

<task type="auto">
  <name>Task 4: Update scanner component index exports</name>
  <files>frontend/components/scanner/index.ts</files>
  <action>
Update `frontend/components/scanner/index.ts` to export all components:
```typescript
/**
 * Scanner Components
 *
 * Components for barcode and QR code scanning functionality.
 */

// Core scanner
export { BarcodeScanner } from "./barcode-scanner";
export type { BarcodeScannerProps } from "./barcode-scanner";

// Quick action menu
export { QuickActionMenu } from "./quick-action-menu";
export type { QuickActionMenuProps, QuickAction } from "./quick-action-menu";

// Manual entry
export { ManualEntryInput } from "./manual-entry-input";
export type { ManualEntryInputProps } from "./manual-entry-input";

// Scan history
export { ScanHistoryList } from "./scan-history-list";
export type { ScanHistoryListProps } from "./scan-history-list";
```
  </action>
  <verify>
```bash
cat frontend/components/scanner/index.ts
grep -c "export" frontend/components/scanner/index.ts
```
Index file exports all 4 components (should have 8+ export lines).
  </verify>
  <done>Scanner component index updated with all component exports</done>
</task>

</tasks>

<verification>
1. All components exist: `ls frontend/components/scanner/`
2. QuickActionMenu handles not_found: `grep "not_found" frontend/components/scanner/quick-action-menu.tsx`
3. ManualEntryInput has form: `grep "onSubmit" frontend/components/scanner/manual-entry-input.tsx`
4. ScanHistoryList uses getScanHistory: `grep "getScanHistory" frontend/components/scanner/scan-history-list.tsx`
5. Index exports all: `grep -c "export" frontend/components/scanner/index.ts` (should be >= 8)
</verification>

<success_criteria>
- QuickActionMenu shows view/loan/move/repair for items, view/move for containers/locations
- QuickActionMenu shows create option for not_found with barcode pre-filled
- ManualEntryInput provides form input with clear and submit
- ScanHistoryList displays history entries with entity icons and timestamps
- All components exported from index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/19-barcode-scanning/19-04-SUMMARY.md`
</output>
