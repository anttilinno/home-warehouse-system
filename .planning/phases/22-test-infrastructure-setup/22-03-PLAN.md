---
phase: 22-test-infrastructure-setup
plan: 03
type: execute
wave: 2
depends_on: ["22-01", "22-02"]
files_modified:
  - .github/workflows/ci.yml
  - README.md
autonomous: true
user_setup:
  - service: codecov
    why: "Coverage reporting and badge generation"
    env_vars:
      - name: CODECOV_TOKEN
        source: "Codecov Dashboard -> Settings -> Upload Token (may not be needed for public repos)"
    dashboard_config:
      - task: "Enable repository in Codecov"
        location: "codecov.io -> Add new repository -> Select from GitHub"

must_haves:
  truths:
    - "CI runs Go unit tests and integration tests in parallel jobs"
    - "CI runs frontend unit tests with coverage"
    - "Coverage reports uploaded to Codecov"
    - "Coverage badge displays in README"
    - "Total CI time under 5 minutes for test jobs"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "CI workflow with parallel test execution and coverage"
      contains: "matrix"
    - path: "README.md"
      provides: "Coverage badge"
      contains: "codecov.io"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "codecov/codecov-action"
      via: "GitHub Action for upload"
      pattern: "codecov/codecov-action"
    - from: ".github/workflows/ci.yml"
      to: "frontend/coverage/lcov.info"
      via: "coverage file path"
      pattern: "coverage.*lcov"
---

<objective>
Create CI workflow with parallel test execution for Go and frontend, coverage reporting via Codecov, and coverage badge in README.

Purpose: Enable fast CI feedback (under 5 minutes) with parallel test jobs. Coverage badges provide visibility into test coverage progress toward 80% target. Unifies Go and frontend testing in a single CI workflow.

Output: `.github/workflows/ci.yml` with matrix strategy for parallel jobs, Codecov integration, and coverage badge in README.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-test-infrastructure-setup/22-RESEARCH.md

# Existing CI workflow
@.github/workflows/e2e-tests.yml

# Plan outputs needed
@.planning/phases/22-test-infrastructure-setup/22-01-SUMMARY.md
@.planning/phases/22-test-infrastructure-setup/22-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unified CI workflow with parallel test jobs</name>
  <files>
    .github/workflows/ci.yml
  </files>
  <action>
Create `.github/workflows/ci.yml` with matrix strategy for parallel execution.

```yaml
name: CI

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  GO_VERSION: "1.25"
  BUN_VERSION: "latest"

jobs:
  # Go tests - parallel unit and integration
  go-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test-type: [unit, integration]

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: wh
          POSTGRES_PASSWORD: wh
          POSTGRES_DB: warehouse_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: backend/go.sum

      - name: Install dbmate
        run: |
          curl -fsSL -o /usr/local/bin/dbmate https://github.com/amacneil/dbmate/releases/latest/download/dbmate-linux-amd64
          chmod +x /usr/local/bin/dbmate

      - name: Run migrations
        if: matrix.test-type == 'integration'
        working-directory: backend
        run: dbmate up
        env:
          DATABASE_URL: postgres://wh:wh@localhost:5432/warehouse_test?sslmode=disable

      - name: Run unit tests
        if: matrix.test-type == 'unit'
        working-directory: backend
        run: |
          go test -v -race -coverprofile=coverage-unit.out -covermode=atomic ./internal/...
        env:
          CGO_ENABLED: 1

      - name: Run integration tests
        if: matrix.test-type == 'integration'
        working-directory: backend
        run: |
          go test -v -tags=integration -coverprofile=coverage-int.out -covermode=atomic ./tests/integration/...
        env:
          GO_DATABASE_URL: postgres://wh:wh@localhost:5432/warehouse_test?sslmode=disable
          GO_TEST_DATABASE_URL: postgres://wh:wh@localhost:5432/warehouse_test?sslmode=disable
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test-secret-key
          CGO_ENABLED: 1

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: go-coverage-${{ matrix.test-type }}
          path: backend/coverage-*.out
          retention-days: 1

  # Frontend unit tests with coverage
  frontend-unit-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        working-directory: frontend
        run: bun install

      - name: Run unit tests with coverage
        working-directory: frontend
        run: bun run test:unit:coverage
        env:
          CI: true

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage/lcov.info
          retention-days: 1

  # Aggregate coverage and upload to Codecov
  coverage:
    needs: [go-tests, frontend-unit-tests]
    runs-on: ubuntu-latest
    if: always() && (needs.go-tests.result == 'success' || needs.frontend-unit-tests.result == 'success')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all coverage artifacts
        uses: actions/download-artifact@v4
        with:
          path: coverage-reports

      - name: List coverage files
        run: find coverage-reports -name "*.out" -o -name "*.info" | head -20

      - name: Upload to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: >-
            coverage-reports/go-coverage-unit/coverage-unit.out,
            coverage-reports/go-coverage-integration/coverage-int.out,
            coverage-reports/frontend-coverage/lcov.info
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
```

**Key design decisions:**
- Matrix strategy for Go tests (unit vs integration run in parallel)
- Services block for PostgreSQL and Redis (integration tests need them)
- Coverage artifacts uploaded separately, then combined in coverage job
- `fail_ci_if_error: false` for Codecov - don't fail CI if upload issues
- Dbmate for migrations (matching existing mise task)
  </action>
  <verify>
    ```bash
    # Validate YAML syntax
    python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))"
    ```
  </verify>
  <done>CI workflow validates with matrix strategy for parallel test execution</done>
</task>

<task type="auto">
  <name>Task 2: Add coverage badge to README</name>
  <files>
    README.md
  </files>
  <action>
Add Codecov badge to the top of README.md.

Read current README.md first, then add badge after the title:

```markdown
# Home Warehouse System

[![codecov](https://codecov.io/gh/[owner]/home-warehouse-system/graph/badge.svg)](https://codecov.io/gh/[owner]/home-warehouse-system)

[Rest of existing README content...]
```

**Note:** Replace `[owner]` with actual GitHub username/org. Check git remote to determine:
```bash
git remote get-url origin
```

If README doesn't exist or is minimal, create basic structure:

```markdown
# Home Warehouse System

[![codecov](https://codecov.io/gh/[owner]/home-warehouse-system/graph/badge.svg)](https://codecov.io/gh/[owner]/home-warehouse-system)

Multi-tenant home inventory management system.

## Tech Stack

- **Backend**: Go 1.25, Chi router, sqlc
- **Frontend**: Next.js 16, React 19, shadcn/ui, Tailwind CSS 4
- **Database**: PostgreSQL

## Quick Start

See `CLAUDE.md` for development commands.
```
  </action>
  <verify>
    ```bash
    grep -q "codecov" README.md && echo "Badge found"
    ```
  </verify>
  <done>README contains Codecov badge with correct repository link</done>
</task>

<task type="auto">
  <name>Task 3: Verify CI workflow locally with act (optional) or commit for GitHub validation</name>
  <files>
    .github/workflows/ci.yml
  </files>
  <action>
Verify the CI workflow is correct by:

1. Check workflow syntax with GitHub CLI (if available):
   ```bash
   gh workflow view ci.yml 2>/dev/null || echo "Workflow not yet pushed"
   ```

2. Ensure all referenced paths exist:
   - `backend/go.sum` (for cache)
   - `frontend/package.json` (bun install)
   - Coverage output paths match vitest config

3. Validate job dependencies:
   - `coverage` job depends on `go-tests` and `frontend-unit-tests`
   - Artifacts named consistently between upload and download

4. Check environment variables match existing patterns:
   - Compare with `.mise.toml` for DB connection strings
   - JWT_SECRET matches test environment expectations

5. Estimate total time:
   - Go unit tests: ~1-2 min
   - Go integration tests: ~2-3 min (includes migration)
   - Frontend unit tests: ~1-2 min
   - Coverage upload: ~30 sec
   - **Total with parallelization: ~3-4 min** (meets &lt;5 min target)

The workflow will be validated when pushed to GitHub. First run may take longer due to cache building.
  </action>
  <verify>
    ```bash
    # Verify files referenced in workflow exist
    test -f backend/go.sum && test -f frontend/package.json && echo "Required files exist"
    ```
  </verify>
  <done>CI workflow references valid paths and is ready for GitHub validation</done>
</task>

</tasks>

<verification>
1. `.github/workflows/ci.yml` exists with matrix strategy
2. Workflow defines `go-tests`, `frontend-unit-tests`, and `coverage` jobs
3. README.md contains Codecov badge
4. Workflow YAML is valid (no syntax errors)
5. All file paths in workflow reference existing files
</verification>

<success_criteria>
1. CI workflow uses parallel matrix for Go tests
2. Frontend unit tests run with coverage in CI
3. Coverage uploaded to Codecov
4. Badge appears in README
5. Estimated CI time under 5 minutes
</success_criteria>

<output>
After completion, create `.planning/phases/22-test-infrastructure-setup/22-03-SUMMARY.md`
</output>
