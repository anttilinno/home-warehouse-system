---
phase: 24-backend-api-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/internal/domain/warehouse/repairphoto/handler_test.go
  - backend/internal/domain/warehouse/declutter/handler_test.go
autonomous: true

must_haves:
  truths:
    - "repairphoto API returns correct responses for list, get, update caption, and delete operations"
    - "declutter API returns correct responses for list, counts, and mark-used operations"
    - "API error paths return correct HTTP status codes (404 for not found, 500 for service errors)"
    - "Handlers do not panic when event broadcaster is nil"
  artifacts:
    - path: "backend/internal/domain/warehouse/repairphoto/handler_test.go"
      provides: "RepairPhoto handler unit tests"
      min_lines: 200
    - path: "backend/internal/domain/warehouse/declutter/handler_test.go"
      provides: "Declutter handler unit tests"
      min_lines: 100
  key_links:
    - from: "handler_test.go"
      to: "testutil.HandlerTestSetup"
      via: "test infrastructure"
      pattern: "testutil\\.NewHandlerTestSetup"
---

<objective>
Add comprehensive handler unit tests for repairphoto and declutter domains that currently have no handler tests.

Purpose: Close handler test coverage gaps identified in Phase 24 research, ensuring all domain handlers have unit tests with mocked services.

Output: Two new handler_test.go files following established patterns from repairlog/handler_test.go
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/24-backend-api-testing/24-RESEARCH.md
@backend/internal/testutil/handler.go
@backend/internal/domain/warehouse/repairlog/handler_test.go (example pattern)
@backend/internal/domain/warehouse/repairphoto/handler.go
@backend/internal/domain/warehouse/repairphoto/service.go
@backend/internal/domain/warehouse/declutter/handler.go
@backend/internal/domain/warehouse/declutter/service.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create repairphoto handler unit tests</name>
  <files>backend/internal/domain/warehouse/repairphoto/handler_test.go</files>
  <action>
Create handler_test.go for repairphoto package following the established pattern from repairlog/handler_test.go.

The handler has these operations to test:
1. ListPhotos (GET /repairs/{repair_log_id}/photos/list) - returns list or empty
2. GetPhoto (GET /repairs/{repair_log_id}/photos/{id}) - returns photo or 404
3. UpdateCaption (PUT /repairs/{repair_log_id}/photos/{id}/caption) - updates or 404
4. DeletePhoto (DELETE /repairs/{repair_log_id}/photos/{id}) - deletes or 404

Create MockService implementing ServiceInterface with methods:
- ListPhotos(ctx, repairLogID, workspaceID) ([]*RepairPhoto, error)
- GetPhoto(ctx, id, workspaceID) (*RepairPhoto, error)
- UpdateCaption(ctx, id, workspaceID, caption *string) (*RepairPhoto, error)
- DeletePhoto(ctx, id, workspaceID) error

Test cases for each handler:
- Success path (returns expected data)
- Not found path (ErrPhotoNotFound -> 404)
- Service error path (generic error -> 500)
- Photo doesn't belong to repair_log_id (-> 404)

For UpdateCaption and DeletePhoto, test event publishing with EventCapture.
Test nil broadcaster safety (should not panic).

Use testutil.NewHandlerTestSetup() for setup.
Create a helper newTestRepairPhoto() function.
URL generator should return fixed URLs for testing.
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/warehouse/repairphoto/... -v -count=1`
All tests pass.
  </verify>
  <done>
repairphoto has handler_test.go with tests for all 4 Huma endpoints: ListPhotos, GetPhoto, UpdateCaption, DeletePhoto, including error paths and event publishing tests.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create declutter handler unit tests</name>
  <files>backend/internal/domain/warehouse/declutter/handler_test.go</files>
  <action>
Create handler_test.go for declutter package following the established pattern.

The handler has these operations to test:
1. List (GET /declutter) - with query params threshold_days, group_by, page, limit
2. GetCounts (GET /declutter/counts) - returns count summary
3. MarkUsed (POST /inventory/{inventory_id}/mark-used) - marks inventory as used

The declutter.Service is a concrete type, not an interface. For handler tests, we need to mock the service. Create a ServiceInterface and MockService:

```go
type ServiceInterface interface {
    ListUnused(ctx context.Context, params ListParams) (*ListResult, error)
    GetCounts(ctx context.Context, workspaceID uuid.UUID) (*Counts, error)
    MarkUsed(ctx context.Context, inventoryID, workspaceID uuid.UUID) error
}
```

If RegisterRoutes takes *Service directly, we may need to:
- Option A: Change handler to accept interface (preferred)
- Option B: Use integration test pattern instead

If Option A is needed, update handler.go to accept ServiceInterface.

Test cases:
- List: success with items, empty list, pagination params, group_by param, service error
- GetCounts: success with counts, service error
- MarkUsed: success, service error, event publishing with EventCapture

Use testutil.NewHandlerTestSetup() for setup.
Create helper newTestDeclutterItem() function.
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/warehouse/declutter/... -v -count=1`
All tests pass.
  </verify>
  <done>
declutter has handler_test.go with tests for all 3 endpoints: List, GetCounts, MarkUsed, including query parameter handling, error paths, and event publishing.
  </done>
</task>

</tasks>

<verification>
1. Run unit tests:
   ```bash
   cd /home/antti/Repos/Misc/home-warehouse-system/backend
   go test ./internal/domain/warehouse/repairphoto/... -v -count=1
   go test ./internal/domain/warehouse/declutter/... -v -count=1
   ```

2. Check coverage improvement:
   ```bash
   go test ./internal/domain/warehouse/repairphoto/... -cover
   go test ./internal/domain/warehouse/declutter/... -cover
   ```
</verification>

<success_criteria>
- repairphoto/handler_test.go exists with 15+ test cases
- declutter/handler_test.go exists with 10+ test cases
- All tests pass
- Tests follow established pattern from repairlog/handler_test.go
</success_criteria>

<output>
After completion, create `.planning/phases/24-backend-api-testing/24-01-SUMMARY.md`
</output>
