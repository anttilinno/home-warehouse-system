---
phase: 24-backend-api-testing
plan: 03
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - backend/internal/domain/warehouse/item/validation_test.go
  - backend/internal/domain/warehouse/inventory/validation_test.go
  - backend/internal/domain/warehouse/loan/validation_test.go
autonomous: true

must_haves:
  truths:
    - "Invalid request payloads return 422 Unprocessable Entity"
    - "Required field validation returns clear error messages"
    - "Type validation rejects invalid UUIDs, dates, enums"
    - "Range validation enforces min/max constraints"
  artifacts:
    - path: "backend/internal/domain/warehouse/item/validation_test.go"
      provides: "Item request validation tests"
      min_lines: 80
    - path: "backend/internal/domain/warehouse/inventory/validation_test.go"
      provides: "Inventory request validation tests"
      min_lines: 80
    - path: "backend/internal/domain/warehouse/loan/validation_test.go"
      provides: "Loan request validation tests"
      min_lines: 80
  key_links:
    - from: "validation_test.go files"
      to: "Huma validation"
      via: "request parsing"
      pattern: "StatusUnprocessableEntity"
---

<objective>
Add table-driven request validation tests for key domain handlers to ensure Huma validation produces correct error responses.

Purpose: Systematically verify that invalid request payloads are rejected with appropriate 422 errors before reaching business logic, per requirement API-03.

Output: Three new validation_test.go files covering request validation for item, inventory, and loan domains.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/24-backend-api-testing/24-RESEARCH.md
@backend/internal/testutil/handler.go
@backend/internal/domain/warehouse/item/handler.go (request types)
@backend/internal/domain/warehouse/inventory/handler.go (request types)
@backend/internal/domain/warehouse/loan/handler.go (request types)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create item validation tests</name>
  <files>backend/internal/domain/warehouse/item/validation_test.go</files>
  <action>
Create validation_test.go in item package for testing request validation.

Use table-driven tests with this pattern:
```go
func TestHandler_CreateValidation(t *testing.T) {
    setup := testutil.NewHandlerTestSetup()
    mockSvc := new(MockService) // From existing handler_test.go
    item.RegisterRoutes(setup.API, mockSvc, nil)

    tests := []struct {
        name       string
        body       string
        wantStatus int
        wantErr    string // partial match in response body
    }{
        {
            name:       "missing required name",
            body:       `{"sku":"TEST-001","min_stock_level":0}`,
            wantStatus: http.StatusUnprocessableEntity,
            wantErr:    "name",
        },
        // More cases...
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            rec := setup.Post("/items", tt.body)
            testutil.AssertStatus(t, rec, tt.wantStatus)
            assert.Contains(t, rec.Body.String(), tt.wantErr)
        })
    }
}
```

Test cases for item:
- Create: missing name, empty name, missing min_stock_level, negative min_stock_level
- Update: invalid category_id (not UUID), empty name on update
- Create with invalid JSON (malformed)
- Create with wrong type (string instead of number for min_stock_level)

Note: Huma returns 422 for schema violations. Don't call mockSvc for validation tests - Huma rejects before handler.
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/warehouse/item/... -v -run Validation -count=1`
  </verify>
  <done>
item/validation_test.go exists with table-driven tests for request validation covering required fields, type mismatches, and range constraints.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create inventory validation tests</name>
  <files>backend/internal/domain/warehouse/inventory/validation_test.go</files>
  <action>
Create validation_test.go in inventory package.

Test cases for inventory:
- Create: missing item_id, missing location_id, missing quantity
- Create: invalid item_id format (not UUID), invalid location_id format
- Create: quantity less than 1 (if min constraint exists)
- Create: invalid condition enum value (e.g., "BROKEN" instead of valid enum)
- Create: invalid status enum value
- Update: invalid condition/status values
- Move: missing location_id

Check inventory handler.go for actual field constraints and enum values.

Follow same table-driven pattern as item validation tests.
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/warehouse/inventory/... -v -run Validation -count=1`
  </verify>
  <done>
inventory/validation_test.go exists with table-driven tests for request validation covering required fields, UUID formats, and enum constraints.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create loan validation tests</name>
  <files>backend/internal/domain/warehouse/loan/validation_test.go</files>
  <action>
Create validation_test.go in loan package.

Test cases for loan:
- Create: missing inventory_id, missing borrower_id
- Create: invalid inventory_id format, invalid borrower_id format
- Create: invalid loaned_at date format
- Create: invalid due_date format
- Create: quantity less than 1 (if constraint exists)
- Update: invalid due_date format on extension

Check loan handler.go for actual request types and constraints.

Follow same table-driven pattern.
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/backend && go test ./internal/domain/warehouse/loan/... -v -run Validation -count=1`
  </verify>
  <done>
loan/validation_test.go exists with table-driven tests for request validation covering required fields, UUID formats, and date formats.
  </done>
</task>

</tasks>

<verification>
1. Run all validation tests:
   ```bash
   cd /home/antti/Repos/Misc/home-warehouse-system/backend
   go test ./internal/domain/warehouse/item/... -v -run Validation -count=1
   go test ./internal/domain/warehouse/inventory/... -v -run Validation -count=1
   go test ./internal/domain/warehouse/loan/... -v -run Validation -count=1
   ```

2. Verify all domain tests still pass:
   ```bash
   go test ./internal/domain/warehouse/... -count=1
   ```
</verification>

<success_criteria>
- item/validation_test.go exists with 8+ test cases
- inventory/validation_test.go exists with 8+ test cases
- loan/validation_test.go exists with 6+ test cases
- All tests pass and verify 422 responses for invalid payloads
- Tests use table-driven structure for maintainability
</success_criteria>

<output>
After completion, create `.planning/phases/24-backend-api-testing/24-03-SUMMARY.md`
</output>
