---
phase: 04-pwa-screenshots-polish
plan: 03
type: execute
wave: 2
depends_on: ["04-02"]
files_modified:
  - frontend/e2e/offline/offline-flows.spec.ts
  - frontend/e2e/offline/sync.spec.ts
  - frontend/e2e/offline/multi-tab.spec.ts
autonomous: true

must_haves:
  truths:
    - "E2E tests verify offline indicator appears when network disconnected"
    - "E2E tests verify cached data remains visible when offline"
    - "E2E tests verify pending changes sync when back online"
    - "E2E tests verify error recovery with retry action"
    - "E2E tests run only on Chromium (skip webkit/firefox)"
  artifacts:
    - path: "frontend/e2e/offline/offline-flows.spec.ts"
      provides: "Core offline flow E2E tests"
      contains: "context.setOffline"
    - path: "frontend/e2e/offline/sync.spec.ts"
      provides: "Sync behavior E2E tests"
      contains: "sync"
    - path: "frontend/e2e/offline/multi-tab.spec.ts"
      provides: "Multi-tab scenario tests"
      contains: "newContext"
  key_links:
    - from: "frontend/e2e/offline/*.spec.ts"
      to: "frontend/e2e/fixtures/authenticated.ts"
      via: "test fixture import"
      pattern: "from.*fixtures/authenticated"
---

<objective>
Create comprehensive E2E tests for offline flows using Playwright network simulation.

Purpose: Verify the complete offline experience works correctly - indicator display, cached data access, mutation queueing, and sync on reconnection. Tests provide regression protection for the PWA offline functionality built in Phases 1-3.

Output: Three test files covering offline flows, sync behavior, and multi-tab scenarios. Chromium only per user decision.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pwa-screenshots-polish/04-CONTEXT.md
@.planning/phases/04-pwa-screenshots-polish/04-RESEARCH.md
@.planning/phases/04-pwa-screenshots-polish/04-02-SUMMARY.md

@frontend/e2e/fixtures/authenticated.ts
@frontend/e2e/features/pwa.spec.ts
@frontend/playwright.config.ts
@frontend/components/pwa/offline-indicator.tsx
@frontend/components/sync-status-indicator.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create core offline flow tests</name>
  <files>frontend/e2e/offline/offline-flows.spec.ts</files>
  <action>
Create E2E tests for core offline functionality using Playwright's context.setOffline() API.

Test file structure:
```typescript
import { test, expect } from "../fixtures/authenticated";

test.describe("Offline Flows", () => {
  // Skip non-Chromium browsers per user decision
  test.skip(({ browserName }) => browserName !== "chromium", "Chromium only");

  // Test cases...
});
```

Test cases to implement:

1. "shows offline indicator when network disconnected"
   - Load dashboard, wait for networkidle
   - Call context.setOffline(true)
   - Verify data-testid="offline-indicator" becomes visible
   - Verify indicator has CloudOff icon (check for lucide class or aria-label)

2. "hides offline indicator when network reconnected"
   - Start offline
   - Verify indicator visible
   - Call context.setOffline(false)
   - Verify indicator disappears

3. "displays cached data when offline"
   - Load dashboard while online (caches data)
   - Go offline
   - Reload page (will use cached data)
   - Verify main content still visible (heading, list items)
   - Verify no error state shown

4. "shows sync status indicator with pending count"
   - Load dashboard while online
   - Go offline
   - Perform an action that queues a mutation (e.g., click a button)
   - Verify sync status shows "pending" or has pending badge

5. "recovers gracefully from offline state"
   - Start online, perform some navigation
   - Go offline
   - Try to navigate (may show offline content)
   - Go back online
   - Verify navigation works again

Key implementation notes:
- Use `await page.waitForSelector('[data-testid="offline-indicator"]')` after setOffline(true)
- Use `await expect(locator).not.toBeVisible()` after setOffline(false)
- Wait for networkidle before going offline to ensure data is cached
- Use try/catch around operations that might fail offline
  </action>
  <verify>
Run the tests:
```bash
cd frontend && npx playwright test e2e/offline/offline-flows.spec.ts --project=chromium
```
All tests should pass.
  </verify>
  <done>
- offline-flows.spec.ts exists with 5+ test cases
- Tests use context.setOffline() for network simulation
- Tests verify offline indicator visibility
- Tests verify cached data display
- Tests skip on non-Chromium browsers
  </done>
</task>

<task type="auto">
  <name>Task 2: Create sync behavior tests</name>
  <files>frontend/e2e/offline/sync.spec.ts</files>
  <action>
Create E2E tests for sync behavior when transitioning between online/offline states.

Test cases to implement:

1. "syncs pending changes when back online"
   - Load dashboard while online
   - Go offline
   - Create a mutation (if UI allows - might just verify pending count)
   - Go back online
   - Verify sync status changes from pending to synced
   - Verify "just now" or similar timestamp shown

2. "shows syncing state during sync"
   - Go offline, queue changes
   - Go back online
   - Verify "Syncing..." state appears briefly
   - Verify syncing completes

3. "handles sync failure gracefully"
   - This is harder to test without mocking
   - Could verify error toast appears if sync fails
   - May skip if too complex for E2E

4. "preserves data across page refresh while offline"
   - Load page, cache data
   - Go offline
   - Refresh page
   - Verify data still displayed
   - Verify offline indicator shown

5. "triggers sync on visibility change"
   - Go offline
   - Queue some changes
   - Go online
   - Hide tab (page.evaluate(() => document.hidden = true) or blur)
   - Show tab again
   - Verify sync triggered (iOS Safari fallback pattern)

Note: Some sync tests may be flaky due to timing. Use appropriate waits and retries.
  </action>
  <verify>
Run the tests:
```bash
cd frontend && npx playwright test e2e/offline/sync.spec.ts --project=chromium
```
Tests should pass (some may be marked skip if too complex).
  </verify>
  <done>
- sync.spec.ts exists with sync behavior tests
- Tests verify sync triggers on reconnection
- Tests verify sync status indicator states
- Tests handle timing appropriately (waits, not hardcoded delays)
  </done>
</task>

<task type="auto">
  <name>Task 3: Create multi-tab scenario tests</name>
  <files>frontend/e2e/offline/multi-tab.spec.ts</files>
  <action>
Create E2E tests for multi-tab offline scenarios using multiple browser contexts.

Per research, use `browser.newContext()` to simulate multiple tabs:

```typescript
test("syncs across tabs when back online", async ({ browser }) => {
  // Create two separate contexts (like two tabs)
  const context1 = await browser.newContext({
    storageState: "playwright/.auth/user.json",
  });
  const context2 = await browser.newContext({
    storageState: "playwright/.auth/user.json",
  });

  const page1 = await context1.newPage();
  const page2 = await context2.newPage();

  // Test scenario...

  await context1.close();
  await context2.close();
});
```

Test cases to implement:

1. "both tabs show offline indicator when network disconnected"
   - Open two contexts/pages
   - Set both offline
   - Verify both show offline indicator

2. "changes in one tab visible in other after sync"
   - Tab 1: Make a change while online
   - Tab 2: Refresh and verify change visible
   - This tests that IndexedDB is shared

3. "offline indicator state is independent per tab"
   - Tab 1: Go offline
   - Tab 2: Stay online
   - Verify Tab 1 shows offline, Tab 2 does not
   - (Each context has independent network state)

4. "pending changes sync from any tab that goes online first"
   - Both tabs offline
   - Tab 1 creates a change
   - Tab 1 goes online
   - Verify sync happens
   - Tab 2 goes online and refreshes
   - Verify change is there

Note: Multi-tab tests are complex. Focus on 2-3 essential scenarios. Mark others as skip if too flaky.
  </action>
  <verify>
Run the tests:
```bash
cd frontend && npx playwright test e2e/offline/multi-tab.spec.ts --project=chromium
```
Tests should pass.
  </verify>
  <done>
- multi-tab.spec.ts exists with multi-context tests
- Tests use browser.newContext() for tab simulation
- Tests verify independent offline states
- Tests clean up contexts properly (context.close())
  </done>
</task>

</tasks>

<verification>
Overall plan verification:

1. Run all offline tests:
```bash
cd frontend && npx playwright test e2e/offline/ --project=chromium
```

2. Verify tests are Chromium-only:
```bash
grep -r "browserName.*chromium" frontend/e2e/offline/
```

3. Verify tests use setOffline API:
```bash
grep -r "setOffline" frontend/e2e/offline/
```

4. Verify reasonable test count (aim for 10-15 tests total across files)
</verification>

<success_criteria>
- [ ] frontend/e2e/offline/ directory exists with 3 test files
- [ ] Tests use context.setOffline() for network simulation
- [ ] Tests skip on non-Chromium browsers
- [ ] Tests verify offline indicator (data-testid="offline-indicator")
- [ ] Tests verify cached data access
- [ ] Tests verify sync behavior
- [ ] Tests verify multi-tab scenarios
- [ ] All tests pass when run with `npx playwright test e2e/offline/ --project=chromium`
- [ ] Tests use proper waits (not hardcoded timeouts)
- [ ] Tests clean up resources (close contexts)
</success_criteria>

<output>
After completion, create `.planning/phases/04-pwa-screenshots-polish/04-03-SUMMARY.md`
</output>
