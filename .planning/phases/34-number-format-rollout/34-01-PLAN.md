---
phase: 34-number-format-rollout
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/app/[locale]/(dashboard)/dashboard/page.tsx
  - frontend/app/[locale]/(dashboard)/dashboard/analytics/page.tsx
  - frontend/app/[locale]/(dashboard)/dashboard/items/[id]/page.tsx
  - frontend/app/[locale]/(dashboard)/dashboard/items/page.tsx
  - frontend/app/[locale]/(dashboard)/dashboard/inventory/page.tsx
  - frontend/app/[locale]/(dashboard)/dashboard/loans/page.tsx
  - frontend/app/[locale]/(dashboard)/dashboard/out-of-stock/page.tsx
  - frontend/app/[locale]/(dashboard)/dashboard/imports/[jobId]/page.tsx
  - frontend/components/ui/export-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard stats cards (total items, locations, containers, active loans) display numbers with user's thousand separator"
    - "Analytics stats cards and loan statistics display numbers with user's format"
    - "Analytics tables (borrower loans, location quantities, location values) use user's number format"
    - "Inventory quantity, loan quantities, and min stock levels display with user's number format"
    - "Export dialog item counts display with user's number format"
    - "Import job statistics (processed, total, success, error) display with user's number format"
    - "CSV export price columns (unit_price, total_value) use user's decimal separator"
  artifacts:
    - path: "frontend/app/[locale]/(dashboard)/dashboard/page.tsx"
      provides: "Dashboard stats with formatNumber"
      contains: "useNumberFormat"
    - path: "frontend/app/[locale]/(dashboard)/dashboard/analytics/page.tsx"
      provides: "Analytics stats, tables, and price with formatNumber"
      contains: "useNumberFormat"
    - path: "frontend/app/[locale]/(dashboard)/dashboard/inventory/page.tsx"
      provides: "Inventory quantity display and CSV price formatters"
      contains: "useNumberFormat"
    - path: "frontend/components/ui/export-dialog.tsx"
      provides: "Export counts with formatNumber"
      contains: "useNumberFormat"
  key_links:
    - from: "all modified files"
      to: "frontend/lib/hooks/use-number-format.ts"
      via: "import { useNumberFormat }"
      pattern: "useNumberFormat"
---

<objective>
Apply useNumberFormat hook to all number display sites across dashboard, analytics, items, inventory, loans, out-of-stock, imports, and export dialog. Replace raw number interpolation, `.toLocaleString()`, `.toFixed(2)`, and hardcoded `$` price formatting with `formatNumber()` from the hook.

Purpose: Ensure all statistics (NUM-07), inventory counts (NUM-04), quantities (NUM-05), and prices in these files (NUM-06) respect the user's chosen thousand/decimal separator preferences.

Output: 9 files converted to use useNumberFormat hook for all number display.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-number-format-rollout/34-RESEARCH.md
@.planning/phases/32-date-format-rollout/32-01-SUMMARY.md
@frontend/lib/hooks/use-number-format.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert statistics and quantity display sites to useNumberFormat</name>
  <files>
    frontend/app/[locale]/(dashboard)/dashboard/page.tsx
    frontend/app/[locale]/(dashboard)/dashboard/analytics/page.tsx
    frontend/app/[locale]/(dashboard)/dashboard/items/[id]/page.tsx
    frontend/app/[locale]/(dashboard)/dashboard/items/page.tsx
    frontend/app/[locale]/(dashboard)/dashboard/loans/page.tsx
    frontend/app/[locale]/(dashboard)/dashboard/out-of-stock/page.tsx
    frontend/app/[locale]/(dashboard)/dashboard/imports/[jobId]/page.tsx
    frontend/components/ui/export-dialog.tsx
  </files>
  <action>
Import `useNumberFormat` from `@/lib/hooks/use-number-format` in each file and call `const { formatNumber } = useNumberFormat();` inside the component function.

Specific replacements per file:

**dashboard/page.tsx:**
- Line ~264: `stats.total_items.toLocaleString()` -> `formatNumber(stats.total_items)`
- Lines ~269, ~275, ~280: `stats.total_locations`, `stats.total_containers`, `stats.active_loans` -> wrap each with `formatNumber()`

**analytics/page.tsx:**
- Lines ~219, ~225, ~231, ~237: `dashboardStats.total_items`, `.total_categories`, `.active_loans`, `.overdue_loans` etc. -> wrap with `formatNumber()` (4 main stats cards - check exact field names)
- Lines ~246, ~252: `dashboardStats.total_locations`, `.total_containers` -> wrap with `formatNumber()`
- Lines ~399, ~401-402: `borrower.total_loans`, `borrower.active_loans` -> wrap with `formatNumber()`
- Lines ~440-441: `location.item_count`, `location.total_quantity` -> wrap with `formatNumber()`
- Line ~443: `${(location.total_value / 100).toFixed(2)}` -> `$${formatNumber(location.total_value / 100, 2)}`
- Lines ~465, ~469, ~473, ~477: `loanStats.total_loans`, `.active_loans`, `.returned_loans`, `.overdue_loans` -> wrap with `formatNumber()`

**items/[id]/page.tsx:**
- Line ~400: `{item.min_stock_level}` -> `{formatNumber(item.min_stock_level)}`

**items/page.tsx:**
- Line ~1351: `{item.min_stock_level}` in table cell -> `{formatNumber(item.min_stock_level)}`

**loans/page.tsx:**
- Line ~1062: `{loan.quantity}` -> `{formatNumber(loan.quantity)}`
- Line ~1236: `Qty: {inv.quantity}` -> `Qty: {formatNumber(inv.quantity)}`
- Line ~1282: `{availableInventory...quantity || 0}` -> wrap with `formatNumber()` (this is a display label showing max available)

**out-of-stock/page.tsx:**
- Line ~212: `{item.min_stock_level}` -> `{formatNumber(item.min_stock_level)}`

**imports/[jobId]/page.tsx:**
- Lines ~291, ~299, ~303, ~307: `job.processed_rows`, `job.total_rows`, `job.success_count`, `job.error_count` -> wrap with `formatNumber()`

**export-dialog.tsx:**
- Line ~180: `currentCount.toLocaleString()` -> `formatNumber(currentCount)`
- Line ~190: `allCount.toLocaleString()` -> `formatNumber(allCount)`

IMPORTANT: Do NOT convert file size displays (`.toFixed(1)` KB/MB in imports pages). Do NOT touch Chart dataKeys or Recharts axes. Do NOT touch `conflict-resolution-dialog.tsx`.
  </action>
  <verify>
Run `cd /home/antti/Repos/Misc/home-warehouse-system/frontend && npx tsc --noEmit` to check TypeScript compilation. Grep for remaining `.toLocaleString()` calls in dashboard pages (should be zero except in analytics chart label callback and conflict-resolution-dialog). Verify no raw number stats remain unformatted in the 8 files.
  </verify>
  <done>All statistics (dashboard stats cards, analytics stats cards, loan stats, import job stats), all quantities (inventory, loans, items min_stock_level), and export dialog counts display through formatNumber. No `.toLocaleString()` remains in these files.</done>
</task>

<task type="auto">
  <name>Task 2: Convert inventory CSV export price formatters to useNumberFormat</name>
  <files>
    frontend/app/[locale]/(dashboard)/dashboard/inventory/page.tsx
  </files>
  <action>
In inventory/page.tsx, the `useNumberFormat` hook is already imported from Task 1 (or import it if executing independently).

Update the CSV export column definitions in the `exportColumns` useMemo:

- Line ~914: `{ key: "unit_price", label: "Unit Price", formatter: (value) => value ? `$${value}` : "-" }` -> `{ key: "unit_price", label: "Unit Price", formatter: (value) => value ? `$${formatNumber(value / 100, 2)}` : "-" }`
- Line ~915: `{ key: "total_value", label: "Total Value", formatter: (value) => value ? `$${value}` : "-" }` -> `{ key: "total_value", label: "Total Value", formatter: (value) => value ? `$${formatNumber(value / 100, 2)}` : "-" }`

IMPORTANT: Check if these values are already in dollars or cents. The research says backend stores prices in cents, but the CSV formatter currently just does `$${value}` without dividing by 100. Read the actual data flow -- if the value passed to the formatter is already in dollars (pre-divided), then use `formatNumber(value, 2)` without the `/100`. If in cents, use `formatNumber(value / 100, 2)`.

Add `formatNumber` to the useMemo dependency array, following the pattern established in Phase 32 where `formatDate` was added to exportColumns dependencies.

Also wrap the inventory quantity InlineEditCell display value at line ~1354 if not already done in Task 1: `inventory.quantity.toString()` -> `formatNumber(inventory.quantity)`. Note: The InlineEditCell's display value should use formatNumber, but the edit/save should still work with raw numbers.
  </action>
  <verify>
Run `cd /home/antti/Repos/Misc/home-warehouse-system/frontend && npx tsc --noEmit` to verify no type errors. Check that the exportColumns useMemo dependency array includes `formatNumber`. Search inventory/page.tsx for remaining `$${value}` patterns (should be zero for price fields).
  </verify>
  <done>Inventory CSV export price columns (unit_price, total_value) format values using formatNumber with correct decimal separators. The formatNumber function is in the useMemo dependency array so format changes apply without page refresh.</done>
</task>

</tasks>

<verification>
1. `cd /home/antti/Repos/Misc/home-warehouse-system/frontend && npx tsc --noEmit` -- zero new TypeScript errors
2. `grep -rn "toLocaleString" frontend/app/[locale]/(dashboard)/dashboard/page.tsx frontend/app/[locale]/(dashboard)/dashboard/analytics/page.tsx frontend/components/ui/export-dialog.tsx` -- zero results (analytics chart label OK if in axis formatter callback)
3. `grep -rn "useNumberFormat" frontend/app/[locale]/(dashboard)/dashboard/` -- should show imports in all 8 page files
4. `cd /home/antti/Repos/Misc/home-warehouse-system/frontend && bun run build` -- production build succeeds
</verification>

<success_criteria>
- All 9 files import and use useNumberFormat hook
- Dashboard stats, analytics stats/tables, loan quantities, item min_stock_levels, import stats, and export counts all go through formatNumber
- Inventory CSV price columns use formatNumber with correct decimal separator
- No `.toLocaleString()` remains in modified files (except chart axis callbacks)
- TypeScript compiles and production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/34-number-format-rollout/34-01-SUMMARY.md`
</output>
