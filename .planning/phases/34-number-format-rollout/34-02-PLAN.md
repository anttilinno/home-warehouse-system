---
phase: 34-number-format-rollout
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/app/[locale]/(dashboard)/dashboard/declutter/page.tsx
  - frontend/components/inventory/repair-history.tsx
autonomous: true

must_haves:
  truths:
    - "Declutter page prices display using user's thousand/decimal separators instead of hardcoded en-US Intl.NumberFormat"
    - "Declutter CSV export price column uses user's decimal separator"
    - "Declutter currentCount statistic uses formatNumber"
    - "Repair history cost displays use user's number format instead of hardcoded en-US Intl.NumberFormat"
    - "Repair cost input accepts user's decimal separator (e.g., European user can type '12,50')"
    - "Repair cost input shows placeholder with user's decimal separator (e.g., '0,00' for comma-decimal users)"
  artifacts:
    - path: "frontend/app/[locale]/(dashboard)/dashboard/declutter/page.tsx"
      provides: "Declutter page with format-aware currency display and CSV export"
      contains: "useNumberFormat"
    - path: "frontend/components/inventory/repair-history.tsx"
      provides: "Repair history with format-aware currency and text-based cost input"
      contains: "useNumberFormat"
  key_links:
    - from: "frontend/app/[locale]/(dashboard)/dashboard/declutter/page.tsx"
      to: "frontend/lib/hooks/use-number-format.ts"
      via: "import { useNumberFormat }"
      pattern: "formatNumber"
    - from: "frontend/components/inventory/repair-history.tsx"
      to: "frontend/lib/hooks/use-number-format.ts"
      via: "import { useNumberFormat }"
      pattern: "parseNumber.*decimalSeparator"
---

<objective>
Refactor formatCurrency in declutter and repair-history to use useNumberFormat hook, convert repair cost input from type="number" to type="text" with inputMode="decimal" and parseNumber validation, and format all remaining number displays in these files.

Purpose: Complete NUM-06 (prices display) and NUM-08 (number inputs parse user format) for the declutter and repair-history files which require more complex formatCurrency refactoring and the only decimal input conversion in the app.

Output: 2 files with format-aware currency display and one input field converted to accept user's decimal separator.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-number-format-rollout/34-RESEARCH.md
@frontend/lib/hooks/use-number-format.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor declutter page formatCurrency and number displays</name>
  <files>
    frontend/app/[locale]/(dashboard)/dashboard/declutter/page.tsx
  </files>
  <action>
Import `useNumberFormat` from `@/lib/hooks/use-number-format` and call `const { formatNumber } = useNumberFormat();` inside the component.

**Refactor formatCurrency (lines ~46-54):**
The current implementation uses `Intl.NumberFormat("en-US", { style: "currency", currency })` which hardcodes US number formatting. Replace with a version that uses `formatNumber`:

```typescript
// Move formatCurrency inside the component (or pass formatNumber to it)
// Since it's a module-level function currently, either:
// Option A: Move inside component
// Option B: Create a local wrapper that captures formatNumber

// Recommended: Create local helper inside component
const formatCurrencyValue = useCallback((amountCents: number | null | undefined, currencyCode: string | null | undefined): string => {
  if (amountCents === null || amountCents === undefined) return "-";
  const amount = amountCents / 100;
  const currency = currencyCode || "EUR";
  // Use currency symbol mapping instead of Intl for the symbol
  const symbol = currency === "USD" ? "$" : currency === "EUR" ? "\u20AC" : currency + " ";
  return `${symbol}${formatNumber(amount, 2)}`;
}, [formatNumber]);
```

Then replace all `formatCurrency(...)` calls with `formatCurrencyValue(...)`:
- Line ~271: `formatCurrency(currentValue, "EUR")` -> `formatCurrencyValue(currentValue, "EUR")`
- Line ~344: `formatCurrency(item.purchase_price, item.currency_code)` -> `formatCurrencyValue(item.purchase_price, item.currency_code)`

Remove the old module-level `formatCurrency` function (lines ~46-54) and the `Intl.NumberFormat` import if it was the only usage.

**Convert CSV export price formatter (line ~172):**
`formatter: (value) => value ? (value / 100).toFixed(2) : ""` -> `formatter: (value) => value ? formatNumber(value / 100, 2) : ""`

Add `formatNumber` to the exportColumns useMemo dependency array.

**Convert currentCount display (line ~264):**
`{currentCount}` -> `{formatNumber(currentCount)}`

**Convert days_unused display (line ~340):**
`{item.days_unused}` -> `{formatNumber(item.days_unused)}`

IMPORTANT: Import `useCallback` from React if not already imported for the formatCurrencyValue wrapper.
  </action>
  <verify>
Run `cd /home/antti/Repos/Misc/home-warehouse-system/frontend && npx tsc --noEmit` to check TypeScript compilation. Grep declutter/page.tsx for `Intl.NumberFormat` (should be gone). Verify `formatNumber` is in exportColumns useMemo dependencies.
  </verify>
  <done>Declutter page displays all prices using user's number format. CSV export price column uses user's decimal separator. No hardcoded `Intl.NumberFormat("en-US")` remains. Statistics count uses formatNumber.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor repair-history formatCurrency and convert cost input</name>
  <files>
    frontend/components/inventory/repair-history.tsx
  </files>
  <action>
Import `useNumberFormat` from `@/lib/hooks/use-number-format` and call `const { formatNumber, parseNumber, decimalSeparator } = useNumberFormat();` inside the component.

**Refactor formatCurrency (lines ~131-139):**
Same pattern as declutter -- the current `Intl.NumberFormat("en-US", { style: "currency", currency })` must be replaced. Create a local helper inside the component:

```typescript
const formatCurrencyValue = useCallback((amountCents: number | null, currencyCode: string | null): string => {
  if (amountCents === null) return "-";
  const amount = amountCents / 100;
  const currency = currencyCode || "EUR";
  const symbol = currency === "USD" ? "$" : currency === "EUR" ? "\u20AC" : currency + " ";
  return `${symbol}${formatNumber(amount, 2)}`;
}, [formatNumber]);
```

Replace all `formatCurrency(...)` calls with `formatCurrencyValue(...)`:
- Line ~386: cost summary display
- Line ~455: individual repair cost
- Line ~738: selected repair detail cost

Remove the old module-level `formatCurrency` function.

**Convert repair cost input (line ~560-568):**
The current input is:
```html
<Input type="number" step="0.01" min="0" value={formCost} placeholder="0.00" ... />
```

Convert to:
```html
<Input type="text" inputMode="decimal" value={formCost} placeholder={`0${decimalSeparator}00`} ... />
```

Remove `step="0.01"` and `min="0"` attributes (these are `type="number"` specific).

**Update form save handler:**
Find where `formCost` is used on save/submit (likely converting to cents). Replace the direct `parseFloat(formCost)` or `Number(formCost)` with `parseNumber(formCost)`. Add null check -- if `parseNumber` returns null, show error toast and return early.

The save logic should look like:
```typescript
const parsedCost = formCost ? parseNumber(formCost) : null;
if (formCost && parsedCost === null) {
  toast.error("Invalid cost format");
  return;
}
const costInCents = parsedCost ? Math.round(parsedCost * 100) : null;
```

Find the exact save handler and update it. Search for where `formCost` is read during form submission or API call construction.

IMPORTANT: The `formCost` state is likely a string (since it's an input value). Verify the existing type and adjust accordingly. If it's already a string, the conversion should work directly. If it's a number type, you may need to change the state type to string.
  </action>
  <verify>
Run `cd /home/antti/Repos/Misc/home-warehouse-system/frontend && npx tsc --noEmit` to check TypeScript compilation. Grep repair-history.tsx for `Intl.NumberFormat` (should be gone). Grep for `type="number"` in repair-history.tsx -- should only remain for non-price integer inputs (if any). Verify `parseNumber` and `decimalSeparator` are used. Run `bun run build` to verify production build succeeds.
  </verify>
  <done>Repair history prices display using user's number format. Cost input accepts user's decimal separator (type="text" with inputMode="decimal"). Cost parsing uses parseNumber from hook. Placeholder shows user's decimal separator (e.g., "0,00" for European format).</done>
</task>

</tasks>

<verification>
1. `cd /home/antti/Repos/Misc/home-warehouse-system/frontend && npx tsc --noEmit` -- zero new TypeScript errors
2. `grep -rn "Intl.NumberFormat" frontend/app/[locale]/(dashboard)/dashboard/declutter/page.tsx frontend/components/inventory/repair-history.tsx` -- zero results
3. `grep -rn "useNumberFormat" frontend/app/[locale]/(dashboard)/dashboard/declutter/page.tsx frontend/components/inventory/repair-history.tsx` -- both files import the hook
4. `grep -n 'inputMode="decimal"' frontend/components/inventory/repair-history.tsx` -- found in cost input
5. `grep -n "parseNumber" frontend/components/inventory/repair-history.tsx` -- used in save handler
6. `cd /home/antti/Repos/Misc/home-warehouse-system/frontend && bun run build` -- production build succeeds
</verification>

<success_criteria>
- Declutter and repair-history no longer use Intl.NumberFormat("en-US")
- Both files import and use useNumberFormat hook
- Declutter CSV export price uses formatNumber with user's decimal separator
- Repair cost input is type="text" with inputMode="decimal"
- Repair cost placeholder shows user's decimal separator
- Cost parsing on save uses parseNumber from hook with null/error handling
- TypeScript compiles and production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/34-number-format-rollout/34-02-SUMMARY.md`
</output>
