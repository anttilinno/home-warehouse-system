---
phase: 15-background-thumbnail-processing
plan: 03
type: execute
wave: 3
depends_on: ["15-02"]
files_modified:
  - frontend/lib/types/photo.ts
  - frontend/lib/api/photos.ts
  - frontend/components/items/item-photo-gallery.tsx
  - frontend/components/items/photo-thumbnail.tsx
autonomous: true

must_haves:
  truths:
    - "Frontend shows processing indicator while thumbnails generate"
    - "Frontend updates automatically when SSE thumbnail_ready event received"
    - "Frontend shows error state when thumbnail generation fails"
    - "Photo gallery gracefully handles photos with pending thumbnails"
  artifacts:
    - path: "frontend/lib/types/photo.ts"
      provides: "ThumbnailStatus type and extended photo interface"
      contains: "thumbnail_status"
    - path: "frontend/components/items/photo-thumbnail.tsx"
      provides: "Thumbnail component with processing/error states"
      contains: "ThumbnailStatus"
  key_links:
    - from: "frontend/components/items/item-photo-gallery.tsx"
      to: "frontend/lib/hooks/use-sse.ts"
      via: "SSE subscription for thumbnail events"
      pattern: "useSSE|onEvent.*thumbnail"
    - from: "frontend/components/items/photo-thumbnail.tsx"
      to: "frontend/lib/types/photo.ts"
      via: "ThumbnailStatus type usage"
      pattern: "ThumbnailStatus"
---

<objective>
Add frontend support for async thumbnail processing with status indicators and SSE updates.

Purpose: Provide users with visual feedback during thumbnail generation (processing spinner) and automatically update UI when thumbnails become ready via SSE events.

Output: Extended photo types, thumbnail component with states, SSE event handling in photo gallery.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-background-thumbnail-processing/15-RESEARCH.md
@.planning/phases/15-background-thumbnail-processing/15-02-SUMMARY.md

@frontend/lib/hooks/use-sse.ts
@frontend/lib/types/
@frontend/components/items/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend photo types with thumbnail status</name>
  <files>frontend/lib/types/photo.ts</files>
  <action>
1. Add ThumbnailStatus enum:
   ```typescript
   export type ThumbnailStatus = 'pending' | 'processing' | 'complete' | 'failed';
   ```

2. Extend ItemPhoto interface (or create if not exists):
   ```typescript
   export interface ItemPhoto {
     id: string;
     item_id: string;
     workspace_id: string;
     filename: string;
     storage_path: string;
     thumbnail_path: string;  // Legacy, may be empty
     thumbnail_status: ThumbnailStatus;
     thumbnail_small_path?: string;
     thumbnail_medium_path?: string;
     thumbnail_large_path?: string;
     thumbnail_error?: string;
     file_size: number;
     mime_type: string;
     width: number;
     height: number;
     display_order: number;
     is_primary: boolean;
     caption?: string;
     uploaded_by: string;
     created_at: string;
     updated_at: string;
   }
   ```

3. Add SSE event types:
   ```typescript
   export interface ThumbnailReadyEvent {
     photo_id: string;
     item_id: string;
     small_thumbnail_url?: string;
     medium_thumbnail_url?: string;
     large_thumbnail_url?: string;
   }

   export interface ThumbnailFailedEvent {
     photo_id: string;
     item_id: string;
     error: string;
   }
   ```

4. Add helper function:
   ```typescript
   export function isThumbnailReady(photo: ItemPhoto): boolean {
     return photo.thumbnail_status === 'complete';
   }

   export function getBestThumbnailUrl(photo: ItemPhoto, baseUrl: string): string | null {
     if (photo.thumbnail_medium_path) {
       return `${baseUrl}/files/${photo.thumbnail_medium_path}`;
     }
     if (photo.thumbnail_path) {
       return `${baseUrl}/files/${photo.thumbnail_path}`;
     }
     return null;
   }
   ```
  </action>
  <verify>
Run `bun run type-check` from frontend directory - no type errors
  </verify>
  <done>
Photo types include ThumbnailStatus enum, multi-size thumbnail paths, and SSE event interfaces.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PhotoThumbnail component with status states</name>
  <files>frontend/components/items/photo-thumbnail.tsx</files>
  <action>
Create a new component that renders a photo thumbnail with processing/error states:

```typescript
"use client";

import { useState } from "react";
import Image from "next/image";
import { Loader2, AlertCircle, ImageOff } from "lucide-react";
import { cn } from "@/lib/utils";
import type { ItemPhoto, ThumbnailStatus } from "@/lib/types/photo";
import { getBestThumbnailUrl } from "@/lib/types/photo";
import { Tooltip, TooltipContent, TooltipTrigger } from "@/components/ui/tooltip";

interface PhotoThumbnailProps {
  photo: ItemPhoto;
  size?: "sm" | "md" | "lg";
  className?: string;
  onClick?: () => void;
}

const sizeMap = {
  sm: { width: 64, height: 64 },
  md: { width: 128, height: 128 },
  lg: { width: 256, height: 256 },
};

export function PhotoThumbnail({
  photo,
  size = "md",
  className,
  onClick,
}: PhotoThumbnailProps) {
  const [imageError, setImageError] = useState(false);
  const dimensions = sizeMap[size];
  const baseUrl = process.env.NEXT_PUBLIC_API_URL || "";

  // Get thumbnail URL based on status
  const thumbnailUrl = getBestThumbnailUrl(photo, baseUrl);

  // Render based on status
  if (photo.thumbnail_status === "pending" || photo.thumbnail_status === "processing") {
    return (
      <div
        className={cn(
          "flex items-center justify-center bg-muted rounded-md",
          className
        )}
        style={{ width: dimensions.width, height: dimensions.height }}
      >
        <Tooltip>
          <TooltipTrigger asChild>
            <div className="flex flex-col items-center gap-1 text-muted-foreground">
              <Loader2 className="h-6 w-6 animate-spin" />
              <span className="text-xs">Processing</span>
            </div>
          </TooltipTrigger>
          <TooltipContent>
            <p>Generating thumbnails...</p>
          </TooltipContent>
        </Tooltip>
      </div>
    );
  }

  if (photo.thumbnail_status === "failed") {
    return (
      <div
        className={cn(
          "flex items-center justify-center bg-destructive/10 rounded-md",
          className
        )}
        style={{ width: dimensions.width, height: dimensions.height }}
      >
        <Tooltip>
          <TooltipTrigger asChild>
            <div className="flex flex-col items-center gap-1 text-destructive">
              <AlertCircle className="h-6 w-6" />
              <span className="text-xs">Failed</span>
            </div>
          </TooltipTrigger>
          <TooltipContent>
            <p>{photo.thumbnail_error || "Thumbnail generation failed"}</p>
          </TooltipContent>
        </Tooltip>
      </div>
    );
  }

  // Status is complete - show image
  if (!thumbnailUrl || imageError) {
    return (
      <div
        className={cn(
          "flex items-center justify-center bg-muted rounded-md",
          className
        )}
        style={{ width: dimensions.width, height: dimensions.height }}
      >
        <ImageOff className="h-6 w-6 text-muted-foreground" />
      </div>
    );
  }

  return (
    <div
      className={cn("relative rounded-md overflow-hidden cursor-pointer", className)}
      style={{ width: dimensions.width, height: dimensions.height }}
      onClick={onClick}
    >
      <Image
        src={thumbnailUrl}
        alt={photo.caption || photo.filename}
        fill
        className="object-cover"
        onError={() => setImageError(true)}
      />
    </div>
  );
}
```

Add translations if using i18n:
- "Processing" -> t("photos.processing")
- "Failed" -> t("photos.failed")
- "Generating thumbnails..." -> t("photos.generatingThumbnails")
  </action>
  <verify>
Run `bun run type-check` - no type errors
Run `bun run lint` - no lint errors
  </verify>
  <done>
PhotoThumbnail component displays spinner for pending/processing, error icon for failed, and image for complete status.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add SSE handling to photo gallery</name>
  <files>frontend/components/items/item-photo-gallery.tsx</files>
  <action>
Update the item photo gallery component to:

1. Import useSSE hook and SSE event types:
   ```typescript
   import { useSSE, type SSEEvent } from "@/lib/hooks/use-sse";
   import type { ThumbnailReadyEvent, ThumbnailFailedEvent } from "@/lib/types/photo";
   ```

2. Add SSE subscription for thumbnail events:
   ```typescript
   // Subscribe to thumbnail SSE events
   useSSE({
     onEvent: (event: SSEEvent) => {
       if (event.type === "photo.thumbnail_ready") {
         const data = event.data as ThumbnailReadyEvent;
         // Update photo in local state or invalidate query
         if (data.item_id === itemId) {
           // Option 1: Update local state if managing photos locally
           setPhotos(prev => prev.map(photo =>
             photo.id === data.photo_id
               ? {
                   ...photo,
                   thumbnail_status: "complete" as const,
                   thumbnail_small_path: data.small_thumbnail_url,
                   thumbnail_medium_path: data.medium_thumbnail_url,
                   thumbnail_large_path: data.large_thumbnail_url,
                 }
               : photo
           ));

           // Option 2: Invalidate react-query if using that
           // queryClient.invalidateQueries(["item-photos", itemId]);
         }
       }

       if (event.type === "photo.thumbnail_failed") {
         const data = event.data as ThumbnailFailedEvent;
         if (data.item_id === itemId) {
           setPhotos(prev => prev.map(photo =>
             photo.id === data.photo_id
               ? {
                   ...photo,
                   thumbnail_status: "failed" as const,
                   thumbnail_error: data.error,
                 }
               : photo
           ));
         }
       }
     },
   });
   ```

3. Update gallery to use PhotoThumbnail component:
   ```typescript
   {photos.map((photo) => (
     <PhotoThumbnail
       key={photo.id}
       photo={photo}
       size="md"
       onClick={() => setSelectedPhoto(photo)}
     />
   ))}
   ```

4. Add toast notification for failed thumbnails (optional):
   ```typescript
   import { toast } from "sonner";

   // In SSE handler for failed event:
   toast.error(t("photos.thumbnailFailed"), {
     description: data.error,
   });
   ```

Adapt based on actual gallery implementation (may use react-query, zustand, or local state).
  </action>
  <verify>
Run `bun run type-check` - no type errors
Run `bun run build` - builds successfully
Manual test: Upload photo, see processing spinner, wait for thumbnail_ready event, see image appear
  </verify>
  <done>
Photo gallery subscribes to SSE events and automatically updates when thumbnails become ready or fail.
  </done>
</task>

</tasks>

<verification>
1. Type check passes: `cd frontend && bun run type-check`
2. Build passes: `bun run build`
3. Manual test flow:
   - Start backend with worker: `mise run dev` and `mise run worker`
   - Start frontend: `mise run fe-dev`
   - Upload a photo to an item
   - Observe: Photo shows with "Processing" spinner
   - Wait 5-10 seconds for background job
   - Observe: Photo updates to show actual thumbnail (no page refresh needed)
</verification>

<success_criteria>
- ThumbnailStatus type defined with pending/processing/complete/failed values
- ItemPhoto interface includes all thumbnail path fields and status
- PhotoThumbnail component shows appropriate state (spinner, error, image)
- Photo gallery subscribes to SSE and updates photos on thumbnail_ready/thumbnail_failed
- No page refresh required to see thumbnails after upload
- Failed thumbnails show error message in tooltip
</success_criteria>

<output>
After completion, create `.planning/phases/15-background-thumbnail-processing/15-03-SUMMARY.md`
</output>
