---
phase: 15-background-thumbnail-processing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/db/migrations/YYYYMMDDHHMMSS_add_thumbnail_processing.sql
  - backend/db/queries/item_photos.sql
  - backend/internal/domain/warehouse/itemphoto/entity.go
  - backend/internal/infra/queries/item_photos.sql.go
autonomous: true

must_haves:
  truths:
    - "item_photos table has thumbnail_status column with valid enum values"
    - "item_photos table has separate columns for small/medium/large thumbnail paths"
    - "item_photos table tracks thumbnail attempts and error message"
    - "sqlc queries exist for updating thumbnail status and paths"
  artifacts:
    - path: "backend/db/migrations/*_add_thumbnail_processing.sql"
      provides: "Schema migration for thumbnail processing columns"
      contains: "thumbnail_status"
    - path: "backend/db/queries/item_photos.sql"
      provides: "sqlc queries for thumbnail status management"
      contains: "UpdateThumbnailStatus"
    - path: "backend/internal/domain/warehouse/itemphoto/entity.go"
      provides: "ThumbnailStatus enum and extended entity fields"
      contains: "ThumbnailStatus"
  key_links:
    - from: "backend/db/queries/item_photos.sql"
      to: "migrations/*_add_thumbnail_processing.sql"
      via: "sqlc references new columns"
      pattern: "thumbnail_status|thumbnail_small_path"
---

<objective>
Add database schema and entity changes for async thumbnail processing with status tracking.

Purpose: Enable non-blocking photo uploads by tracking thumbnail generation status (pending, processing, complete, failed) with separate paths for small/medium/large thumbnails.

Output: Database migration, updated sqlc queries, extended entity with ThumbnailStatus enum.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-background-thumbnail-processing/15-RESEARCH.md

@backend/internal/domain/warehouse/itemphoto/entity.go
@backend/db/queries/item_photos.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration for thumbnail processing columns</name>
  <files>backend/db/migrations/YYYYMMDDHHMMSS_add_thumbnail_processing.sql</files>
  <action>
Create a new dbmate migration that adds thumbnail processing columns to item_photos table:

1. Add columns:
   - `thumbnail_status VARCHAR(20) NOT NULL DEFAULT 'pending'` with CHECK constraint for values: pending, processing, complete, failed
   - `thumbnail_small_path VARCHAR(500)` - nullable, path to 150px thumbnail
   - `thumbnail_medium_path VARCHAR(500)` - nullable, path to 400px thumbnail (replaces current thumbnail_path usage)
   - `thumbnail_large_path VARCHAR(500)` - nullable, path to 800px thumbnail
   - `thumbnail_attempts INTEGER NOT NULL DEFAULT 0` - retry counter
   - `thumbnail_error TEXT` - nullable, stores last error message

2. Create partial index on thumbnail_status for efficient job queue lookups:
   `CREATE INDEX idx_item_photos_thumbnail_pending ON warehouse.item_photos(thumbnail_status) WHERE thumbnail_status IN ('pending', 'processing');`

3. Migrate existing photos: Set thumbnail_status='complete' and thumbnail_medium_path=thumbnail_path for all existing photos that have a thumbnail_path.

4. Add column comments explaining each field's purpose.

Use timestamp format YYYYMMDDHHMMSS (use current time when creating).
  </action>
  <verify>
Run `mise run migrate` and verify:
- Migration applies successfully
- New columns exist: `\d warehouse.item_photos` shows thumbnail_status, thumbnail_small_path, etc.
- Existing photos have thumbnail_status='complete' where thumbnail_path was set
- Partial index exists on thumbnail_status
  </verify>
  <done>
Migration creates thumbnail processing columns with proper constraints, index, and data migration for existing photos.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add sqlc queries for thumbnail status management</name>
  <files>backend/db/queries/item_photos.sql</files>
  <action>
Add new sqlc queries for thumbnail processing:

1. `UpdateThumbnailStatus` - Update status and increment attempts:
   ```sql
   -- name: UpdateThumbnailStatus :exec
   UPDATE warehouse.item_photos
   SET thumbnail_status = $2,
       thumbnail_attempts = thumbnail_attempts + 1,
       thumbnail_error = $3,
       updated_at = now()
   WHERE id = $1;
   ```

2. `UpdateThumbnailPaths` - Set all thumbnail paths and mark complete:
   ```sql
   -- name: UpdateThumbnailPaths :one
   UPDATE warehouse.item_photos
   SET thumbnail_small_path = $2,
       thumbnail_medium_path = $3,
       thumbnail_large_path = $4,
       thumbnail_status = 'complete',
       thumbnail_error = NULL,
       updated_at = now()
   WHERE id = $1
   RETURNING *;
   ```

3. `ListPendingThumbnails` - Find photos needing processing:
   ```sql
   -- name: ListPendingThumbnails :many
   SELECT * FROM warehouse.item_photos
   WHERE thumbnail_status IN ('pending', 'processing')
     AND thumbnail_attempts < 5
   ORDER BY created_at ASC
   LIMIT $1;
   ```

4. `GetItemPhotoForProcessing` - Get photo with workspace for job:
   ```sql
   -- name: GetItemPhotoForProcessing :one
   SELECT ip.*, i.workspace_id
   FROM warehouse.item_photos ip
   JOIN warehouse.items i ON i.id = ip.item_id
   WHERE ip.id = $1;
   ```

Run `mise run sqlc` to regenerate queries.
  </action>
  <verify>
Run `mise run sqlc` - generates without errors
Check backend/internal/infra/queries/item_photos.sql.go contains:
- UpdateThumbnailStatus function
- UpdateThumbnailPaths function
- ListPendingThumbnails function
  </verify>
  <done>
sqlc queries exist for updating thumbnail status, setting paths on completion, and listing pending thumbnails.
  </done>
</task>

<task type="auto">
  <name>Task 3: Extend ItemPhoto entity with ThumbnailStatus enum and fields</name>
  <files>backend/internal/domain/warehouse/itemphoto/entity.go</files>
  <action>
1. Add ThumbnailStatus type and constants:
   ```go
   // ThumbnailStatus represents the processing state of photo thumbnails
   type ThumbnailStatus string

   const (
       ThumbnailStatusPending    ThumbnailStatus = "pending"
       ThumbnailStatusProcessing ThumbnailStatus = "processing"
       ThumbnailStatusComplete   ThumbnailStatus = "complete"
       ThumbnailStatusFailed     ThumbnailStatus = "failed"
   )

   // IsValid checks if the status is a valid enum value
   func (s ThumbnailStatus) IsValid() bool {
       switch s {
       case ThumbnailStatusPending, ThumbnailStatusProcessing, ThumbnailStatusComplete, ThumbnailStatusFailed:
           return true
       }
       return false
   }
   ```

2. Add new fields to ItemPhoto struct:
   ```go
   ThumbnailStatus     ThumbnailStatus  // Current processing status
   ThumbnailSmallPath  *string          // 150px thumbnail path
   ThumbnailMediumPath *string          // 400px thumbnail path
   ThumbnailLargePath  *string          // 800px thumbnail path
   ThumbnailAttempts   int32            // Number of processing attempts
   ThumbnailError      *string          // Last error message if failed
   ```

3. Update Validate() method:
   - Make ThumbnailPath validation optional (nil allowed for async processing)
   - Add ThumbnailStatus validation if set (must be valid enum)

4. Add helper methods:
   ```go
   // IsThumbnailReady returns true if thumbnails are ready for display
   func (p *ItemPhoto) IsThumbnailReady() bool {
       return p.ThumbnailStatus == ThumbnailStatusComplete
   }

   // GetBestThumbnail returns the path to the best available thumbnail
   // Returns medium if available, falls back to legacy ThumbnailPath
   func (p *ItemPhoto) GetBestThumbnail() string {
       if p.ThumbnailMediumPath != nil && *p.ThumbnailMediumPath != "" {
           return *p.ThumbnailMediumPath
       }
       return p.ThumbnailPath // Legacy fallback
   }
   ```
  </action>
  <verify>
Run `go build ./...` from backend directory - no compilation errors
Run unit tests: `mise run test-unit` - all pass
  </verify>
  <done>
ItemPhoto entity has ThumbnailStatus enum, multi-size thumbnail path fields, and helper methods for thumbnail availability.
  </done>
</task>

</tasks>

<verification>
1. Database has new columns: `psql -c "\d warehouse.item_photos" | grep thumbnail`
2. sqlc regeneration successful: `mise run sqlc` exits 0
3. Go builds: `cd backend && go build ./...` exits 0
4. Existing tests pass: `mise run test-unit`
</verification>

<success_criteria>
- Migration adds thumbnail_status with enum constraint and all size-specific path columns
- Existing photos migrated to thumbnail_status='complete'
- Partial index on thumbnail_status for efficient pending photo lookups
- sqlc queries for status updates, path updates, and pending photo listing
- ItemPhoto entity extended with ThumbnailStatus enum and multi-size fields
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/15-background-thumbnail-processing/15-01-SUMMARY.md`
</output>
