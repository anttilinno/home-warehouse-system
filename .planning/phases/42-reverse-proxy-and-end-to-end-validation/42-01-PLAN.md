---
phase: 42-reverse-proxy-and-end-to-end-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker/angie/angie.conf
  - docker-compose.yml
autonomous: true

must_haves:
  truths:
    - "HTTPS serves frontend app on port 443 through Angie proxy"
    - "API requests at /auth/, /workspaces/, /notifications/, /push/, /barcode/ reach the backend through Angie"
    - "SSE connections at /workspaces/{id}/sse stream events without buffering or premature timeout"
    - "HTTP requests on port 80 redirect to HTTPS on port 443"
    - "Self-signed certificates are generated by the provided script and mounted into Angie"
  artifacts:
    - path: "docker/angie/angie.conf"
      provides: "Reverse proxy routing with HTTPS, SSE support, and HTTP redirect"
      contains: "proxy_buffering off"
    - path: "docker/angie/proxy_params.conf"
      provides: "Common proxy headers"
      contains: "X-Forwarded-Proto"
    - path: "docker/certs/generate-certs.sh"
      provides: "Self-signed certificate generation"
      contains: "openssl req -x509"
    - path: "docker-compose.yml"
      provides: "Angie service definition with cert volume mount"
      contains: "angie"
  key_links:
    - from: "docker-compose.yml"
      to: "docker/angie/angie.conf"
      via: "volume mount"
      pattern: "angie\\.conf:/etc/angie/angie\\.conf"
    - from: "docker-compose.yml"
      to: ".data/certs"
      via: "volume mount"
      pattern: "\\.data/certs:/etc/angie/certs"
    - from: "docker/angie/angie.conf"
      to: "backend:8080"
      via: "upstream proxy_pass"
      pattern: "upstream backend"
    - from: "docker/angie/angie.conf"
      to: "frontend:3000"
      via: "upstream proxy_pass"
      pattern: "upstream frontend"
---

<objective>
Harden the Angie reverse proxy configuration for production SSE reliability and add a healthcheck to the angie service. Most configuration already exists from Phase 40 and is correct -- this plan makes targeted improvements to SSE proxy settings and adds operational completeness.

Purpose: Ensure the full production stack works reliably end-to-end, especially SSE connections which are sensitive to proxy buffering and connection settings.
Output: Production-ready Angie configuration with proper SSE handling and service healthcheck.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@docker/angie/angie.conf
@docker/angie/proxy_params.conf
@docker/certs/generate-certs.sh
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Harden Angie SSE proxy settings and add keepalive</name>
  <files>docker/angie/angie.conf</files>
  <action>
The existing angie.conf is mostly correct. Make these targeted improvements:

1. **SSE location block (`/workspaces/`)** -- add HTTP/1.1 and Connection header:
   ```
   location /workspaces/ {
       proxy_pass http://backend;
       proxy_http_version 1.1;
       proxy_set_header Connection "";
       proxy_buffering off;
       proxy_cache off;
       proxy_read_timeout 86400s;
       proxy_send_timeout 86400s;
   }
   ```
   - `proxy_http_version 1.1` -- required for keepalive connections to upstream
   - `proxy_set_header Connection ""` -- clears the hop-by-hop Connection header so upstream sees a clean keepalive connection (critical for SSE)
   - `proxy_cache off` -- explicitly disable caching for SSE streams
   - Keep existing `proxy_buffering off` and timeout settings

2. **Upstream keepalive** -- add keepalive to the backend upstream block for connection reuse:
   ```
   upstream backend {
       server backend:8080;
       keepalive 16;
   }
   ```
   This maintains a pool of idle keepalive connections to the backend, reducing latency for new requests.

3. No other changes needed. The /notifications/ route is standard REST (not SSE) so it does not need special proxy settings. The HTTP-to-HTTPS redirect, SSL config, and frontend proxy are all correct as-is.
  </action>
  <verify>
Run: `docker run --rm -v $(pwd)/docker/angie/angie.conf:/etc/angie/angie.conf:ro docker.angie.software/angie:latest angie -t -c /etc/angie/angie.conf` to validate config syntax (will warn about missing upstreams but should not error on syntax). Alternatively, visually confirm the file has `proxy_http_version 1.1`, `proxy_set_header Connection ""`, `proxy_cache off` in the /workspaces/ block, and `keepalive 16` in the upstream.
  </verify>
  <done>The /workspaces/ location block has proxy_http_version 1.1, Connection "" header, proxy_cache off, and proxy_buffering off. The backend upstream has keepalive 16.</done>
</task>

<task type="auto">
  <name>Task 2: Add Angie healthcheck and verify cert script integration</name>
  <files>docker-compose.yml</files>
  <action>
1. **Add healthcheck to the angie service** in docker-compose.yml so dependent services (if any in future) and `docker compose ps` can report proxy health:
   ```yaml
   angie:
     image: docker.angie.software/angie:latest
     profiles: ["prod"]
     depends_on:
       backend:
         condition: service_healthy
       frontend:
         condition: service_healthy
     ports:
       - "80:80"
       - "443:443"
     volumes:
       - ./docker/angie/angie.conf:/etc/angie/angie.conf:ro
       - ./docker/angie/proxy_params.conf:/etc/angie/proxy_params.conf:ro
       - ./.data/certs:/etc/angie/certs:ro
     healthcheck:
       test: ["CMD-SHELL", "curl -fsk https://localhost/health || exit 1"]
       interval: 10s
       timeout: 5s
       retries: 3
       start_period: 5s
     networks:
       - warehouse
   ```
   The healthcheck uses `curl -fsk` where `-k` skips certificate verification (self-signed) and hits the `/health` endpoint which proxies through to the backend. This verifies the full proxy chain is working.

   Note: The Angie image is based on Debian and includes curl. If curl is not available, fall back to:
   ```
   test: ["CMD-SHELL", "wget -qO- --no-check-certificate https://localhost/health || exit 1"]
   ```

2. **Verify cert script outputs to correct location**: The existing `docker/certs/generate-certs.sh` writes to `.data/certs/server.crt` and `.data/certs/server.key`. The docker-compose.yml mounts `.data/certs:/etc/angie/certs:ro`. The angie.conf references `/etc/angie/certs/server.crt` and `/etc/angie/certs/server.key`. This chain is correct -- no changes needed to the cert script or its output paths.

3. No other changes to docker-compose.yml. All service definitions, profiles, environment variables, and volume mounts from Phase 40 and 41 are correct.
  </action>
  <verify>
Run: `docker compose --profile prod config --quiet` to validate the compose file parses correctly. Verify the angie service has a healthcheck block in the output.
  </verify>
  <done>The angie service in docker-compose.yml has a healthcheck that validates the full proxy chain via HTTPS /health endpoint. The cert script, volume mounts, and angie.conf SSL paths are all aligned.</done>
</task>

</tasks>

<verification>
1. `docker/angie/angie.conf` has SSE-hardened /workspaces/ block with proxy_http_version 1.1, Connection "", proxy_cache off, proxy_buffering off, and 86400s timeouts
2. `docker/angie/angie.conf` backend upstream has keepalive 16
3. `docker-compose.yml` angie service has healthcheck
4. `docker/certs/generate-certs.sh` is executable and outputs to `.data/certs/`
5. HTTP redirect (port 80 -> 443) exists in angie.conf
6. All API routes (/auth/, /workspaces/, /health, /users/, /docs, /redoc, /openapi.json, /barcode/, /notifications/, /push/, /api/v1/) proxy to backend
7. Default route (/) proxies to frontend with WebSocket upgrade support
</verification>

<success_criteria>
- Angie config validates syntactically
- docker-compose.yml parses without errors
- SSE proxy settings are hardened (HTTP/1.1, no buffering, no caching, long timeouts)
- Angie healthcheck validates full proxy chain
- All four PROXY requirements addressed: routing (PROXY-01), SSE (PROXY-02), HTTPS with self-signed certs (PROXY-03), HTTP redirect (PROXY-04)
</success_criteria>

<output>
After completion, create `.planning/phases/42-reverse-proxy-and-end-to-end-validation/42-01-SUMMARY.md`
</output>
