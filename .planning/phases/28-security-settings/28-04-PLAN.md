---
phase: 28-security-settings
plan: 04
type: execute
wave: 3
depends_on: ["28-03"]
files_modified:
  - frontend/components/settings/active-sessions.tsx
  - frontend/components/settings/security-settings.tsx
  - frontend/lib/api/auth.ts
  - frontend/messages/en.json
autonomous: true

must_haves:
  truths:
    - "User can view a list of all active sessions showing device type and last activity"
    - "User can revoke any individual session, logging out that device"
    - "User can log out all other sessions at once, keeping only current session active"
    - "Current session is marked and cannot be revoked"
  artifacts:
    - path: "frontend/components/settings/active-sessions.tsx"
      provides: "Session list with revoke functionality"
      min_lines: 100
    - path: "frontend/lib/api/auth.ts"
      provides: "Session API functions"
      exports: ["getSessions", "revokeSession", "revokeAllOtherSessions"]
  key_links:
    - from: "frontend/components/settings/active-sessions.tsx"
      to: "/users/me/sessions"
      via: "authApi.getSessions"
      pattern: "getSessions"
    - from: "frontend/components/settings/active-sessions.tsx"
      to: "/users/me/sessions/:id"
      via: "authApi.revokeSession"
      pattern: "revokeSession"
    - from: "frontend/components/settings/security-settings.tsx"
      to: "ActiveSessions"
      via: "component import"
      pattern: "ActiveSessions"
---

<objective>
Implement active sessions UI with view and revocation functionality.

Purpose: Users can see where they're logged in and revoke sessions on other devices. This completes SEC-02, SEC-03, and SEC-04 requirements.

Output: ActiveSessions component showing session list with device info, last activity, revoke buttons, and "logout all others" action.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/28-security-settings/28-RESEARCH.md
@.planning/phases/28-security-settings/28-03-SUMMARY.md

# Existing patterns
@frontend/components/settings/account-settings.tsx
@frontend/lib/api/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add session API functions to auth client</name>
  <files>frontend/lib/api/auth.ts</files>
  <action>
Add session-related types and functions to frontend/lib/api/auth.ts:

```typescript
export interface Session {
  id: string;
  device_info: string;
  ip_address: string | null;
  last_active_at: string;
  created_at: string;
  is_current: boolean;
}

// Add to authApi object:
export const authApi = {
  // ... existing functions ...

  getSessions: async (): Promise<Session[]> => {
    return apiClient.get<Session[]>("/users/me/sessions");
  },

  revokeSession: async (sessionId: string): Promise<void> => {
    await apiClient.delete(`/users/me/sessions/${sessionId}`);
  },

  revokeAllOtherSessions: async (): Promise<void> => {
    await apiClient.delete("/users/me/sessions");
  },

  changePassword: async (currentPassword: string, newPassword: string): Promise<void> => {
    await apiClient.patch("/users/me/password", {
      current_password: currentPassword,
      new_password: newPassword,
    });
  },
};
```

Note: changePassword may already exist from plan 01 - just ensure getSessions, revokeSession, and revokeAllOtherSessions are added.
  </action>
  <verify>TypeScript compiles: `cd frontend && bun run build --no-lint 2>&1 | grep -E "error|Error" || echo "No errors"`</verify>
  <done>authApi has getSessions, revokeSession, and revokeAllOtherSessions functions</done>
</task>

<task type="auto">
  <name>Task 2: Create ActiveSessions component</name>
  <files>
    frontend/components/settings/active-sessions.tsx
    frontend/messages/en.json
  </files>
  <action>
Create frontend/components/settings/active-sessions.tsx:

```typescript
"use client";

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { useTranslations } from "next-intl";
import { Monitor, Smartphone, Tablet, LogOut, Loader2 } from "lucide-react";
import { formatDistanceToNow } from "date-fns";

import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Skeleton } from "@/components/ui/skeleton";
import { authApi, Session } from "@/lib/api/auth";
import { toast } from "sonner";

function getDeviceIcon(deviceInfo: string) {
  const lower = deviceInfo.toLowerCase();
  if (lower.includes("iphone") || lower.includes("android") || lower.includes("mobile")) {
    return Smartphone;
  }
  if (lower.includes("ipad") || lower.includes("tablet")) {
    return Tablet;
  }
  return Monitor;
}

export function ActiveSessions() {
  const t = useTranslations("settings.security.sessions");
  const queryClient = useQueryClient();

  const { data: sessions, isLoading, error } = useQuery({
    queryKey: ["sessions"],
    queryFn: () => authApi.getSessions(),
  });

  const revokeMutation = useMutation({
    mutationFn: (sessionId: string) => authApi.revokeSession(sessionId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["sessions"] });
      toast.success(t("revokeSuccess"));
    },
    onError: () => {
      toast.error(t("revokeError"));
    },
  });

  const revokeAllMutation = useMutation({
    mutationFn: () => authApi.revokeAllOtherSessions(),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["sessions"] });
      toast.success(t("revokeAllSuccess"));
    },
    onError: () => {
      toast.error(t("revokeAllError"));
    },
  });

  if (isLoading) {
    return (
      <div className="space-y-3">
        <Skeleton className="h-16 w-full" />
        <Skeleton className="h-16 w-full" />
      </div>
    );
  }

  if (error) {
    return (
      <p className="text-sm text-destructive">{t("loadError")}</p>
    );
  }

  const hasOtherSessions = sessions && sessions.filter(s => !s.is_current).length > 0;

  return (
    <div className="space-y-4">
      {sessions?.map((session) => {
        const DeviceIcon = getDeviceIcon(session.device_info);
        return (
          <div
            key={session.id}
            className="flex items-center justify-between p-3 border rounded-lg"
          >
            <div className="flex items-center gap-3">
              <DeviceIcon className="h-5 w-5 text-muted-foreground" />
              <div>
                <div className="flex items-center gap-2">
                  <p className="font-medium text-sm">
                    {session.device_info || t("unknownDevice")}
                  </p>
                  {session.is_current && (
                    <Badge variant="secondary" className="text-xs">
                      {t("currentSession")}
                    </Badge>
                  )}
                </div>
                <p className="text-xs text-muted-foreground">
                  {t("lastActive", {
                    time: formatDistanceToNow(new Date(session.last_active_at), {
                      addSuffix: true,
                    }),
                  })}
                </p>
              </div>
            </div>
            {!session.is_current && (
              <Button
                variant="ghost"
                size="sm"
                onClick={() => revokeMutation.mutate(session.id)}
                disabled={revokeMutation.isPending}
                title={t("revokeButton")}
              >
                {revokeMutation.isPending && revokeMutation.variables === session.id ? (
                  <Loader2 className="h-4 w-4 animate-spin" />
                ) : (
                  <LogOut className="h-4 w-4" />
                )}
              </Button>
            )}
          </div>
        );
      })}

      {hasOtherSessions && (
        <Button
          variant="outline"
          className="w-full"
          onClick={() => revokeAllMutation.mutate()}
          disabled={revokeAllMutation.isPending}
        >
          {revokeAllMutation.isPending && (
            <Loader2 className="mr-2 h-4 w-4 animate-spin" />
          )}
          {t("revokeAllButton")}
        </Button>
      )}

      {sessions?.length === 1 && sessions[0].is_current && (
        <p className="text-sm text-muted-foreground text-center">
          {t("onlyCurrentSession")}
        </p>
      )}
    </div>
  );
}
```

Add i18n keys to frontend/messages/en.json under settings.security.sessions:
```json
"sessions": {
  "title": "Active Sessions",
  "unknownDevice": "Unknown device",
  "currentSession": "Current",
  "lastActive": "Active {time}",
  "revokeButton": "Sign out this device",
  "revokeAllButton": "Sign out all other sessions",
  "revokeSuccess": "Session signed out",
  "revokeError": "Failed to sign out session",
  "revokeAllSuccess": "All other sessions signed out",
  "revokeAllError": "Failed to sign out sessions",
  "loadError": "Failed to load sessions",
  "onlyCurrentSession": "This is your only active session"
}
```
  </action>
  <verify>TypeScript compiles: `cd frontend && bun run build --no-lint 2>&1 | grep -E "error|Error" || echo "No errors"`</verify>
  <done>ActiveSessions component renders session list with device icons, last activity, current badge, revoke buttons, and "sign out all" button</done>
</task>

<task type="auto">
  <name>Task 3: Integrate ActiveSessions into SecuritySettings</name>
  <files>frontend/components/settings/security-settings.tsx</files>
  <action>
Update frontend/components/settings/security-settings.tsx to replace the "Coming soon" placeholder with the ActiveSessions component:

1. Add import:
```typescript
import { ActiveSessions } from "./active-sessions";
```

2. Replace the sessions section placeholder with:
```tsx
{/* Sessions Section */}
<div className="space-y-4">
  <h3 className="text-sm font-medium flex items-center gap-2">
    <Smartphone className="h-4 w-4" />
    {t("sessions.title")}
  </h3>
  <ActiveSessions />
</div>
```

The complete SecuritySettings component should now have:
1. Card header with Shield icon, title, description
2. CardContent with two sections:
   - Password section with PasswordChange component
   - Sessions section with ActiveSessions component
  </action>
  <verify>
1. TypeScript compiles: `cd frontend && bun run build --no-lint 2>&1 | grep -E "error|Error" || echo "No errors"`
2. Visual check: Navigate to Settings, verify Sessions section shows actual session data
  </verify>
  <done>SecuritySettings shows both PasswordChange and ActiveSessions components, sessions load and display correctly</done>
</task>

</tasks>

<verification>
1. Frontend builds without TypeScript errors
2. Navigate to Settings page - Security section shows session list
3. Current session has "Current" badge and no revoke button
4. Other sessions (if any) have revoke button
5. Click revoke on a session - session disappears, toast shows
6. "Sign out all other sessions" button appears when multiple sessions exist
7. After "sign out all", only current session remains
8. Session list shows device type with appropriate icon
9. Last active time is shown in relative format ("2 hours ago")
</verification>

<success_criteria>
- SEC-02 satisfied: User can view list of active sessions with device type and last activity
- SEC-03 satisfied: User can revoke individual sessions
- SEC-04 satisfied: User can logout all other sessions at once
- Current session is protected from revocation
- UI updates immediately after revocation actions
- Loading and error states handled gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/28-security-settings/28-04-SUMMARY.md`
</output>
