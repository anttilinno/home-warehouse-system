---
phase: 28-security-settings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/components/settings/password-change.tsx
  - frontend/components/settings/security-settings.tsx
  - frontend/lib/api/auth.ts
  - frontend/app/[locale]/(dashboard)/dashboard/settings/page.tsx
  - frontend/messages/en.json
autonomous: true

must_haves:
  truths:
    - "User can change their password by providing current password and new password"
    - "Current password validation happens on backend - incorrect password shows error"
    - "New password requires minimum 8 characters"
    - "Password fields clear after successful change"
  artifacts:
    - path: "frontend/components/settings/password-change.tsx"
      provides: "Password change form component"
      min_lines: 80
    - path: "frontend/components/settings/security-settings.tsx"
      provides: "Security settings card container"
      min_lines: 30
    - path: "frontend/lib/api/auth.ts"
      provides: "changePassword API function"
      exports: ["changePassword"]
  key_links:
    - from: "frontend/components/settings/password-change.tsx"
      to: "/users/me/password"
      via: "authApi.changePassword"
      pattern: "changePassword"
    - from: "frontend/app/[locale]/(dashboard)/dashboard/settings/page.tsx"
      to: "SecuritySettings"
      via: "component import"
      pattern: "SecuritySettings"
---

<objective>
Implement password change UI for the security settings section.

Purpose: Users can update their password directly from the settings page without navigating elsewhere. This addresses requirement SEC-01.

Output: Working PasswordChange component with form validation, error handling, and integration with the existing backend PATCH /users/me/password endpoint.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/28-security-settings/28-RESEARCH.md

# Existing patterns
@frontend/components/settings/account-settings.tsx
@frontend/lib/api/auth.ts
@backend/internal/domain/auth/user/handler.go (lines 391-406, 907-912 for UpdatePasswordInput)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add changePassword to auth API client</name>
  <files>frontend/lib/api/auth.ts</files>
  <action>
Add a changePassword function to the authApi object that:
- Takes currentPassword: string and newPassword: string parameters
- Calls PATCH /users/me/password with { current_password, new_password }
- Returns Promise<void> (endpoint returns 204 No Content on success)

The backend handler already exists and returns:
- 200 on success (no body)
- 400 if current password is incorrect (message: "current password is incorrect")
- 400 if new password is invalid

Follow the existing patterns in authApi for error handling.
  </action>
  <verify>TypeScript compiles without errors: `cd frontend && bun run build --no-lint 2>&1 | grep -E "error|Error" || echo "No errors"`</verify>
  <done>authApi.changePassword function exists and TypeScript types are correct</done>
</task>

<task type="auto">
  <name>Task 2: Create PasswordChange and SecuritySettings components</name>
  <files>
    frontend/components/settings/password-change.tsx
    frontend/components/settings/security-settings.tsx
    frontend/messages/en.json
  </files>
  <action>
Create PasswordChange component (frontend/components/settings/password-change.tsx):
- Use react-hook-form with zodResolver for validation
- Schema: current_password (required), new_password (min 8 chars), confirm_password (must match)
- Form fields: Current Password, New Password, Confirm New Password (all type="password")
- Submit button: "Change Password" with loading state (use Loader2 spinner)
- On success: reset form, show toast.success("Password changed successfully")
- On 400 error: show toast.error("Current password is incorrect")
- On other error: show toast.error("Failed to change password")
- Use Label/Input pattern from account-settings.tsx
- Use useTranslations("settings.security.password") for all text

Create SecuritySettings container (frontend/components/settings/security-settings.tsx):
- Card component with Shield icon in header
- Title: t("title") and description: t("description")
- CardContent with two sections:
  1. Password section with KeyRound icon, title, and PasswordChange component
  2. Sessions section with Smartphone icon, title, and placeholder "Coming soon" (will be implemented in plan 04)
- Use the pattern from AccountSettings component

Add i18n keys to frontend/messages/en.json under settings.security:
```json
"security": {
  "title": "Security",
  "description": "Manage your password and active sessions",
  "password": {
    "title": "Password",
    "currentPassword": "Current Password",
    "newPassword": "New Password",
    "confirmPassword": "Confirm New Password",
    "changeButton": "Change Password",
    "successMessage": "Password changed successfully",
    "errorIncorrect": "Current password is incorrect",
    "errorFailed": "Failed to change password",
    "validationMinLength": "Password must be at least 8 characters",
    "validationMismatch": "Passwords don't match"
  },
  "sessions": {
    "title": "Active Sessions",
    "comingSoon": "Session management coming soon"
  }
}
```

Remove the existing "comingSoon" key if it was specific to security - keep it if it's generic.
  </action>
  <verify>TypeScript compiles: `cd frontend && bun run build --no-lint 2>&1 | grep -E "error|Error" || echo "No errors"`</verify>
  <done>PasswordChange form submits to API, shows validation errors for short passwords and mismatched confirm, shows success/error toasts</done>
</task>

<task type="auto">
  <name>Task 3: Integrate SecuritySettings into settings page</name>
  <files>frontend/app/[locale]/(dashboard)/dashboard/settings/page.tsx</files>
  <action>
Update the settings page to:
1. Import SecuritySettings from "@/components/settings/security-settings"
2. Replace the placeholder Security card (lines 56-67, the one with opacity-50 and "Coming Soon") with the SecuritySettings component
3. Remove the Shield import if not used elsewhere (it's now in SecuritySettings)
4. Keep the overall grid layout (md:grid-cols-2)

The page should now show:
- Data Management card
- Notification Settings card
- Account Settings card
- Date Format Settings card
- Security Settings card (newly functional)
  </action>
  <verify>
1. `cd frontend && bun run build --no-lint 2>&1 | grep -E "error|Error" || echo "No errors"`
2. Dev server test: Start frontend, navigate to /dashboard/settings, verify Security card is no longer grayed out
  </verify>
  <done>Security Settings card renders on settings page with password change form visible and functional</done>
</task>

</tasks>

<verification>
1. Frontend builds without TypeScript errors
2. Navigate to Settings page - Security card is visible and not grayed out
3. Click in password fields - form is interactive
4. Submit empty form - validation errors appear
5. Submit with short new password - validation error for min length
6. Submit with mismatched passwords - validation error for mismatch
7. Submit with correct current password - success toast, form clears
8. Submit with incorrect current password - error toast "Current password is incorrect"
</verification>

<success_criteria>
- SEC-01 requirement satisfied: User can change password by providing current + new password
- Password change form validates input client-side (min length, match)
- Backend validates current password - error shown if incorrect
- Success/error feedback via toast notifications
- Form resets after successful password change
</success_criteria>

<output>
After completion, create `.planning/phases/28-security-settings/28-01-SUMMARY.md`
</output>
