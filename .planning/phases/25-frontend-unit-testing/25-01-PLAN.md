---
phase: 25-frontend-unit-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/hooks/__tests__/use-offline-mutation.test.ts
autonomous: true

must_haves:
  truths:
    - "useOfflineMutation queues mutation before optimistic update"
    - "useOfflineMutation writes optimistic data to IndexedDB for creates"
    - "useOfflineMutation triggers sync when online"
    - "useOfflineMutation skips sync when offline"
    - "useOfflineMutation returns idempotency key from mutate"
  artifacts:
    - path: "frontend/lib/hooks/__tests__/use-offline-mutation.test.ts"
      provides: "Comprehensive hook tests"
      min_lines: 150
  key_links:
    - from: "use-offline-mutation.test.ts"
      to: "lib/sync/mutation-queue"
      via: "vi.mock"
      pattern: "vi\\.mock.*mutation-queue"
    - from: "use-offline-mutation.test.ts"
      to: "lib/db/offline-db"
      via: "vi.mock"
      pattern: "vi\\.mock.*offline-db"
---

<objective>
Add comprehensive tests for useOfflineMutation hook covering queue, retry, conflict, and network state scenarios.

Purpose: Prevent regressions in the critical offline mutation flow (FE-01 requirement)
Output: Test file with 10+ test cases covering all hook behaviors
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25-frontend-unit-testing/25-RESEARCH.md
@frontend/lib/hooks/use-offline-mutation.ts
@frontend/lib/hooks/__tests__/use-global-search.test.ts
@frontend/lib/test-utils/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useOfflineMutation test file with mocking infrastructure</name>
  <files>frontend/lib/hooks/__tests__/use-offline-mutation.test.ts</files>
  <action>
Create comprehensive test file following the established pattern from use-global-search.test.ts.

**Mocking setup:**
- Mock `@/lib/sync/mutation-queue` (queueMutation, getMutationQueue)
- Mock `@/lib/sync/sync-manager` (syncManager singleton)
- Mock `@/lib/db/offline-db` (put function)
- Mock navigator.onLine (reset in afterEach)

**Test suites to implement:**

1. **Queue behavior tests:**
   - "queues mutation and returns idempotency key" - verify queueMutation called, tempId returned
   - "queues mutation before calling onMutate" - verify call order using invocationCallOrder
   - "passes entity, operation, payload to queueMutation" - verify correct arguments

2. **Optimistic update tests:**
   - "calls onMutate with payload, tempId, and dependsOn" - verify onMutate callback
   - "writes optimistic data to IndexedDB for creates" - verify put() called with _pending: true
   - "writes optimistic data to IndexedDB for updates" - verify put() called with entityId
   - "does not write to IndexedDB for non-create/update operations"

3. **Network state tests:**
   - "triggers sync when online" - set navigator.onLine = true, verify processQueue called
   - "does not trigger sync when offline" - set navigator.onLine = false, verify not called
   - "handles sync errors gracefully" - mock processQueue to throw, verify no crash

4. **isPending state tests:**
   - "isPending is false initially"
   - "isPending reflects transition state during onMutate"

5. **Helper function tests:**
   - "isPendingMutation returns true for objects with _pending: true"
   - "isPendingMutation returns false for objects without _pending"
   - "getPendingMutationsForEntity filters by entity type"
   - "getPendingCreates returns creates with tempId and _pending flag"
   - "getPendingUpdates returns updates with entityId and payload"

**Implementation notes:**
- Use `renderHook` from @testing-library/react
- Use `act` and `waitFor` for async operations
- Reset navigator.onLine in afterEach to avoid test pollution
- Use vi.mocked() for type-safe mock assertions
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/frontend && bun test use-offline-mutation --reporter=verbose`
All tests pass.
  </verify>
  <done>
useOfflineMutation hook has 15+ passing tests covering:
- Queue behavior (mutation queued, idempotency key returned)
- Optimistic updates (IndexedDB writes for create/update)
- Network state (sync triggered when online, skipped when offline)
- Helper functions (isPendingMutation, getPendingCreates, getPendingUpdates)
  </done>
</task>

</tasks>

<verification>
```bash
cd /home/antti/Repos/Misc/home-warehouse-system/frontend
bun test use-offline-mutation --reporter=verbose
bun test --coverage lib/hooks/use-offline-mutation
```

Expect:
- All tests pass
- Coverage for use-offline-mutation.ts increases
</verification>

<success_criteria>
- Test file exists at frontend/lib/hooks/__tests__/use-offline-mutation.test.ts
- 15+ test cases covering all documented behaviors
- All tests pass
- Tests follow established patterns from use-global-search.test.ts
</success_criteria>

<output>
After completion, create `.planning/phases/25-frontend-unit-testing/25-01-SUMMARY.md`
</output>
