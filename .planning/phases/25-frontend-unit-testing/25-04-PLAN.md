---
phase: 25-frontend-unit-testing
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/components/scanner/__tests__/barcode-scanner.test.tsx
autonomous: true

must_haves:
  truths:
    - "BarcodeScanner shows loading state during initialization"
    - "BarcodeScanner handles permission denied errors"
    - "BarcodeScanner renders scanner when initialized"
    - "BarcodeScanner shows pause overlay when paused"
    - "BarcodeScanner toggles torch when supported"
  artifacts:
    - path: "frontend/components/scanner/__tests__/barcode-scanner.test.tsx"
      provides: "BarcodeScanner component tests"
      min_lines: 120
  key_links:
    - from: "barcode-scanner.test.tsx"
      to: "next/dynamic"
      via: "vi.mock"
      pattern: "vi\\.mock.*next/dynamic"
    - from: "barcode-scanner.test.tsx"
      to: "lib/scanner"
      via: "vi.mock"
      pattern: "vi\\.mock.*lib/scanner"
---

<objective>
Add tests for BarcodeScanner component verifying camera interaction, decode callbacks, and error states.

Purpose: Prevent scanner regressions (FE-04 requirement)
Output: Test file with 10+ test cases covering scanner component behaviors
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25-frontend-unit-testing/25-RESEARCH.md
@frontend/components/scanner/barcode-scanner.tsx
@frontend/lib/hooks/__tests__/use-global-search.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BarcodeScanner test file with browser API mocks</name>
  <files>frontend/components/scanner/__tests__/barcode-scanner.test.tsx</files>
  <action>
Create test file for BarcodeScanner component. Mock dynamic imports and browser APIs.

**Mocking setup:**

1. **Mock next/dynamic:**
```typescript
vi.mock("next/dynamic", () => ({
  default: () => {
    const MockScanner = (props: {
      onScan: (r: unknown[]) => void;
      onError: (e: Error) => void;
      paused?: boolean;
    }) => (
      <div data-testid="mock-scanner" data-paused={props.paused}>
        <button onClick={() => props.onScan([{ rawValue: "TEST123" }])}>
          Simulate Scan
        </button>
        <button onClick={() => props.onError(new Error("Test error"))}>
          Simulate Error
        </button>
      </div>
    );
    MockScanner.displayName = "MockScanner";
    return MockScanner;
  },
}));
```

2. **Mock lib/scanner:**
```typescript
vi.mock("@/lib/scanner", () => ({
  initBarcodePolyfill: vi.fn().mockResolvedValue(undefined),
  SUPPORTED_FORMATS: ["qr_code", "ean_13", "ean_8"],
}));
```

3. **Mock navigator.mediaDevices:**
```typescript
const mockStream = {
  getTracks: () => [{ stop: vi.fn() }],
  getVideoTracks: () => [{
    stop: vi.fn(),
    getCapabilities: () => ({ torch: false }),
  }],
};

Object.defineProperty(navigator, "mediaDevices", {
  value: {
    getUserMedia: vi.fn().mockResolvedValue(mockStream),
  },
  writable: true,
  configurable: true,
});
```

**Test suites to implement:**

1. **Initialization tests:**
   - "shows loading state during initialization"
   - "renders scanner after successful initialization"
   - "shows error state when polyfill initialization fails"

2. **Permission tests:**
   - "handles permission denied error (NotAllowedError)"
   - "shows camera access denied message"
   - "calls onError callback on permission denied"

3. **Scanner behavior tests:**
   - "calls onScan when barcode detected"
   - "calls onError when scanner error occurs"
   - "shows pause overlay when paused prop is true"
   - "hides pause overlay when paused prop is false"

4. **Torch control tests:**
   - "shows torch button when torch is supported"
   - "hides torch button when torch is not supported"
   - "toggles torch state on button click"
   - "hides torch button when paused"

5. **Scanning indicator tests:**
   - "shows scanning indicator when not paused"
   - "hides scanning indicator when paused"

**Implementation notes:**
- Mock getUserMedia to simulate camera access
- Test both torch-supported and torch-unsupported scenarios
- Use waitFor for async initialization
- Test onScan and onError callbacks via mock scanner buttons
- The component uses `next/dynamic`, which needs special mocking
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/frontend && bun test barcode-scanner --reporter=verbose`
All tests pass.
  </verify>
  <done>
BarcodeScanner component has 10+ passing tests covering:
- Initialization states (loading, success, error)
- Permission handling (denied, error callback)
- Scanner callbacks (onScan, onError)
- Pause overlay display
- Torch controls (visibility, toggle)
  </done>
</task>

</tasks>

<verification>
```bash
cd /home/antti/Repos/Misc/home-warehouse-system/frontend
bun test barcode-scanner --reporter=verbose
```

Expect:
- All tests pass
- Scanner initialization and error states verified
</verification>

<success_criteria>
- Test file exists at frontend/components/scanner/__tests__/barcode-scanner.test.tsx
- 10+ test cases covering documented behaviors
- All tests pass
- Browser API mocking (mediaDevices) works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/25-frontend-unit-testing/25-04-SUMMARY.md`
</output>
