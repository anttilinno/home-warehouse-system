---
phase: 25-frontend-unit-testing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/sync/__tests__/sync-manager.test.ts
autonomous: true

must_haves:
  truths:
    - "SyncManager processes mutations in entity order"
    - "SyncManager handles conflict resolution correctly"
    - "SyncManager respects dependency chains (dependsOn)"
    - "SyncManager broadcasts events to listeners"
    - "SyncManager handles network errors with retry"
  artifacts:
    - path: "frontend/lib/sync/__tests__/sync-manager.test.ts"
      provides: "Comprehensive SyncManager class tests"
      min_lines: 200
  key_links:
    - from: "sync-manager.test.ts"
      to: "lib/sync/mutation-queue"
      via: "vi.mock"
      pattern: "vi\\.mock.*mutation-queue"
    - from: "sync-manager.test.ts"
      to: "lib/sync/conflict-resolver"
      via: "vi.mock"
      pattern: "vi\\.mock.*conflict-resolver"
---

<objective>
Add comprehensive tests for SyncManager class covering ordering, batching, error handling, and recovery.

Purpose: Prevent sync regressions and verify conflict handling (FE-02 requirement)
Output: Test file with 20+ test cases covering SyncManager behaviors beyond ordering
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25-frontend-unit-testing/25-RESEARCH.md
@frontend/lib/sync/sync-manager.ts
@frontend/lib/sync/__tests__/sync-manager-ordering.test.ts
@frontend/lib/test-utils/sync-mock.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive SyncManager test file</name>
  <files>frontend/lib/sync/__tests__/sync-manager.test.ts</files>
  <action>
Create comprehensive test file for SyncManager class. The existing sync-manager-ordering.test.ts covers ENTITY_SYNC_ORDER constant; this file tests the SyncManager class methods.

**Mocking setup:**
- Mock `./mutation-queue` (getPendingMutations, updateMutationStatus, removeMutation, etc.)
- Mock `./conflict-resolver` (findConflictFields, classifyConflict, resolveWithLastWriteWins, logConflict)
- Mock global.fetch for API calls
- Mock BroadcastChannel (jsdom doesn't have it)
- Mock navigator.onLine
- Mock localStorage for workspace_id

**BroadcastChannel mock pattern:**
```typescript
class MockBroadcastChannel {
  name: string;
  onmessage: ((event: MessageEvent) => void) | null = null;
  constructor(name: string) { this.name = name; }
  postMessage = vi.fn();
  close = vi.fn();
}
global.BroadcastChannel = MockBroadcastChannel as unknown as typeof BroadcastChannel;
```

**Test suites to implement:**

1. **processQueue tests:**
   - "skips processing if already processing (lock mechanism)"
   - "skips processing if offline"
   - "processes mutations in entity order"
   - "broadcasts SYNC_STARTED and SYNC_COMPLETE events"

2. **Dependency handling tests:**
   - "skips mutation if dependencies not synced"
   - "processes mutation after dependencies sync"
   - "cascades failure when parent mutation fails"
   - "broadcasts MUTATION_CASCADE_FAILED for cascade failures"

3. **Conflict handling tests:**
   - "auto-resolves non-critical conflicts with LWW"
   - "queues critical conflicts for user review"
   - "broadcasts CONFLICT_AUTO_RESOLVED for auto-resolved conflicts"
   - "broadcasts CONFLICT_NEEDS_REVIEW for critical conflicts"
   - "logs conflicts to IndexedDB"

4. **Error handling and retry tests:**
   - "retries on network error"
   - "does not retry on 4xx client errors (except 408, 429)"
   - "marks mutation as failed after max retries"
   - "broadcasts MUTATION_FAILED when max retries reached"

5. **Event subscription tests:**
   - "subscribe returns unsubscribe function"
   - "listeners receive all event types"
   - "unsubscribe removes listener"

6. **Topological sort tests:**
   - "topologicalSortCategories orders parents before children"
   - "topologicalSortLocations orders parents before children"
   - "handles single mutation without sorting"
   - "handles mutations with no parent references"

7. **Public API tests:**
   - "getPendingCount returns correct count"
   - "retryMutation resets status and processes queue"
   - "cancelMutation removes mutation from queue"
   - "destroy cleans up listeners and channels"

**Implementation notes:**
- Create manager instance in beforeEach, call destroy() in afterEach
- Reset navigator.onLine and localStorage in afterEach
- Use factories from lib/test-utils for MutationQueueEntry creation
  </action>
  <verify>
Run: `cd /home/antti/Repos/Misc/home-warehouse-system/frontend && bun test sync-manager --reporter=verbose`
All tests pass.
  </verify>
  <done>
SyncManager class has 20+ passing tests covering:
- Queue processing (locking, offline skip, entity ordering)
- Dependency handling (wait, skip, cascade)
- Conflict resolution (auto-resolve, user review, logging)
- Error handling and retry (network errors, client errors, max retries)
- Event subscription (subscribe, unsubscribe, broadcast)
- Topological sorting for hierarchical entities
  </done>
</task>

</tasks>

<verification>
```bash
cd /home/antti/Repos/Misc/home-warehouse-system/frontend
bun test sync-manager --reporter=verbose
bun test --coverage lib/sync/sync-manager
```

Expect:
- All tests pass
- Coverage for sync-manager.ts increases significantly
</verification>

<success_criteria>
- Test file exists at frontend/lib/sync/__tests__/sync-manager.test.ts
- 20+ test cases covering documented behaviors
- All tests pass
- Comprehensive coverage of SyncManager class methods
</success_criteria>

<output>
After completion, create `.planning/phases/25-frontend-unit-testing/25-02-SUMMARY.md`
</output>
