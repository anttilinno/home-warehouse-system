---
phase: 39-notification-preferences
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/db/migrations/011_notification_preferences.sql
  - backend/internal/domain/auth/user/entity.go
  - backend/internal/domain/auth/user/handler.go
  - backend/internal/domain/auth/user/service.go
  - backend/internal/infra/postgres/user_repository.go
  - backend/internal/testutil/factory/user.go
  - backend/internal/domain/auth/user/entity_test.go
autonomous: true

must_haves:
  truths:
    - "PATCH /users/me/preferences accepts notification_preferences JSONB and persists it"
    - "GET /users/me returns notification_preferences in the response"
    - "Existing user preference fields continue to work unchanged"
    - "Empty notification_preferences defaults to all-enabled behavior"
  artifacts:
    - path: "backend/db/migrations/011_notification_preferences.sql"
      provides: "JSONB column on auth.users"
      contains: "notification_preferences"
    - path: "backend/internal/domain/auth/user/entity.go"
      provides: "notificationPreferences field, getter, and update method"
      contains: "NotificationPreferences"
    - path: "backend/internal/domain/auth/user/handler.go"
      provides: "notification_preferences in request/response types"
      contains: "NotificationPreferences"
    - path: "backend/internal/infra/postgres/user_repository.go"
      provides: "notification_preferences in all queries and scan functions"
      contains: "notification_preferences"
  key_links:
    - from: "backend/internal/domain/auth/user/handler.go"
      to: "backend/internal/domain/auth/user/service.go"
      via: "UpdatePreferencesInput.NotificationPreferences"
      pattern: "NotificationPreferences"
    - from: "backend/internal/domain/auth/user/service.go"
      to: "backend/internal/domain/auth/user/entity.go"
      via: "user.UpdateNotificationPreferences()"
      pattern: "UpdateNotificationPreferences"
    - from: "backend/internal/infra/postgres/user_repository.go"
      to: "backend/internal/domain/auth/user/entity.go"
      via: "Reconstruct with notificationPreferences parameter"
      pattern: "Reconstruct.*notif"
---

<objective>
Add notification_preferences JSONB column to the backend and thread it through the entire Go user domain: entity, handler, service, and repository.

Purpose: Backend must accept, persist, and return notification preferences so the frontend can read/write them via the existing PATCH /users/me/preferences endpoint.
Output: Working backend that accepts `notification_preferences` JSON object and returns it on all user responses.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-notification-preferences/39-RESEARCH.md
@backend/internal/domain/auth/user/entity.go
@backend/internal/domain/auth/user/handler.go
@backend/internal/domain/auth/user/service.go
@backend/internal/infra/postgres/user_repository.go
@backend/internal/testutil/factory/user.go
@backend/internal/domain/auth/user/entity_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration and Go entity extension</name>
  <files>
    backend/db/migrations/011_notification_preferences.sql
    backend/internal/domain/auth/user/entity.go
  </files>
  <action>
1. Create migration `backend/db/migrations/011_notification_preferences.sql`:
   ```sql
   -- migrate:up
   ALTER TABLE auth.users
     ADD COLUMN notification_preferences JSONB NOT NULL DEFAULT '{}'::jsonb;

   COMMENT ON COLUMN auth.users.notification_preferences IS
   'User notification preferences by category. Empty object means all enabled. Keys: enabled, loans, inventory, workspace, system.';

   -- migrate:down
   ALTER TABLE auth.users
     DROP COLUMN notification_preferences;
   ```

2. Modify `backend/internal/domain/auth/user/entity.go`:
   - Add field `notificationPreferences map[string]bool` to User struct (after decimalSeparator)
   - Add getter: `func (u *User) NotificationPreferences() map[string]bool { return u.notificationPreferences }`
   - Add method `UpdateNotificationPreferences(prefs map[string]bool)` that merges provided keys into existing map (initialize map if nil), then sets updatedAt = time.Now()
   - In `NewUser()`: initialize `notificationPreferences: make(map[string]bool)` (empty map = all enabled, opt-out model)
   - In `Reconstruct()`: add `notificationPreferences map[string]bool` as parameter after `avatarPath` and before `createdAt`. Assign it in the returned struct.
   - In `UpdatePreferences()`: add `notificationPreferences map[string]bool` parameter after `decimalSeparator`. If notificationPreferences is not nil, call `u.UpdateNotificationPreferences(prefs)`. This keeps the existing UpdatePreferences as the single entry point from the service layer.

   IMPORTANT: The Reconstruct() signature change will break all call sites. That is handled in Task 2.
  </action>
  <verify>Run `mise run migrate` to apply migration. Then `cd backend && go vet ./internal/domain/auth/user/...` -- expect compile errors from Reconstruct callers (fixed in Task 2).</verify>
  <done>Migration file exists with correct up/down SQL. Entity has notificationPreferences field, getter, UpdateNotificationPreferences method, and updated Reconstruct signature.</done>
</task>

<task type="auto">
  <name>Task 2: Repository, handler, service, and all Reconstruct call sites</name>
  <files>
    backend/internal/infra/postgres/user_repository.go
    backend/internal/domain/auth/user/handler.go
    backend/internal/domain/auth/user/service.go
    backend/internal/testutil/factory/user.go
    backend/internal/domain/auth/user/entity_test.go
  </files>
  <action>
1. **user_repository.go** -- Update ALL queries and scan functions. Search for every occurrence of `decimal_separator` or `time_format` to find all locations. Specifically:
   - `Save()`: Add `notification_preferences` to INSERT column list and VALUES ($15), and to ON CONFLICT UPDATE SET. Marshal `u.NotificationPreferences()` to JSON bytes before passing as parameter.
   - `FindByID()`: Add `notification_preferences` to SELECT column list.
   - `FindByEmail()`: Add `notification_preferences` to SELECT column list.
   - `List()`: Add `notification_preferences` to SELECT column list.
   - `UpdateAvatar()`: Add `notification_preferences` to RETURNING column list.
   - `UpdateEmail()`: Add `notification_preferences` to RETURNING column list.
   - `scanUser()`: Add `var notifPrefsRaw []byte` to variable declarations. Add it to `row.Scan(...)` after `avatarPath`. After scan, unmarshal: `var notifPrefs map[string]bool; if len(notifPrefsRaw) > 0 { json.Unmarshal(notifPrefsRaw, &notifPrefs) }`. Pass `notifPrefs` to `Reconstruct()` after `avatarPath`.
   - `scanUserFromRows()`: Same changes as `scanUser()`.
   - Add `"encoding/json"` to imports.

   CRITICAL: Every SELECT that feeds into scanUser/scanUserFromRows must have notification_preferences in the column list. Every INSERT/UPDATE must include it. Missing any causes runtime scan errors.

2. **handler.go** -- Extend request/response types and handler logic:
   - Add `NotificationPreferences map[string]bool \`json:"notification_preferences"\`` to `UserResponse` struct (after Theme, before AvatarURL).
   - Add `NotificationPreferences map[string]bool \`json:"notification_preferences,omitempty"\`` to `UpdatePrefsRequestBody` struct.
   - In `getMe()`: add `NotificationPreferences: user.NotificationPreferences()` to UserResponse.
   - In `updateMe()`: add `NotificationPreferences: user.NotificationPreferences()` to UserResponse.
   - In `updatePreferences()`: add `NotificationPreferences: input.Body.NotificationPreferences` to UpdatePreferencesInput. Add `NotificationPreferences: user.NotificationPreferences()` to the returned UserResponse.
   - In `listUsers()`: add `NotificationPreferences: u.NotificationPreferences()` to UserAdminResponse. Also add field to `UserAdminResponse` struct.
   - In `getUserByID()`: add `NotificationPreferences: user.NotificationPreferences()` to UserAdminResponse.
   - In `uploadAvatar()`: the manual JSON fprintf needs `notification_preferences` added. Add it after theme: `,"notification_preferences":%s` and marshal user.NotificationPreferences() to JSON string.
   - In ALL legacy `RegisterProtectedRoutes` functions that build UserResponse: add NotificationPreferences field.

3. **service.go** -- Extend UpdatePreferencesInput and pass through:
   - Add `NotificationPreferences map[string]bool` field to `UpdatePreferencesInput`.
   - In `UpdatePreferences()`: pass `input.NotificationPreferences` as the new parameter to `user.UpdatePreferences(...)`.

4. **factory/user.go** -- Update all Reconstruct calls:
   - In `WithEmail()`: add `u.NotificationPreferences()` parameter after `u.AvatarPath()` and before `u.CreatedAt()`.
   - In `WithSuperuser()`: same change.

5. **entity_test.go** -- Update the TestUser_Reconstruct test:
   - Add `nil` (or `map[string]bool{}`) as parameter after `&avatarPath` in the Reconstruct call.
   - Optionally add assertion: `assert.NotNil(t, u.NotificationPreferences())` or check the value.
  </action>
  <verify>
Run `cd /home/antti/Repos/Misc/home-warehouse-system && mise run test-unit` to verify all tests pass. Then run `mise run lint` to check for lint errors. Then run `mise run build` to verify compilation.
  </verify>
  <done>
Backend compiles and all tests pass. PATCH /users/me/preferences accepts notification_preferences, persists it, and GET /users/me returns it. All Reconstruct call sites updated. All repository queries include notification_preferences column.
  </done>
</task>

</tasks>

<verification>
1. `mise run build` succeeds (compilation check)
2. `mise run test-unit` passes (all existing tests + updated Reconstruct test)
3. `mise run lint` clean
4. Manual curl test (requires running backend):
   - `curl -X PATCH /users/me/preferences -d '{"notification_preferences": {"enabled": true, "loans": false}}' -H "Authorization: Bearer $TOKEN"` returns 200 with notification_preferences in response
   - `curl /users/me -H "Authorization: Bearer $TOKEN"` returns notification_preferences field
</verification>

<success_criteria>
- Migration 011 exists and applies cleanly
- Go backend compiles with no errors
- All unit tests pass
- notification_preferences JSONB field is persisted and returned through the existing preferences endpoint
- Empty {} defaults treated as all-enabled (opt-out model)
</success_criteria>

<output>
After completion, create `.planning/phases/39-notification-preferences/39-01-SUMMARY.md`
</output>
