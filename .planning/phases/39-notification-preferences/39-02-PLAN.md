---
phase: 39-notification-preferences
plan: 02
type: execute
wave: 2
depends_on: ["39-01"]
files_modified:
  - frontend/components/ui/switch.tsx
  - frontend/components/settings/notification-preference-settings.tsx
  - frontend/app/[locale]/(dashboard)/dashboard/settings/notifications/page.tsx
  - frontend/lib/api/auth.ts
  - frontend/components/dashboard/notifications-dropdown.tsx
  - frontend/messages/en.json
  - frontend/messages/et.json
  - frontend/messages/ru.json
autonomous: true

must_haves:
  truths:
    - "User sees a master toggle and 4 per-category toggles on the notifications settings page"
    - "Flipping any toggle auto-saves immediately to the backend without a submit button"
    - "Master toggle off disables all category toggles visually but preserves their individual states"
    - "Notification preferences filter the NotificationsDropdown display -- disabled categories are hidden"
    - "SSE data sync continues regardless of notification preference settings"
    - "All labels are translated in en, et, and ru"
  artifacts:
    - path: "frontend/components/ui/switch.tsx"
      provides: "shadcn Switch component"
      contains: "Switch"
    - path: "frontend/components/settings/notification-preference-settings.tsx"
      provides: "NotificationPreferenceSettings component with master + 4 category toggles"
      contains: "NotificationPreferenceSettings"
      min_lines: 50
    - path: "frontend/app/[locale]/(dashboard)/dashboard/settings/notifications/page.tsx"
      provides: "Notifications settings page with both push and preference components"
      contains: "NotificationPreferenceSettings"
    - path: "frontend/lib/api/auth.ts"
      provides: "notification_preferences on User interface"
      contains: "notification_preferences"
    - path: "frontend/components/dashboard/notifications-dropdown.tsx"
      provides: "Client-side filtering of notifications by category preferences"
      contains: "notification_preferences"
  key_links:
    - from: "frontend/components/settings/notification-preference-settings.tsx"
      to: "/users/me/preferences"
      via: "fetch PATCH on toggle change"
      pattern: "users/me/preferences"
    - from: "frontend/components/settings/notification-preference-settings.tsx"
      to: "frontend/lib/contexts/auth-context.tsx"
      via: "useAuth().user.notification_preferences and refreshUser()"
      pattern: "useAuth|refreshUser"
    - from: "frontend/components/dashboard/notifications-dropdown.tsx"
      to: "frontend/lib/contexts/auth-context.tsx"
      via: "useAuth().user.notification_preferences for filtering"
      pattern: "notification_preferences"
---

<objective>
Build the frontend notification preference UI and wire it into the notifications settings page, plus add client-side notification filtering in the dropdown.

Purpose: Users can control which notification categories they see, with toggles that auto-save immediately. The dropdown filters notifications based on user preferences.
Output: Working notification preferences page with master + 4 category toggles, auto-save, and dropdown filtering.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-notification-preferences/39-RESEARCH.md
@.planning/phases/39-notification-preferences/39-01-SUMMARY.md
@frontend/components/settings/theme-settings.tsx
@frontend/components/settings/notification-settings.tsx
@frontend/components/dashboard/notifications-dropdown.tsx
@frontend/app/[locale]/(dashboard)/dashboard/settings/notifications/page.tsx
@frontend/lib/api/auth.ts
@frontend/lib/api/notifications.ts
@frontend/messages/en.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Switch component, User type, and NotificationPreferenceSettings component</name>
  <files>
    frontend/components/ui/switch.tsx
    frontend/lib/api/auth.ts
    frontend/components/settings/notification-preference-settings.tsx
  </files>
  <action>
1. **Install shadcn Switch component:**
   ```bash
   cd /home/antti/Repos/Misc/home-warehouse-system/frontend && bunx shadcn@latest add switch --yes
   ```
   This creates `frontend/components/ui/switch.tsx`.

2. **Modify `frontend/lib/api/auth.ts`:**
   - Add `NotificationPreferences` interface before the `User` interface:
     ```typescript
     export interface NotificationPreferences {
       enabled?: boolean;
       loans?: boolean;
       inventory?: boolean;
       workspace?: boolean;
       system?: boolean;
     }
     ```
   - Add `notification_preferences: NotificationPreferences;` to the `User` interface (after `theme`, before `avatar_url`).

3. **Create `frontend/components/settings/notification-preference-settings.tsx`:**
   Follow the ThemeSettings auto-save pattern exactly. Key implementation details:

   - Import: useState from react, useTranslations from next-intl, Bell/BellOff/Package/Users/Shield/Megaphone from lucide-react, Switch from @/components/ui/switch, Label from @/components/ui/label, Card/CardContent/CardDescription/CardHeader/CardTitle from @/components/ui/card, useAuth from @/lib/contexts/auth-context, toast from sonner.

   - Define categories array with icon mapping:
     ```typescript
     const CATEGORIES = [
       { key: "loans", icon: Megaphone },
       { key: "inventory", icon: Package },
       { key: "workspace", icon: Users },
       { key: "system", icon: Shield },
     ] as const;
     ```
     (Choose appropriate icons -- Megaphone for loans/reminders, Package for inventory, Users for workspace, Shield for system. Adjust if better icons exist in lucide.)

   - Component `NotificationPreferenceSettings`:
     - Get `user` and `refreshUser` from `useAuth()`
     - State: `isUpdating` as `string | null` (tracks which toggle is saving)
     - Read current prefs: `const prefs = user?.notification_preferences ?? {};`
     - Master enabled: `const isEnabled = prefs.enabled !== false;` (default true when key missing)
     - Category enabled check: `prefs[cat] !== false` (default true when key missing)

   - `handleToggle(key: string, checked: boolean)` function:
     - Set `isUpdating(key)` for loading state
     - Build new prefs: `{ ...prefs, [key]: checked }`
     - PATCH to `/users/me/preferences` with body `{ notification_preferences: newPrefs }`
     - Use same fetch pattern as ThemeSettings: Authorization header from `localStorage.getItem("auth_token")`, credentials: "include"
     - On success: `await refreshUser()`, `toast.success(t("saved"))`
     - On error: `toast.error(t("saveError"))`
     - Finally: `setIsUpdating(null)`

   - Render structure:
     - Card with CardHeader (title with Bell icon, description)
     - CardContent with space-y-6
     - Master toggle section: div with flex items-center justify-between, Label for master, Switch checked={isEnabled} disabled={isUpdating !== null}
     - Separator (simple border-t div or Separator component)
     - Category toggles section: map over CATEGORIES, each with flex items-center justify-between, icon + label on left, Switch on right
     - Each category Switch: checked={prefs[cat.key] !== false}, disabled={!isEnabled || isUpdating !== null}
     - When master is off, category section should have reduced opacity: `className={cn("space-y-4", !isEnabled && "opacity-50")}`

   - Do NOT use react-hook-form. Do NOT wrap in extra Card components beyond the one in this component.
  </action>
  <verify>
Run `cd /home/antti/Repos/Misc/home-warehouse-system/frontend && bun run build` to verify compilation. Check that switch.tsx exists. Check that the component file has no TypeScript errors.
  </verify>
  <done>Switch component installed. User interface has notification_preferences field. NotificationPreferenceSettings component exists with master toggle + 4 category toggles following the auto-save pattern.</done>
</task>

<task type="auto">
  <name>Task 2: Wire notifications page, add i18n, and filter dropdown</name>
  <files>
    frontend/app/[locale]/(dashboard)/dashboard/settings/notifications/page.tsx
    frontend/components/dashboard/notifications-dropdown.tsx
    frontend/messages/en.json
    frontend/messages/et.json
    frontend/messages/ru.json
  </files>
  <action>
1. **Modify notifications page** (`frontend/app/[locale]/(dashboard)/dashboard/settings/notifications/page.tsx`):
   - Replace the "Coming soon" placeholder with the new components.
   - Import `NotificationPreferenceSettings` from `@/components/settings/notification-preference-settings`.
   - Import `NotificationSettings` from `@/components/settings/notification-settings` (existing push subscription component).
   - Keep the existing mobile back link and page title/description.
   - Render `<NotificationPreferenceSettings />` first, then `<NotificationSettings />` below it.
   - Remove the `comingSoon` text reference. The description should come from `t("notifications.description")` (already exists in i18n: "Configure notification preferences").
   - Per established decision: page.tsx imports components directly, no extra Card wrappers.

2. **Add i18n keys to `frontend/messages/en.json`:**
   Add under `settings.notificationPreferences` (new key, sibling to existing `settings.notifications`):
   ```json
   "notificationPreferences": {
     "title": "Notification Categories",
     "description": "Choose which types of notifications you want to receive",
     "masterToggle": "Enable notifications",
     "masterDescription": "Receive in-app notifications",
     "categories": {
       "loans": "Loans",
       "loansDescription": "Loan reminders, overdue notices, and returns",
       "inventory": "Inventory",
       "inventoryDescription": "Low stock alerts and repair reminders",
       "workspace": "Workspace",
       "workspaceDescription": "Invitations and member activity",
       "system": "System",
       "systemDescription": "System announcements and updates"
     },
     "saved": "Notification preferences saved",
     "saveError": "Failed to save notification preferences"
   }
   ```

3. **Add i18n keys to `frontend/messages/et.json`:**
   Same structure with Estonian translations:
   ```json
   "notificationPreferences": {
     "title": "Teavituste kategooriad",
     "description": "Vali, milliseid teavitusi soovid saada",
     "masterToggle": "Luba teavitused",
     "masterDescription": "Saa rakendusesiseseid teavitusi",
     "categories": {
       "loans": "Laenutused",
       "loansDescription": "Laenutuse meeldetuletused, hilinenud teated ja tagastused",
       "inventory": "Inventar",
       "inventoryDescription": "Madala laoseisu hoiatused ja remondi meeldetuletused",
       "workspace": "Tooruum",
       "workspaceDescription": "Kutsed ja liikmete tegevus",
       "system": "Susteem",
       "systemDescription": "Susteemiteated ja uuendused"
     },
     "saved": "Teavituste eelistused salvestatud",
     "saveError": "Teavituste eelistuste salvestamine ebaonnestus"
   }
   ```

4. **Add i18n keys to `frontend/messages/ru.json`:**
   Same structure with Russian translations:
   ```json
   "notificationPreferences": {
     "title": "Kategorii uwiedomlenij",
     "description": "Wyberite, kakie uwiedomlenija wy hotite poluchat'",
     "masterToggle": "Wkljuchit' uwiedomlenija",
     "masterDescription": "Poluchat' uwiedomlenija w prilozhenii",
     "categories": {
       "loans": "Zajmy",
       "loansDescription": "Napominanija o zajmah, prosrochkah i wozwratah",
       "inventory": "Inwentar'",
       "inventoryDescription": "Preduprezhdeniia o nizkom zapase i napominanija o remonte",
       "workspace": "Rabochee prostranstwo",
       "workspaceDescription": "Priglashenija i aktiwnost' uchastnikow",
       "system": "Sistema",
       "systemDescription": "Sistemnye ob''jawlenija i obnovlenija"
     },
     "saved": "Nastrojki uwiedomlenij sohraneny",
     "saveError": "Ne udalos' sohranit' nastrojki uwiedomlenij"
   }
   ```

   IMPORTANT for Russian: Use proper Cyrillic characters (not transliteration). The above are placeholders showing structure -- use actual Cyrillic:
   - title: "Категории уведомлений"
   - description: "Выберите, какие уведомления вы хотите получать"
   - masterToggle: "Включить уведомления"
   - masterDescription: "Получать уведомления в приложении"
   - categories.loans: "Займы"
   - categories.loansDescription: "Напоминания о займах, просрочках и возвратах"
   - categories.inventory: "Инвентарь"
   - categories.inventoryDescription: "Предупреждения о низком запасе и напоминания о ремонте"
   - categories.workspace: "Рабочее пространство"
   - categories.workspaceDescription: "Приглашения и активность участников"
   - categories.system: "Система"
   - categories.systemDescription: "Системные объявления и обновления"
   - saved: "Настройки уведомлений сохранены"
   - saveError: "Не удалось сохранить настройки уведомлений"

   For Estonian, use proper characters:
   - title: "Teavituste kategooriad"
   - description: "Vali, milliseid teavitusi soovid saada"
   - masterToggle: "Luba teavitused"
   - masterDescription: "Saa rakendusesiseseid teavitusi"
   - categories.loans: "Laenutused"
   - categories.loansDescription: "Laenutuse meeldetuletused, hilinenud teated ja tagastused"
   - categories.inventory: "Inventar"
   - categories.inventoryDescription: "Madala laoseisu hoiatused ja remondi meeldetuletused"
   - categories.workspace: "Tooruum"  (NOTE: verify -- "Tooruum" means workroom. "Workspace" might be better as "Tooruum" or keep as loanword)
   - categories.workspaceDescription: "Kutsed ja liikmete tegevus"
   - categories.system: "Susteem" (NOTE: use "Susteem" or "System" -- Estonian often uses "Susteem")
   - categories.systemDescription: "Susteemiteated ja uuendused"
   - saved: "Teavituste eelistused salvestatud"
   - saveError: "Teavituste eelistuste salvestamine ebaonnestus"

   (NOTE: Check existing Estonian translations in messages/et.json for style consistency -- use the same tone and terminology patterns already established.)

5. **Modify NotificationsDropdown** (`frontend/components/dashboard/notifications-dropdown.tsx`):
   - Import `useAuth` from `@/lib/contexts/auth-context`.
   - Import `NotificationType` from `@/lib/api/notifications`.
   - Add a category mapping constant at the top of the file (or inside the component):
     ```typescript
     const NOTIFICATION_CATEGORY_MAP: Record<string, string> = {
       LOAN_DUE_SOON: "loans",
       LOAN_OVERDUE: "loans",
       LOAN_RETURNED: "loans",
       LOW_STOCK: "inventory",
       WORKSPACE_INVITE: "workspace",
       MEMBER_JOINED: "workspace",
       SYSTEM: "system",
     };
     ```
   - Inside the `NotificationsDropdown` component: get `user` from `useAuth()`.
   - Create a filter function:
     ```typescript
     const prefs = user?.notification_preferences ?? {};
     const isNotifEnabled = prefs.enabled !== false; // master toggle

     const filteredNotifications = isNotifEnabled
       ? notifications.filter((n) => {
           const category = NOTIFICATION_CATEGORY_MAP[n.notification_type];
           return category ? prefs[category] !== false : true;
         })
       : []; // master off = show nothing
     ```
   - Replace `notifications` with `filteredNotifications` in the render section (the `.map()` and `.length` checks).
   - Also update the unread count display to reflect filtered count. Adjust `unreadCount` display:
     The server-side count doesn't know about preferences. For visual consistency, show filtered count: `const displayCount = isNotifEnabled ? unreadCount : 0;` -- or more precisely, rely on the filtered notifications length when popover is open.
     Simplest approach: Keep the server unread count for the badge (it's a count of actual unread, preferences are a display filter). When the popover opens, the user sees only filtered notifications. This is acceptable since the badge motivates opening the dropdown where filtering applies.
     ALTERNATIVE (better UX): Filter the badge count too. Since we don't know the type breakdown of unread without fetching, the simplest is: if `!isNotifEnabled`, show 0 badge. Otherwise show server count. This isn't perfect but handles the master toggle case. This is a reasonable tradeoff for this phase.

   - CRITICAL: Do NOT touch the SSE event handlers. The `useSSE` callback must continue to process ALL events regardless of notification preferences. Only the DISPLAY is filtered (the rendered notification list and badge).
  </action>
  <verify>
Run `cd /home/antti/Repos/Misc/home-warehouse-system/frontend && bun run build` to verify no TypeScript/build errors. Verify i18n keys exist in all three language files.
  </verify>
  <done>
Notifications page shows NotificationPreferenceSettings + NotificationSettings components. All i18n keys present in en/et/ru. NotificationsDropdown filters displayed notifications based on user preferences. SSE data sync is untouched.
  </done>
</task>

</tasks>

<verification>
1. `bun run build` succeeds in frontend directory
2. Notifications settings page renders both the preference toggles and the push notification component
3. Toggle changes trigger PATCH to /users/me/preferences with notification_preferences payload
4. Master toggle off visually disables category toggles and filters dropdown to show no notifications
5. Individual category toggle off hides that category's notifications from dropdown
6. SSE event handlers in notifications-dropdown.tsx remain unchanged
7. All labels visible in English, Estonian, and Russian
</verification>

<success_criteria>
- Master toggle + 4 category toggles visible on /dashboard/settings/notifications
- Toggles auto-save via PATCH /users/me/preferences (no submit button)
- Master off = categories dimmed + dropdown shows no notifications
- Category off = that category hidden from dropdown
- SSE data sync continues regardless of preference settings
- Push notification settings (existing component) still visible below
- All text translated in en, et, ru
</success_criteria>

<output>
After completion, create `.planning/phases/39-notification-preferences/39-02-SUMMARY.md`
</output>
