---
phase: 40-compose-profiles-and-environment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.yml
autonomous: true

must_haves:
  truths:
    - "`docker compose up` starts only postgres and redis with ports exposed to host"
    - "`docker compose --profile prod up` starts the full stack including postgres-prod, backend, worker, scheduler, frontend, angie, and docspell"
    - "Prod postgres is a separate container with separate volume and no exposed ports"
    - "Docspell services only start under the prod profile"
    - "Migration targets postgres-prod in prod profile"
  artifacts:
    - path: "docker-compose.yml"
      provides: "Dev/prod profile separation with isolated databases"
      contains: "postgres-prod"
  key_links:
    - from: "migrate service"
      to: "postgres-prod"
      via: "DATABASE_URL connection string"
      pattern: "postgres-prod:5432"
    - from: "backend/worker/scheduler"
      to: "postgres-prod"
      via: "environment variables"
      pattern: "postgres-prod:5432"
---

<objective>
Add prod-only Postgres container and move Docspell services to prod profile, establishing clean dev/prod separation in docker-compose.yml.

Purpose: COMP-01 through COMP-05 â€” dev profile runs only infra, prod profile runs the full stack with database isolation.
Output: Updated docker-compose.yml with prod Postgres, profiled Docspell, and corrected service dependencies.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add prod Postgres and profile Docspell services</name>
  <files>docker-compose.yml</files>
  <action>
Edit docker-compose.yml to add a separate production Postgres container and move Docspell to prod profile:

1. **Add `postgres-prod` service** (after redis, before docspell):
   - `profiles: ["prod"]`
   - `image: postgres:18`
   - `container_name: warehouse-postgres-prod`
   - Environment: `POSTGRES_USER: wh`, `POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-wh}`, `POSTGRES_DB: warehouse_prod`, `PGDATA: /var/lib/postgresql/data`
   - NO ports exposed (internal only)
   - Volume: `postgres-prod-data:/var/lib/postgresql/data` (named volume, not bind mount)
   - Same init script: `./docker/postgres:/docker-entrypoint-initdb.d`
   - Same healthcheck as dev postgres but checking `warehouse_prod`: `pg_isready -U wh -d warehouse_prod`
   - Network: `warehouse`

2. **Add `profiles: ["prod"]` to all three Docspell services:**
   - `docspell-postgres`
   - `docspell-restserver`
   - `docspell-joex`

3. **Update migrate service** to depend on `postgres-prod` instead of `postgres`:
   - `depends_on: postgres-prod: condition: service_healthy`
   - `DATABASE_URL: "postgresql://wh:${POSTGRES_PASSWORD:-wh}@postgres-prod:5432/warehouse_prod?sslmode=disable"`

4. **Update backend, worker, scheduler** dependencies and database URLs:
   - All three: change `depends_on` from `migrate` (completed) to also use `postgres-prod` path
   - backend environment: `DATABASE_URL: "postgresql://wh:${POSTGRES_PASSWORD:-wh}@postgres-prod:5432/warehouse_prod?sslmode=disable"`
   - worker environment: `GO_DATABASE_URL: "postgresql://wh:${POSTGRES_PASSWORD:-wh}@postgres-prod:5432/warehouse_prod?sslmode=disable"` (keep GO_DATABASE_URL -- worker requires it)
   - scheduler environment: `GO_DATABASE_URL: "postgresql://wh:${POSTGRES_PASSWORD:-wh}@postgres-prod:5432/warehouse_prod?sslmode=disable"` (scheduler checks GO_DATABASE_URL first, falls back to config)

5. **Add `postgres-prod-data` to the volumes section** at the bottom of the file.

Do NOT change the dev postgres or redis services -- they stay as-is with no profile (always start).
  </action>
  <verify>
Run `grep -c "profiles:" docker-compose.yml` -- should show profiles on postgres-prod, docspell-postgres, docspell-restserver, docspell-joex, migrate, backend, worker, scheduler, frontend, angie (10 services with profiles).
Run `grep "postgres-prod" docker-compose.yml` -- should show the new service and references from migrate/backend/worker/scheduler.
Run `docker compose config --services` -- should show only `postgres` and `redis` (no profile = dev only).
Run `docker compose --profile prod config --services` -- should show all services.
  </verify>
  <done>Dev compose starts only postgres + redis. Prod compose includes postgres-prod (no exposed ports, named volume), all app services target postgres-prod, and Docspell services are profiled.</done>
</task>

<task type="auto">
  <name>Task 2: Fix prod environment variables for production readiness</name>
  <files>docker-compose.yml</files>
  <action>
Fix all environment variable issues in the prod services within docker-compose.yml:

1. **backend service:**
   - Remove `DEBUG: "true"` entirely (config.go defaults to false when unset)
   - Change `JWT_SECRET` from hardcoded to variable substitution: `JWT_SECRET: "${JWT_SECRET:?JWT_SECRET must be set}"`
   - Keep `PHOTO_STORAGE_DIR: "/data/photos"` (correct)
   - Keep `APP_URL` and `BACKEND_URL` as-is (will be configurable in Phase 42)
   - Add `APP_ENV: "production"` for clarity

2. **worker service:**
   - Keep `GO_DATABASE_URL` (already correct -- worker requires this env var name per worker/main.go line 31)
   - `REDIS_URL` is already `"redis://redis:6379"` (correct with prefix)
   - Keep `PHOTO_STORAGE_DIR: "/data/photos"` (correct)

3. **scheduler service:**
   - Change env var from `DATABASE_URL` to `GO_DATABASE_URL` for consistency (scheduler checks GO_DATABASE_URL first per scheduler/main.go line 32)
   - Fix `REDIS_URL` from `"redis:6379"` to `"redis://redis:6379"` (add redis:// prefix -- scheduler falls back to `localhost:6379` if empty, but the redis:// prefix is needed for proper URL parsing)
   - Keep `PHOTO_STORAGE_DIR: "/data/photos"` (correct)

4. **frontend service:**
   - Add `environment:` section with `NODE_ENV: "production"` and `NEXT_PUBLIC_API_URL: ""` (empty -- frontend routes through Angie proxy via relative /api paths)

Note: The password substitution `${POSTGRES_PASSWORD:-wh}` provides a default for local testing but allows override via `.env` file or environment for real production deployment.
  </action>
  <verify>
Run these checks:
- `grep -c "DEBUG" docker-compose.yml` -- should be 0 (removed)
- `grep "JWT_SECRET" docker-compose.yml` -- should show variable substitution, not hardcoded value
- `grep "REDIS_URL" docker-compose.yml` -- all occurrences should have `redis://` prefix
- `grep "GO_DATABASE_URL" docker-compose.yml` -- should appear in worker AND scheduler
- `grep "NODE_ENV" docker-compose.yml` -- should show `production` in frontend
- `docker compose --profile prod config 2>&1` -- should parse without errors (validates YAML syntax and variable substitution)
  </verify>
  <done>All prod services use production-appropriate environment variables: no debug flags, JWT_SECRET requires explicit setting, consistent database URL env vars, correct Redis URL format, frontend has NODE_ENV=production.</done>
</task>

</tasks>

<verification>
1. `docker compose config --services` outputs exactly: `postgres`, `redis` (dev only)
2. `docker compose --profile prod config --services` outputs all services including `postgres-prod`
3. `docker compose --profile prod config` parses without errors
4. No `DEBUG` env var in any prod service
5. `postgres-prod` has no `ports:` section (internal only)
6. Migration service depends on `postgres-prod` (not `postgres`)
7. All three Docspell services have `profiles: ["prod"]`
</verification>

<success_criteria>
- `docker compose up` starts only Postgres (dev) and Redis
- `docker compose --profile prod up` starts the full stack with prod Postgres isolated from dev
- Docspell only starts under prod profile
- Migration targets postgres-prod before app services start
- No debug flags, dev credentials properly parameterized, photo storage uses named volume
</success_criteria>

<output>
After completion, create `.planning/phases/40-compose-profiles-and-environment/40-01-SUMMARY.md`
</output>
