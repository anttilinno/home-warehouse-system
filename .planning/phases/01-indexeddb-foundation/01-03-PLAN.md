---
phase: 01-indexeddb-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - frontend/components/sync-status-indicator.tsx
  - frontend/components/pwa-install-prompt.tsx
  - frontend/app/(dashboard)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "User sees 'Last synced: X ago' timestamp in the UI"
    - "Sync indicator shows syncing state when data is being fetched"
    - "PWA install prompt appears for eligible users (not already installed)"
    - "Freshness indicator uses relative time (e.g., '2 hours ago', 'just now')"
  artifacts:
    - path: "frontend/components/sync-status-indicator.tsx"
      provides: "Unified sync status component showing last sync time and syncing state"
      exports: ["SyncStatusIndicator"]
      min_lines: 40
    - path: "frontend/components/pwa-install-prompt.tsx"
      provides: "PWA install prompt banner for home screen installation"
      exports: ["PwaInstallPrompt"]
      min_lines: 30
  key_links:
    - from: "frontend/components/sync-status-indicator.tsx"
      to: "frontend/lib/contexts/offline-context.tsx"
      via: "useOffline hook for sync state"
      pattern: "useOffline.*lastSyncTimestamp|isSyncing"
    - from: "frontend/components/pwa-install-prompt.tsx"
      to: "frontend/lib/hooks/use-pwa-install.ts"
      via: "usePwaInstall hook for install state"
      pattern: "usePwaInstall"
    - from: "frontend/app/(dashboard)/layout.tsx"
      to: "frontend/components/sync-status-indicator.tsx"
      via: "component import and usage"
      pattern: "SyncStatusIndicator"
---

<objective>
Create UI components for offline data freshness and PWA installation. This completes Phase 1 by making the sync state visible to users.

Purpose: ODA-3 requires freshness indicator, ODA-5 requires PWA install prompt. Users need to know when data was last synced and be prompted to install for better offline experience.

Output:
- `frontend/components/sync-status-indicator.tsx` - Shows last sync time and syncing state
- `frontend/components/pwa-install-prompt.tsx` - Prompts PWA installation
- Updated dashboard layout with these components
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

@frontend/lib/contexts/offline-context.tsx
@frontend/lib/hooks/use-pwa-install.ts
@frontend/app/(dashboard)/layout.tsx
@frontend/components/ui/badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SyncStatusIndicator component</name>
  <files>
    frontend/components/sync-status-indicator.tsx
  </files>
  <action>
Create `frontend/components/sync-status-indicator.tsx` - a component that displays sync status in the UI.

**Requirements:**
1. Show "Last synced: X ago" with relative time formatting
2. Show loading/syncing state when sync is in progress
3. Show offline indicator when not connected
4. Compact design suitable for header/sidebar placement
5. Use existing shadcn/ui components (Badge, etc.)

**Implementation:**

```typescript
"use client";

import { useOffline } from "@/lib/contexts/offline-context";
import { Badge } from "@/components/ui/badge";
import { Cloud, CloudOff, RefreshCw, Check } from "lucide-react";

function formatRelativeTime(timestamp: number): string {
  const now = Date.now();
  const diff = now - timestamp;

  const seconds = Math.floor(diff / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);
  const days = Math.floor(hours / 24);

  if (seconds < 60) return "just now";
  if (minutes < 60) return `${minutes}m ago`;
  if (hours < 24) return `${hours}h ago`;
  return `${days}d ago`;
}

export function SyncStatusIndicator() {
  const { isOnline, isSyncing, lastSyncTimestamp, triggerSync } = useOffline();

  // Offline state
  if (!isOnline) {
    return (
      <Badge variant="secondary" className="gap-1.5 text-xs">
        <CloudOff className="h-3 w-3" />
        Offline
      </Badge>
    );
  }

  // Syncing state
  if (isSyncing) {
    return (
      <Badge variant="secondary" className="gap-1.5 text-xs">
        <RefreshCw className="h-3 w-3 animate-spin" />
        Syncing...
      </Badge>
    );
  }

  // Synced state with timestamp
  if (lastSyncTimestamp) {
    return (
      <Badge
        variant="outline"
        className="gap-1.5 text-xs cursor-pointer hover:bg-accent"
        onClick={triggerSync}
        title="Click to sync now"
      >
        <Check className="h-3 w-3 text-green-500" />
        {formatRelativeTime(lastSyncTimestamp)}
      </Badge>
    );
  }

  // Never synced (or loading)
  return (
    <Badge variant="outline" className="gap-1.5 text-xs">
      <Cloud className="h-3 w-3" />
      Not synced
    </Badge>
  );
}
```

**Design notes:**
- Use Badge component from shadcn/ui for consistent styling
- Icons from lucide-react (already in project)
- Clickable when synced to trigger manual sync
- Color-coded: green check for synced, spinning for syncing, gray for offline
- Compact size (text-xs) for header placement
  </action>
  <verify>
Run `cd frontend && bun run build` to verify TypeScript compilation.
Import the component in a test page and verify it renders.
  </verify>
  <done>
SyncStatusIndicator component exports and shows relative time, syncing state, and offline indicator.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PwaInstallPrompt component</name>
  <files>
    frontend/components/pwa-install-prompt.tsx
  </files>
  <action>
Create `frontend/components/pwa-install-prompt.tsx` - a dismissible banner prompting PWA installation.

**Requirements:**
1. Only show when app is installable (not already installed)
2. Show iOS-specific instructions for Safari users
3. Dismissible with "Don't show again" option (stored in localStorage)
4. Use existing usePwaInstall hook
5. Visually distinct but not intrusive

**Implementation:**

```typescript
"use client";

import { useState, useEffect } from "react";
import { usePwaInstall } from "@/lib/hooks/use-pwa-install";
import { Button } from "@/components/ui/button";
import { X, Download, Share } from "lucide-react";

const DISMISS_KEY = "pwa-install-dismissed";

export function PwaInstallPrompt() {
  const { isInstallable, isInstalled, isIOS, promptInstall } = usePwaInstall();
  const [isDismissed, setIsDismissed] = useState(true); // Start true to prevent flash

  useEffect(() => {
    // Check localStorage on mount
    const dismissed = localStorage.getItem(DISMISS_KEY);
    setIsDismissed(dismissed === "true");
  }, []);

  const handleDismiss = () => {
    localStorage.setItem(DISMISS_KEY, "true");
    setIsDismissed(true);
  };

  const handleInstall = async () => {
    const accepted = await promptInstall();
    if (accepted) {
      setIsDismissed(true);
    }
  };

  // Don't show if: already installed, not installable, or dismissed
  if (isInstalled || !isInstallable || isDismissed) {
    return null;
  }

  // iOS Safari - show manual instructions
  if (isIOS) {
    return (
      <div className="fixed bottom-0 left-0 right-0 z-50 border-t bg-background p-4 shadow-lg sm:bottom-4 sm:left-4 sm:right-auto sm:max-w-sm sm:rounded-lg sm:border">
        <button
          onClick={handleDismiss}
          className="absolute right-2 top-2 text-muted-foreground hover:text-foreground"
          aria-label="Dismiss"
        >
          <X className="h-4 w-4" />
        </button>
        <div className="flex items-start gap-3 pr-6">
          <div className="rounded-full bg-primary/10 p-2">
            <Share className="h-5 w-5 text-primary" />
          </div>
          <div>
            <p className="font-medium">Install Home Warehouse</p>
            <p className="mt-1 text-sm text-muted-foreground">
              Tap <Share className="inline h-4 w-4" /> then &quot;Add to Home Screen&quot; for the best offline experience.
            </p>
          </div>
        </div>
      </div>
    );
  }

  // Chrome/Edge - show install button
  return (
    <div className="fixed bottom-0 left-0 right-0 z-50 border-t bg-background p-4 shadow-lg sm:bottom-4 sm:left-4 sm:right-auto sm:max-w-sm sm:rounded-lg sm:border">
      <button
        onClick={handleDismiss}
        className="absolute right-2 top-2 text-muted-foreground hover:text-foreground"
        aria-label="Dismiss"
      >
        <X className="h-4 w-4" />
      </button>
      <div className="flex items-center gap-3 pr-6">
        <div className="rounded-full bg-primary/10 p-2">
          <Download className="h-5 w-5 text-primary" />
        </div>
        <div className="flex-1">
          <p className="font-medium">Install Home Warehouse</p>
          <p className="text-sm text-muted-foreground">
            Get offline access and faster loading.
          </p>
        </div>
        <Button size="sm" onClick={handleInstall}>
          Install
        </Button>
      </div>
    </div>
  );
}
```

**Design notes:**
- Fixed position at bottom on mobile, floating card on desktop
- Dismissible with X button (persists to localStorage)
- iOS gets different UI with Share icon and manual instructions
- Chrome/Edge get Install button that triggers native prompt
- Subtle background to not obstruct content
  </action>
  <verify>
Run `cd frontend && bun run build` to verify TypeScript compilation.
Test on Chrome desktop: should see install prompt if not already installed as PWA.
  </verify>
  <done>
PwaInstallPrompt component exports and shows platform-appropriate install prompt, dismissible and respects localStorage.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate components into dashboard layout</name>
  <files>
    frontend/app/(dashboard)/layout.tsx
  </files>
  <action>
Update `frontend/app/(dashboard)/layout.tsx` to include the new components.

**Add SyncStatusIndicator:**
1. Find the header/topbar area of the layout
2. Add SyncStatusIndicator near the user menu or in a visible location
3. Position it where it's visible but not intrusive

**Add PwaInstallPrompt:**
1. Add PwaInstallPrompt at the root of the layout (it's self-positioning)
2. It will only render when conditions are met

**Implementation approach:**

Read the current layout file structure first, then:

1. Import the components:
```typescript
import { SyncStatusIndicator } from "@/components/sync-status-indicator";
import { PwaInstallPrompt } from "@/components/pwa-install-prompt";
```

2. Add SyncStatusIndicator in the header section (find the topbar/header). Look for user avatar, notifications, or similar elements. Place SyncStatusIndicator nearby:
```tsx
{/* In header area, near other status indicators */}
<SyncStatusIndicator />
```

3. Add PwaInstallPrompt at the end of the layout (before closing tags):
```tsx
{children}
<PwaInstallPrompt />
```

**Important:** Preserve all existing layout functionality. This is additive only.
  </action>
  <verify>
1. Start dev server: `cd frontend && bun run dev`
2. Navigate to dashboard
3. Verify SyncStatusIndicator appears in header showing sync state
4. Verify clicking the indicator triggers a sync
5. Clear localStorage and verify PwaInstallPrompt appears (if not installed as PWA)
6. Verify dismissing the prompt persists across page reload
  </verify>
  <done>
Dashboard layout includes SyncStatusIndicator in header and PwaInstallPrompt. Users see sync status and install prompt.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **TypeScript compilation**: `cd frontend && bun run build` succeeds without errors
2. **Sync status visible**: Header shows "Last synced: X ago" with relative time
3. **Syncing feedback**: Status changes to "Syncing..." during data fetch
4. **Offline indicator**: Status shows "Offline" when disconnected
5. **Manual sync**: Clicking the indicator triggers sync
6. **Install prompt**: Non-PWA users see install prompt on Chrome/Edge
7. **iOS instructions**: iOS Safari users see Share instructions
8. **Dismissible**: Prompt can be dismissed, respects localStorage
9. **No regressions**: Existing dashboard functionality unchanged
</verification>

<success_criteria>
- frontend/components/sync-status-indicator.tsx exports SyncStatusIndicator
- frontend/components/pwa-install-prompt.tsx exports PwaInstallPrompt
- SyncStatusIndicator shows relative time (just now, 5m ago, 2h ago, etc.)
- SyncStatusIndicator shows syncing/offline/synced states
- PwaInstallPrompt shows for eligible users, dismissible
- Both components integrated into dashboard layout
- TypeScript builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-indexeddb-foundation/01-03-SUMMARY.md`
</output>
