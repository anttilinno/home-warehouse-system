---
phase: 32-date-format-rollout
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/hooks/use-date-format.ts
  - frontend/app/[locale]/(dashboard)/dashboard/page.tsx
  - frontend/components/dashboard/notifications-dropdown.tsx
  - frontend/lib/hooks/use-filters.ts
  - frontend/lib/scanner/scan-history.ts
  - frontend/app/[locale]/(dashboard)/dashboard/items/page.tsx
  - frontend/app/[locale]/(dashboard)/dashboard/inventory/page.tsx
  - frontend/app/[locale]/(dashboard)/dashboard/containers/page.tsx
  - frontend/app/[locale]/(dashboard)/dashboard/borrowers/page.tsx
  - frontend/app/[locale]/(dashboard)/dashboard/loans/page.tsx
  - frontend/app/[locale]/(dashboard)/dashboard/declutter/page.tsx
  - frontend/components/inventory/repair-history.tsx
  - frontend/app/[locale]/(dashboard)/dashboard/imports/[jobId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "All table date columns display in user's chosen format (DD/MM/YYYY, MM/DD/YY, or YYYY-MM-DD)"
    - "All detail page date displays use user's chosen format"
    - "CSV exports format date columns per user's preference"
    - "DateTime displays (started_at, completed_at) format the date portion per user's preference"
    - "Relative time displays (formatDistanceToNow, 'X ago') remain unchanged"
    - "useDateFormat hook exposes parseDate and placeholder for downstream use"
  artifacts:
    - path: "frontend/lib/hooks/use-date-format.ts"
      provides: "Extended hook with parseDate and placeholder"
      contains: "parseDate"
    - path: "frontend/app/[locale]/(dashboard)/dashboard/items/page.tsx"
      provides: "Items page with format-aware export columns"
      contains: "useDateFormat"
    - path: "frontend/app/[locale]/(dashboard)/dashboard/inventory/page.tsx"
      provides: "Inventory page with format-aware export columns"
      contains: "useDateFormat"
    - path: "frontend/app/[locale]/(dashboard)/dashboard/loans/page.tsx"
      provides: "Loans page with format-aware export columns"
      contains: "formatDate"
    - path: "frontend/components/inventory/repair-history.tsx"
      provides: "Repair history with format-aware date display"
      contains: "useDateFormat"
  key_links:
    - from: "frontend/app/[locale]/(dashboard)/dashboard/items/page.tsx"
      to: "frontend/lib/hooks/use-date-format.ts"
      via: "useDateFormat hook import"
      pattern: "import.*useDateFormat.*use-date-format"
    - from: "frontend/components/inventory/repair-history.tsx"
      to: "frontend/lib/hooks/use-date-format.ts"
      via: "formatDate replacing format(parseISO(...), 'PP')"
      pattern: "formatDate\\(repair\\."
---

<objective>
Extend the useDateFormat hook with parseDate/placeholder utilities and convert every date display and CSV export site across the entire application to use the hook instead of direct date-fns or toLocaleDateString calls.

Purpose: This is the core rollout of DATE-01 through DATE-03, DATE-07, DATE-09, and DATE-10 requirements -- making all displayed and exported dates respect the user's chosen format preference.

Output: Extended hook + 12 files converted from hardcoded date formatting to user-preference-aware formatting.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-date-format-rollout/32-RESEARCH.md
@frontend/lib/hooks/use-date-format.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend useDateFormat hook with parseDate and placeholder</name>
  <files>frontend/lib/hooks/use-date-format.ts</files>
  <action>
Add `parse` import from `date-fns` alongside existing imports.

Add to `UseDateFormatReturn` interface:
- `parseDate: (dateString: string) => Date | null` — parses a date string according to user's format preference
- `placeholder: string` — lowercase placeholder string for user's format (e.g., "dd/mm/yyyy")

Add `PLACEHOLDER_MAP` constant mapping each `PresetDateFormat` to its lowercase placeholder:
- `"MM/DD/YY"` -> `"mm/dd/yy"`
- `"DD/MM/YYYY"` -> `"dd/mm/yyyy"`
- `"YYYY-MM-DD"` -> `"yyyy-mm-dd"`

Implement `placeholder` as a useMemo that looks up from PLACEHOLDER_MAP, falling back to `format.toLowerCase()`.

Implement `parseDate` as a useCallback that:
1. Returns null for empty/falsy input
2. Uses date-fns `parse(dateString, dateFnsFormatStr, new Date())`
3. Validates result with `isValid()`
4. Returns the Date if valid, null otherwise
5. Catches exceptions and returns null
6. Depends on `[dateFnsFormatStr]`

Add parseDate and placeholder to the return object.
  </action>
  <verify>Run `cd frontend && npx tsc --noEmit` — should compile without errors. Verify the hook file exports parseDate and placeholder in the return type.</verify>
  <done>useDateFormat hook returns parseDate function and placeholder string alongside existing formatDate/formatDateTime/format/dateFnsFormat.</done>
</task>

<task type="auto">
  <name>Task 2: Convert all display sites to use useDateFormat hook</name>
  <files>
    frontend/app/[locale]/(dashboard)/dashboard/page.tsx
    frontend/components/dashboard/notifications-dropdown.tsx
    frontend/lib/hooks/use-filters.ts
    frontend/lib/scanner/scan-history.ts
    frontend/components/inventory/repair-history.tsx
    frontend/app/[locale]/(dashboard)/dashboard/imports/[jobId]/page.tsx
  </files>
  <action>
Convert each file from direct date formatting to using useDateFormat. All changes follow the same pattern: add import, call hook (if component), replace formatting call.

**dashboard/page.tsx** (~line 50):
- Add `import { useDateFormat } from "@/lib/hooks/use-date-format";`
- Inside the component function, add `const { formatDate } = useDateFormat();`
- In the `formatRelativeTime` helper function: this is a local function inside the component. Replace the `return date.toLocaleDateString();` fallback (last line of the function) with `return formatDate(date);`. Keep all the relative time logic ("just now", "X minutes ago", etc.) unchanged.

**notifications-dropdown.tsx** (~line 29):
- Add `import { useDateFormat } from "@/lib/hooks/use-date-format";`
- Inside the component function, add `const { formatDate } = useDateFormat();`
- In the `formatRelativeTime` local function: replace `return date.toLocaleDateString();` fallback with `return formatDate(date);`. Keep all relative time logic unchanged.

**use-filters.ts** (~lines 81, 84, 87):
- Add `import { useDateFormat } from "@/lib/hooks/use-date-format";` at top
- Inside the `useFilters` hook function, add `const { formatDate } = useDateFormat();`
- Replace `range.from.toLocaleDateString()` with `formatDate(range.from)` (line 81, twice)
- Replace `range.to.toLocaleDateString()` with `formatDate(range.to)` (line 81, 87)
- Replace `range.from.toLocaleDateString()` in "From" line (84) with `formatDate(range.from)`
- Replace `range.to.toLocaleDateString()` in "Until" line (87) with `formatDate(range.to)`

**scan-history.ts** (~line 190):
- This is a non-React utility function (`formatTimestamp`), NOT a hook or component. It CANNOT call useDateFormat.
- The `toLocaleDateString` call here is inside a relative-time function that shows "Just now", "X min ago", etc., and only falls back to date display for entries older than 24h.
- This is similar to `formatDistanceToNow` — it's a relative time display with a date fallback. Per the research guidance, this is a borderline case. However, since this function is a plain utility (not a React hook), and the date display is a fallback for old entries only, leave this file AS-IS. Do NOT convert it. The scan history is a non-critical offline utility with minimal date display.

**repair-history.tsx** (~lines 434, 451, 719, 732):
- Add `import { useDateFormat } from "@/lib/hooks/use-date-format";`
- Inside the component function, add `const { formatDate } = useDateFormat();`
- Replace `format(parseISO(repair.reminder_date), "PP")` with `formatDate(repair.reminder_date)` (lines 434, 719)
- Replace `format(parseISO(repair.repair_date), "PP")` with `formatDate(repair.repair_date)` (lines 451, 732). Note: the existing code at line 451 has a ternary `repair.repair_date ? format(...) : "-"` — since `formatDate` already handles null/undefined by returning "-", simplify to just `formatDate(repair.repair_date)`.
- If `format` and `parseISO` are no longer used anywhere in the file after these changes, remove those imports. Check carefully — the file has date inputs that may use `format` for value binding (format(new Date(), "yyyy-MM-dd") for input values). Keep those imports if still used.

**imports/[jobId]/page.tsx** (~lines 313, 318):
- Add `import { useDateFormat } from "@/lib/hooks/use-date-format";`
- Inside the component function, add `const { formatDateTime } = useDateFormat();`
- Replace `format(new Date(job.started_at), "PPpp")` with `formatDateTime(job.started_at)` (line 313)
- Replace `format(new Date(job.completed_at), "PPpp")` with `formatDateTime(job.completed_at)` (line 318)
- If `format` from date-fns is no longer used elsewhere in the file, remove that import.

**DO NOT touch:**
- analytics/page.tsx — chart month labels are a different concern (deferred per research)
- Any file using `formatDistanceToNow` — those are relative time displays
- scan-history.ts — non-React utility with relative time display
  </action>
  <verify>Run `cd frontend && npx tsc --noEmit` — no type errors. Grep for `toLocaleDateString` in frontend/ — should only remain in scan-history.ts and analytics/page.tsx. Grep for `"PP"` format token — should not appear in repair-history.tsx. Grep for `"PPpp"` — should not appear in imports/[jobId]/page.tsx.</verify>
  <done>All user-facing date displays (except relative time and chart labels) use useDateFormat hook. Dashboard, notifications, filter chips, repair history, and import job details all respect user's date format preference.</done>
</task>

<task type="auto">
  <name>Task 3: Convert all CSV export formatters to use useDateFormat</name>
  <files>
    frontend/app/[locale]/(dashboard)/dashboard/items/page.tsx
    frontend/app/[locale]/(dashboard)/dashboard/inventory/page.tsx
    frontend/app/[locale]/(dashboard)/dashboard/containers/page.tsx
    frontend/app/[locale]/(dashboard)/dashboard/borrowers/page.tsx
    frontend/app/[locale]/(dashboard)/dashboard/loans/page.tsx
    frontend/app/[locale]/(dashboard)/dashboard/declutter/page.tsx
  </files>
  <action>
Each of these 6 pages has `exportColumns` definitions with date formatters using `toLocaleDateString()` or `format(parseISO(...), "yyyy-MM-dd")`. Convert them all to use `formatDate` from the hook.

**For each page, the pattern is:**
1. If not already imported, add `import { useDateFormat } from "@/lib/hooks/use-date-format";`
2. Inside the component, add `const { formatDate } = useDateFormat();` (if not already present — loans/page.tsx already has it)
3. Replace date formatters in exportColumns
4. Add `formatDate` to the useMemo dependency array for exportColumns

**items/page.tsx** (~lines 780-781):
- Add import and hook call
- Replace `formatter: (value) => new Date(value).toLocaleDateString()` with `formatter: (value) => formatDate(value)` for both created_at and updated_at
- Add `formatDate` to the exportColumns useMemo dependency array

**inventory/page.tsx** (~lines 915-916):
- Add import and hook call
- Replace `formatter: (value) => new Date(value).toLocaleDateString()` with `formatter: (value) => formatDate(value)` for both created_at and updated_at
- Add `formatDate` to the exportColumns useMemo dependency array

**containers/page.tsx** (~lines 585-586):
- Add import and hook call
- Replace `formatter: (value) => new Date(value).toLocaleDateString()` with `formatter: (value) => formatDate(value)` for both created_at and updated_at
- Add `formatDate` to the exportColumns useMemo dependency array

**borrowers/page.tsx** (~lines 347-348):
- Add import and hook call
- Replace `formatter: (value) => new Date(value).toLocaleDateString()` with `formatter: (value) => formatDate(value)` for both created_at and updated_at
- Add `formatDate` to the exportColumns useMemo dependency array

**loans/page.tsx** (~lines 691-695):
- Already has `useDateFormat` imported and `formatDate` destructured (from prior work in items detail display)
- Replace loan date formatters:
  - `formatter: (value) => format(parseISO(value), "yyyy-MM-dd")` -> `formatter: (value) => formatDate(value)` for loaned_date, due_date
  - `formatter: (value) => value ? format(parseISO(value), "yyyy-MM-dd") : "Not returned"` -> `formatter: (value) => value ? formatDate(value) : "Not returned"` for returned_date
  - `formatter: (value) => new Date(value).toLocaleDateString()` -> `formatter: (value) => formatDate(value)` for created_at
- Add `formatDate` to the exportColumns useMemo dependency array (currently depends on `[borrowers]`)

**declutter/page.tsx** (~line 179):
- Add import and hook call
- Replace `formatter: (value) => value ? format(parseISO(value), "yyyy-MM-dd") : "Never"` with `formatter: (value) => value ? formatDate(value) : "Never"` for last_used_at
- Add `formatDate` to the exportColumns useMemo dependency array
- If `format` and `parseISO` from date-fns are no longer used elsewhere in the file, remove those imports.

**IMPORTANT:** After converting export formatters in loans/page.tsx, check if `format` and `parseISO` are still needed for date input `value` attributes (e.g., `format(new Date(), "yyyy-MM-dd")` for native date input values). Those MUST remain as `yyyy-MM-dd` per the HTML spec for `<input type="date">`. Do NOT remove format/parseISO imports if they're still used for input values.
  </action>
  <verify>Run `cd frontend && npx tsc --noEmit` — no type errors. Grep for `toLocaleDateString` in the 6 page files — should return zero matches. Check that each exportColumns useMemo includes `formatDate` in its dependency array.</verify>
  <done>All 6 pages with CSV export format date columns per user's preference. Export output matches the date format shown in the UI.</done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` — zero type errors
2. `grep -r "toLocaleDateString" frontend/app frontend/components frontend/lib/hooks` — only scan-history.ts and analytics/page.tsx remain
3. `grep -r '"PP"' frontend/components/inventory/repair-history.tsx` — no matches
4. `grep -r '"PPpp"' frontend/app` — no matches
5. `grep -r "useDateFormat" frontend/` — should show imports in all converted files
6. `cd frontend && npm run build` — production build succeeds (catches any runtime issues)
</verification>

<success_criteria>
- Every absolute date display in tables, cards, detail pages, and repair history uses formatDate from useDateFormat
- Every CSV export date column uses formatDate from useDateFormat
- DateTime displays (import job timestamps) use formatDateTime from useDateFormat
- Relative time displays (formatDistanceToNow, "X ago" patterns) remain unchanged
- Native date input value attributes still use yyyy-MM-dd format (browser requirement)
- useDateFormat hook exports parseDate and placeholder for Plan 02 consumption
- Frontend builds successfully with no type errors
</success_criteria>

<output>
After completion, create `.planning/phases/32-date-format-rollout/32-01-SUMMARY.md`
</output>
