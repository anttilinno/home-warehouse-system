---
phase: 38-data-and-storage-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/utils/format-bytes.ts
  - frontend/components/settings/storage-usage.tsx
  - frontend/components/settings/cache-management.tsx
  - frontend/components/settings/sync-settings.tsx
  - frontend/app/[locale]/(dashboard)/dashboard/settings/data-storage/page.tsx
  - frontend/messages/en.json
  - frontend/messages/et.json
  - frontend/messages/ru.json
autonomous: true

must_haves:
  truths:
    - "User sees storage usage with progress bar on Data & Storage subpage"
    - "User can clear offline cache via button with confirmation dialog, page reloads after"
    - "User sees persistent storage status and can request persistent storage"
    - "User can trigger manual sync and sees last-sync timestamp"
    - "User can access backup/restore (import/export) via dialog on this page"
  artifacts:
    - path: "frontend/lib/utils/format-bytes.ts"
      provides: "Human-readable byte formatting utility"
      exports: ["formatBytes"]
    - path: "frontend/components/settings/storage-usage.tsx"
      provides: "Storage usage Card with Progress bar"
      exports: ["StorageUsage"]
    - path: "frontend/components/settings/cache-management.tsx"
      provides: "Cache clearing + persistent storage Card"
      exports: ["CacheManagement"]
    - path: "frontend/components/settings/sync-settings.tsx"
      provides: "Manual sync trigger + last-sync Card"
      exports: ["SyncSettings"]
    - path: "frontend/app/[locale]/(dashboard)/dashboard/settings/data-storage/page.tsx"
      provides: "Composed Data & Storage subpage"
      contains: "StorageUsage"
  key_links:
    - from: "frontend/components/settings/storage-usage.tsx"
      to: "navigator.storage.estimate()"
      via: "Browser Storage API"
      pattern: "navigator\\.storage\\.estimate"
    - from: "frontend/components/settings/cache-management.tsx"
      to: "frontend/lib/db/offline-db.ts"
      via: "deleteDB() import"
      pattern: "import.*deleteDB.*offline-db"
    - from: "frontend/components/settings/sync-settings.tsx"
      to: "frontend/lib/contexts/offline-context.tsx"
      via: "useOffline() hook"
      pattern: "useOffline\\(\\)"
    - from: "frontend/app/[locale]/(dashboard)/dashboard/settings/data-storage/page.tsx"
      to: "frontend/components/shared/backup-restore-dialog.tsx"
      via: "BackupRestoreDialog import"
      pattern: "import.*BackupRestoreDialog"
---

<objective>
Build the Data & Storage settings subpage with storage usage display, cache management, sync controls, and backup/restore access.

Purpose: Give users visibility into their offline storage usage and control over cached data, sync timing, and import/export -- completing the Data & Storage section of the modular settings architecture.

Output: Four new frontend files (3 settings components + 1 utility), one modified page file, three modified translation files.
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-data-and-storage-management/38-RESEARCH.md

# Source files to reference for patterns and APIs
@frontend/components/settings/theme-settings.tsx
@frontend/components/shared/backup-restore-dialog.tsx
@frontend/lib/contexts/offline-context.tsx
@frontend/lib/db/offline-db.ts
@frontend/components/sync-status-indicator.tsx
@frontend/components/ui/progress.tsx
@frontend/app/[locale]/(dashboard)/dashboard/settings/data-storage/page.tsx
@frontend/messages/en.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create storage, cache, and sync settings components with formatBytes utility</name>
  <files>
    frontend/lib/utils/format-bytes.ts
    frontend/components/settings/storage-usage.tsx
    frontend/components/settings/cache-management.tsx
    frontend/components/settings/sync-settings.tsx
  </files>
  <action>
**1. Create `frontend/lib/utils/format-bytes.ts`:**
- Export a `formatBytes(bytes: number, decimals?: number): string` function
- Handle 0 bytes as "0 B"
- Use 1024 base with units: B, KB, MB, GB
- Default to 1 decimal place

**2. Create `frontend/components/settings/storage-usage.tsx`:**
- Export `StorageUsage` component using the Card pattern (see `theme-settings.tsx` for structure)
- Use `useTranslations("settings.dataStorage")` for all strings
- On mount, call `navigator.storage.estimate()` with full graceful degradation:
  - Guard with `typeof navigator !== "undefined" && navigator.storage?.estimate`
  - If unsupported, show a "Storage information unavailable" message
  - If supported, show usage and quota formatted with `formatBytes()`
- Display a `Progress` component (from `@/components/ui/progress`) showing percentage used
- Show text like "12.3 MB of 2.1 GB used (0.6%)" below the progress bar
- Add a small note: "Storage values are approximate" (Safari caveat)
- Include a RefreshCw icon button to re-fetch the estimate
- Use `HardDrive` icon from lucide-react in the CardTitle
- State: `usage`, `quota`, `supported`, `loading` -- fetched in a `useEffect` on mount and on refresh button click

**3. Create `frontend/components/settings/cache-management.tsx`:**
- Export `CacheManagement` component using the Card pattern
- Use `useTranslations("settings.dataStorage")` for all strings
- Import `useOffline()` from `@/lib/contexts/offline-context` for `persistentStorage` state
- Two sections within the Card:

  **Section A - Clear Offline Cache:**
  - A destructive-variant Button "Clear Offline Cache" with Trash2 icon
  - On click, open an AlertDialog (from `@/components/ui/alert-dialog`) with:
    - Title: "Clear offline cache?"
    - Description: warns that all offline data will be deleted and the page will reload
    - Cancel and Continue (destructive) buttons
  - On confirm: call `deleteDB()` from `@/lib/db/offline-db`, then clear all SW caches via `caches.keys()` + `caches.delete()`, also delete the "PhotoUploadQueue" IDB database, then show a toast "Cache cleared. Reloading..." and call `window.location.reload()` after a 1-second delay
  - Guard `caches` and `indexedDB` APIs with typeof checks

  **Section B - Persistent Storage:**
  - Show current status as a Badge: "Granted" (default variant) or "Not granted" (secondary variant)
  - If not granted, show a Button "Request Persistent Storage"
  - On request: call `navigator.storage.persist()`, if granted update local state and show success toast; if denied show info toast explaining the browser decides automatically
  - Use `Shield` icon from lucide-react for the section label
  - Track local `isPersistent` state initialized from `useOffline().persistentStorage`

**4. Create `frontend/components/settings/sync-settings.tsx`:**
- Export `SyncSettings` component using the Card pattern
- Use `useTranslations("settings.dataStorage")` for all strings
- Import `useOffline()` for: `triggerSync`, `isSyncing`, `lastSyncTimestamp`, `syncError`, `isOnline`, `pendingMutationCount`, `isMutationSyncing`, `processMutationQueue`
- Content:

  **Row 1 - Sync Now button:**
  - Button with RefreshCw icon, text "Sync Now"
  - While syncing: disable button, spin the RefreshCw icon with `animate-spin` class
  - On click: call `triggerSync()` then `processMutationQueue()`
  - Disabled when offline

  **Row 2 - Last sync timestamp:**
  - If `lastSyncTimestamp` is not null, show formatted date/time using `useDateFormat` and `useTimeFormat` hooks (established pattern from Phase 30-34), plus a relative time string
  - For relative time, copy the `formatRelativeTime` logic inline (it's only 10 lines, from `sync-status-indicator.tsx`) -- do NOT import from that file since it's a non-exported local function
  - If never synced, show "Never synced"

  **Row 3 - Status indicators:**
  - Online/offline status: Wifi/WifiOff icon with "Online"/"Offline" text
  - Pending mutations: if `pendingMutationCount > 0`, show count with Clock icon
  - Sync error: if `syncError` is not null, show error in a destructive Alert

- Use `RefreshCw` icon from lucide-react in the CardTitle
  </action>
  <verify>
Run `cd /home/antti/Repos/Misc/home-warehouse-system/frontend && npx tsc --noEmit` -- no type errors in the 4 new files. Verify all 4 files exist and export their components.
  </verify>
  <done>
Four files created: `format-bytes.ts` exports `formatBytes`, `storage-usage.tsx` exports `StorageUsage` with Progress bar and storage estimate, `cache-management.tsx` exports `CacheManagement` with AlertDialog and persistent storage controls, `sync-settings.tsx` exports `SyncSettings` with manual sync and last-sync display. All compile without type errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire up data-storage page and add i18n translations</name>
  <files>
    frontend/app/[locale]/(dashboard)/dashboard/settings/data-storage/page.tsx
    frontend/messages/en.json
    frontend/messages/et.json
    frontend/messages/ru.json
  </files>
  <action>
**1. Update `frontend/app/[locale]/(dashboard)/dashboard/settings/data-storage/page.tsx`:**
- Follow the established subpage pattern (see `profile/page.tsx` or `appearance/page.tsx`):
  - Mobile back link with ArrowLeft
  - h2 heading with `t("nav.dataStorage")`
  - Description with `t("dataStorage.description")`
- Import and render in order:
  1. `<StorageUsage />` from `@/components/settings/storage-usage`
  2. `<CacheManagement />` from `@/components/settings/cache-management`
  3. `<SyncSettings />` from `@/components/settings/sync-settings`
  4. A "Backup & Restore" Card that contains a description and a Button that triggers `<BackupRestoreDialog />` from `@/components/shared/backup-restore-dialog`
- The Backup & Restore section: create a simple Card with CardHeader (title "Backup & Restore" with HardDrive icon, description about exporting/importing workspace data) and CardContent with the BackupRestoreDialog component using a Button as trigger
- Use `useTranslations("settings")` at the page level for the heading/description, components use their own `useTranslations("settings.dataStorage")` internally

**2. Add i18n translations to all three locale files.**

Add a `"dataStorage"` key inside the `"settings"` object in each file. Structure:

```json
"dataStorage": {
  "description": "Manage offline data, storage, and backups",
  "storageUsage": {
    "title": "Storage Usage",
    "description": "Disk space used by offline data and caches",
    "used": "{usage} of {quota} used ({percent}%)",
    "unsupported": "Storage information is not available in this browser",
    "approximate": "Storage values are approximate",
    "refresh": "Refresh"
  },
  "cacheManagement": {
    "title": "Cache Management",
    "description": "Manage offline cache and storage persistence",
    "clearCache": "Clear Offline Cache",
    "clearCacheConfirmTitle": "Clear offline cache?",
    "clearCacheConfirmDesc": "This will delete all offline data and cached files. The page will reload automatically. Your online data is not affected.",
    "clearCacheCancel": "Cancel",
    "clearCacheConfirm": "Clear Cache",
    "clearCacheSuccess": "Cache cleared. Reloading...",
    "persistentStorage": "Persistent Storage",
    "persistentStorageDesc": "Prevents the browser from automatically deleting offline data when storage is low",
    "persistentGranted": "Granted",
    "persistentNotGranted": "Not granted",
    "requestPersistent": "Request Persistent Storage",
    "persistentSuccess": "Persistent storage granted",
    "persistentDenied": "The browser did not grant persistent storage. This is decided automatically based on your usage patterns."
  },
  "sync": {
    "title": "Sync",
    "description": "Manage data synchronization with the server",
    "syncNow": "Sync Now",
    "syncing": "Syncing...",
    "lastSync": "Last synced",
    "neverSynced": "Never synced",
    "online": "Online",
    "offline": "Offline",
    "pendingMutations": "{count} pending changes",
    "syncError": "Last sync failed"
  },
  "backupRestore": {
    "title": "Backup & Restore",
    "description": "Export your workspace data for backup or import from a previous backup",
    "openDialog": "Open Backup & Restore"
  }
}
```

For `et.json`, translate to Estonian:
```json
"dataStorage": {
  "description": "Halda viiuteta andmeid, salvestusruumi ja varukoopiaid",
  "storageUsage": {
    "title": "Salvestusruumi kasutus",
    "description": "Kettal viiuteta andmete ja vahemalu poolt kasutatav ruum",
    "used": "{usage} / {quota} kasutatud ({percent}%)",
    "unsupported": "Salvestusruumi info pole selles brauseris saadaval",
    "approximate": "Salvestusruumi vaartused on ligikaudsed",
    "refresh": "Varskenda"
  },
  "cacheManagement": {
    "title": "Vahemalu haldus",
    "description": "Halda viiuteta vahemalu ja salvestusruumi puisivust",
    "clearCache": "Tuhjenda viiuteta vahemalu",
    "clearCacheConfirmTitle": "Tuhjendada viiuteta vahemalu?",
    "clearCacheConfirmDesc": "See kustutab koik viiuteta andmed ja vahemalu failid. Leht laadib automaatselt uuesti. Teie veebiandmed ei ole mojutatud.",
    "clearCacheCancel": "Tuehista",
    "clearCacheConfirm": "Tuhjenda vahemalu",
    "clearCacheSuccess": "Vahemalu tuhjendatud. Laadimine...",
    "persistentStorage": "Puisiv salvestusruum",
    "persistentStorageDesc": "Takistab brauserit automaatselt kustutamast viiuteta andmeid, kui salvestusruum on vaike",
    "persistentGranted": "Lubatud",
    "persistentNotGranted": "Lubamata",
    "requestPersistent": "Taotle puisivat salvestusruumi",
    "persistentSuccess": "Puisiv salvestusruum lubatud",
    "persistentDenied": "Brauser ei lubanud puisivat salvestusruumi. See otsustatakse automaatselt teie kasutusharjumuste pohjal."
  },
  "sync": {
    "title": "Suenkroonimine",
    "description": "Halda andmete suenkroonimist serveriga",
    "syncNow": "Suengi kohe",
    "syncing": "Suenkroonimine...",
    "lastSync": "Viimati suengitud",
    "neverSynced": "Pole suengitud",
    "online": "Veebis",
    "offline": "Viiuteta",
    "pendingMutations": "{count} ootel muudatust",
    "syncError": "Viimane suenkroonimine ebaonnestus"
  },
  "backupRestore": {
    "title": "Varukoopia ja taastamine",
    "description": "Ekspordi tooruumi andmed varundamiseks voi impordi eelmisest varukoopiast",
    "openDialog": "Ava varukoopia ja taastamine"
  }
}
```

For `ru.json`, translate to Russian:
```json
"dataStorage": {
  "description": "Upravlenie avtonomnymi dannymi, khranilishchem i rezervnymi kopiyami",
  "storageUsage": {
    "title": "Ispolzovanie khranilishcha",
    "description": "Diskovoe prostranstvo, ispolzuemoe avtonomnymi dannymi i keshom",
    "used": "{usage} iz {quota} ispolzovano ({percent}%)",
    "unsupported": "Informatsiya o khranilishche nedostupna v etom brauzere",
    "approximate": "Znacheniya khranilishcha yavlyayutsya priblizitelnymi",
    "refresh": "Obnovit"
  },
  "cacheManagement": {
    "title": "Upravlenie keshem",
    "description": "Upravlenie avtonomnym keshem i postoyannym khranilishchem",
    "clearCache": "Ochistit avtonomny kesh",
    "clearCacheConfirmTitle": "Ochistit avtonomny kesh?",
    "clearCacheConfirmDesc": "Eto udalit vse avtonomnye dannye i keshirovannye fayly. Stranitsa perezagruzitsya avtomaticheski. Vashi onlayn-dannye ne budut zatronuty.",
    "clearCacheCancel": "Otmena",
    "clearCacheConfirm": "Ochistit kesh",
    "clearCacheSuccess": "Kesh ochishchen. Perezagruzka...",
    "persistentStorage": "Postoyannoe khranilishche",
    "persistentStorageDesc": "Predotvrashchaet avtomaticheskoe udalenie avtonomnykh dannykh brauzerom pri nekhvatke mesta",
    "persistentGranted": "Predostavleno",
    "persistentNotGranted": "Ne predostavleno",
    "requestPersistent": "Zaprosit postoyannoe khranilishche",
    "persistentSuccess": "Postoyannoe khranilishche predostavleno",
    "persistentDenied": "Brauzer ne predostavil postoyannoe khranilishche. Eto reshaetsya avtomaticheski na osnove vashikh shablonov ispolzovaniya."
  },
  "sync": {
    "title": "Sinkhronizatsiya",
    "description": "Upravlenie sinkhronizatsiey dannykh s serverom",
    "syncNow": "Sinkhronizirovat",
    "syncing": "Sinkhronizatsiya...",
    "lastSync": "Poslednyaya sinkhronizatsiya",
    "neverSynced": "Ne sinkhronizirovalos",
    "online": "V seti",
    "offline": "Avtonomno",
    "pendingMutations": "{count} ozhidayushchikh izmeneniy",
    "syncError": "Poslednyaya sinkhronizatsiya ne udalas"
  },
  "backupRestore": {
    "title": "Rezervnoe kopirovanie i vosstanovlenie",
    "description": "Eksport dannykh rabochego prostranstva dlya rezervnogo kopirovaniya ili import iz predydushchey kopii",
    "openDialog": "Otkryt rezervnoe kopirovanie"
  }
}
```

**IMPORTANT i18n notes:**
- The Estonian and Russian translations above use ASCII-transliterated placeholders. The executor should write proper Unicode characters (e.g., proper Estonian diacritics like oe, ae, ue, oo and Russian Cyrillic). Use existing translations in those files as a reference for character sets and tone.
- Place the `"dataStorage"` block after the `"language"` block (or wherever the last settings subsection is) inside the `"settings"` object.
  </action>
  <verify>
Run `cd /home/antti/Repos/Misc/home-warehouse-system/frontend && npx tsc --noEmit` -- no type errors. Run `cd /home/antti/Repos/Misc/home-warehouse-system/frontend && npx next build 2>&1 | tail -20` -- build succeeds with no errors. Verify that visiting `/dashboard/settings/data-storage` no longer shows "Coming soon" text.
  </verify>
  <done>
Data & Storage subpage shows four sections: StorageUsage with progress bar, CacheManagement with clear button and persistent storage controls, SyncSettings with sync button and timestamp, and Backup & Restore card with dialog trigger. All strings are translated in en.json, et.json, and ru.json. Page follows established subpage pattern with mobile back link, heading, and description. No "Coming soon" text remains.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no type errors
2. `npx next build` succeeds
3. Data & Storage page renders all four Card sections
4. Storage usage shows progress bar with formatted bytes
5. Clear cache button opens AlertDialog confirmation
6. Persistent storage shows status badge
7. Sync Now button triggers sync with spinner
8. Last sync timestamp displays formatted date/time
9. Backup & Restore button opens the existing BackupRestoreDialog
10. All strings appear correctly when switching between en, et, ru locales
</verification>

<success_criteria>
- User navigates to Data & Storage subpage and sees storage usage with progress bar (DATA-01)
- User can clear offline cache via button with confirmation dialog, page reloads after (DATA-02)
- User sees persistent storage status and can request persistent storage (DATA-03)
- User can trigger manual sync and sees last-sync timestamp (DATA-04)
- User can open backup/restore dialog from this page (DATA-05)
- All text is translated in English, Estonian, and Russian
</success_criteria>

<output>
After completion, create `.planning/phases/38-data-and-storage-management/38-01-SUMMARY.md`
</output>
