---
phase: 14-declutter-assistant
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/db/migrations/006_declutter_last_used.sql
  - backend/db/queries/declutter.sql
  - backend/internal/infra/queries/declutter.sql.go (generated)
autonomous: true

must_haves:
  truths:
    - "last_used_at column exists on warehouse.inventory table"
    - "Existing inventory records have last_used_at set to created_at (not null)"
    - "Index exists on last_used_at for performance"
    - "sqlc queries generated and compile without errors"
  artifacts:
    - path: "backend/db/migrations/006_declutter_last_used.sql"
      provides: "Schema migration adding last_used_at column"
      contains: "last_used_at TIMESTAMPTZ"
    - path: "backend/db/queries/declutter.sql"
      provides: "sqlc queries for declutter feature"
      contains: "ListUnusedInventory"
  key_links:
    - from: "backend/db/queries/declutter.sql"
      to: "backend/internal/infra/queries/declutter.sql.go"
      via: "sqlc generate"
      pattern: "ListUnusedInventory"
---

<objective>
Add last_used_at timestamp column to inventory table and create sqlc queries for declutter feature.

Purpose: Enable tracking of when inventory items were last used, foundational for the declutter assistant feature.
Output: Database migration applied, sqlc queries generated and ready for domain layer.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-declutter-assistant/14-RESEARCH.md

@backend/db/migrations/001_initial_schema.sql
@backend/db/queries/inventory.sql
@backend/db/queries/analytics.sql
@backend/sqlc.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration for last_used_at column</name>
  <files>backend/db/migrations/006_declutter_last_used.sql</files>
  <action>
Create migration file `006_declutter_last_used.sql` with:

-- migrate:up
```sql
-- Add last_used_at column to track when inventory was last "used"
-- This powers the declutter assistant feature
ALTER TABLE warehouse.inventory
ADD COLUMN last_used_at TIMESTAMPTZ;

-- Set existing records to created_at as conservative default
-- This prevents all items showing as "never used" after deploy
UPDATE warehouse.inventory
SET last_used_at = created_at
WHERE last_used_at IS NULL;

-- Create partial index for efficient unused item queries
-- Only indexes non-archived items since that's all we query
CREATE INDEX ix_inventory_last_used ON warehouse.inventory(workspace_id, last_used_at)
WHERE is_archived = false;

COMMENT ON COLUMN warehouse.inventory.last_used_at IS
'Timestamp when this inventory was last marked as "used". Used for declutter assistant. Defaults to created_at for existing records.';
```

-- migrate:down
```sql
DROP INDEX IF EXISTS warehouse.ix_inventory_last_used;
ALTER TABLE warehouse.inventory DROP COLUMN IF EXISTS last_used_at;
```
  </action>
  <verify>Run `mise run migrate` - migration applies without errors</verify>
  <done>last_used_at column exists on inventory table, existing records have non-null values, index created</done>
</task>

<task type="auto">
  <name>Task 2: Create sqlc queries for declutter operations</name>
  <files>backend/db/queries/declutter.sql</files>
  <action>
Create `declutter.sql` with queries following analytics.sql patterns:

```sql
-- Declutter Assistant Queries
-- These queries support the declutter feature for identifying unused inventory

-- name: ListUnusedInventory :many
-- Lists inventory items unused for specified threshold days
-- Supports grouping by category or location for organized display
SELECT
    inv.id,
    inv.workspace_id,
    inv.item_id,
    inv.location_id,
    inv.container_id,
    inv.quantity,
    inv.condition,
    inv.status,
    inv.purchase_price,
    inv.currency_code,
    inv.last_used_at,
    inv.created_at,
    inv.updated_at,
    it.name as item_name,
    it.sku as item_sku,
    l.name as location_name,
    c.name as category_name,
    c.id as category_id,
    EXTRACT(DAY FROM (NOW() - COALESCE(inv.last_used_at, inv.created_at)))::int as days_unused
FROM warehouse.inventory inv
JOIN warehouse.items it ON inv.item_id = it.id
JOIN warehouse.locations l ON inv.location_id = l.id
LEFT JOIN warehouse.categories c ON it.category_id = c.id
WHERE inv.workspace_id = $1
  AND inv.is_archived = false
  AND COALESCE(inv.last_used_at, inv.created_at) < NOW() - make_interval(days => $2)
ORDER BY
    CASE WHEN sqlc.arg(group_by)::text = 'category' THEN c.name END NULLS LAST,
    CASE WHEN sqlc.arg(group_by)::text = 'location' THEN l.name END NULLS LAST,
    days_unused DESC
LIMIT $3 OFFSET $4;

-- name: CountUnusedInventory :one
-- Counts total unused inventory for pagination
SELECT COUNT(*)::int as total
FROM warehouse.inventory inv
WHERE inv.workspace_id = $1
  AND inv.is_archived = false
  AND COALESCE(inv.last_used_at, inv.created_at) < NOW() - make_interval(days => $2);

-- name: MarkInventoryUsed :one
-- Atomically updates last_used_at to current time
UPDATE warehouse.inventory
SET last_used_at = NOW(), updated_at = NOW()
WHERE id = $1 AND workspace_id = $2
RETURNING *;

-- name: GetUnusedInventoryCounts :one
-- Returns summary counts for different thresholds (90/180/365 days)
-- Used for dashboard summary display
SELECT
    COUNT(*) FILTER (WHERE COALESCE(last_used_at, created_at) < NOW() - interval '90 days')::int as unused_90,
    COUNT(*) FILTER (WHERE COALESCE(last_used_at, created_at) < NOW() - interval '180 days')::int as unused_180,
    COUNT(*) FILTER (WHERE COALESCE(last_used_at, created_at) < NOW() - interval '365 days')::int as unused_365,
    COALESCE(SUM(purchase_price) FILTER (WHERE COALESCE(last_used_at, created_at) < NOW() - interval '90 days'), 0)::bigint as value_90,
    COALESCE(SUM(purchase_price) FILTER (WHERE COALESCE(last_used_at, created_at) < NOW() - interval '180 days'), 0)::bigint as value_180,
    COALESCE(SUM(purchase_price) FILTER (WHERE COALESCE(last_used_at, created_at) < NOW() - interval '365 days'), 0)::bigint as value_365
FROM warehouse.inventory
WHERE workspace_id = $1 AND is_archived = false;

-- name: GetMaxInventoryValue :one
-- Returns the maximum purchase price in workspace for percentile calculation
SELECT COALESCE(MAX(purchase_price), 0)::int as max_value
FROM warehouse.inventory
WHERE workspace_id = $1 AND is_archived = false;
```
  </action>
  <verify>Run `mise run sqlc` - generates Go code without errors</verify>
  <done>declutter.sql.go generated in backend/internal/infra/queries/ with type-safe query methods</done>
</task>

<task type="auto">
  <name>Task 3: Verify database and generated code</name>
  <files>None (verification only)</files>
  <action>
1. Verify migration applied:
   - Check `schema_migrations` table shows migration 006 applied
   - Query `SELECT last_used_at FROM warehouse.inventory LIMIT 1` returns non-null values

2. Verify sqlc generation:
   - Check `backend/internal/infra/queries/declutter.sql.go` exists
   - Contains `ListUnusedInventory`, `CountUnusedInventory`, `MarkInventoryUsed`, `GetUnusedInventoryCounts`, `GetMaxInventoryValue` functions

3. Verify Go compiles:
   - Run `mise run build` - compiles without errors

4. Check index exists:
   - Query `SELECT indexname FROM pg_indexes WHERE tablename = 'inventory' AND indexname = 'ix_inventory_last_used'`
  </action>
  <verify>`mise run build` passes, `mise run test-unit` passes</verify>
  <done>Database schema updated, sqlc code generated, Go compiles successfully</done>
</task>

</tasks>

<verification>
1. Migration 006 applied successfully to database
2. All existing inventory records have last_used_at = created_at (non-null)
3. Index ix_inventory_last_used exists
4. sqlc generated declutter.sql.go with all query methods
5. `mise run build` compiles without errors
6. `mise run test-unit` passes without regressions
</verification>

<success_criteria>
- last_used_at column exists on warehouse.inventory table with proper index
- Existing records backfilled with created_at values
- sqlc queries generated and compile
- No test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/14-declutter-assistant/14-01-SUMMARY.md`
</output>
