---
phase: 09-containers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/app/[locale]/(dashboard)/dashboard/containers/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can create a container while offline and see it appear immediately with pending badge"
    - "User can update container details while offline and see changes immediately with pending badge"
    - "User can create a container in a pending location while offline"
    - "Pending container rows show location name context (e.g., 'Pending... in Garage Shelf A')"
    - "Global sync status indicator includes container pending count"
  artifacts:
    - path: "frontend/app/[locale]/(dashboard)/dashboard/containers/page.tsx"
      provides: "Offline mutation support for containers with optimistic UI"
      contains: "useOfflineMutation"
  key_links:
    - from: "containers/page.tsx handleSave"
      to: "useOfflineMutation"
      via: "createContainerOffline/updateContainerOffline"
      pattern: "createContainerOffline|updateContainerOffline"
    - from: "containers/page.tsx"
      to: "syncManager"
      via: "MUTATION_SYNCED subscription"
      pattern: "syncManager\\.subscribe"
    - from: "containers/page.tsx location dropdown"
      to: "pending locations"
      via: "optimisticLocations state"
      pattern: "optimisticLocations"
---

<objective>
Add offline mutation support to the containers page with optimistic UI.

Purpose: Enable users to create and update containers while offline, with immediate visual feedback showing pending status with location context. Containers depend on locations via foreign key, so must handle cross-entity dependency when creating container in pending location.

Output: Containers page with full offline create/update capability, pending indicators showing "Pending... in [LocationName]", and proper dependency tracking for pending locations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-containers/09-RESEARCH.md

# Reference implementation - locations page with offline mutations
@frontend/app/[locale]/(dashboard)/dashboard/locations/page.tsx

# Current containers page to modify
@frontend/app/[locale]/(dashboard)/dashboard/containers/page.tsx

# Offline mutation hook
@frontend/lib/hooks/use-offline-mutation.ts

# Sync manager for event subscription
@frontend/lib/sync/sync-manager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add offline mutation infrastructure to containers page</name>
  <files>frontend/app/[locale]/(dashboard)/dashboard/containers/page.tsx</files>
  <action>
Add offline mutation support to the containers page following the locations page pattern:

1. **Imports** - Add at top of file:
   - `Cloud` from lucide-react
   - `useOfflineMutation` from "@/lib/hooks/use-offline-mutation"
   - `syncManager` and `SyncEvent` type from "@/lib/sync/sync-manager"
   - `cn` from "@/lib/utils"
   - `getPendingMutationsForEntity` from "@/lib/db/mutation-queue"

2. **State** - Add after existing state declarations:
   - `optimisticContainers` state: `useState<(Container & { _pending?: boolean })[]>([])`
   - `optimisticLocations` state: `useState<(Location & { _pending?: boolean })[]>([])`

3. **Offline mutation hooks** - Add after state declarations:
   - `createContainerOffline` hook using useOfflineMutation for 'containers' entity, 'create' operation
   - `updateContainerOffline` hook using useOfflineMutation for 'containers' entity, 'update' operation
   - In onMutate callbacks, add to optimisticContainers state with _pending: true

4. **Merged containers** - Add useMemo:
   - Merge fetched containers with optimisticContainers
   - For existing containers with updates, merge and mark _pending: true
   - Add new optimistic containers not yet in fetched list

5. **Merged locations for dropdown** - Add useMemo:
   - Merge fetched locations with optimisticLocations for dropdown display
   - Include "(pending)" suffix in display name for pending locations

6. **Sync event subscriptions** - Add useEffect:
   - Subscribe to syncManager for MUTATION_SYNCED events for both 'containers' and 'locations' entities
   - On container sync: remove from optimisticContainers, trigger refetch
   - On location sync: remove from optimisticLocations
   - Subscribe to MUTATION_FAILED for error toasts
   - Load pending location creates on mount using getPendingMutationsForEntity('locations')

7. **Update getLocationName helper**:
   - Use merged locations (fetched + optimistic) instead of just locations array

8. **Update handleSave function**:
   - For create: Check if formLocationId matches any pending optimistic location
   - If location is pending, pass dependsOn: [formLocationId] to createContainerOffline
   - Build payload matching ContainerCreate fields
   - Call createContainerOffline instead of containersApi.create
   - Show appropriate toast: "Container created" if online, "Container queued for sync" if offline
   - For update: Call updateContainerOffline with _entityId in payload
   - Show appropriate toast: "Container updated" if online, "Container update queued" if offline

9. **Update location dropdown in dialog**:
   - Use merged locations (allLocations) instead of just locations
   - Show "(pending)" suffix for pending locations in SelectItem

Note: Keep existing filteredContainers and flattenedContainers logic but operate on mergedContainers instead of containers.
  </action>
  <verify>
Run `cd frontend && npx tsc --noEmit` - should compile without errors.
Verify imports are correct and no unused variables.
  </verify>
  <done>
Containers page has useOfflineMutation hooks for create and update operations.
optimisticContainers and optimisticLocations state exists.
Sync event subscription cleans up optimistic state after sync.
handleSave uses offline mutations with dependsOn for pending location dependencies.
Location dropdown shows pending locations with "(pending)" suffix.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add pending indicator UI and conditional rendering</name>
  <files>frontend/app/[locale]/(dashboard)/dashboard/containers/page.tsx</files>
  <action>
Add visual indicators and conditional rendering for pending containers:

1. **TableRow styling** - In the TableRow for each container:
   - Add className with cn() to apply "bg-amber-50" when container._pending is true
   - Pattern: `className={cn(container._pending && "bg-amber-50")}`

2. **Pending badge** - In the TableCell with container name:
   - After the container name and before the Archived badge
   - Add conditional Badge when container._pending:
     ```tsx
     {container._pending && (
       <Badge variant="outline" className="text-xs text-amber-600 border-amber-300 shrink-0">
         <Cloud className="w-3 h-3 mr-1 animate-pulse" />
         {(() => {
           const locationName = getLocationName(container.location_id);
           return locationName ? `Pending... in ${locationName}` : 'Pending';
         })()}
       </Badge>
     )}
     ```

3. **Hide dropdown menu for pending containers**:
   - Wrap the entire DropdownMenu in conditional: `{!container._pending && ( ... )}`
   - This prevents edit/archive/delete actions on containers that don't exist on server yet

4. **Disable bulk selection checkbox for pending containers**:
   - Add `disabled={container._pending}` to the Checkbox in the row
   - Pending containers can't be exported or archived in bulk (no server data)

5. **Update filteredContainers** - Modify the useMemo:
   - Change to operate on `mergedContainers` instead of `containers`
   - Ensure pending containers appear in filtered results

6. **Update flattenedContainers** - Modify the useMemo:
   - Already depends on filteredContainers, no change needed
   - But verify it correctly adds location_name using getLocationName (which now includes pending locations)

7. **Update bulk operations**:
   - In selectAll keyboard shortcut, filter out pending containers from selection
   - Update to: `selectAll(sortedContainers.filter(c => !c._pending).map((c) => c.id))`
  </action>
  <verify>
Run `cd frontend && npx tsc --noEmit` - should compile without errors.
Run `cd frontend && npm run lint -- --quiet` - should pass with no new errors.
  </verify>
  <done>
Pending containers show amber-50 background.
Pending badge displays "Pending... in [LocationName]" with Cloud icon.
Dropdown menu is hidden for pending containers.
Bulk selection checkbox is disabled for pending containers.
filteredContainers and flattenedContainers use merged data including optimistic containers.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. TypeScript compilation:
   ```bash
   cd frontend && npx tsc --noEmit
   ```

2. Lint check:
   ```bash
   cd frontend && npm run lint -- --quiet
   ```

3. Verify key patterns exist in containers/page.tsx:
   - `useOfflineMutation` hook calls for create and update
   - `optimisticContainers` state
   - `optimisticLocations` state
   - `syncManager.subscribe` for event handling
   - `mergedContainers` useMemo
   - `dependsOn` usage in handleSave
   - Pending badge with "Pending... in" pattern
   - `bg-amber-50` class for pending rows
   - Conditional `!container._pending` for dropdown menu
   - `disabled={container._pending}` for checkbox

4. Manual verification (if dev server available):
   - Create container while online - should work as before
   - Create container while offline - should show immediately with pending badge
   - Update container while offline - should show updated values with pending badge
   - Create location offline, then create container in that location - should show "Pending... in [LocationName]"
   - Go online - pending indicators should disappear after sync
</verification>

<success_criteria>
- [ ] TypeScript compiles without errors
- [ ] Lint passes without new errors
- [ ] useOfflineMutation hooks exist for create and update
- [ ] optimisticContainers and optimisticLocations state exists
- [ ] Sync event subscription handles container and location syncs
- [ ] handleSave uses offline mutations with dependsOn for pending locations
- [ ] Location dropdown shows pending locations with "(pending)" suffix
- [ ] Pending containers have amber background
- [ ] Pending badge shows "Pending... in [LocationName]" with Cloud icon
- [ ] Dropdown menu hidden for pending containers
- [ ] Bulk selection disabled for pending containers
</success_criteria>

<output>
After completion, create `.planning/phases/09-containers/09-01-SUMMARY.md` using summary template.
</output>
