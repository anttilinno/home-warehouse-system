---
phase: 20-mobile-navigation-fab-and-gestures
plan: 04
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - frontend/lib/hooks/use-selection-mode.ts
  - frontend/components/list/selectable-list-item.tsx
  - frontend/components/list/index.ts
autonomous: true

must_haves:
  truths:
    - "Long press (500ms) on list item enters selection mode"
    - "Long press triggers haptic feedback"
    - "Scroll movement (>25px) cancels long press"
    - "Selection mode shows checkbox on each list item"
  artifacts:
    - path: "frontend/lib/hooks/use-selection-mode.ts"
      provides: "Selection mode state management"
      exports: ["useSelectionMode"]
    - path: "frontend/components/list/selectable-list-item.tsx"
      provides: "List item with long-press selection"
      exports: ["SelectableListItem"]
  key_links:
    - from: "frontend/components/list/selectable-list-item.tsx"
      to: "use-long-press"
      via: "import"
      pattern: "useLongPress.*from.*use-long-press"
---

<objective>
Create long-press selection mode for list items

Purpose: Allow users to enter multi-select mode via long press gesture (QACT-06), leveraging existing useBulkSelection hook
Output: SelectableListItem component and useSelectionMode hook for managing selection mode state
</objective>

<execution_context>
@/home/antti/.claude/get-shit-done/workflows/execute-plan.md
@/home/antti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/20-mobile-navigation-fab-and-gestures/20-RESEARCH.md
@.planning/phases/20-mobile-navigation-fab-and-gestures/20-01-SUMMARY.md
@frontend/lib/hooks/use-bulk-selection.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useSelectionMode hook</name>
  <files>frontend/lib/hooks/use-selection-mode.ts</files>
  <action>
Create selection mode state hook at `frontend/lib/hooks/use-selection-mode.ts`:

```typescript
"use client";

import { useState, useCallback } from "react";
import { useBulkSelection, type UseBulkSelectionReturn } from "./use-bulk-selection";

export interface UseSelectionModeReturn<T> extends UseBulkSelectionReturn<T> {
  /** Whether selection mode is active */
  isSelectionMode: boolean;
  /** Enter selection mode (optionally selecting an initial item) */
  enterSelectionMode: (initialId?: T) => void;
  /** Exit selection mode and clear all selections */
  exitSelectionMode: () => void;
  /** Toggle selection mode */
  toggleSelectionMode: () => void;
}

/**
 * Hook for managing selection mode state with bulk selection
 *
 * Combines selection mode toggle with useBulkSelection for complete
 * multi-select functionality. Use with SelectableListItem component.
 *
 * @example
 * ```tsx
 * const {
 *   isSelectionMode,
 *   enterSelectionMode,
 *   exitSelectionMode,
 *   selectedIds,
 *   toggleSelection,
 *   isSelected,
 * } = useSelectionMode<string>();
 *
 * // Long press enters selection mode
 * <SelectableListItem
 *   id={item.id}
 *   selectionMode={isSelectionMode}
 *   selected={isSelected(item.id)}
 *   onSelect={toggleSelection}
 *   onEnterSelectionMode={enterSelectionMode}
 * >
 *   {item.name}
 * </SelectableListItem>
 * ```
 */
export function useSelectionMode<T = string>(): UseSelectionModeReturn<T> {
  const [isSelectionMode, setIsSelectionMode] = useState(false);
  const bulkSelection = useBulkSelection<T>();

  const enterSelectionMode = useCallback(
    (initialId?: T) => {
      setIsSelectionMode(true);
      if (initialId !== undefined) {
        bulkSelection.selectItem(initialId);
      }
    },
    [bulkSelection]
  );

  const exitSelectionMode = useCallback(() => {
    setIsSelectionMode(false);
    bulkSelection.clearSelection();
  }, [bulkSelection]);

  const toggleSelectionMode = useCallback(() => {
    if (isSelectionMode) {
      exitSelectionMode();
    } else {
      setIsSelectionMode(true);
    }
  }, [isSelectionMode, exitSelectionMode]);

  return {
    isSelectionMode,
    enterSelectionMode,
    exitSelectionMode,
    toggleSelectionMode,
    ...bulkSelection,
  };
}
```

Key points:
- Extends useBulkSelection with selection mode state
- enterSelectionMode can optionally select an initial item (for long-press trigger)
- exitSelectionMode clears all selections
- Re-exports all useBulkSelection methods
  </action>
  <verify>
```bash
cd frontend && npx tsc --noEmit lib/hooks/use-selection-mode.ts 2>&1 | head -20
```
  </verify>
  <done>useSelectionMode hook created extending useBulkSelection</done>
</task>

<task type="auto">
  <name>Task 2: Create SelectableListItem component</name>
  <files>frontend/components/list/selectable-list-item.tsx</files>
  <action>
Create the selectable list item component at `frontend/components/list/selectable-list-item.tsx`:

```typescript
"use client";

import { useCallback } from "react";
import { useLongPress } from "use-long-press";
import { Checkbox } from "@/components/ui/checkbox";
import { triggerHaptic } from "@/lib/hooks/use-haptic";
import { cn } from "@/lib/utils";

interface SelectableListItemProps {
  /** Unique identifier for this item */
  id: string;
  /** Content to render inside the list item */
  children: React.ReactNode;
  /** Whether selection mode is currently active */
  selectionMode: boolean;
  /** Whether this item is currently selected */
  selected: boolean;
  /** Callback when item selection changes */
  onSelect: (id: string) => void;
  /** Callback to enter selection mode (called on long press) */
  onEnterSelectionMode: (id: string) => void;
  /** Additional className for the container */
  className?: string;
  /** Disable long-press functionality */
  disableLongPress?: boolean;
}

/**
 * List item with long-press to enter selection mode
 *
 * Features:
 * - Long press (500ms) enters selection mode and selects this item
 * - Movement during press (>25px) cancels to allow scrolling
 * - Haptic feedback on long press and selection
 * - Checkbox appears when in selection mode
 * - Click toggles selection when in selection mode
 *
 * @example
 * ```tsx
 * <SelectableListItem
 *   id={item.id}
 *   selectionMode={isSelectionMode}
 *   selected={isSelected(item.id)}
 *   onSelect={toggleSelection}
 *   onEnterSelectionMode={enterSelectionMode}
 * >
 *   <div className="flex items-center gap-3">
 *     <span>{item.name}</span>
 *   </div>
 * </SelectableListItem>
 * ```
 */
export function SelectableListItem({
  id,
  children,
  selectionMode,
  selected,
  onSelect,
  onEnterSelectionMode,
  className,
  disableLongPress = false,
}: SelectableListItemProps) {
  // Long press handler - enters selection mode
  const longPressHandlers = useLongPress(
    () => {
      if (!selectionMode) {
        triggerHaptic("tap");
        onEnterSelectionMode(id);
      }
    },
    {
      threshold: 500, // 500ms to trigger
      cancelOnMovement: 25, // Cancel if moved more than 25px (allows scrolling)
      detect: "touch", // Touch only (not mouse - mouse has right-click)
    }
  );

  // Click handler - toggles selection when in selection mode
  const handleClick = useCallback(() => {
    if (selectionMode) {
      triggerHaptic("tap");
      onSelect(id);
    }
  }, [selectionMode, id, onSelect]);

  // Handle checkbox change
  const handleCheckboxChange = useCallback(
    (checked: boolean | "indeterminate") => {
      if (checked === true || checked === false) {
        triggerHaptic("tap");
        onSelect(id);
      }
    },
    [id, onSelect]
  );

  // Prevent context menu on long press (native browser behavior)
  const handleContextMenu = useCallback((e: React.MouseEvent) => {
    if (!disableLongPress) {
      e.preventDefault();
    }
  }, [disableLongPress]);

  return (
    <div
      {...(disableLongPress ? {} : longPressHandlers())}
      onClick={handleClick}
      onContextMenu={handleContextMenu}
      className={cn(
        "flex items-center gap-3 p-3 rounded-lg cursor-pointer",
        "hover:bg-muted/50 active:bg-muted/70",
        "transition-colors duration-150",
        selected && "bg-primary/10",
        className
      )}
      role="listitem"
      aria-selected={selectionMode ? selected : undefined}
      data-selected={selected || undefined}
    >
      {selectionMode && (
        <Checkbox
          checked={selected}
          onCheckedChange={handleCheckboxChange}
          aria-label={`Select item ${id}`}
          className="shrink-0"
          onClick={(e) => e.stopPropagation()} // Prevent double-toggle
        />
      )}
      <div className="flex-1 min-w-0">{children}</div>
    </div>
  );
}
```

Key points:
- Uses use-long-press library with 500ms threshold
- cancelOnMovement: 25 prevents triggering while scrolling
- detect: "touch" - mouse users can use regular selection methods
- Haptic feedback on long press and selection
- Checkbox appears/disappears based on selectionMode
- Click only toggles selection when in selection mode
- Context menu prevented to avoid browser menu on long press
- aria-selected for accessibility
  </action>
  <verify>
```bash
cd frontend && npx tsc --noEmit components/list/selectable-list-item.tsx 2>&1 | head -20
```
  </verify>
  <done>SelectableListItem component created with long-press gesture</done>
</task>

<task type="auto">
  <name>Task 3: Create barrel export</name>
  <files>frontend/components/list/index.ts</files>
  <action>
Create barrel export at `frontend/components/list/index.ts`:

```typescript
export { SelectableListItem } from "./selectable-list-item";
```
  </action>
  <verify>
```bash
test -f frontend/components/list/index.ts && echo "File exists"
```
  </verify>
  <done>Barrel export created for list components</done>
</task>

</tasks>

<verification>
1. Components directory exists: `ls frontend/components/list/`
2. Hook file exists: `test -f frontend/lib/hooks/use-selection-mode.ts`
3. TypeScript compiles: `cd frontend && npx tsc --noEmit`
</verification>

<success_criteria>
- Long press (500ms) on SelectableListItem enters selection mode
- Scroll movement (>25px) cancels long press
- Haptic feedback triggers on long press
- Checkbox appears when selectionMode=true
- useSelectionMode combines selection mode state with useBulkSelection
</success_criteria>

<output>
After completion, create `.planning/phases/20-mobile-navigation-fab-and-gestures/20-04-SUMMARY.md`
</output>
