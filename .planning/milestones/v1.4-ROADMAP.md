# Milestone v1.4: Test Overhaul

**Status:** SHIPPED 2026-01-31
**Phases:** 22-26
**Total Plans:** 20 executed (24 planned)

## Overview

This milestone establishes an 80% minimum coverage standard across the codebase. Starting with test infrastructure (fixtures, coverage tools, CI parallelization), we systematically address under-tested backend packages, add API testing layers, cover critical frontend hooks/components, and stabilize flaky E2E tests. The result is a test suite that catches regressions early and runs fast in CI.

## Phases

### Phase 22: Test Infrastructure Setup

**Goal**: Testing foundations enable fast, reliable test development across all layers
**Depends on**: Nothing (first phase of milestone)
**Plans**: 3 plans

Plans:
- [x] 22-01: Go test factories for common entities
- [x] 22-02: Frontend coverage and mock utilities setup
- [x] 22-03: CI parallelization and coverage reporting

**Details:**
- Go test factories with 8 entity types (Item, Location, Container, Inventory, User, Workspace, Category, Borrower)
- Functional options pattern for test customization
- gofakeit integration for realistic fake data
- @vitest/coverage-v8 with text, HTML, JSON, lcov reporters
- Frontend test utilities: offline-mock.ts, sync-mock.ts, factories.ts
- CI matrix strategy for parallel Go unit/integration tests
- Codecov integration with badge in README

### Phase 23: Backend Business Logic Tests

**Goal**: Critical backend packages have comprehensive test coverage preventing regressions
**Depends on**: Phase 22 (needs test factories)
**Plans**: 8 plans (6 original + 2 gap closure)

Plans:
- [x] 23-01: Import/export package tests (BE-01) — 92.4% achieved
- [x] 23-02: Pending changes package tests (BE-02) — 57.3% achieved (gap: handler.go)
- [x] 23-03: Import job package tests (BE-03) — 86.3% achieved
- [x] 23-04: Jobs package tests (BE-04) — 20.1% achieved (architectural constraint)
- [x] 23-05: Item photo package tests (BE-05) — 80.5% achieved
- [x] 23-06: Repair log package tests (BE-06) — 92.8% achieved
- [ ] 23-07: pendingchange handler unit tests (gap closure) — NOT EXECUTED
- [ ] 23-08: jobs ProcessTask error paths (gap closure) — NOT EXECUTED

**Details:**
- MockService pattern for handler testing
- Interface extraction for testability (WorkspaceBackupQueries, ServiceInterface)
- Table-driven tests with comprehensive error paths
- EventCapture pattern for SSE testing

### Phase 24: Backend API Testing

**Goal**: API layer has unit and integration tests ensuring request handling correctness
**Depends on**: Phase 22 (needs test factories), Phase 23 (patterns established)
**Plans**: 3 plans

Plans:
- [x] 24-01: repairphoto and declutter handler unit tests — 38 test cases
- [x] 24-02: repair workflow integration tests — 989 lines
- [ ] 24-03: Request/response validation tests — NOT EXECUTED

**Details:**
- MockService pattern for handler isolation
- Integration tests with test database
- Auth/authz tests verifying 401 responses
- Status transition validation tests

### Phase 25: Frontend Unit Testing

**Goal**: Critical frontend hooks and components have tests preventing sync and UI regressions
**Depends on**: Phase 22 (needs mock utilities)
**Plans**: 5 plans

Plans:
- [x] 25-01: useOfflineMutation hook tests — 29 tests
- [x] 25-02: SyncManager comprehensive tests — 34 tests
- [x] 25-03: MultiStepForm component tests — 21 tests
- [x] 25-04: BarcodeScanner component tests — 18 tests
- [x] 25-05: FloatingActionButton component tests — 28 tests

**Details:**
- vi.hoisted pattern for mock functions with vi.mock factory
- renderHook with act/waitFor for async hook testing
- React Testing Library for component tests
- 130 new tests total, all passing

### Phase 26: E2E Stability and Coverage

**Goal**: E2E test suite runs reliably and covers critical user flows
**Depends on**: Phase 25 (unit tests stable first)
**Plans**: 4 plans

Plans:
- [x] 26-01: Auth setup timing fix — waitForTimeout replaced with proper waits
- [x] 26-02: High-risk test stabilization — 25 waitForTimeout calls removed
- [x] 26-03: Inventory E2E tests — 18 tests with InventoryPage Page Object
- [x] 26-04: Loan CRUD flow tests — 4 serial tests with prerequisite checks

**Details:**
- Promise.race for multiple wait conditions
- waitForResponse for API call monitoring
- retry-with-backoff for flaky operations
- Page Object pattern (InventoryPage, LoansPage)
- Global networkidle → domcontentloaded fix for SSE connections
- 10 consecutive runs verified

---

## Milestone Summary

**Key Decisions:**
- Use functional options pattern for Go test factory customization
- Extract interfaces for testability (WorkspaceBackupQueries, ServiceInterface)
- vi.hoisted pattern for Vitest mock functions with vi.mock factory
- waitForURL/waitForResponse instead of waitForTimeout for E2E reliability
- Global domcontentloaded wait strategy (SSE connections prevent networkidle)

**Issues Resolved:**
- E2E auth setup flakiness (waitForTimeout replaced with proper conditions)
- theme.spec.ts flakiness (7 waitForTimeout → 0)
- categories-dnd.spec.ts flakiness (7 waitForTimeout → 0)
- approval-detail.spec.ts timing issues (5 waitForTimeout → 0)

**Issues Deferred:**
- BE-02 pendingchange handler unit tests (integration tests exist)
- BE-04 jobs package 60% target (requires database mocking library)
- API-03 validation tests (nice-to-have)
- 56 waitForTimeout calls in 24 lower-priority files
- Multi-entity E2E flows (create item → inventory → loan)

**Technical Debt Incurred:**
- Go test factories built but not adopted by Phase 23/24 tests (use inline mocks instead)
- Frontend entity factories (createItem, createLocation) unused by Phase 25 tests
- Phase 24 missing VERIFICATION.md (2 of 3 plans completed)

---

*For current project status, see .planning/ROADMAP.md*
