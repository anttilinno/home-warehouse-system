# Milestone v1.8: Docker Deployment

**Status:** SHIPPED 2026-02-14
**Phases:** 40-42
**Total Plans:** 3

## Overview

Production-ready Docker Compose deployment with clean dev/prod separation, per-service optimized container images, and Angie HTTPS reverse proxy with SSE support.

## Phases

### Phase 40: Compose Profiles and Environment

**Goal**: Developer runs `docker compose up` for dev and `docker compose --profile prod up` for full production stack with proper isolation
**Depends on**: Nothing (first phase of milestone)
**Requirements**: COMP-01, COMP-02, COMP-03, COMP-04, COMP-05, ENV-01, ENV-02, ENV-03
**Plans**: 1 plan

Plans:
- [x] 40-01: Compose profiles, prod Postgres isolation, and environment variable cleanup

**Details:**
- Added postgres-prod container with prod profile, no exposed ports, named volume
- Moved Docspell services behind prod profile
- Updated migrate/backend/worker/scheduler to target postgres-prod
- Hardened env vars: removed DEBUG, required JWT_SECRET, fixed REDIS_URL, added NODE_ENV

### Phase 41: Container Images

**Goal**: Each service builds into its own optimized, minimal container image via separate Dockerfiles
**Depends on**: Phase 40
**Requirements**: IMG-01, IMG-02, IMG-03, IMG-04
**Plans**: 1 plan

Plans:
- [x] 41-01: Split backend into per-service Dockerfiles and update compose references

**Details:**
- Dockerfile.server: CGO + libwebp for photo processing
- Dockerfile.worker: Pure Go (CGO_ENABLED=0), no libwebp (~30MB lighter)
- Dockerfile.scheduler: CGO + libwebp for thumbnail jobs
- Removed monolithic Dockerfile, updated compose references

### Phase 42: Reverse Proxy and End-to-End Validation

**Goal**: Angie reverse proxy routes all traffic correctly with HTTPS, and the full production stack works end-to-end
**Depends on**: Phase 40, Phase 41
**Requirements**: PROXY-01, PROXY-02, PROXY-03, PROXY-04
**Plans**: 1 plan

Plans:
- [x] 42-01: Harden SSE proxy settings, add Angie healthcheck

**Details:**
- SSE hardening: proxy_http_version 1.1, Connection "", proxy_cache off
- Backend upstream keepalive 16 for connection reuse
- Angie healthcheck: curl -fsk https://localhost/health

---

## Milestone Summary

**Key Decisions:**
- Angie (nginx fork) as reverse proxy (user preference)
- Alpine runtime for backend due to CGO/libwebp dependency
- Dev profile = infra only (Postgres + Redis), app runs on host
- Prod profile = full stack with Angie
- Separate Postgres containers per profile (named volume for prod)
- Per-service Dockerfiles: each binary gets own Dockerfile with only required deps
- Worker drops CGO/libwebp entirely (pure Go, no photo processing)
- JWT_SECRET uses required variable substitution (${JWT_SECRET:?})

**Issues Resolved:**
- None â€” clean implementation

**Issues Deferred:**
- Full prod stack runtime testing (requires actual docker builds)
- Kubernetes manifests (future milestone)

**Technical Debt Incurred:**
- None

---
_For current project status, see .planning/ROADMAP.md_
