# Milestone v1.1: Offline Entity Extension

**Status:** SHIPPED 2026-01-25
**Phases:** 6-11
**Total Plans:** 12

## Overview

Extended offline mutation support from items to all core entities (locations, containers, inventory, categories, borrowers) with dependency-aware sync ordering and conflict history UI.

**Milestone Goal:** Reliable offline create/update for all core entities with proper sync ordering and visibility into resolved conflicts.

## Phases

### Phase 6: Infrastructure & Borrowers

**Goal**: Establish dependency-aware sync infrastructure and deliver offline mutations for borrowers (simplest entity - no foreign keys, no hierarchy)
**Depends on**: Phase 5 (v1 complete)
**Requirements**: INFRA-01, INFRA-02, INFRA-03, INFRA-04, INFRA-05, BORR-01, BORR-02, BORR-03, BORR-04
**Plans**: 2 plans

Plans:
- [x] 06-01-PLAN.md — Dependency-aware sync infrastructure (dependsOn field, entity ordering, cascade failures)
- [x] 06-02-PLAN.md — Borrowers offline mutations with pending indicators and E2E tests

**Details:**
- Extended MutationQueueEntry with optional dependsOn field for tracking prerequisite mutations
- Implemented ENTITY_SYNC_ORDER: categories, locations, borrowers, containers, items, inventory, loans
- Added cascade failure handling to mark dependent mutations as failed when parents fail
- Added vitest for unit testing sync logic with 6 passing tests
- Borrowers page supports offline create/update with optimistic UI and pending indicators

### Phase 7: Categories

**Goal**: Deliver offline mutations for categories with parent-child hierarchy support
**Depends on**: Phase 6
**Requirements**: CAT-01, CAT-02, CAT-03, CAT-04, CAT-05
**Plans**: 2 plans

Plans:
- [x] 07-01-PLAN.md — Topological sort for categories sync + offline mutation integration in categories page
- [x] 07-02-PLAN.md — E2E tests for offline category mutations including hierarchical scenarios

**Details:**
- Extended useOfflineMutation hook with dependsOn parameter for hierarchical entity support
- Implemented topological sort using Kahn's algorithm to sync parents before children
- Added offline create/update to categories page with optimistic UI
- Pending indicator shows parent context (e.g., "Pending... under Electronics")
- Disabled drag-drop for pending categories to prevent complex reparenting scenarios

### Phase 8: Locations

**Goal**: Deliver offline mutations for locations with parent-child hierarchy support (foundation for containers and inventory)
**Depends on**: Phase 7
**Requirements**: LOC-01, LOC-02, LOC-03, LOC-04, LOC-05
**Plans**: 2 plans

Plans:
- [x] 08-01-PLAN.md — Topological sort for locations sync + offline mutation integration in locations page
- [x] 08-02-PLAN.md — E2E tests for offline location mutations including hierarchical scenarios

**Details:**
- Implemented topologicalSortLocations using same Kahn's algorithm pattern as categories
- Locations page supports offline create/update with optimistic UI
- Pending indicator shows parent context (e.g., "Pending... under Garage")
- Dropdown menu hidden for pending locations

### Phase 9: Containers

**Goal**: Deliver offline mutations for containers with location foreign key dependency
**Depends on**: Phase 8
**Requirements**: CONT-01, CONT-02, CONT-03, CONT-04, CONT-05
**Plans**: 2 plans

Plans:
- [x] 09-01-PLAN.md — Offline mutation support for containers page with cross-entity location dependency
- [x] 09-02-PLAN.md — E2E tests for offline container mutations

**Details:**
- Cross-entity dependency via dependsOn for containers in pending locations
- Pending locations loaded on mount for dropdown availability
- Pending indicator shows location context (e.g., "Pending... in Garage Shelf A")
- Dropdown shows pending locations with "(pending)" suffix

### Phase 10: Inventory

**Goal**: Deliver offline mutations for inventory records with multiple foreign key dependencies (item, location, container)
**Depends on**: Phase 9
**Requirements**: INV-01, INV-02, INV-03, INV-04, INV-05
**Plans**: 3 plans

Plans:
- [x] 10-01-PLAN.md — Offline mutation support for inventory page with multi-entity dependencies
- [x] 10-02-PLAN.md — E2E tests for offline inventory mutations
- [x] 10-03-PLAN.md — Wire inline edit handlers to use updateInventoryOffline (gap closure)

**Details:**
- Triple-entity dependency tracking (item + location + container) for inventory mutations
- Pending indicator shows item + location context (e.g., "Pending... Drill at Garage / Shelf A")
- Merged reference data arrays (allItems, allLocations, allContainers) for consistent access
- Inline edit handlers (quantity, condition, status) use updateInventoryOffline

### Phase 11: Conflict History

**Goal**: Expose conflict history UI so users can view all resolved conflicts across entity types
**Depends on**: Phase 10
**Requirements**: HIST-01, HIST-02, HIST-03, HIST-04
**Plans**: 1 plan

Plans:
- [x] 11-01-PLAN.md — Sync history page with entity type and date range filtering

**Details:**
- getFilteredConflicts function for efficient IndexedDB queries with date range filtering
- Sync history page at /dashboard/sync-history
- Entity type dropdown filter (all + 7 entity types)
- Date range inputs with clear button
- Conflict cards show entity type, entity ID, conflicting fields, resolution, timestamps
- Full i18n support (English, Estonian, Russian)
- Sidebar navigation link with History icon

---

## Milestone Summary

**Key Decisions:**
- Entity sync order: categories → locations → borrowers → containers → items → inventory → loans
- Topological sort (Kahn's algorithm) for hierarchical entities (categories, locations)
- dependsOn parameter for cross-entity dependencies (containers→locations, inventory→items/locations/containers)
- Cascade failure propagation using failedKeys set during queue processing
- Native HTML5 date inputs for conflict history date range filter
- Entity ID display (not name) for conflict history since entity may not be in cache

**Issues Resolved:**
- Inline edit handlers (quantity, condition, status) now use offline mutations (Plan 10-03)
- All 29 requirements satisfied with full cross-phase integration

**Technical Debt Incurred:**
- E2E tests blocked by auth setup timeout (test code correct, infrastructure issue)
- Modal edit and move dialog features show "coming soon" toast
- Bulk status update still uses direct API (bulk operations are separate concern)

---

*For current project status, see `.planning/ROADMAP.md` (next milestone)*
*Archived: 2026-01-25*
