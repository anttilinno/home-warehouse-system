services:
  postgres:
    image: postgres:18
    container_name: warehouse-postgres
    user: "1000:1000"
    environment:
      POSTGRES_USER: wh
      POSTGRES_PASSWORD: wh
      POSTGRES_DB: warehouse_dev
      PGDATA: /var/lib/postgresql/data
    ports:
      - "5432:5432"
    volumes:
      - ./.data/postgres:/var/lib/postgresql/data
      - ./docker/postgres:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U wh -d warehouse_dev"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:latest
    container_name: warehouse-redis
    user: "1000:1000"
    ports:
      - "6379:6379"
    volumes:
      - ./.data/redis:/data

  # Docspell PostgreSQL (separate database)
  docspell-postgres:
    image: postgres:18
    container_name: warehouse-docspell-postgres
    user: "1000:1000"
    environment:
      POSTGRES_USER: docspell
      POSTGRES_PASSWORD: docspell
      POSTGRES_DB: docspell
      PGDATA: /var/lib/postgresql/data
    ports:
      - "5433:5432"
    volumes:
      - ./.data/docspell-postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U docspell -d docspell"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Docspell REST Server
  docspell-restserver:
    image: docspell/restserver:latest
    container_name: warehouse-docspell-restserver
    user: "1000:1000"
    depends_on:
      docspell-postgres:
        condition: service_healthy
    environment:
      DOCSPELL_SERVER_BIND_ADDRESS: "0.0.0.0"
      DOCSPELL_SERVER_INTERNAL_URL: "http://docspell-restserver:7880"
      DOCSPELL_SERVER_ADMIN_ENDPOINT_SECRET: "admin-secret-change-me"
      DOCSPELL_SERVER_BACKEND_SIGNUP_MODE: "open"
      DOCSPELL_SERVER_BACKEND_JDBC_URL: "jdbc:postgresql://docspell-postgres:5432/docspell"
      DOCSPELL_SERVER_BACKEND_JDBC_USER: "docspell"
      DOCSPELL_SERVER_BACKEND_JDBC_PASSWORD: "docspell"
      DOCSPELL_SERVER_AUTH_SERVER_SECRET: "b64:EirgOHnTqkYhwAmEOep73O8XjbwQBqyh1EW="
    ports:
      - "7880:7880"
    volumes:
      - ./.data/docspell:/opt/docspell

  # Docspell JOEX (Job Executor)
  docspell-joex:
    image: docspell/joex:latest
    container_name: warehouse-docspell-joex
    user: "1000:1000"
    depends_on:
      - docspell-restserver
    environment:
      DOCSPELL_JOEX_APP_ID: "joex-1"
      DOCSPELL_JOEX_BIND_ADDRESS: "0.0.0.0"
      DOCSPELL_JOEX_BASE_URL: "http://docspell-joex:7878"
      DOCSPELL_JOEX_JDBC_URL: "jdbc:postgresql://docspell-postgres:5432/docspell"
      DOCSPELL_JOEX_JDBC_USER: "docspell"
      DOCSPELL_JOEX_JDBC_PASSWORD: "docspell"
    ports:
      - "7878:7878"
    volumes:
      - ./.data/docspell:/opt/docspell

